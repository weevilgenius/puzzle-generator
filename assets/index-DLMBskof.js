import{m,a as _n}from"./mithril-CdZ0BR3D.js";import{r as li}from"./webawesome-DgEd3PYa.js";import{P as ci}from"./paper-rdR45VFZ.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();const ui={view:({attrs:n})=>m("a.github-corner",{href:n.link,"aria-label":"View source on GitHub",title:"View source on GitHub",target:"_blank"},m("svg",{width:80,height:80,viewBox:"0 0 250 250","aria-hidden":"true"},[m("path",{d:"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"}),m("path.octo-arm",{fill:"currentColor",style:"transform-origin: 130px 106px;",d:"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"}),m("path.octo-body",{fill:"currentColor",d:"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"})]))},hi={view:()=>{const n=m.route.get();return m("nav.navigation",[m("div.nav-links",m("wa-radio-group",{orientation:"horizontal",value:n,onchange:e=>{e.redraw=!1;const i=e.target;m.route.set(String(i.value))}},[m("wa-radio",{appearance:"button",value:"/puzzle"},"Puzzle Generator"),m("wa-radio",{appearance:"button",value:"/test"},"Test Harness")]))])}},Wt=50,qt=5,di=qt*qt,pi=.1,fi=10,dt=1,gi=.025,mi=[.25,.5,1,2,4],yi=["25%","50%","100%","200%","400%"];function Qe(n,e){const i=!!n&&!!n.project&&!!n.project.activeLayer&&!!n.view&&!!n.view._context&&n.view._visible!==!1;return i||console.warn(`[${e}] Paper not ready`,{hasScope:!!n,hasProject:!!n?.project,hasLayer:!!n?.project?.activeLayer,hasView:!!n?.view,ctx:!!n?.view?._context,visible:n?.view?._visible}),i}function j(n,e,i){try{return n.scope.activate(),i()}catch(o){console.error(`[${e}] block in paper scope failed`,o)}}function kn(n,e,i){const o=new ci.PaperScope;return o.setup(n),o.view.viewSize=new o.Size(e,i),{scope:o}}function vi(n){const e=[];if(n.segments.length===0)return e;const i=n.segments[0],o={type:"move",p:[i.point.x,i.point.y]};e.push(o);for(let s=1;s<n.segments.length;s++){const r=n.segments[s-1],a=n.segments[s];if(r.handleOut&&r.handleOut.length>0||a.handleIn&&a.handleIn.length>0){const c=r.handleOut?[r.point.x+r.handleOut.x,r.point.y+r.handleOut.y]:[r.point.x,r.point.y],u=a.handleIn?[a.point.x+a.handleIn.x,a.point.y+a.handleIn.y]:[a.point.x,a.point.y],d={type:"bezier",p1:c,p2:u,p3:[a.point.x,a.point.y]};e.push(d)}else{const c={type:"line",p:[a.point.x,a.point.y]};e.push(c)}}if(n.closed&&n.segments.length>=2){const s=n.segments[n.segments.length-1],r=n.segments[0];if(s.handleOut&&s.handleOut.length>0||r.handleIn&&r.handleIn.length>0){const l=s.handleOut?[s.point.x+s.handleOut.x,s.point.y+s.handleOut.y]:[s.point.x,s.point.y],c=r.handleIn?[r.point.x+r.handleIn.x,r.point.y+r.handleIn.y]:[r.point.x,r.point.y],u={type:"bezier",p1:l,p2:c,p3:[r.point.x,r.point.y]};e.push(u)}else{const l={type:"line",p:[r.point.x,r.point.y]};e.push(l)}}return e}function Mt(n,e){const i=e.scope,o=new i.Path;if(n.length===0)return o;let s=null;for(const r of n)switch(r.type){case"move":{const[a,l]=r.p;s=new i.Point(a,l),o.moveTo(s);break}case"line":{const[a,l]=r.p;s=new i.Point(a,l),o.lineTo(s);break}case"bezier":{if(!s){console.warn("paperUtils: CurveTo command without a current point, skipping");break}const[a,l]=r.p1,[c,u]=r.p2,[d,h]=r.p3,p=new i.Point(d,h),f=new i.Point(a,l),y=new i.Point(c,u);o.add(p);const v=o.lastSegment,g=y.subtract(p);if(v.handleIn=g,o.segments.length>=2){const w=f.subtract(s);o.segments[o.segments.length-2].handleOut=w}s=p;break}case"arc":console.warn("paperUtils: Arc commands not yet supported, skipping arc command");break}return o}function wi(n,e,i){const o=i.scope,s=new o.Group,r=Mt(n.borderPath,i);r.strokeColor=new o.Color(e),r.strokeWidth=1,r.data.isBorder=!0,s.addChild(r);for(const a of n.pieces.values()){const l=bi(a,n,i);l.strokeColor=new o.Color(e),l.strokeWidth=1,l.data.pieceId=a.id,s.addChild(l)}return s}function bi(n,e,i){const o=i.scope,s=new o.Path;let r=e.halfEdges.get(n.halfEdge);if(!r)return s;const a=r.id;s.moveTo(new o.Point(r.origin[0],r.origin[1]));do{if(r.segments)for(const l of r.segments)xi(s,l,i);else{const l=e.halfEdges.get(r.next);s.lineTo(new o.Point(l.origin[0],l.origin[1]))}r=e.halfEdges.get(r.next)}while(r.id!==a);return s}function xi(n,e,i){const o=i.scope;switch(e.type){case"line":{n.lineTo(new o.Point(e.p[0],e.p[1]));break}case"bezier":{n.cubicCurveTo(new o.Point(e.p1[0],e.p1[1]),new o.Point(e.p2[0],e.p2[1]),new o.Point(e.p3[0],e.p3[1]));break}}}function Pi(n,e,i,o){if(e.removeChildren(),!i)return;const s=o.scope;for(const r of n.pieces.values()){const[a,l]=r.site,c=new s.Path.Circle(new s.Point(a,l),3);c.fillColor=new s.Color(i),c.data.pieceId=r.id,e.addChild(c)}}function Ci(n,e,i){if(e.removeChildren(),!n.problems||n.problems.length===0)return;const o=i.scope;for(const s of n.problems){const[r,a]=s,l=new o.Path.Circle(new o.Point(r,a),8);l.strokeColor=new o.Color("red"),l.strokeWidth=2,e.addChild(l)}}function Si(n,e){return e()}async function Ii(n,e){return e()}function zi(n,e,i,o){o.paperCtx=kn(n,e,i),o.paperCtx||console.error("PuzzleRenderer: Failed to create Paper.js context")}function et(n,e,i,o){if(!n.paperCtx){console.error("PuzzleRenderer: Cannot render - Paper.js context not initialized");return}Si("Paper.js Rendering",()=>{j(n.paperCtx,"PuzzleRenderer:renderPuzzle",()=>{const s=n.paperCtx.scope;if(!Qe(s,"PuzzleRenderer:renderPuzzle")){console.error("PuzzleRenderer: Paper.js not ready - canvas may have been replaced");return}n.paperPath&&(n.paperPath.remove(),n.paperPath=null),n.paperPath=wi(e,i,n.paperCtx),_i(e,n),n.seedPointItems&&n.paperCtx&&Pi(e,n.seedPointItems,o,n.paperCtx),n.problemItems&&n.paperCtx&&Ci(e,n.problemItems,n.paperCtx),s.view.update()})})}function Ei(n){if(!n.paperCtx){console.error("PuzzleRenderer: Cannot create groups - Paper.js context not initialized");return}j(n.paperCtx,"PuzzleRenderer:createPaperGroups",()=>{const e=n.paperCtx.scope;if(!Qe(e,"PuzzleRenderer:createPaperGroups")){console.error("PuzzleRenderer: Paper.js not ready - canvas may have been replaced");return}n.backgroundRaster=null,n.seedPointItems=new e.Group,n.problemItems=new e.Group,n.vertexItems=new e.Group})}function Bt(n,e,i,o){if(!n.paperCtx){console.error("PuzzleRenderer: Cannot update background - Paper.js context not initialized");return}j(n.paperCtx,"PuzzleRenderer:updateBackgroundImage",()=>{const s=n.paperCtx.scope;if(n.backgroundRaster&&(n.backgroundRaster.remove(),n.backgroundRaster=null),e){const r=new s.Raster(e);r.position=new s.Point(i/2,o/2),r.onLoad=()=>{if(r.width&&r.height){const a=i/r.width,l=o/r.height;r.scale(a,l)}},r.sendToBack(),n.backgroundRaster=r}})}function Mn(n){const e=new Set;for(const i of n.halfEdges.values())if(i.twin===-1){const o=n.vertices.findIndex(s=>s[0]===i.origin[0]&&s[1]===i.origin[1]);o>=0&&e.add(o)}return e}function _i(n,e){if(!e.vertexItems||!e.paperCtx)return;const i=e.paperCtx.scope;e.vertexItems.removeChildren();const o=Mn(n);for(let s=0;s<n.vertices.length;s++){if(o.has(s))continue;const[r,a]=n.vertices[s],l=new i.Path.Circle(new i.Point(r,a),4);l.fillColor=new i.Color("#4363d8"),l.strokeColor=new i.Color("#ffffff"),l.strokeWidth=1,l.visible=!1,l.data.vertexId=s,e.vertexItems.addChild(l)}}function ki(n){n.backgroundRaster&&(n.backgroundRaster.remove(),n.backgroundRaster=null),n.paperPath&&(n.paperPath.remove(),n.paperPath=null),n.seedPointItems&&(n.seedPointItems.remove(),n.seedPointItems=null),n.problemItems&&(n.problemItems.remove(),n.problemItems=null),n.vertexItems&&(n.vertexItems.remove(),n.vertexItems=null),n.paperCtx&&n.paperCtx.scope.project.remove()}class ct{generators=new Map;register(e,i,o){this.generators.has(e)&&console.warn(`Generator "${e}" is already registered, overwriting`),this.generators.set(e,{factory:i,uiMetadata:o})}create(e,i,o){const s=this.generators.get(o.name);if(!s)throw new Error(`Unknown generator "${o.name}". Is it registered?`);return s.factory(e,i,o)}getAvailableGenerators(){return Array.from(this.generators.values()).sort((e,i)=>e.uiMetadata.sortHint-i.uiMetadata.sortHint).map(e=>({name:e.uiMetadata.name,displayName:e.uiMetadata.displayName}))}getUIMetadata(e){return this.generators.get(e)?.uiMetadata}getDefaultConfig(e,i,o){const s={name:e,width:i,height:o},r=this.getUIMetadata(e);if(r)for(const a of r.controls)s[a.name]=a.defaultValue;return s}}const $e=new ct,He=new ct,Ve=new ct,le=new ct;let Mi=0;function Tn(){return Mi++}const{abs:ve,cos:Y,sin:ce,acos:Ti,atan2:we,sqrt:J,pow:W}=Math;function be(n){return n<0?-W(-n,1/3):W(n,1/3)}const Dn=Math.PI,Ge=2*Dn,Q=Dn/2,Di=1e-6,pt=Number.MAX_SAFE_INTEGER||9007199254740991,ft=Number.MIN_SAFE_INTEGER||-9007199254740991,Ri={x:0,y:0,z:0},M={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(n,e){const i=e(n);let o=i.x*i.x+i.y*i.y;return typeof i.z<"u"&&(o+=i.z*i.z),J(o)},compute:function(n,e,i){if(n===0)return e[0].t=0,e[0];const o=e.length-1;if(n===1)return e[o].t=1,e[o];const s=1-n;let r=e;if(o===0)return e[0].t=n,e[0];if(o===1){const l={x:s*r[0].x+n*r[1].x,y:s*r[0].y+n*r[1].y,t:n};return i&&(l.z=s*r[0].z+n*r[1].z),l}if(o<4){let l=s*s,c=n*n,u,d,h,p=0;o===2?(r=[r[0],r[1],r[2],Ri],u=l,d=s*n*2,h=c):o===3&&(u=l*s,d=l*n*3,h=s*c*3,p=n*c);const f={x:u*r[0].x+d*r[1].x+h*r[2].x+p*r[3].x,y:u*r[0].y+d*r[1].y+h*r[2].y+p*r[3].y,t:n};return i&&(f.z=u*r[0].z+d*r[1].z+h*r[2].z+p*r[3].z),f}const a=JSON.parse(JSON.stringify(e));for(;a.length>1;){for(let l=0;l<a.length-1;l++)a[l]={x:a[l].x+(a[l+1].x-a[l].x)*n,y:a[l].y+(a[l+1].y-a[l].y)*n},typeof a[l].z<"u"&&(a[l].z=a[l].z+(a[l+1].z-a[l].z)*n);a.splice(a.length-1,1)}return a[0].t=n,a[0]},computeWithRatios:function(n,e,i,o){const s=1-n,r=i,a=e;let l=r[0],c=r[1],u=r[2],d=r[3],h;if(l*=s,c*=n,a.length===2)return h=l+c,{x:(l*a[0].x+c*a[1].x)/h,y:(l*a[0].y+c*a[1].y)/h,z:o?(l*a[0].z+c*a[1].z)/h:!1,t:n};if(l*=s,c*=2*s,u*=n*n,a.length===3)return h=l+c+u,{x:(l*a[0].x+c*a[1].x+u*a[2].x)/h,y:(l*a[0].y+c*a[1].y+u*a[2].y)/h,z:o?(l*a[0].z+c*a[1].z+u*a[2].z)/h:!1,t:n};if(l*=s,c*=1.5*s,u*=3*s,d*=n*n*n,a.length===4)return h=l+c+u+d,{x:(l*a[0].x+c*a[1].x+u*a[2].x+d*a[3].x)/h,y:(l*a[0].y+c*a[1].y+u*a[2].y+d*a[3].y)/h,z:o?(l*a[0].z+c*a[1].z+u*a[2].z+d*a[3].z)/h:!1,t:n}},derive:function(n,e){const i=[];for(let o=n,s=o.length,r=s-1;s>1;s--,r--){const a=[];for(let l=0,c;l<r;l++)c={x:r*(o[l+1].x-o[l].x),y:r*(o[l+1].y-o[l].y)},e&&(c.z=r*(o[l+1].z-o[l].z)),a.push(c);i.push(a),o=a}return i},between:function(n,e,i){return e<=n&&n<=i||M.approximately(n,e)||M.approximately(n,i)},approximately:function(n,e,i){return ve(n-e)<=(i||Di)},length:function(n){const i=M.Tvalues.length;let o=0;for(let s=0,r;s<i;s++)r=.5*M.Tvalues[s]+.5,o+=M.Cvalues[s]*M.arcfn(r,n);return .5*o},map:function(n,e,i,o,s){const r=i-e,a=s-o,l=n-e,c=l/r;return o+a*c},lerp:function(n,e,i){const o={x:e.x+n*(i.x-e.x),y:e.y+n*(i.y-e.y)};return e.z!==void 0&&i.z!==void 0&&(o.z=e.z+n*(i.z-e.z)),o},pointToString:function(n){let e=n.x+"/"+n.y;return typeof n.z<"u"&&(e+="/"+n.z),e},pointsToString:function(n){return"["+n.map(M.pointToString).join(", ")+"]"},copy:function(n){return JSON.parse(JSON.stringify(n))},angle:function(n,e,i){const o=e.x-n.x,s=e.y-n.y,r=i.x-n.x,a=i.y-n.y,l=o*a-s*r,c=o*r+s*a;return we(l,c)},round:function(n,e){const i=""+n,o=i.indexOf(".");return parseFloat(i.substring(0,o+1+e))},dist:function(n,e){const i=n.x-e.x,o=n.y-e.y;return J(i*i+o*o)},closest:function(n,e){let i=W(2,63),o,s;return n.forEach(function(r,a){s=M.dist(e,r),s<i&&(i=s,o=a)}),{mdist:i,mpos:o}},abcratio:function(n,e){if(e!==2&&e!==3)return!1;if(typeof n>"u")n=.5;else if(n===0||n===1)return n;const i=W(n,e)+W(1-n,e),o=i-1;return ve(o/i)},projectionratio:function(n,e){if(e!==2&&e!==3)return!1;if(typeof n>"u")n=.5;else if(n===0||n===1)return n;const i=W(1-n,e),o=W(n,e)+i;return i/o},lli8:function(n,e,i,o,s,r,a,l){const c=(n*o-e*i)*(s-a)-(n-i)*(s*l-r*a),u=(n*o-e*i)*(r-l)-(e-o)*(s*l-r*a),d=(n-i)*(r-l)-(e-o)*(s-a);return d==0?!1:{x:c/d,y:u/d}},lli4:function(n,e,i,o){const s=n.x,r=n.y,a=e.x,l=e.y,c=i.x,u=i.y,d=o.x,h=o.y;return M.lli8(s,r,a,l,c,u,d,h)},lli:function(n,e){return M.lli4(n,n.c,e,e.c)},makeline:function(n,e){return new N(n.x,n.y,(n.x+e.x)/2,(n.y+e.y)/2,e.x,e.y)},findbbox:function(n){let e=pt,i=pt,o=ft,s=ft;return n.forEach(function(r){const a=r.bbox();e>a.x.min&&(e=a.x.min),i>a.y.min&&(i=a.y.min),o<a.x.max&&(o=a.x.max),s<a.y.max&&(s=a.y.max)}),{x:{min:e,mid:(e+o)/2,max:o,size:o-e},y:{min:i,mid:(i+s)/2,max:s,size:s-i}}},shapeintersections:function(n,e,i,o,s){if(!M.bboxoverlap(e,o))return[];const r=[],a=[n.startcap,n.forward,n.back,n.endcap],l=[i.startcap,i.forward,i.back,i.endcap];return a.forEach(function(c){c.virtual||l.forEach(function(u){if(u.virtual)return;const d=c.intersects(u,s);d.length>0&&(d.c1=c,d.c2=u,d.s1=n,d.s2=i,r.push(d))})}),r},makeshape:function(n,e,i){const o=e.points.length,s=n.points.length,r=M.makeline(e.points[o-1],n.points[0]),a=M.makeline(n.points[s-1],e.points[0]),l={startcap:r,forward:n,back:e,endcap:a,bbox:M.findbbox([r,n,e,a])};return l.intersections=function(c){return M.shapeintersections(l,l.bbox,c,c.bbox,i)},l},getminmax:function(n,e,i){if(!i)return{min:0,max:0};let o=pt,s=ft,r,a;i.indexOf(0)===-1&&(i=[0].concat(i)),i.indexOf(1)===-1&&i.push(1);for(let l=0,c=i.length;l<c;l++)r=i[l],a=n.get(r),a[e]<o&&(o=a[e]),a[e]>s&&(s=a[e]);return{min:o,mid:(o+s)/2,max:s,size:s-o}},align:function(n,e){const i=e.p1.x,o=e.p1.y,s=-we(e.p2.y-o,e.p2.x-i),r=function(a){return{x:(a.x-i)*Y(s)-(a.y-o)*ce(s),y:(a.x-i)*ce(s)+(a.y-o)*Y(s)}};return n.map(r)},roots:function(n,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const i=n.length-1,o=M.align(n,e),s=function(z){return 0<=z&&z<=1};if(i===2){const z=o[0].y,C=o[1].y,S=o[2].y,_=z-2*C+S;if(_!==0){const k=-J(C*C-z*S),T=-z+C,D=-(k+T)/_,R=-(-k+T)/_;return[D,R].filter(s)}else if(C!==S&&_===0)return[(2*C-S)/(2*C-2*S)].filter(s);return[]}const r=o[0].y,a=o[1].y,l=o[2].y,c=o[3].y;let u=-r+3*a-3*l+c,d=3*r-6*a+3*l,h=-3*r+3*a,p=r;if(M.approximately(u,0)){if(M.approximately(d,0))return M.approximately(h,0)?[]:[-p/h].filter(s);const z=J(h*h-4*d*p),C=2*d;return[(z-h)/C,(-h-z)/C].filter(s)}d/=u,h/=u,p/=u;const f=(3*h-d*d)/3,y=f/3,v=(2*d*d*d-9*d*h+27*p)/27,g=v/2,w=g*g+y*y*y;let x,b,E,P,I;if(w<0){const z=-f/3,C=z*z*z,S=J(C),_=-v/(2*S),k=_<-1?-1:_>1?1:_,T=Ti(k),D=be(S),R=2*D;return E=R*Y(T/3)-d/3,P=R*Y((T+Ge)/3)-d/3,I=R*Y((T+2*Ge)/3)-d/3,[E,P,I].filter(s)}else{if(w===0)return x=g<0?be(-g):-be(g),E=2*x-d/3,P=-x-d/3,[E,P].filter(s);{const z=J(w);return x=be(-g+z),b=be(g+z),[x-b-d/3].filter(s)}}},droots:function(n){if(n.length===3){const e=n[0],i=n[1],o=n[2],s=e-2*i+o;if(s!==0){const r=-J(i*i-e*o),a=-e+i,l=-(r+a)/s,c=-(-r+a)/s;return[l,c]}else if(i!==o&&s===0)return[(2*i-o)/(2*(i-o))];return[]}if(n.length===2){const e=n[0],i=n[1];return e!==i?[e/(e-i)]:[]}return[]},curvature:function(n,e,i,o,s){let r,a,l,c,u=0,d=0;const h=M.compute(n,e),p=M.compute(n,i),f=h.x*h.x+h.y*h.y;if(o?(r=J(W(h.y*p.z-p.y*h.z,2)+W(h.z*p.x-p.z*h.x,2)+W(h.x*p.y-p.x*h.y,2)),a=W(f+h.z*h.z,3/2)):(r=h.x*p.y-h.y*p.x,a=W(f,3/2)),r===0||a===0)return{k:0,r:0};if(u=r/a,d=a/r,!s){const y=M.curvature(n-.001,e,i,o,!0).k,v=M.curvature(n+.001,e,i,o,!0).k;c=(v-u+(u-y))/2,l=(ve(v-u)+ve(u-y))/2}return{k:u,r:d,dk:c,adk:l}},inflections:function(n){if(n.length<4)return[];const e=M.align(n,{p1:n[0],p2:n.slice(-1)[0]}),i=e[2].x*e[1].y,o=e[3].x*e[1].y,s=e[1].x*e[2].y,r=e[3].x*e[2].y,a=18*(-3*i+2*o+3*s-r),l=18*(3*i-o-3*s),c=18*(s-i);if(M.approximately(a,0)){if(!M.approximately(l,0)){let p=-c/l;if(0<=p&&p<=1)return[p]}return[]}const u=2*a;if(M.approximately(u,0))return[];const d=l*l-4*a*c;if(d<0)return[];const h=Math.sqrt(d);return[(h-l)/u,-(l+h)/u].filter(function(p){return 0<=p&&p<=1})},bboxoverlap:function(n,e){const i=["x","y"],o=i.length;for(let s=0,r,a,l,c;s<o;s++)if(r=i[s],a=n[r].mid,l=e[r].mid,c=(n[r].size+e[r].size)/2,ve(a-l)>=c)return!1;return!0},expandbox:function(n,e){e.x.min<n.x.min&&(n.x.min=e.x.min),e.y.min<n.y.min&&(n.y.min=e.y.min),e.z&&e.z.min<n.z.min&&(n.z.min=e.z.min),e.x.max>n.x.max&&(n.x.max=e.x.max),e.y.max>n.y.max&&(n.y.max=e.y.max),e.z&&e.z.max>n.z.max&&(n.z.max=e.z.max),n.x.mid=(n.x.min+n.x.max)/2,n.y.mid=(n.y.min+n.y.max)/2,n.z&&(n.z.mid=(n.z.min+n.z.max)/2),n.x.size=n.x.max-n.x.min,n.y.size=n.y.max-n.y.min,n.z&&(n.z.size=n.z.max-n.z.min)},pairiteration:function(n,e,i){const o=n.bbox(),s=e.bbox(),r=1e5,a=i||.5;if(o.x.size+o.y.size<a&&s.x.size+s.y.size<a)return[(r*(n._t1+n._t2)/2|0)/r+"/"+(r*(e._t1+e._t2)/2|0)/r];let l=n.split(.5),c=e.split(.5),u=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];u=u.filter(function(h){return M.bboxoverlap(h.left.bbox(),h.right.bbox())});let d=[];return u.length===0||(u.forEach(function(h){d=d.concat(M.pairiteration(h.left,h.right,a))}),d=d.filter(function(h,p){return d.indexOf(h)===p})),d},getccenter:function(n,e,i){const o=e.x-n.x,s=e.y-n.y,r=i.x-e.x,a=i.y-e.y,l=o*Y(Q)-s*ce(Q),c=o*ce(Q)+s*Y(Q),u=r*Y(Q)-a*ce(Q),d=r*ce(Q)+a*Y(Q),h=(n.x+e.x)/2,p=(n.y+e.y)/2,f=(e.x+i.x)/2,y=(e.y+i.y)/2,v=h+l,g=p+c,w=f+u,x=y+d,b=M.lli8(h,p,v,g,f,y,w,x),E=M.dist(b,n);let P=we(n.y-b.y,n.x-b.x),I=we(e.y-b.y,e.x-b.x),z=we(i.y-b.y,i.x-b.x),C;return P<z?((P>I||I>z)&&(P+=Ge),P>z&&(C=z,z=P,P=C)):z<I&&I<P?(C=z,z=P,P=C):z+=Ge,b.s=P,b.e=z,b.r=E,b},numberSort:function(n,e){return n-e}};class Ie{constructor(e){this.curves=[],this._3d=!1,e&&(this.curves=e,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(e){return M.pointsToString(e.points)}).join(", ")+"]"}addCurve(e){this.curves.push(e),this._3d=this._3d||e._3d}length(){return this.curves.map(function(e){return e.length()}).reduce(function(e,i){return e+i})}curve(e){return this.curves[e]}bbox(){const e=this.curves;for(var i=e[0].bbox(),o=1;o<e.length;o++)M.expandbox(i,e[o].bbox());return i}offset(e){const i=[];return this.curves.forEach(function(o){i.push(...o.offset(e))}),new Ie(i)}}const{abs:xe,min:Xt,max:Yt,cos:Ai,sin:Li,acos:Oi,sqrt:Pe}=Math,Ni=Math.PI;class N{constructor(e){let i=e&&e.forEach?e:Array.from(arguments).slice(),o=!1;if(typeof i[0]=="object"){o=i.length;const f=[];i.forEach(function(y){["x","y","z"].forEach(function(v){typeof y[v]<"u"&&f.push(y[v])})}),i=f}let s=!1;const r=i.length;if(o){if(o>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");s=!0}}else if(r!==6&&r!==8&&r!==9&&r!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const a=this._3d=!s&&(r===9||r===12)||e&&e[0]&&typeof e[0].z<"u",l=this.points=[];for(let f=0,y=a?3:2;f<r;f+=y){var c={x:i[f],y:i[f+1]};a&&(c.z=i[f+2]),l.push(c)}const u=this.order=l.length-1,d=this.dims=["x","y"];a&&d.push("z"),this.dimlen=d.length;const h=M.align(l,{p1:l[0],p2:l[u]}),p=M.dist(l[0],l[u]);this._linear=h.reduce((f,y)=>f+xe(y.y),0)<p/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(e,i,o,s){if(typeof s>"u"&&(s=.5),s===0)return new N(i,i,o);if(s===1)return new N(e,i,i);const r=N.getABC(2,e,i,o,s);return new N(e,r.A,o)}static cubicFromPoints(e,i,o,s,r){typeof s>"u"&&(s=.5);const a=N.getABC(3,e,i,o,s);typeof r>"u"&&(r=M.dist(i,a.C));const l=r*(1-s)/s,c=M.dist(e,o),u=(o.x-e.x)/c,d=(o.y-e.y)/c,h=r*u,p=r*d,f=l*u,y=l*d,v={x:i.x-h,y:i.y-p},g={x:i.x+f,y:i.y+y},w=a.A,x={x:w.x+(v.x-w.x)/(1-s),y:w.y+(v.y-w.y)/(1-s)},b={x:w.x+(g.x-w.x)/s,y:w.y+(g.y-w.y)/s},E={x:e.x+(x.x-e.x)/s,y:e.y+(x.y-e.y)/s},P={x:o.x+(b.x-o.x)/(1-s),y:o.y+(b.y-o.y)/(1-s)};return new N(e,E,P,o)}static getUtils(){return M}getUtils(){return N.getUtils()}static get PolyBezier(){return Ie}valueOf(){return this.toString()}toString(){return M.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const e=this.points,i=e[0].x,o=e[0].y,s=["M",i,o,this.order===2?"Q":"C"];for(let r=1,a=e.length;r<a;r++)s.push(e[r].x),s.push(e[r].y);return s.join(" ")}setRatios(e){if(e.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=e,this._lut=[]}verify(){const e=this.coordDigest();e!==this._print&&(this._print=e,this.update())}coordDigest(){return this.points.map(function(e,i){return""+i+e.x+e.y+(e.z?e.z:0)}).join("")}update(){this._lut=[],this.dpoints=M.derive(this.points,this._3d),this.computedirection()}computedirection(){const e=this.points,i=M.angle(e[0],e[this.order],e[1]);this.clockwise=i>0}length(){return M.length(this.derivative.bind(this))}static getABC(e=2,i,o,s,r=.5){const a=M.projectionratio(r,e),l=1-a,c={x:a*i.x+l*s.x,y:a*i.y+l*s.y},u=M.abcratio(r,e);return{A:{x:o.x+(o.x-c.x)/u,y:o.y+(o.y-c.y)/u},B:o,C:c,S:i,E:s}}getABC(e,i){i=i||this.get(e);let o=this.points[0],s=this.points[this.order];return N.getABC(this.order,o,i,s,e)}getLUT(e){if(this.verify(),e=e||100,this._lut.length===e+1)return this._lut;this._lut=[],e++,this._lut=[];for(let i=0,o,s;i<e;i++)s=i/(e-1),o=this.compute(s),o.t=s,this._lut.push(o);return this._lut}on(e,i){i=i||5;const o=this.getLUT(),s=[];for(let r=0,a,l=0;r<o.length;r++)a=o[r],M.dist(a,e)<i&&(s.push(a),l+=r/o.length);return s.length?t/=s.length:!1}project(e){const i=this.getLUT(),o=i.length-1,s=M.closest(i,e),r=s.mpos,a=(r-1)/o,l=(r+1)/o,c=.1/o;let u=s.mdist,d=a,h=d,p;u+=1;for(let f;d<l+c;d+=c)p=this.compute(d),f=M.dist(e,p),f<u&&(u=f,h=d);return h=h<0?0:h>1?1:h,p=this.compute(h),p.t=h,p.d=u,p}get(e){return this.compute(e)}point(e){return this.points[e]}compute(e){return this.ratios?M.computeWithRatios(e,this.points,this.ratios,this._3d):M.compute(e,this.points,this._3d,this.ratios)}raise(){const e=this.points,i=[e[0]],o=e.length;for(let s=1,r,a;s<o;s++)r=e[s],a=e[s-1],i[s]={x:(o-s)/o*r.x+s/o*a.x,y:(o-s)/o*r.y+s/o*a.y};return i[o]=e[o-1],new N(i)}derivative(e){return M.compute(e,this.dpoints[0],this._3d)}dderivative(e){return M.compute(e,this.dpoints[1],this._3d)}align(){let e=this.points;return new N(M.align(e,{p1:e[0],p2:e[e.length-1]}))}curvature(e){return M.curvature(e,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return M.inflections(this.points)}normal(e){return this._3d?this.__normal3(e):this.__normal2(e)}__normal2(e){const i=this.derivative(e),o=Pe(i.x*i.x+i.y*i.y);return{t:e,x:-i.y/o,y:i.x/o}}__normal3(e){const i=this.derivative(e),o=this.derivative(e+.01),s=Pe(i.x*i.x+i.y*i.y+i.z*i.z),r=Pe(o.x*o.x+o.y*o.y+o.z*o.z);i.x/=s,i.y/=s,i.z/=s,o.x/=r,o.y/=r,o.z/=r;const a={x:o.y*i.z-o.z*i.y,y:o.z*i.x-o.x*i.z,z:o.x*i.y-o.y*i.x},l=Pe(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=l,a.y/=l,a.z/=l;const c=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return{t:e,x:c[0]*i.x+c[1]*i.y+c[2]*i.z,y:c[3]*i.x+c[4]*i.y+c[5]*i.z,z:c[6]*i.x+c[7]*i.y+c[8]*i.z}}hull(e){let i=this.points,o=[],s=[],r=0;for(s[r++]=i[0],s[r++]=i[1],s[r++]=i[2],this.order===3&&(s[r++]=i[3]);i.length>1;){o=[];for(let a=0,l,c=i.length-1;a<c;a++)l=M.lerp(e,i[a],i[a+1]),s[r++]=l,o.push(l);i=o}return s}split(e,i){if(e===0&&i)return this.split(i).left;if(i===1)return this.split(e).right;const o=this.hull(e),s={left:this.order===2?new N([o[0],o[3],o[5]]):new N([o[0],o[4],o[7],o[9]]),right:this.order===2?new N([o[5],o[4],o[2]]):new N([o[9],o[8],o[6],o[3]]),span:o};return s.left._t1=M.map(0,0,1,this._t1,this._t2),s.left._t2=M.map(e,0,1,this._t1,this._t2),s.right._t1=M.map(e,0,1,this._t1,this._t2),s.right._t2=M.map(1,0,1,this._t1,this._t2),i?(i=M.map(i,e,1,0,1),s.right.split(i).left):s}extrema(){const e={};let i=[];return this.dims.forEach((function(o){let s=function(a){return a[o]},r=this.dpoints[0].map(s);e[o]=M.droots(r),this.order===3&&(r=this.dpoints[1].map(s),e[o]=e[o].concat(M.droots(r))),e[o]=e[o].filter(function(a){return a>=0&&a<=1}),i=i.concat(e[o].sort(M.numberSort))}).bind(this)),e.values=i.sort(M.numberSort).filter(function(o,s){return i.indexOf(o)===s}),e}bbox(){const e=this.extrema(),i={};return this.dims.forEach((function(o){i[o]=M.getminmax(this,o,e[o])}).bind(this)),i}overlaps(e){const i=this.bbox(),o=e.bbox();return M.bboxoverlap(i,o)}offset(e,i){if(typeof i<"u"){const o=this.get(e),s=this.normal(e),r={c:o,n:s,x:o.x+s.x*i,y:o.y+s.y*i};return this._3d&&(r.z=o.z+s.z*i),r}if(this._linear){const o=this.normal(0),s=this.points.map(function(r){const a={x:r.x+e*o.x,y:r.y+e*o.y};return r.z&&o.z&&(a.z=r.z+e*o.z),a});return[new N(s)]}return this.reduce().map(function(o){return o._linear?o.offset(e)[0]:o.scale(e)})}simple(){if(this.order===3){const s=M.angle(this.points[0],this.points[3],this.points[1]),r=M.angle(this.points[0],this.points[3],this.points[2]);if(s>0&&r<0||s<0&&r>0)return!1}const e=this.normal(0),i=this.normal(1);let o=e.x*i.x+e.y*i.y;return this._3d&&(o+=e.z*i.z),xe(Oi(o))<Ni/3}reduce(){let e,i=0,o=0,s=.01,r,a=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),i=c[0],e=1;e<c.length;e++)o=c[e],r=this.split(i,o),r._t1=i,r._t2=o,a.push(r),i=o;return a.forEach(function(u){for(i=0,o=0;o<=1;)for(o=i+s;o<=1+s;o+=s)if(r=u.split(i,o),!r.simple()){if(o-=s,xe(i-o)<s)return[];r=u.split(i,o),r._t1=M.map(i,0,1,u._t1,u._t2),r._t2=M.map(o,0,1,u._t1,u._t2),l.push(r),i=o;break}i<1&&(r=u.split(i,1),r._t1=M.map(i,0,1,u._t1,u._t2),r._t2=u._t2,l.push(r))}),l}translate(e,i,o){o=typeof o=="number"?o:i;const s=this.order;let r=this.points.map((a,l)=>(1-l/s)*i+l/s*o);return new N(this.points.map((a,l)=>({x:a.x+e.x*r[l],y:a.y+e.y*r[l]})))}scale(e){const i=this.order;let o=!1;if(typeof e=="function"&&(o=e),o&&i===2)return this.raise().scale(o);const s=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),o?o(0):e,o?o(1):e);const a=o?o(0):e,l=o?o(1):e,c=[this.offset(0,10),this.offset(1,10)],u=[],d=M.lli4(c[0],c[0].c,c[1],c[1].c);if(!d)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(h){const p=u[h*i]=M.copy(r[h*i]);p.x+=(h?l:a)*c[h].n.x,p.y+=(h?l:a)*c[h].n.y}),o?([0,1].forEach(function(h){if(!(i===2&&h)){var p=r[h+1],f={x:p.x-d.x,y:p.y-d.y},y=o?o((h+1)/i):e;o&&!s&&(y=-y);var v=Pe(f.x*f.x+f.y*f.y);f.x/=v,f.y/=v,u[h+1]={x:p.x+y*f.x,y:p.y+y*f.y}}}),new N(u)):([0,1].forEach(h=>{if(i===2&&h)return;const p=u[h*i],f=this.derivative(h),y={x:p.x+f.x,y:p.y+f.y};u[h+1]=M.lli4(p,y,d,r[h+1])}),new N(u))}outline(e,i,o,s){if(i=i===void 0?e:i,this._linear){const P=this.normal(0),I=this.points[0],z=this.points[this.points.length-1];let C,S,_;o===void 0&&(o=e,s=i),C={x:I.x+P.x*e,y:I.y+P.y*e},_={x:z.x+P.x*o,y:z.y+P.y*o},S={x:(C.x+_.x)/2,y:(C.y+_.y)/2};const k=[C,S,_];C={x:I.x-P.x*i,y:I.y-P.y*i},_={x:z.x-P.x*s,y:z.y-P.y*s},S={x:(C.x+_.x)/2,y:(C.y+_.y)/2};const T=[_,S,C],D=M.makeline(T[2],k[0]),R=M.makeline(k[2],T[0]),L=[D,new N(k),R,new N(T)];return new Ie(L)}const r=this.reduce(),a=r.length,l=[];let c=[],u,d=0,h=this.length();const p=typeof o<"u"&&typeof s<"u";function f(P,I,z,C,S){return function(_){const k=C/z,T=(C+S)/z,D=I-P;return M.map(_,0,1,P+k*D,P+T*D)}}r.forEach(function(P){const I=P.length();p?(l.push(P.scale(f(e,o,h,d,I))),c.push(P.scale(f(-i,-s,h,d,I)))):(l.push(P.scale(e)),c.push(P.scale(-i))),d+=I}),c=c.map(function(P){return u=P.points,u[3]?P.points=[u[3],u[2],u[1],u[0]]:P.points=[u[2],u[1],u[0]],P}).reverse();const y=l[0].points[0],v=l[a-1].points[l[a-1].points.length-1],g=c[a-1].points[c[a-1].points.length-1],w=c[0].points[0],x=M.makeline(g,y),b=M.makeline(v,w),E=[x].concat(l).concat([b]).concat(c);return new Ie(E)}outlineshapes(e,i,o){i=i||e;const s=this.outline(e,i).curves,r=[];for(let a=1,l=s.length;a<l/2;a++){const c=M.makeshape(s[a],s[l-a],o);c.startcap.virtual=a>1,c.endcap.virtual=a<l/2-1,r.push(c)}return r}intersects(e,i){return e?e.p1&&e.p2?this.lineIntersects(e):(e instanceof N&&(e=e.reduce()),this.curveintersects(this.reduce(),e,i)):this.selfintersects(i)}lineIntersects(e){const i=Xt(e.p1.x,e.p2.x),o=Xt(e.p1.y,e.p2.y),s=Yt(e.p1.x,e.p2.x),r=Yt(e.p1.y,e.p2.y);return M.roots(this.points,e).filter(a=>{var l=this.get(a);return M.between(l.x,i,s)&&M.between(l.y,o,r)})}selfintersects(e){const i=this.reduce(),o=i.length-2,s=[];for(let r=0,a,l,c;r<o;r++)l=i.slice(r,r+1),c=i.slice(r+2),a=this.curveintersects(l,c,e),s.push(...a);return s}curveintersects(e,i,o){const s=[];e.forEach(function(a){i.forEach(function(l){a.overlaps(l)&&s.push({left:a,right:l})})});let r=[];return s.forEach(function(a){const l=M.pairiteration(a.left,a.right,o);l.length>0&&(r=r.concat(l))}),r}arcs(e){return e=e||.5,this._iterate(e,[])}_error(e,i,o,s){const r=(s-o)/4,a=this.get(o+r),l=this.get(s-r),c=M.dist(e,i),u=M.dist(e,a),d=M.dist(e,l);return xe(u-c)+xe(d-c)}_iterate(e,i){let o=0,s=1,r;do{r=0,s=1;let a=this.get(o),l,c,u,d,h=!1,p=!1,f,y=s,v=1;do if(p=h,d=u,y=(o+s)/2,l=this.get(y),c=this.get(s),u=M.getccenter(a,l,c),u.interval={start:o,end:s},h=this._error(u,a,o,s)<=e,f=p&&!h,f||(v=s),h){if(s>=1){if(u.interval.end=v=1,d=u,s>1){let w={x:u.x+u.r*Ai(u.e),y:u.y+u.r*Li(u.e)};u.e+=M.angle({x:u.x,y:u.y},w,this.get(1))}break}s=s+(s-o)/2}else s=y;while(!f&&r++<100);if(r>=100)break;d=d||u,i.push(d),o=v}while(s<1);return i}}var $i=(function(){function n(e,i){var o=[],s=!0,r=!1,a=void 0;try{for(var l=e[Symbol.iterator](),c;!(s=(c=l.next()).done)&&(o.push(c.value),!(i&&o.length===i));s=!0);}catch(u){r=!0,a=u}finally{try{!s&&l.return&&l.return()}finally{if(r)throw a}}return o}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return n(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}})(),ze=Math.PI*2,gt=function(e,i,o,s,r,a,l){var c=e.x,u=e.y;c*=i,u*=o;var d=s*c-r*u,h=r*c+s*u;return{x:d+a,y:h+l}},Hi=function(e,i){var o=i===1.5707963267948966?.551915024494:i===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(i/4),s=Math.cos(e),r=Math.sin(e),a=Math.cos(e+i),l=Math.sin(e+i);return[{x:s-r*o,y:r+s*o},{x:a+l*o,y:l-a*o},{x:a,y:l}]},Kt=function(e,i,o,s){var r=e*s-i*o<0?-1:1,a=e*o+i*s;return a>1&&(a=1),a<-1&&(a=-1),r*Math.acos(a)},Vi=function(e,i,o,s,r,a,l,c,u,d,h,p){var f=Math.pow(r,2),y=Math.pow(a,2),v=Math.pow(h,2),g=Math.pow(p,2),w=f*y-f*g-y*v;w<0&&(w=0),w/=f*g+y*v,w=Math.sqrt(w)*(l===c?-1:1);var x=w*r/a*p,b=w*-a/r*h,E=d*x-u*b+(e+o)/2,P=u*x+d*b+(i+s)/2,I=(h-x)/r,z=(p-b)/a,C=(-h-x)/r,S=(-p-b)/a,_=Kt(1,0,I,z),k=Kt(I,z,C,S);return c===0&&k>0&&(k-=ze),c===1&&k<0&&(k+=ze),[E,P,_,k]},Ui=function(e){var i=e.px,o=e.py,s=e.cx,r=e.cy,a=e.rx,l=e.ry,c=e.xAxisRotation,u=c===void 0?0:c,d=e.largeArcFlag,h=d===void 0?0:d,p=e.sweepFlag,f=p===void 0?0:p,y=[];if(a===0||l===0)return[];var v=Math.sin(u*ze/360),g=Math.cos(u*ze/360),w=g*(i-s)/2+v*(o-r)/2,x=-v*(i-s)/2+g*(o-r)/2;if(w===0&&x===0)return[];a=Math.abs(a),l=Math.abs(l);var b=Math.pow(w,2)/Math.pow(a,2)+Math.pow(x,2)/Math.pow(l,2);b>1&&(a*=Math.sqrt(b),l*=Math.sqrt(b));var E=Vi(i,o,s,r,a,l,h,f,v,g,w,x),P=$i(E,4),I=P[0],z=P[1],C=P[2],S=P[3],_=Math.abs(S)/(ze/4);Math.abs(1-_)<1e-7&&(_=1);var k=Math.max(Math.ceil(_),1);S/=k;for(var T=0;T<k;T++)y.push(Hi(C,S)),C+=S;return y.map(function(D){var R=gt(D[0],a,l,g,v,I,z),L=R.x,A=R.y,O=gt(D[1],a,l,g,v,I,z),H=O.x,$=O.y,q=gt(D[2],a,l,g,v,I,z),ye=q.x,ht=q.y;return{x1:L,y1:A,x2:H,y2:$,x:ye,y:ht}})};function Fi(n,e){return n>e?1:n<e?-1:0}class Ht{constructor(e=Fi,i=!1){this._compare=e,this._root=null,this._size=0,this._noDuplicates=!!i}rotateLeft(e){var i=e.right;i&&(e.right=i.left,i.left&&(i.left.parent=e),i.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=i:e.parent.right=i:this._root=i,i&&(i.left=e),e.parent=i}rotateRight(e){var i=e.left;i&&(e.left=i.right,i.right&&(i.right.parent=e),i.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=i:e.parent.right=i:this._root=i,i&&(i.right=e),e.parent=i}_splay(e){for(;e.parent;){var i=e.parent;i.parent?i.left===e&&i.parent.left===i?(this.rotateRight(i.parent),this.rotateRight(i)):i.right===e&&i.parent.right===i?(this.rotateLeft(i.parent),this.rotateLeft(i)):i.left===e&&i.parent.right===i?(this.rotateRight(i),this.rotateLeft(i)):(this.rotateLeft(i),this.rotateRight(i)):i.left===e?this.rotateRight(i):this.rotateLeft(i)}}splay(e){for(var i,o,s,r,a;e.parent;)i=e.parent,o=i.parent,o&&o.parent?(s=o.parent,s.left===o?s.left=e:s.right=e,e.parent=s):(e.parent=null,this._root=e),r=e.left,a=e.right,e===i.left?(o&&(o.left===i?(i.right?(o.left=i.right,o.left.parent=o):o.left=null,i.right=o,o.parent=i):(r?(o.right=r,r.parent=o):o.right=null,e.left=o,o.parent=e)),a?(i.left=a,a.parent=i):i.left=null,e.right=i,i.parent=e):(o&&(o.right===i?(i.left?(o.right=i.left,o.right.parent=o):o.right=null,i.left=o,o.parent=i):(a?(o.left=a,a.parent=o):o.left=null,e.right=o,o.parent=e)),r?(i.right=r,r.parent=i):i.right=null,e.left=i,i.parent=e)}replace(e,i){e.parent?e===e.parent.left?e.parent.left=i:e.parent.right=i:this._root=i,i&&(i.parent=e.parent)}minNode(e=this._root){if(e)for(;e.left;)e=e.left;return e}maxNode(e=this._root){if(e)for(;e.right;)e=e.right;return e}insert(e,i){var o=this._root,s=null,r=this._compare,a;if(this._noDuplicates)for(;o;){if(s=o,a=r(o.key,e),a===0)return;r(o.key,e)<0?o=o.right:o=o.left}else for(;o;)s=o,r(o.key,e)<0?o=o.right:o=o.left;return o={key:e,data:i,left:null,right:null,parent:s},s?r(s.key,o.key)<0?s.right=o:s.left=o:this._root=o,this.splay(o),this._size++,o}find(e){for(var i=this._root,o=this._compare;i;){var s=o(i.key,e);if(s<0)i=i.right;else if(s>0)i=i.left;else return i}return null}contains(e){for(var i=this._root,o=this._compare;i;){var s=o(e,i.key);if(s===0)return!0;s<0?i=i.left:i=i.right}return!1}remove(e){var i=this.find(e);if(!i)return!1;if(this.splay(i),!i.left)this.replace(i,i.right);else if(!i.right)this.replace(i,i.left);else{var o=this.minNode(i.right);o.parent!==i&&(this.replace(o,o.right),o.right=i.right,o.right.parent=o),this.replace(i,o),o.left=i.left,o.left.parent=o}return this._size--,!0}removeNode(e){if(!e)return!1;if(this.splay(e),!e.left)this.replace(e,e.right);else if(!e.right)this.replace(e,e.left);else{var i=this.minNode(e.right);i.parent!==e&&(this.replace(i,i.right),i.right=e.right,i.right.parent=i),this.replace(e,i),i.left=e.left,i.left.parent=i}return this._size--,!0}erase(e){var i=this.find(e);if(i){this.splay(i);var o=i.left,s=i.right,r=null;o&&(o.parent=null,r=this.maxNode(o),this.splay(r),this._root=r),s&&(o?r.right=s:this._root=s,s.parent=r),this._size--}}pop(){var e=this._root,i=null;if(e){for(;e.left;)e=e.left;i={key:e.key,data:e.data},this.remove(e.key)}return i}next(e){var i=e;if(i)if(i.right)for(i=i.right;i&&i.left;)i=i.left;else for(i=e.parent;i&&i.right===e;)e=i,i=i.parent;return i}prev(e){var i=e;if(i)if(i.left)for(i=i.left;i&&i.right;)i=i.right;else for(i=e.parent;i&&i.left===e;)e=i,i=i.parent;return i}forEach(e){for(var i=this._root,o=[],s=!1,r=0;!s;)i?(o.push(i),i=i.left):o.length>0?(i=o.pop(),e(i,r++),i=i.right):s=!0;return this}range(e,i,o,s){const r=[],a=this._compare;let l=this._root,c;for(;r.length!==0||l;)if(l)r.push(l),l=l.left;else{if(l=r.pop(),c=a(l.key,i),c>0)break;if(a(l.key,e)>=0&&o.call(s,l))return this;l=l.right}return this}keys(){for(var e=this._root,i=[],o=[],s=!1;!s;)e?(i.push(e),e=e.left):i.length>0?(e=i.pop(),o.push(e.key),e=e.right):s=!0;return o}values(){for(var e=this._root,i=[],o=[],s=!1;!s;)e?(i.push(e),e=e.left):i.length>0?(e=i.pop(),o.push(e.data),e=e.right):s=!0;return o}at(e){for(var i=this._root,o=[],s=!1,r=0;!s;)if(i)o.push(i),i=i.left;else if(o.length>0){if(i=o.pop(),r===e)return i;r++,i=i.right}else s=!0;return null}load(e=[],i=[],o=!1){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const s=e.length;return o&&Dt(e,i,0,s-1,this._compare),this._root=Tt(null,e,i,0,s),this._size=s,this}min(){var e=this.minNode(this._root);return e?e.key:null}max(){var e=this.maxNode(this._root);return e?e.key:null}isEmpty(){return this._root===null}get size(){return this._size}static createTree(e,i,o,s,r){return new Ht(o,r).load(e,i,s)}}function Tt(n,e,i,o,s){const r=s-o;if(r>0){const a=o+Math.floor(r/2),l=e[a],c=i[a],u={key:l,data:c,parent:n};return u.left=Tt(u,e,i,o,a),u.right=Tt(u,e,i,a+1,s),u}return null}function Dt(n,e,i,o,s){if(i>=o)return;const r=n[i+o>>1];let a=i-1,l=o+1;for(;;){do a++;while(s(n[a],r)<0);do l--;while(s(n[l],r)>0);if(a>=l)break;let c=n[a];n[a]=n[l],n[l]=c,c=e[a],e[a]=e[l],e[l]=c}Dt(n,e,i,l,s),Dt(n,e,l+1,o,s)}const Rn=0,An=1,Ln=2,On=3,tt=0,Rt=1,nt=2,Nn=3;function Ce(n,e,i){e===null?(n.inOut=!1,n.otherInOut=!0):(n.isSubject===e.isSubject?(n.inOut=!e.inOut,n.otherInOut=e.otherInOut):(n.inOut=!e.otherInOut,n.otherInOut=e.isVertical()?!e.inOut:e.inOut),e&&(n.prevInResult=!Zt(e,i)||e.isVertical()?e.prevInResult:e)),Zt(n,i)?n.resultTransition=Gi(n,i):n.resultTransition=0}function Zt(n,e){switch(n.type){case Rn:switch(e){case tt:return!n.otherInOut;case Rt:return n.otherInOut;case nt:return n.isSubject&&n.otherInOut||!n.isSubject&&!n.otherInOut;case Nn:return!0}break;case Ln:return e===tt||e===Rt;case On:return e===nt;case An:return!1}return!1}function Gi(n,e){let i=!n.inOut,o=!n.otherInOut,s;switch(e){case tt:s=i&&o;break;case Rt:s=i||o;break;case Nn:s=i^o;break;case nt:n.isSubject?s=i&&!o:s=o&&!i;break}return s?1:-1}class me{constructor(e,i,o,s,r){this.left=i,this.point=e,this.otherEvent=o,this.isSubject=s,this.type=r||Rn,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0}isBelow(e){const i=this.point,o=this.otherEvent.point;return this.left?(i[0]-e[0])*(o[1]-e[1])-(o[0]-e[0])*(i[1]-e[1])>0:(o[0]-e[0])*(i[1]-e[1])-(i[0]-e[0])*(o[1]-e[1])>0}isAbove(e){return!this.isBelow(e)}isVertical(){return this.point[0]===this.otherEvent.point[0]}get inResult(){return this.resultTransition!==0}clone(){const e=new me(this.point,this.left,this.otherEvent,this.isSubject,this.type);return e.contourId=this.contourId,e.resultTransition=this.resultTransition,e.prevInResult=this.prevInResult,e.isExteriorRing=this.isExteriorRing,e.inOut=this.inOut,e.otherInOut=this.otherInOut,e}}function X(n,e){return n[0]===e[0]?n[1]===e[1]:!1}const K=11102230246251565e-32,V=134217729,ji=(3+8*K)*K;function mt(n,e,i,o,s){let r,a,l,c,u=e[0],d=o[0],h=0,p=0;d>u==d>-u?(r=u,u=e[++h]):(r=d,d=o[++p]);let f=0;if(h<n&&p<i)for(d>u==d>-u?(a=u+r,l=r-(a-u),u=e[++h]):(a=d+r,l=r-(a-d),d=o[++p]),r=a,l!==0&&(s[f++]=l);h<n&&p<i;)d>u==d>-u?(a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h]):(a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p]),r=a,l!==0&&(s[f++]=l);for(;h<n;)a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h],r=a,l!==0&&(s[f++]=l);for(;p<i;)a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p],r=a,l!==0&&(s[f++]=l);return(r!==0||f===0)&&(s[f++]=r),f}function Wi(n,e){let i=e[0];for(let o=1;o<n;o++)i+=e[o];return i}function Ue(n){return new Float64Array(n)}const qi=(3+16*K)*K,Bi=(2+12*K)*K,Xi=(9+64*K)*K*K,ue=Ue(4),Jt=Ue(8),Qt=Ue(12),en=Ue(16),F=Ue(4);function Yi(n,e,i,o,s,r,a){let l,c,u,d,h,p,f,y,v,g,w,x,b,E,P,I,z,C;const S=n-s,_=i-s,k=e-r,T=o-r;E=S*T,p=V*S,f=p-(p-S),y=S-f,p=V*T,v=p-(p-T),g=T-v,P=y*g-(E-f*v-y*v-f*g),I=k*_,p=V*k,f=p-(p-k),y=k-f,p=V*_,v=p-(p-_),g=_-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,ue[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,ue[1]=b-(w+h)+(h-I),C=x+w,h=C-x,ue[2]=x-(C-h)+(w-h),ue[3]=C;let D=Wi(4,ue),R=Bi*a;if(D>=R||-D>=R||(h=n-S,l=n-(S+h)+(h-s),h=i-_,u=i-(_+h)+(h-s),h=e-k,c=e-(k+h)+(h-r),h=o-T,d=o-(T+h)+(h-r),l===0&&c===0&&u===0&&d===0)||(R=Xi*a+ji*Math.abs(D),D+=S*d+T*l-(k*u+_*c),D>=R||-D>=R))return D;E=l*T,p=V*l,f=p-(p-l),y=l-f,p=V*T,v=p-(p-T),g=T-v,P=y*g-(E-f*v-y*v-f*g),I=c*_,p=V*c,f=p-(p-c),y=c-f,p=V*_,v=p-(p-_),g=_-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,F[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,F[1]=b-(w+h)+(h-I),C=x+w,h=C-x,F[2]=x-(C-h)+(w-h),F[3]=C;const L=mt(4,ue,4,F,Jt);E=S*d,p=V*S,f=p-(p-S),y=S-f,p=V*d,v=p-(p-d),g=d-v,P=y*g-(E-f*v-y*v-f*g),I=k*u,p=V*k,f=p-(p-k),y=k-f,p=V*u,v=p-(p-u),g=u-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,F[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,F[1]=b-(w+h)+(h-I),C=x+w,h=C-x,F[2]=x-(C-h)+(w-h),F[3]=C;const A=mt(L,Jt,4,F,Qt);E=l*d,p=V*l,f=p-(p-l),y=l-f,p=V*d,v=p-(p-d),g=d-v,P=y*g-(E-f*v-y*v-f*g),I=c*u,p=V*c,f=p-(p-c),y=c-f,p=V*u,v=p-(p-u),g=u-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,F[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,F[1]=b-(w+h)+(h-I),C=x+w,h=C-x,F[2]=x-(C-h)+(w-h),F[3]=C;const O=mt(A,Qt,4,F,en);return en[O-1]}function Ki(n,e,i,o,s,r){const a=(e-r)*(i-s),l=(n-s)*(o-r),c=a-l;if(a===0||l===0||a>0!=l>0)return c;const u=Math.abs(a+l);return Math.abs(c)>=qi*u?c:-Yi(n,e,i,o,s,r,u)}function At(n,e,i){const o=Ki(n[0],n[1],e[0],e[1],i[0],i[1]);return o>0?-1:o<0?1:0}function te(n,e){const i=n.point,o=e.point;return i[0]>o[0]?1:i[0]<o[0]?-1:i[1]!==o[1]?i[1]>o[1]?1:-1:Zi(n,e,i)}function Zi(n,e,i,o){return n.left!==e.left?n.left?1:-1:At(i,n.otherEvent.point,e.otherEvent.point)!==0?n.isBelow(e.otherEvent.point)?-1:1:!n.isSubject&&e.isSubject?1:-1}function ee(n,e,i){const o=new me(e,!1,n,n.isSubject),s=new me(e,!0,n.otherEvent,n.isSubject);return X(n.point,n.otherEvent.point)&&console.warn("what is that, a collapsed segment?",n),o.contourId=s.contourId=n.contourId,te(s,n.otherEvent)>0&&(n.otherEvent.left=!0,s.left=!1),n.otherEvent.otherEvent=s,n.otherEvent=o,i.push(s),i.push(o),i}function je(n,e){return n[0]*e[1]-n[1]*e[0]}function yt(n,e){return n[0]*e[0]+n[1]*e[1]}function Ji(n,e,i,o,s){const r=[e[0]-n[0],e[1]-n[1]],a=[o[0]-i[0],o[1]-i[1]];function l(g,w,x){return[g[0]+w*x[0],g[1]+w*x[1]]}const c=[i[0]-n[0],i[1]-n[1]];let u=je(r,a),d=u*u;const h=yt(r,r);if(d>0){const g=je(c,a)/u;if(g<0||g>1)return null;const w=je(c,r)/u;return w<0||w>1?null:g===0||g===1?[l(n,g,r)]:w===0||w===1?[l(i,w,a)]:[l(n,g,r)]}if(u=je(c,r),d=u*u,d>0)return null;const p=yt(r,c)/h,f=p+yt(r,a)/h,y=Math.min(p,f),v=Math.max(p,f);return y<=1&&v>=0?y===1?[l(n,y>0?y:0,r)]:v===0?[l(n,v<1?v:1,r)]:[l(n,y>0?y:0,r),l(n,v<1?v:1,r)]:null}function vt(n,e,i){const o=Ji(n.point,n.otherEvent.point,e.point,e.otherEvent.point),s=o?o.length:0;if(s===0||s===1&&(X(n.point,e.point)||X(n.otherEvent.point,e.otherEvent.point))||s===2&&n.isSubject===e.isSubject)return 0;if(s===1)return!X(n.point,o[0])&&!X(n.otherEvent.point,o[0])&&ee(n,o[0],i),!X(e.point,o[0])&&!X(e.otherEvent.point,o[0])&&ee(e,o[0],i),1;const r=[];let a=!1,l=!1;return X(n.point,e.point)?a=!0:te(n,e)===1?r.push(e,n):r.push(n,e),X(n.otherEvent.point,e.otherEvent.point)?l=!0:te(n.otherEvent,e.otherEvent)===1?r.push(e.otherEvent,n.otherEvent):r.push(n.otherEvent,e.otherEvent),a&&l||a?(e.type=An,n.type=e.inOut===n.inOut?Ln:On,a&&!l&&ee(r[1].otherEvent,r[0].point,i),2):l?(ee(r[0],r[1].point,i),3):r[0]!==r[3].otherEvent?(ee(r[0],r[1].point,i),ee(r[1],r[2].point,i),3):(ee(r[0],r[1].point,i),ee(r[3].otherEvent,r[2].point,i),3)}function Qi(n,e){if(n===e)return 0;if(At(n.point,n.otherEvent.point,e.point)!==0||At(n.point,n.otherEvent.point,e.otherEvent.point)!==0)return X(n.point,e.point)?n.isBelow(e.otherEvent.point)?-1:1:n.point[0]===e.point[0]?n.point[1]<e.point[1]?-1:1:te(n,e)===1?e.isAbove(n.point)?-1:1:n.isBelow(e.point)?-1:1;if(n.isSubject===e.isSubject){let i=n.point,o=e.point;if(i[0]===o[0]&&i[1]===o[1])return i=n.otherEvent.point,o=e.otherEvent.point,i[0]===o[0]&&i[1]===o[1]?0:n.contourId>e.contourId?1:-1}else return n.isSubject?-1:1;return te(n,e)===1?1:-1}function er(n,e,i,o,s,r){const a=new Ht(Qi),l=[],c=Math.min(o[2],s[2]);let u,d,h;for(;n.length!==0;){let p=n.pop();if(l.push(p),p.point[0]>c||r===nt)break;if(p.left){d=u=a.insert(p),h=a.minNode(),u!==h?u=a.prev(u):u=null,d=a.next(d);const f=u?u.key:null;let y;if(Ce(p,f,r),d&&vt(p,d.key,n)===2&&(Ce(p,f,r),Ce(d.key,p,r)),u&&vt(u.key,p,n)===2){let v=u;v!==h?v=a.prev(v):v=null,y=v?v.key:null,Ce(f,y,r),Ce(p,f,r)}}else p=p.otherEvent,d=u=a.find(p),u&&d&&(u!==h?u=a.prev(u):u=null,d=a.next(d),a.remove(p),d&&u&&vt(u.key,d.key,n))}return l}class tr{constructor(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null}isExterior(){return this.holeOf==null}}function nr(n){let e,i,o,s;const r=[];for(i=0,o=n.length;i<o;i++)e=n[i],(e.left&&e.inResult||!e.left&&e.otherEvent.inResult)&&r.push(e);let a=!1;for(;!a;)for(a=!0,i=0,o=r.length;i<o;i++)i+1<o&&te(r[i],r[i+1])===1&&(s=r[i],r[i]=r[i+1],r[i+1]=s,a=!1);for(i=0,o=r.length;i<o;i++)e=r[i],e.otherPos=i;for(i=0,o=r.length;i<o;i++)e=r[i],e.left||(s=e.otherPos,e.otherPos=e.otherEvent.otherPos,e.otherEvent.otherPos=s);return r}function ir(n,e,i,o){let s=n+1,r=e[n].point,a;const l=e.length;for(s<l&&(a=e[s].point);s<l&&a[0]===r[0]&&a[1]===r[1];){if(i[s])s++;else return s;s<l&&(a=e[s].point)}for(s=n-1;i[s]&&s>o;)s--;return s}function rr(n,e,i){const o=new tr;if(n.prevInResult!=null){const s=n.prevInResult,r=s.outputContourId;if(s.resultTransition>0){const l=e[r];if(l.holeOf!=null){const c=l.holeOf;e[c].holeIds.push(i),o.holeOf=c,o.depth=e[r].depth}else e[r].holeIds.push(i),o.holeOf=r,o.depth=e[r].depth+1}else o.holeOf=null,o.depth=e[r].depth}else o.holeOf=null,o.depth=0;return o}function or(n){let e,i;const o=nr(n),s={},r=[];for(e=0,i=o.length;e<i;e++){if(s[e])continue;const a=r.length,l=rr(o[e],r,a),c=p=>{s[p]=!0,p<o.length&&o[p]&&(o[p].outputContourId=a)};let u=e,d=e;const h=o[e].point;for(l.points.push(h);c(u),u=o[u].otherPos,c(u),l.points.push(o[u].point),u=ir(u,o,s,d),!(u==d||u>=o.length||!o[u]););r.push(l)}return r}var We={exports:{}},tn;function sr(){if(tn)return We.exports;tn=1,We.exports=n,We.exports.default=n;function n(i,o){if(!(this instanceof n))return new n(i,o);if(this.data=i||[],this.length=this.data.length,this.compare=o||e,this.length>0)for(var s=(this.length>>1)-1;s>=0;s--)this._down(s)}function e(i,o){return i<o?-1:i>o?1:0}return n.prototype={push:function(i){this.data.push(i),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var i=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),i}},peek:function(){return this.data[0]},_up:function(i){for(var o=this.data,s=this.compare,r=o[i];i>0;){var a=i-1>>1,l=o[a];if(s(r,l)>=0)break;o[i]=l,i=a}o[i]=r},_down:function(i){for(var o=this.data,s=this.compare,r=this.length>>1,a=o[i];i<r;){var l=(i<<1)+1,c=l+1,u=o[l];if(c<this.length&&s(o[c],u)<0&&(l=c,u=o[c]),s(u,a)>=0)break;o[i]=u,i=l}o[i]=a}},We.exports}var ar=sr();const lr=_n(ar),nn=Math.max,rn=Math.min;let qe=0;function on(n,e,i,o,s,r){let a,l,c,u,d,h;for(a=0,l=n.length-1;a<l;a++){if(c=n[a],u=n[a+1],d=new me(c,!1,void 0,e),h=new me(u,!1,d,e),d.otherEvent=h,c[0]===u[0]&&c[1]===u[1])continue;d.contourId=h.contourId=i,r||(d.isExteriorRing=!1,h.isExteriorRing=!1),te(d,h)>0?h.left=!0:d.left=!0;const p=c[0],f=c[1];s[0]=rn(s[0],p),s[1]=rn(s[1],f),s[2]=nn(s[2],p),s[3]=nn(s[3],f),o.push(d),o.push(h)}}function cr(n,e,i,o,s){const r=new lr(null,te);let a,l,c,u,d,h;for(c=0,u=n.length;c<u;c++)for(a=n[c],d=0,h=a.length;d<h;d++)l=d===0,l&&qe++,on(a[d],!0,qe,r,i,l);for(c=0,u=e.length;c<u;c++)for(a=e[c],d=0,h=a.length;d<h;d++)l=d===0,l&&qe++,on(a[d],!1,qe,r,o,l);return r}const it=[];function ur(n,e,i){let o=null;return n.length*e.length===0&&(o=it),o}function hr(n,e,i,o,s){let r=null;return(i[0]>o[2]||o[0]>i[2]||i[1]>o[3]||o[1]>i[3])&&(r=it),r}function dr(n,e,i){typeof n[0][0][0]=="number"&&(n=[n]),typeof e[0][0][0]=="number"&&(e=[e]);let o=ur(n,e);if(o)return o===it?null:o;const s=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],a=cr(n,e,s,r);if(o=hr(n,e,s,r),o)return o===it?null:o;const l=er(a,n,e,s,r,i),c=or(l),u=[];for(let d=0;d<c.length;d++){let h=c[d];if(h.isExterior()){let p=[h.points];for(let f=0;f<h.holeIds.length;f++){let y=h.holeIds[f];p.push(c[y].points)}u.push(p)}}return u}function pr(n,e){return dr(n,e,tt)}function fr(n,e){const i=n[0]-e[0],o=n[1]-e[1];return i*i+o*o}function gr(n){return{vertices:n.vertices,pieces:Array.from(n.pieces.entries()),edges:Array.from(n.edges.entries()),halfEdges:Array.from(n.halfEdges.entries()),boundary:n.boundary,borderPath:n.borderPath}}function $n(n,e){let[i,o]=n,[s,r]=n;const a=l=>{i=Math.min(i,l[0]),o=Math.min(o,l[1]),s=Math.max(s,l[0]),r=Math.max(r,l[1])};for(const l of e)l.type==="line"?a(l.p):(a(l.p1),a(l.p2),a(l.p3));return[i,o,s,r]}function Hn(n,e){let i=1/0,o=1/0,s=-1/0,r=-1/0;const a=n.halfEdge;let l=e.halfEdges.get(a);if(!l)return n.bounds;const c=u=>{i=Math.min(i,u[0]),o=Math.min(o,u[1]),s=Math.max(s,u[0]),r=Math.max(r,u[1])};do{if(c(l.origin),l.segments){const u=$n(l.origin,l.segments);c([u[0],u[1]]),c([u[2],u[3]])}l=e.halfEdges.get(l.next)}while(l&&l.id!==a);return[i,o,s,r]}function Lt(n){if(n.length===0)return[0,0,0,0];let e=n[0][0],i=n[0][1],o=e,s=i;for(let r=1;r<n.length;r++){const a=n[r];e=Math.min(e,a[0]),i=Math.min(i,a[1]),o=Math.max(o,a[0]),s=Math.max(s,a[1])}return[e,i,o,s]}function mr(n,e){return Math.abs(n[0]-e[0])<1e-6&&Math.abs(n[1]-e[1])<1e-6}function Vn(n,e,i,o){if(!n.tabs)return;const s=e.halfEdges.get(n.heLeft),r=e.halfEdges.get(n.heRight),a=s.origin,l=r.origin,c=[];let u=a;n.tabs.sort((d,h)=>d.position-h.position);for(const d of n.tabs){const h=d.position-d.size/2,p=[a[0]+(l[0]-a[0])*h,a[1]+(l[1]-a[1])*h];Math.hypot(p[0]-u[0],p[1]-u[1])>1e-6&&c.push({type:"line",p});const f=[a[0]+(l[0]-a[0])*(h+d.size),a[1]+(l[1]-a[1])*(h+d.size)],y=i.createTabSegments(p,f,d,o);c.push(...y),u=f}Math.hypot(l[0]-u[0],l[1]-u[1])>1e-6&&c.push({type:"line",p:l}),s.segments=c,r.segments=yr(c,a),n.bounds=$n(a,c)}function yr(n,e){const i=[];for(let o=n.length-1;o>=0;o--){const s=n[o];let r=e;if(o>0){const a=n[o-1];r=a.type==="line"?a.p:a.p3}s.type==="line"?i.push({type:"line",p:r}):i.push({type:"bezier",p1:s.p2,p2:s.p1,p3:r})}return i}function vr(n,e){const{p:i,radii:o,rotation:s,largeArc:r,sweep:a}=e,[l,c]=n,[u,d]=i,[h,p]=o;return Ui({px:l,py:c,cx:u,cy:d,rx:h,ry:p,xAxisRotation:s,largeArcFlag:r?1:0,sweepFlag:a?1:0}).map(v=>({type:"bezier",p1:[v.x1,v.y1],p2:[v.x2,v.y2],p3:[v.x,v.y]}))}function Un(n){const e=[];let i=[];if(n.length===0||n[0].type!=="move")return[];let o=[0,0];for(const s of n)switch(s.type){case"move":i.length>0&&e.push(i),o=s.p,i=[o];break;case"line":i.push(s.p),o=s.p;break;case"bezier":{const{p1:r,p2:a,p3:l}=s,u=new N([...o,...r,...a,...l]).getLUT(100);i.push(...u.slice(1).map(d=>[d.x,d.y])),o=l;break}case"arc":{const r=vr(o,s);let a=o;for(const l of r){const u=new N([...a,...l.p1,...l.p2,...l.p3]).getLUT(100);i.push(...u.slice(1).map(d=>[d.x,d.y])),a=l.p3}o=s.p;break}}return i.length>0&&e.push(i),e}function Vt(n,e,i){if(e.length>0&&e[0].type!=="move")throw new Error("Boundary path must start with a 'move' command.");const o=Un(e);let s=0;for(const r of o)xr(n,r)&&s++;return s%2===1}function wr(n){return Array.isArray(n[0])&&Array.isArray(n[0][0])&&typeof n[0][0][0]=="number"}function br(n,e){const i=[n.map(r=>[r[0],r[1]])],o=[e.map(r=>[r[0],r[1]])],s=pr(i,o);return!s||s.length===0?null:wr(s)?s:s.map(r=>r[0].map(a=>[a[0],a[1]]))}function xr(n,e){const[i,o]=n;let s=!1;for(let r=0,a=e.length-1;r<e.length;a=r++){const[l,c]=e[r],[u,d]=e[a];c>o!=d>o&&i<(u-l)*(o-c)/(d-c)+l&&(s=!s)}return s}function Pr(n,e,i){const o=[];for(const r of n)i.vertices.find(a=>mr(a,r))||i.vertices.push(r);for(const r of n){const a={id:Tn(),origin:r,twin:-1,next:-1,prev:-1,piece:e};o.push(a)}const s=o.length;for(let r=0;r<s;r++){const a=(r+1)%s,l=(r+s-1)%s;o[r].next=o[a].id,o[r].prev=o[l].id}return o.forEach(r=>i.halfEdges.set(r.id,r)),o}function Fn(n,e,i,o){const s=(a,l)=>`${a[0]},${a[1]}-${l[0]},${l[1]}`,r=n.length;for(let a=0;a<r;a++){const l=n[a],c=l.origin,u=e.halfEdges.get(l.next).origin,d=s(u,c),h=i.get(d),p=Tn();let f;if(h!==void 0){const y=e.halfEdges.get(h);l.twin=y.id,y.twin=l.id,f={id:p,heLeft:y.id,heRight:l.id,bounds:Lt([c,u])},i.delete(d)}else{const y=s(c,u);if(i.set(y,l.id),o(c,u))f={id:p,heLeft:l.id,heRight:-1,bounds:Lt([c,u])},e.boundary.push(p);else continue}e.edges.set(p,f)}}function Gn(n){return function(){let e=n+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}async function rt(n){return Ii("Puzzle Generation",()=>{const{bounds:e,pieceSize:i,border:o}=n,{pointConfig:s,pieceConfig:r,placementConfig:a,tabConfig:l}=n;console.log(`rebuilding puzzle with dimensions ${e.width}x${e.height}, piece size ${i}`);const c=$e.create(o,e,s),u=He.create(o,e,r),d=Ve.create(o,e,a),h=le.create(o,e,l),p=n.seed??new Date().getTime(),f=Gn(p),y=n.seedPoints??c.generatePoints({width:e.width,height:e.height,pieceSize:i,random:f,border:o});console.log(`${n.seedPoints?"Using":"Generated"} ${y.length} points`);const v=u.generatePieces(y,{random:f,pieceSize:i,border:o,bounds:e,customPieces:n.customPieces});if(console.log(`Generated ${v.pieces.size} pieces`),!n.skipTabs){d.placeTabs({topology:v,random:f});for(const w of v.edges.values())w.heRight!==-1&&w.tabs&&w.tabs.length>0&&Vn(w,v,h,f)}const g={created:new Date().toISOString(),seed:p,width:e.width,height:e.height,pieceSize:i,pointConfig:s,pieceConfig:r,placementConfig:a,tabConfig:l,seedPoints:y,vertices:v.vertices,boundary:v.boundary,borderPath:v.borderPath,pieces:v.pieces,edges:v.edges,halfEdges:v.halfEdges,customPieces:n.customPieces};return Promise.resolve(g)})}async function Cr(n,e,i){const o=[...n.seedPoints];let s=0;for(const r of n.pieces.values()){if(r.id===e){o[s]=i;break}s++}return rt({bounds:{width:n.width,height:n.height},border:n.borderPath,pieceSize:n.pieceSize,pointConfig:n.pointConfig,pieceConfig:n.pieceConfig,placementConfig:n.placementConfig,tabConfig:n.tabConfig,seed:n.seed,seedPoints:o,customPieces:n.customPieces,skipTabs:!1})}function Ot(n,e){return[{type:"move",p:[0,0]},{type:"line",p:[n,0]},{type:"line",p:[n,e]},{type:"line",p:[0,e]},{type:"line",p:[0,0]}]}function Sr(n){const e=n/2,i=e;return[{type:"move",p:[0,i]},{type:"arc",p:[n,i],radii:[e,e],rotation:0,largeArc:!1,sweep:!0},{type:"arc",p:[0,i],radii:[e,e],rotation:0,largeArc:!1,sweep:!0}]}function Ir(n,e){const i=n/2,o=e/2;return[{type:"move",p:[0,o]},{type:"arc",p:[n,o],radii:[i,o],rotation:0,largeArc:!1,sweep:!0},{type:"arc",p:[0,o],radii:[i,o],rotation:0,largeArc:!1,sweep:!0}]}function zr(n,e,i){const o=Math.min(n,e)/2,s=Math.min(i,o);return[{type:"move",p:[s,0]},{type:"line",p:[n-s,0]},{type:"arc",p:[n,s],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[n,e-s]},{type:"arc",p:[n-s,e],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[s,e]},{type:"arc",p:[0,e-s],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[0,s]},{type:"arc",p:[s,0],radii:[s,s],rotation:0,largeArc:!1,sweep:!0}]}function Er(n,e,i){if(e<0||e>=n.vertices.length){console.warn("moveVertex called with invalid vertex index:",e);return}const o=n.vertices[e];n.vertices[e]=i;const s=[];for(const l of n.halfEdges.values())l.origin[0]===o[0]&&l.origin[1]===o[1]&&s.push(l);const r=new Set,a=[i[0]-o[0],i[1]-o[1]];for(const l of s){l.origin=i,r.add(l.piece);const c=n.halfEdges.get(l.prev);if(c?.segments){const u=c.segments[c.segments.length-1];u.type==="line"?u.p=i:(u.p3=i,u.p1=[u.p1[0]+a[0],u.p1[1]+a[1]],u.p2=[u.p2[0]+a[0],u.p2[1]+a[1]]),r.add(c.piece)}}_r(n,e);for(const l of r){const c=n.pieces.get(l);c&&(c.bounds=Hn(c,n))}}function _r(n,e){const{seed:i,width:o,height:s,placementConfig:r,tabConfig:a}=n,l=Gn(i),c=Ot(o,s),u={width:o,height:s},d=Ve.create(c,u,r),h=le.create(c,u,a),p=new Set,f=n.vertices[e],y=new Map;for(const g of n.edges.values())y.set(g.heLeft,g),g.heRight!==-1&&y.set(g.heRight,g);for(const g of n.halfEdges.values()){const w=n.halfEdges.get(g.next)?.origin;if(g.origin===f||w===f){const E=y.get(g.id);E&&p.add(E)}}d.updateTabPlacements(Array.from(p),{topology:n,random:l});const v=new Set;for(const g of p)if(g.heRight!==-1){const x=n.halfEdges.get(g.heLeft);x&&(x.segments=void 0,v.add(n.pieces.get(x.piece)));const b=n.halfEdges.get(g.heRight);b&&(b.segments=void 0,v.add(n.pieces.get(b.piece))),Vn(g,n,h,l)}for(const g of v)g.bounds=Hn(g,n)}let Ee=null,_e=null,ke=null,Me=null,Te=null,re=null,pe=!1,ne=null;function kr(n,e){Ee=i=>{const o=i.target;o.tagName==="INPUT"||o.tagName==="WA-INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable||i.code==="Space"&&(i.preventDefault(),n.isSpacebarPressed||(n.isSpacebarPressed=!0,Be(n)))},_e=i=>{const o=i.target;o.tagName==="INPUT"||o.tagName==="WA-INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable||i.code==="Space"&&(n.isSpacebarPressed=!1,Be(n),i.preventDefault())},ke=i=>{if(i.preventDefault(),!n.paperCtx)return;const o=n.paperCtx.scope,s=-Math.sign(i.deltaY)*gi,r=Math.max(pi,Math.min(fi,n.zoom+s));if(r!==n.zoom){const a=new o.Point(i.offsetX,i.offsetY),l=o.view.viewToProject(a),c=r/n.zoom;o.view.scale(c,l),n.zoom=r,e&&e(r),m.redraw()}},Me=i=>{n.isSpacebarPressed&&(pe=!0,ne={x:i.clientX,y:i.clientY},Be(n),i.preventDefault())},Te=i=>{if(n.isSpacebarPressed&&i.preventDefault(),pe&&ne){if(!n.paperCtx)return;const o=n.paperCtx.scope,s=i.clientX-ne.x,r=i.clientY-ne.y,a=s/n.zoom,l=r/n.zoom;o.view.translate(new o.Point(a,l)),ne={x:i.clientX,y:i.clientY}}},re=()=>{pe&&(pe=!1,ne=null,Be(n))},window.addEventListener("keydown",Ee),window.addEventListener("keyup",_e),n.canvas&&(n.canvas.addEventListener("wheel",ke,{passive:!1}),n.canvas.addEventListener("mousedown",Me),n.canvas.addEventListener("mousemove",Te),n.canvas.addEventListener("mouseup",re),n.canvas.addEventListener("mouseleave",re))}function Mr(n){Ee&&(window.removeEventListener("keydown",Ee),Ee=null),_e&&(window.removeEventListener("keyup",_e),_e=null),n&&(ke&&(n.removeEventListener("wheel",ke),ke=null),Me&&(n.removeEventListener("mousedown",Me),Me=null),Te&&(n.removeEventListener("mousemove",Te),Te=null),re&&(n.removeEventListener("mouseup",re),n.removeEventListener("mouseleave",re),re=null)),pe=!1,ne=null}function Be(n){if(n.canvas){if(n.isSpacebarPressed){n.canvas.style.cursor=pe?"grabbing":"grab";return}if(n.isDragging){n.canvas.style.cursor="grabbing";return}n.canvas.style.cursor="default"}}function Ze(n,e){for(const i of n.children)if(i.data.vertexId===e)return i;return null}function ut(n,e,i){if(!i.paperCtx)return null;const o=i.paperCtx.scope,s=e.getBoundingClientRect();let r,a;if(n instanceof TouchEvent){if(n.changedTouches.length===0)return null;const c=n.changedTouches[0];r=c.clientX,a=c.clientY}else r=n.clientX,a=n.clientY;const l=new o.Point(r-s.left,a-s.top);return o.view.viewToProject(l)}function ot(n){return[n.x,n.y]}function sn(n,e,i,o){const s=[...n.puzzle.seedPoints];let r=0;for(const a of n.puzzle.pieces.values()){if(a.id===i){s[r]=o;break}r++}rt({bounds:{width:n.puzzle.width,height:n.puzzle.height},border:n.puzzle.borderPath,pieceSize:n.puzzle.pieceSize,pointConfig:n.puzzle.pointConfig,pieceConfig:n.puzzle.pieceConfig,placementConfig:n.puzzle.placementConfig,tabConfig:n.puzzle.tabConfig,seed:n.puzzle.seed,seedPoints:s,skipTabs:!0}).then(a=>{e.draggedSeedPointId===i&&et(e,a,n.color,n.pointColor)}).catch(a=>{console.error("Failed to regenerate preview:",a)})}function Tr(n,e,i){if(n.redraw=!1,i.isDragging||i.isSpacebarPressed||!i.canvas)return;const o=ut(n,i.canvas,i);if(!o)return;let s=!1;const r=ot(o);if(i.vertexItems){let a=-1,l=di;const c=Mn(e.puzzle);for(let u=0;u<e.puzzle.vertices.length;u++){if(c.has(u))continue;const d=fr(e.puzzle.vertices[u],r);d<l&&(l=d,a=u)}if(a>=0){if(i.hoveredVertexId!==a){if(i.hoveredVertexId>=0){const d=Ze(i.vertexItems,i.hoveredVertexId);d&&(d.visible=!1)}const u=Ze(i.vertexItems,a);u&&(u.visible=!0,i.hoveredVertexId=a)}s=!0}else if(i.hoveredVertexId>=0){const u=Ze(i.vertexItems,i.hoveredVertexId);u&&(u.visible=!1,i.hoveredVertexId=-1)}}e.pointColor&&i.seedPointItems&&i.seedPointItems.hitTest(o,{fill:!0,tolerance:5})&&(s=!0),i.canvas.style.cursor=s?"grab":"default"}function an(n,e,i){if(n.redraw=!1,!i.canvas||i.isSpacebarPressed)return;if(n instanceof TouchEvent&&n.touches.length>1){i.isDragging=!1,i.draggedVertexId=-1,i.draggedSeedPointId=-1;return}if(n instanceof MouseEvent&&n.button!==0)return;const o=ut(n,i.canvas,i);if(o){if(e.pointColor&&i.seedPointItems){const s=i.seedPointItems.hitTest(o,{fill:!0,tolerance:5});if(s?.item.data.pieceId!==void 0){i.draggedSeedPointId=s.item.data.pieceId,i.isDragging=!1,n instanceof MouseEvent&&(i.documentMouseMove=r=>{const a=r;a.redraw=!1,st(a,e,i)},i.documentMouseUp=r=>{const a=r;a.redraw=!1,De(a,e,i)},document.addEventListener("mousemove",i.documentMouseMove),document.addEventListener("mouseup",i.documentMouseUp));return}}if(i.vertexItems){const s=i.vertexItems.hitTest(o,{fill:!0,tolerance:8});if(s?.item.data.vertexId!==void 0){i.draggedVertexId=s.item.data.vertexId,i.isDragging=!1,n instanceof MouseEvent&&(i.documentMouseMove=r=>{const a=r;a.redraw=!1,st(a,e,i)},i.documentMouseUp=r=>{const a=r;a.redraw=!1,De(a,e,i)},document.addEventListener("mousemove",i.documentMouseMove),document.addEventListener("mouseup",i.documentMouseUp));return}}}}function st(n,e,i){if(n.redraw=!1,!i.canvas)return;const o=ut(n,i.canvas,i);if(o){if(i.draggedVertexId>=0){i.isDragging=!0,n.preventDefault(),i.canvas.style.cursor="grabbing";const s=ot(o);if(Er(e.puzzle,i.draggedVertexId,s),i.vertexItems){const r=Ze(i.vertexItems,i.draggedVertexId);r&&(r.position=o)}et(i,e.puzzle,e.color,e.pointColor);return}if(i.draggedSeedPointId>=0){i.isDragging=!0,n.preventDefault(),i.canvas.style.cursor="grabbing";const s=ot(o),r=performance.now();if(r-i.lastRegenerationTime<Wt){i.pendingRegeneration&&clearTimeout(i.pendingRegeneration),i.pendingRegeneration=window.setTimeout(()=>{sn(e,i,i.draggedSeedPointId,s)},Wt);return}i.lastRegenerationTime=r,sn(e,i,i.draggedSeedPointId,s)}}}function De(n,e,i){if(n.redraw=!1,!i.canvas)return;i.pendingRegeneration&&(clearTimeout(i.pendingRegeneration),i.pendingRegeneration=null);const o=i.draggedVertexId>=0&&i.isDragging,s=i.draggedSeedPointId>=0&&i.isDragging;if(o&&(n.preventDefault(),e.onPuzzleChanged(e.puzzle)),s){n.preventDefault();const r=i.draggedSeedPointId,a=ut(n,i.canvas,i);if(a&&e.onSeedPointMoved){const l=ot(a);e.onSeedPointMoved(r,l)}}i.documentMouseMove&&(document.removeEventListener("mousemove",i.documentMouseMove),i.documentMouseMove=null),i.documentMouseUp&&(document.removeEventListener("mouseup",i.documentMouseUp),i.documentMouseUp=null),i.isDragging=!1,i.draggedVertexId=-1,i.draggedSeedPointId=-1,i.canvas.style.cursor="default"}const Dr=()=>{const n={canvas:null,isDragging:!1,draggedVertexId:-1,draggedSeedPointId:-1,lastRegenerationTime:0,pendingRegeneration:null,documentMouseMove:null,documentMouseUp:null,paperCtx:null,backgroundRaster:null,paperPath:null,seedPointItems:null,problemItems:null,vertexItems:null,hoveredVertexId:-1,selectedPieceId:-1,zoom:dt,isSpacebarPressed:!1},e=(r,a)=>{if(r===n.zoom||!n.paperCtx)return;const l=n.paperCtx.scope,c=r/n.zoom;l.view.scale(c,l.view.center),n.zoom=r,a?.onZoomChanged&&a.onZoomChanged(r),m.redraw()},i=()=>{if(!n.paperCtx)return;const r=n.paperCtx.scope,a=dt/n.zoom;r.view.scale(a,r.view.center),n.zoom=dt,r.view.center=new r.Point(r.view.viewSize.width/2,r.view.viewSize.height/2),m.redraw()},o=()=>`${Math.round(n.zoom*100)}%`;let s;return{oncreate:({dom:r,attrs:a})=>{if(n.canvas=r.querySelector("canvas.puzzle-renderer"),!n.canvas){console.error("PuzzleRenderer: couldn't get canvas element");return}zi(n.canvas,a.width,a.height,n),Ei(n),kr(n,a.onZoomChanged),Bt(n,a.imageUrl,a.width,a.height),s=a.imageUrl,a.isDirty||et(n,a.puzzle,a.color,a.pointColor)},onupdate:({attrs:r})=>{if(!n.canvas){console.error("PuzzleRenderer: couldn't get canvas element");return}r.imageUrl!==s&&(Bt(n,r.imageUrl,r.width,r.height),s=r.imageUrl),r.isDirty||et(n,r.puzzle,r.color,r.pointColor)},onremove:()=>{n.documentMouseMove&&(document.removeEventListener("mousemove",n.documentMouseMove),n.documentMouseMove=null),n.documentMouseUp&&(document.removeEventListener("mouseup",n.documentMouseUp),n.documentMouseUp=null),Mr(n.canvas),ki(n)},view:({attrs:r})=>{const a=o();return m(".puzzle-renderer-wrapper",[m("canvas.puzzle-renderer",{key:"puzzle-renderer-canvas",width:r.width,height:r.height,style:{width:`${r.width}px`,height:`${r.height}px`,touchAction:"manipulation"},onmousedown:l=>an(l,r,n),onmousemove:l=>{Tr(l,r,n),st(l,r,n)},onmouseup:l=>De(l,r,n),ontouchstart:l=>an(l,r,n),ontouchmove:l=>st(l,r,n),ontouchend:l=>De(l,r,n),ontouchcancel:l=>De(l,r,n)}),m(".puzzle-renderer-controls",{key:"puzzle-renderer-controls"},[m("wa-dropdown.zoom-control",{"onwa-select":l=>{l.redraw=!1;const c=l.detail.item.value;if(c&&typeof c=="string"){const u=parseFloat(c);isNaN(u)||e(u,r)}}},[m("wa-button",{slot:"trigger","with-caret":!0,size:"small",value:n.zoom},a),...mi.map((l,c)=>m("wa-dropdown-item",{type:"checkbox",checked:n.zoom==l?!0:void 0,value:l.toString()},yi[c]))]),m("wa-tooltip",{for:"recenter-button"},"Recenter view"),m("wa-button#recenter-button",{appearance:"plain",size:"large",onclick:()=>{i()}},m("wa-icon",{library:"material",name:"recenter",label:"Recenter view"}))])])}}};function Rr(n,e,i,o="black"){const r=[];for(const c of n.edges.values()){const u=n.halfEdges.get(c.heLeft);if(u)if(r.push(`M ${u.origin[0].toFixed(3)} ${u.origin[1].toFixed(3)}`),u.segments)for(const d of u.segments)switch(d.type){case"bezier":r.push(`C ${d.p1[0].toFixed(3)} ${d.p1[1].toFixed(3)}, ${d.p2[0].toFixed(3)} ${d.p2[1].toFixed(3)}, ${d.p3[0].toFixed(3)} ${d.p3[1].toFixed(3)}`);break;case"line":r.push(`L ${d.p[0].toFixed(3)} ${d.p[1].toFixed(3)}`);break}else{let d;u.twin!==-1?d=n.halfEdges.get(u.twin).origin:d=n.halfEdges.get(u.next).origin,r.push(`L ${d[0].toFixed(3)} ${d[1].toFixed(3)}`)}}const a=r.join(" ");return`
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg
  width="${e}"
  height="${i}"
  viewBox="0 0 ${e} ${i}"
  xmlns="http://www.w3.org/2000/svg"
  version="1.1"
>
  <path
    d="${a}"
    fill="none"
    stroke="${o}"
    stroke-width="1"
    vector-effect="non-scaling-stroke"
  />
</svg>`.trim().replace(/\r\n/g,`
`)}function Ar(n,e="puzzle.svg"){const i=new Blob([n],{type:"image/svg+xml"}),o=URL.createObjectURL(i),s=document.createElement("a");s.href=o,s.download=e,s.hidden=!0,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(o),100)}const Lr={view:({attrs:n})=>m("wa-button.download-svg",{size:"small",onclick:()=>{const e=Rr(n.puzzle,n.width,n.height,n.color);Ar(e,n.filename??"puzzle.svg")}},"Download SVG")},Or={view:({attrs:n})=>{const e=n.progressPercent!==void 0&&n.progressPercent<100,i=!e&&n.problems!==void 0&&n.problems==0,o=!e&&n.problems!==void 0&&n.problems>0;return m(".geometry-check-indicator",[m(".label","Geometry Check:"),m("wa-tooltip",{for:"check-geometry-now"},"Check geometry now"),m("wa-button#check-geometry-now",{variant:"neutral",appearance:"plain",size:"small",disabled:e,onclick:s=>{s.redraw=!1,n.onCheckRequested?.()}},m("wa-icon",{library:"material",name:"editor_choice",label:"Check geometry now"})),m("wa-tooltip",{for:"auto-check-geometry"},"Check geometry after every change"),m("wa-checkbox#auto-check-geometry",{checked:n.autoCheck,disabled:e,size:"small",onchange:s=>{s.redraw=!1;const r=s.target;n.onAutocheckChanged?.(r.checked)}},"auto check"),e&&m("wa-progress-bar",{label:"Geometry check progress",value:n.progressPercent??0}),i&&m("wa-badge",{variant:"success",pill:!0},"OK"),o&&m("wa-badge",{variant:"danger",pill:!0},`${n.problems} issue${n.problems===1?"":"s"}`)])}};function Nr(n,e,i=800){if(n<=i)return{width:n,height:e};const o=e/n;return{width:i,height:Math.round(i*o)}}const $r=()=>{const n={inputElement:void 0,imageLoaded:!1,imageName:""};return{view:({attrs:e})=>[m("wa-button.upload-button",{size:"small",disabled:e.disabled===!0,onclick:()=>{n.inputElement&&n.inputElement.click()}},e.label??"Upload Image"),m("input[type=file]",{style:{display:"none"},accept:"image/*",oncreate:({dom:i})=>{n.inputElement=i},onchange:i=>{if(i.redraw=!1,n.inputElement){const o=n.inputElement.files?.[0];o?.type.startsWith("image/")&&createImageBitmap(o).then(s=>{const{width:r,height:a}=Nr(s.width,s.height),l=URL.createObjectURL(o);s.close(),n.imageName=o.name,e.onUpload(l,o.name,r,a),n.imageLoaded=!0}).catch(s=>{console.error("could not create a bitmap image: ",s)})}}}),m("span.background-image-label",n.imageName),n.imageLoaded&&m("wa-icon.clear-button",{library:"material",name:"close",label:"Clear background image",onclick:i=>{i.redraw=!1,!e.disabled&&(n.imageName="",n.imageLoaded=!1,e.onClear())}},"Clear")]}},jn=()=>({view:({attrs:n})=>m("wa-checkbox.boolean-input",{hint:n.config.helpText,disabled:n.disabled,checked:n.value,onchange:e=>{const o=e.target.checked;n.onChange(o)}},n.config.label)}),Je=()=>({view:({attrs:n})=>m("wa-input.number-input",{label:n.config.label,hint:n.config.helpText,type:"number",inputmode:"numeric",size:"small",disabled:n.disabled,value:n.value,min:n.config.min,max:n.config.max,onchange:e=>{const i=e.target,o=parseFloat(i.value??"");n.onChange(isNaN(o)?void 0:o)}})}),Hr=()=>({view:({attrs:n})=>m("wa-slider.range-input",{label:n.config.label,hint:n.config.helpText,disabled:n.disabled,value:n.value,min:n.config.min,max:n.config.max,step:n.config.step,"with-tooltip":!0,onchange:e=>{const o=e.target.value;n.onChange(isNaN(o)?void 0:o)}})}),Wn=()=>({view:({attrs:n})=>m("wa-input.string-input",{label:n.config.label,hint:n.config.helpText,type:"text",size:"small",disabled:n.disabled,value:n.value,oninput:e=>{e.redraw=!1;const o=e.target.value??"";n.onChange(o.length>0?o:void 0)}})}),Vr=()=>({view:({attrs:n})=>{const e=n.registry.getAvailableGenerators();return m(".generator-picker",m("wa-tab-group",{active:n.generator,"onwa-tab-show":i=>{const o=i.detail.name;n.generator!==o&&n.onGeneratorChange(o)}},[...e.map(i=>{const o=n.registry.getUIMetadata(i.name),s=m("wa-tab",{panel:i.name},i.displayName),r=m("wa-tab-panel",{name:i.name},m(".controls",[o?.description?m("p",o.description):null,...o?.controls.map(a=>{switch(a.type){case"range":return m(Hr,{config:a,value:n.config?.[a.name]??a.defaultValue,onChange:l=>{n.onConfigChange(a.name,l)}});case"boolean":return m(jn,{config:a,value:(n.config?.[a.name]??a.defaultValue)===!0,onChange:l=>{n.onConfigChange(a.name,l)}});case"number":return m(Je,{config:a,value:n.config?.[a.name]??a.defaultValue,onChange:l=>{n.onConfigChange(a.name,l)}});case"string":return m(Wn,{config:a,value:n.config?.[a.name]??a.defaultValue,onChange:l=>{n.onConfigChange(a.name,l)}})}})??[],!o?.description&&o?.controls.length==0?m("p","No controls for this strategy."):null]));return[s,r]})]))}}),ln=[["Square","1:1",1],["Classic Photo","5:4",5/4],["Standard Photo","4:3",4/3],["35mm/DSLR","3:2",3/2],["Widescreen","16:9",16/9],["UltraWide","21:9",21/9],["Panorama","2:1",2/1],["Instagram Portrait","4:5",4/5],["Classic Portrait","3:4",3/4],["DSLR Portrait","2:3",2/3],["Phone Portrait","9:16",9/16],["Tall Poster","9:21",9/21],["Tall Panorama","1:2",1/2]],Ur={view:({attrs:n})=>{const e=!ln.some(([,,o])=>o===n.ratio),i=ln.map(([o,s,r])=>m("wa-option",{value:String(r)},`${o} [${s}]`));return e&&i.unshift(m("wa-option",{value:"custom"},"Custom")),m(".aspect-ratio-picker",[m("wa-select",{label:"Aspect Ratio",size:"small",disabled:n.disabled,value:e?"custom":String(n.ratio),onchange:o=>{o.redraw=!1;const r=o.target.value;r&&r!=="custom"&&n.onChange(Number(r))}},i),m("wa-slider",{min:.25,max:4,step:.01,"with-tooltip":!0,size:"small",disabled:n.disabled,value:n.ratio,onchange:o=>{o.redraw=!1;const s=o.target;n.onChange(s.value)}})])}},cn={view:({attrs:n})=>m("wa-color-picker",{label:n.label,value:n.color,size:n.size??"medium",format:"rgb",onchange:e=>{e.redraw=!1;const i=e.target;n.onUpdate(i.value??"")}})},Fr=[["rectangle","Rectangle"],["circle","Circle"],["ellipse","Ellipse"],["rounded-rect","Rounded Rectangle"]],Gr={view:({attrs:n})=>{const e=Fr.map(([i,o])=>m("wa-option",{value:i},o));return m("wa-select",{label:"Border Shape",size:"small",disabled:n.disabled,value:n.shape,onchange:i=>{i.redraw=!1;const s=i.target.value;s&&n.onChange(s)}},e)}},oe=10,wt="#2196F3",un=2,jr="#999999",Wr=1,qr=[4,4],hn=.5,Br=15,Xr=10,Yr="#4CAF50",Kr=2,Zr=.1,Jr=10,bt=1,Qr=.025,eo=[.25,.5,1,2,4],to=["25%","50%","100%","200%","400%"];let Re=null,Ae=null,Le=null,Oe=null,Ne=null,se=null,fe=!1,ie=null;function no(n,e,i){if(!n.paperCtx)throw new Error("PathEditor: Cannot setup mouse handling - Paper.js context not initialized");const o=j(n.paperCtx,"PathEditor:setupTool",()=>{const s=n.paperCtx.scope;return new s.Tool});return Re=s=>{const r=s.target;r.tagName==="INPUT"||r.tagName==="WA-INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable||(s.code==="Space"?(s.preventDefault(),n.isSpacebarPressed||(n.isSpacebarPressed=!0,B(n))):s.key==="Shift"&&!n.isShiftPressed?(n.isShiftPressed=!0,B(n)):(s.code==="Delete"||s.code==="Backspace")&&(n.mode==="edit"&&n.selectedSegment&&n.path&&n.paperCtx&&n.path.segments.length>2&&(n.selectedSegment.remove(),n.selectedSegment=null,n.selectedHandle=null,j(n.paperCtx,"PathEditor:deleteSegment",()=>{e()})),s.preventDefault()))},Ae=s=>{const r=s.target;r.tagName==="INPUT"||r.tagName==="WA-INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable||(s.code==="Space"?(n.isSpacebarPressed=!1,B(n),s.preventDefault()):s.key==="Shift"&&(n.isShiftPressed=!1,B(n)))},Le=s=>{if(s.preventDefault(),!n.paperCtx)return;const r=n.paperCtx.scope,a=-Math.sign(s.deltaY)*Qr,l=Math.max(Zr,Math.min(Jr,n.zoom+a));if(l!==n.zoom){const c=new r.Point(s.offsetX,s.offsetY),u=r.view.viewToProject(c),d=l/n.zoom;r.view.scale(d,u),n.zoom=l,i()}},Oe=s=>{n.isSpacebarPressed&&(fe=!0,ie={x:s.clientX,y:s.clientY},B(n),s.preventDefault())},Ne=s=>{if(n.isSpacebarPressed&&s.preventDefault(),fe&&ie){if(!n.paperCtx)return;const r=n.paperCtx.scope,a=s.clientX-ie.x,l=s.clientY-ie.y,c=a/n.zoom,u=l/n.zoom;r.view.translate(new r.Point(c,u)),ie={x:s.clientX,y:s.clientY}}},se=()=>{fe&&(fe=!1,ie=null,B(n))},window.addEventListener("keydown",Re),window.addEventListener("keyup",Ae),n.canvas&&(n.canvas.addEventListener("wheel",Le,{passive:!1}),n.canvas.addEventListener("mousedown",Oe),n.canvas.addEventListener("mousemove",Ne),n.canvas.addEventListener("mouseup",se),n.canvas.addEventListener("mouseleave",se)),o.onMouseDown=s=>{n.isSpacebarPressed||(n.mode==="draw"?ro(n,s,e):so(n,s))},o.onMouseDrag=s=>{n.isSpacebarPressed||(n.mode==="draw"?oo(n,s):ao(n,s))},o.onMouseUp=()=>{n.isSpacebarPressed||(n.mode==="draw"?n.pendingPoint&&n.path&&n.paperCtx&&(j(n.paperCtx,"PathEditor:onMouseUp",()=>{const s=n.paperCtx.scope;if(n.isDraggingCurve&&n.previewPath&&n.previewPath.segments.length>0){const r=n.previewPath.lastSegment,a=new s.Segment(n.pendingPoint,r.handleIn,r.handleOut);if(n.path.add(a),n.path.segments.length>1&&n.previewPath.segments.length>1){const l=n.path.segments[n.path.segments.length-2],c=n.previewPath.segments[0];l.handleOut=c.handleOut}}else n.path.add(n.pendingPoint);n.pendingPoint=null,n.isDraggingCurve=!1,n.previewPath&&(n.previewPath.removeSegments(),n.previewPath.visible=!1),e()}),B(n)):n.paperCtx&&j(n.paperCtx,"PathEditor:onMouseUp-editMode",()=>{e()}))},o.onMouseMove=s=>{n.isSpacebarPressed||(n.mode==="draw"?qn(n,s.point):n.mode==="edit"&&B(n,s.point))},o.activate(),o}function io(n){Re&&(window.removeEventListener("keydown",Re),Re=null),Ae&&(window.removeEventListener("keyup",Ae),Ae=null),n&&(Le&&(n.removeEventListener("wheel",Le),Le=null),Oe&&(n.removeEventListener("mousedown",Oe),Oe=null),Ne&&(n.removeEventListener("mousemove",Ne),Ne=null),se&&(n.removeEventListener("mouseup",se),n.removeEventListener("mouseleave",se),se=null)),fe=!1,ie=null}function B(n,e){if(n.canvas){if(n.isSpacebarPressed){n.canvas.style.cursor=fe?"grabbing":"grab";return}if(n.mode==="draw"){n.isNearFirstPoint?n.canvas.style.cursor="copy":n.canvas.style.cursor="crosshair";return}if(n.mode==="edit"){if(n.isShiftPressed){n.canvas.style.cursor="crosshair";return}if(e&&n.path){if(n.selectedSegment!==null||n.path.fullySelected){const r=n.path.hitTest(e,{handles:!0,tolerance:oe});if(r?.type==="handle-in"||r?.type==="handle-out"){n.canvas.style.cursor="pointer";return}}if(n.path.hitTest(e,{segments:!0,tolerance:oe})?.segment){n.canvas.style.cursor="move";return}if(n.path.hitTest(e,{stroke:!0,tolerance:oe})){n.canvas.style.cursor="pointer";return}}}n.canvas.style.cursor="default"}}function ro(n,e,i){if(!(!n.path||!n.paperCtx)){if(n.isNearFirstPoint&&n.path.segments.length>=2){n.path.closed=!0,n.snapIndicator&&(n.snapIndicator.visible=!1),n.mode="edit",n.isNearFirstPoint=!1,n.previewPath&&(n.previewPath.removeSegments(),n.previewPath.visible=!1),j(n.paperCtx,"PathEditor:closePathBySnapping",()=>{i()});return}n.path.segments.length>0&&j(n.paperCtx,"PathEditor:handleDrawModeDown",()=>{const o=n.paperCtx.scope,s=n.path.lastSegment;s.handleOut&&s.handleOut.length>0&&(s.handleOut=new o.Point(0,0))}),n.pendingPoint=e.point.clone(),n.isDraggingCurve=!1,qn(n,e.point)}}function oo(n,e){!n.path||!n.previewPath||!n.pendingPoint||!n.paperCtx||j(n.paperCtx,"PathEditor:handleDrawModeDrag",()=>{const i=n.paperCtx.scope;n.isDraggingCurve=!0;const o=n.pendingPoint,s=e.point.subtract(o),r=s.multiply(hn),a=s.multiply(-hn);let l=new i.Point(0,0);if(n.path.segments.length>0){const c=n.path.lastSegment,u=o.subtract(c.point);if(n.path.segments.length>1)if(c.handleIn&&c.handleIn.length>0){const f=c.handleIn.normalize(),y=u.length;l=f.multiply(-y)}else if(n.path.segments.length>1){const f=n.path.segments[n.path.segments.length-2];l=c.point.subtract(f.point).multiply(.33)}else l=u.multiply(.33);n.previewPath.removeSegments();const d=new i.Segment(c.point,new i.Point(0,0),l);n.previewPath.add(d);const h=new i.Segment(o,a,r);n.previewPath.add(h),n.previewPath.visible=!0}else{n.previewPath.removeSegments();const c=new i.Segment(o,a,r);n.previewPath.add(c),n.previewPath.visible=!0}})}function qn(n,e){!n.previewPath||!n.path||!n.paperCtx||j(n.paperCtx,"PathEditor:updatePreviewPath",()=>{const i=n.paperCtx.scope;if(n.previewPath.removeSegments(),n.isNearFirstPoint=!1,n.snapIndicator&&(n.snapIndicator.visible=!1),n.path.segments.length>0){const o=n.path.lastSegment.point;if(n.path.segments.length>=2){const s=n.path.firstSegment.point;if(e.getDistance(s)<Br){n.isNearFirstPoint=!0,n.previewPath.moveTo(o),n.previewPath.lineTo(s),n.previewPath.visible=!0,n.snapIndicator?(n.snapIndicator.position=s,n.snapIndicator.visible=!0):n.snapIndicator=new i.Path.Circle({center:s,radius:Xr,strokeColor:new i.Color(Yr),strokeWidth:Kr,fillColor:null}),B(n);return}}n.previewPath.moveTo(o),n.previewPath.lineTo(e),n.previewPath.visible=!0,B(n)}else n.previewPath.visible=!1,B(n)})}function so(n,e){if(!n.path)return;if(n.isShiftPressed){const r=n.path.hitTest(e.point,{stroke:!0,tolerance:oe});if(r?.location){const a=r.location,l=n.path.insert(a.index+1,a.point);for(const c of n.path.segments)c.selected=!1;l.selected=!0,n.selectedSegment=l,n.selectedHandle=null,n.path.fullySelected=!1;return}return}if(n.selectedSegment!==null||n.path.fullySelected){const r=n.path.hitTest(e.point,{handles:!0,tolerance:oe});if(r?.type==="handle-in"||r?.type==="handle-out"){n.selectedHandle={segment:r.segment,type:r.type==="handle-in"?"handleIn":"handleOut"},n.selectedSegment=null;return}}const o=n.path.hitTest(e.point,{segments:!0,tolerance:oe});if(o?.segment){for(const r of n.path.segments)r.selected=!1;n.selectedSegment=o.segment,n.selectedSegment.selected=!0,n.selectedHandle=null;return}if(n.path.hitTest(e.point,{stroke:!0,tolerance:oe})){n.path.fullySelected=!0,n.selectedSegment=null,n.selectedHandle=null;return}n.selectedSegment=null,n.selectedHandle=null,n.path.selected=!1,n.path.fullySelected=!1;for(const r of n.path.segments)r.selected=!1}function ao(n,e){if(n.selectedSegment)n.selectedSegment.point=n.selectedSegment.point.add(e.delta);else if(n.selectedHandle){const{segment:i,type:o}=n.selectedHandle,s=e.point.subtract(i.point);o==="handleOut"?i.handleOut=s:i.handleIn=s}}const Bn=()=>{const n={canvas:null,paperCtx:null,path:null,previewPath:null,mode:"draw",selectedSegment:null,selectedHandle:null,zoom:bt,isSpacebarPressed:!1,isShiftPressed:!1,pendingPoint:null,isDraggingCurve:!1,isNearFirstPoint:!1,snapIndicator:null};let e=null,i;const o=(u,d)=>{if(n.paperCtx=kn(u,d.width,d.height),n.canvas=u,!n.paperCtx){console.error("PathEditor: Failed to create Paper.js context");return}j(n.paperCtx,"PathEditor:initializePaper",()=>{const h=n.paperCtx.scope;if(!Qe(h,"PathEditor:initializePaper")){console.error("PathEditor: Paper.js not ready - canvas may have been replaced");return}h.settings.handleSize=8;const p=d.initialPath&&d.initialPath.length>0;if(n.mode=p?"edit":"draw",n.path=new h.Path,n.path.strokeColor=new h.Color(d.strokeColor??wt),n.path.strokeWidth=un,p&&d.initialPath){const f=Mt(d.initialPath,n.paperCtx);n.path.segments=f.segments,n.path.strokeColor=new h.Color(d.strokeColor??wt),n.path.strokeWidth=un}n.previewPath=new h.Path,n.previewPath.strokeColor=new h.Color(jr),n.previewPath.strokeWidth=Wr,n.previewPath.dashArray=qr,n.previewPath.visible=!1,e=no(n,()=>{s(d)},()=>{m.redraw()})})},s=u=>{if(n.path){const d=vi(n.path);u.onPathChanged(d)}m.redraw()},r=u=>{n.mode==="draw"&&(n.mode="edit",n.pendingPoint=null,n.isDraggingCurve=!1,n.isNearFirstPoint=!1,n.previewPath&&(n.previewPath.removeSegments(),n.previewPath.visible=!1),n.snapIndicator&&(n.snapIndicator.visible=!1),s(u))},a=()=>{e&&(e.remove(),e=null),io(n.canvas),n.paperCtx&&n.paperCtx.scope.project.remove(),n.canvas=null,n.paperCtx=null,n.path=null,n.previewPath=null,n.snapIndicator=null,n.selectedSegment=null,n.selectedHandle=null},l=u=>{if(u===n.zoom||!n.paperCtx)return;const d=n.paperCtx.scope,h=u/n.zoom;d.view.scale(h,d.view.center),n.zoom=u,m.redraw()},c=()=>`${Math.round(n.zoom*100)}%`;return{oncreate:({dom:u,attrs:d})=>{const h=u.querySelector("canvas");h&&(o(h,d),i=d.initialPath)},onremove:()=>{a()},onupdate:({attrs:u})=>{if(!n.path||!n.paperCtx||(u.strokeColor&&(n.path.strokeColor=new n.paperCtx.scope.Color(u.strokeColor)),u.initialPath===i))return;const d=i?.length??0,h=u.initialPath?.length??0;if(i=u.initialPath,d===h)return;u.initialPath&&u.initialPath.length>0?u.initialPath&&n.paperCtx&&j(n.paperCtx,"PathEditor:onupdate-loadPath",()=>{const f=n.paperCtx.scope;if(!Qe(f,"PathEditor:onupdate-loadPath")){console.error("PathEditor: Paper.js not ready during path reload - canvas may have been replaced");return}n.path.removeSegments();const y=Mt(u.initialPath,n.paperCtx);n.path.segments=y.segments,n.path.strokeColor=new f.Color(u.strokeColor??wt),n.mode="edit",n.selectedSegment=null,n.selectedHandle=null,n.pendingPoint=null,n.isDraggingCurve=!1,n.isNearFirstPoint=!1,n.snapIndicator&&(n.snapIndicator.visible=!1),m.redraw()}):(n.path.removeSegments(),n.mode="draw",n.selectedSegment=null,n.selectedHandle=null,n.pendingPoint=null,n.isDraggingCurve=!1,n.isNearFirstPoint=!1,n.snapIndicator&&(n.snapIndicator.visible=!1),m.redraw())},view:({attrs:u})=>{const d=c();return m(".path-editor",[m("canvas",{key:"path-editor-canvas",width:u.width,height:u.height,style:{width:`${u.width}px`,height:`${u.height}px`}}),m(".path-editor-controls",{key:"path-editor-controls"},[m(".mode-indicator",`Mode: ${n.mode==="draw"?"Drawing":"Editing"}`),n.mode==="draw"&&m("wa-button.end-drawing-button",{variant:"success",size:"small",onclick:()=>r(u)},"End Drawing"),m("wa-dropdown.zoom-control",{"onwa-select":h=>{h.redraw=!1;const p=h.detail.item.value;if(p&&typeof p=="string"){const f=parseFloat(p);isNaN(f)||l(f)}}},[m("wa-button",{slot:"trigger","with-caret":!0,size:"small",value:n.zoom},d),...eo.map((h,p)=>m("wa-dropdown-item",{type:"checkbox",checked:n.zoom==h?!0:void 0,value:h.toString()},to[p]))]),m("wa-tooltip",{for:"recenter-button"},"Recenter view"),m("wa-button#recenter-button",{appearance:"plain",size:"large",onclick:()=>{n.paperCtx&&j(n.paperCtx,"PathEditor:recenter",()=>{const h=n.paperCtx.scope,p=bt/n.zoom;h.view.scale(p,h.view.center),n.zoom=bt,h.view.center=new h.Point(h.view.viewSize.width/2,h.view.viewSize.height/2)})}},m("wa-icon",{library:"material",name:"recenter",label:"Recenter view"}))])])}}};function lo(n,e=.5){const i=[];let o=[0,0];for(const s of n)switch(s.type){case"move":o=s.p,i.push(o);break;case"line":o=s.p,i.push(o);break;case"bezier":{const r=Math.max(8,Math.ceil(Math.hypot(s.p3[0]-o[0],s.p3[1]-o[1])/e));for(let a=1;a<=r;a++){const l=a/r,c=l*l,u=c*l,d=1-l,h=d*d,p=h*d,f=p*o[0]+3*h*l*s.p1[0]+3*d*c*s.p2[0]+u*s.p3[0],y=p*o[1]+3*h*l*s.p1[1]+3*d*c*s.p2[1]+u*s.p3[1];i.push([f,y])}o=s.p3;break}case"arc":{const r=Math.max(8,Math.ceil(Math.hypot(s.p[0]-o[0],s.p[1]-o[1])/e));for(let a=1;a<=r;a++){const l=a/r,c=o[0]+l*(s.p[0]-o[0]),u=o[1]+l*(s.p[1]-o[1]);i.push([c,u])}o=s.p;break}}return i}function Xn(n,e=.01){if(n.length<2)return!1;let i=null;for(const l of n)if(l.type==="move"){i=l.p;break}if(!i)return!1;let o=null;for(let l=n.length-1;l>=0;l--){const c=n[l];switch(c.type){case"move":case"line":o=c.p;break;case"bezier":o=c.p3;break;case"arc":o=c.p;break}if(o)break}if(!o)return!1;const s=i[0]-o[0],r=i[1]-o[1];return Math.sqrt(s*s+r*r)<=e}function co(n,e,i,o){const[s,r]=n,[a,l]=e,[c,u]=i,[d,h]=o,p=(s-a)*(u-h)-(r-l)*(c-d);if(Math.abs(p)<1e-10)return null;const f=((s-c)*(u-h)-(r-u)*(c-d))/p,y=-((s-a)*(r-u)-(r-l)*(s-c))/p;if(f>0&&f<1&&y>0&&y<1){const v=s+f*(a-s),g=r+f*(l-r);return[v,g]}return null}function Xe(n,e,i){const o=n[0]-e[0],s=n[1]-e[1];return Math.sqrt(o*o+s*s)<=i}function uo(n,e,i,o,s){return Xe(n,i,s)||Xe(n,o,s)||Xe(e,i,s)||Xe(e,o,s)}function ho(n){const e=lo(n);if(e.length<4)return[];const i=[],o=1;for(let s=0;s<e.length-1;s++)for(let r=s+2;r<e.length-1;r++){const a=e[s],l=e[s+1],c=e[r],u=e[r+1];if(uo(a,l,c,u,o))continue;const d=co(a,l,c,u);d&&i.push(d)}return i}function dn(n){const e=[];let i;Xn(n)||e.push("Path must be closed (first point must equal last point)");const o=ho(n);return o.length>0&&(e.push(`Path has ${o.length} self-intersection${o.length>1?"s":""}`),i=o),{isValid:e.length===0,errors:e,intersections:i}}function Yn(n){try{const i=new DOMParser().parseFromString(n,"image/svg+xml"),o=i.querySelector("parsererror");if(o)return console.error("[SVGParser] XML parsing error:",o.textContent),{commands:[],warning:"Failed to parse SVG"};const s=i.querySelector("path");if(!s)return console.error("[SVGParser] No path element found in SVG"),{commands:[],warning:"Failed to parse SVG: no path element"};const r=s.getAttribute("d");return r?po(r):(console.error("[SVGParser] Path element has no d attribute"),{commands:[],warning:"Failed to parse SVG: Path element has no d attribute"})}catch(e){return console.error("[SVGParser] Error parsing SVG:",e),{commands:[],warning:"Failed to parse SVG"}}}function po(n){const e=[];let i=!1;const s=n.replace(/([MmLlHhVvCcSsQqTtAaZz])/g," $1 ").replace(/(\d)-/g,"$1 -").replace(/,/g," ").replace(/\s+/g," ").trim().split(" ").filter(g=>g.length>0);let r=0,a=0,l=0,c=0,u=0,d=0,h=0,p="",f=!0;const y=()=>{const g=parseFloat(s[r]);return r++,g};for(;r<s.length;){let g=s[r];isNaN(parseFloat(g))?r++:p==="M"?g="L":p==="m"?g="l":g=p;const w=g===g.toLowerCase();switch(g.toUpperCase()){case"M":{if(!f){i=!0,r=s.length;break}f=!1;const b=y(),E=y();w?(a+=b,l+=E):(a=b,l=E),c=a,u=l,e.push({type:"move",p:[a,l]}),p=g;break}case"L":{const b=y(),E=y();w?(a+=b,l+=E):(a=b,l=E),e.push({type:"line",p:[a,l]}),d=a,h=l,p=g;break}case"H":{const b=y();w?a+=b:a=b,e.push({type:"line",p:[a,l]}),d=a,h=l,p=g;break}case"V":{const b=y();w?l+=b:l=b,e.push({type:"line",p:[a,l]}),d=a,h=l,p=g;break}case"C":{const b=y(),E=y(),P=y(),I=y(),z=y(),C=y();let S=b,_=E,k=P,T=I,D=z,R=C;w&&(S+=a,_+=l,k+=a,T+=l,D+=a,R+=l),e.push({type:"bezier",p1:[S,_],p2:[k,T],p3:[D,R]}),d=k,h=T,a=D,l=R,p=g;break}case"S":{const b=y(),E=y(),P=y(),I=y(),z=2*a-d,C=2*l-h;let S=b,_=E,k=P,T=I;w&&(S+=a,_+=l,k+=a,T+=l),e.push({type:"bezier",p1:[z,C],p2:[S,_],p3:[k,T]}),d=S,h=_,a=k,l=T,p=g;break}case"Q":{const b=y(),E=y(),P=y(),I=y();let z=b,C=E,S=P,_=I;w&&(z+=a,C+=l,S+=a,_+=l);const k=a+2/3*(z-a),T=l+2/3*(C-l),D=S+2/3*(z-S),R=_+2/3*(C-_);e.push({type:"bezier",p1:[k,T],p2:[D,R],p3:[S,_]}),d=z,h=C,a=S,l=_,p=g;break}case"T":{const b=y(),E=y(),P=2*a-d,I=2*l-h;let z=b,C=E;w&&(z+=a,C+=l);const S=a+2/3*(P-a),_=l+2/3*(I-l),k=z+2/3*(P-z),T=C+2/3*(I-C);e.push({type:"bezier",p1:[S,_],p2:[k,T],p3:[z,C]}),d=P,h=I,a=z,l=C,p=g;break}case"A":{y(),y(),y(),y(),y();const b=y(),E=y();let P=b,I=E;w&&(P+=a,I+=l),e.push({type:"line",p:[P,I]}),a=P,l=I,d=P,h=I,p=g;break}case"Z":{(a!==c||l!==u)&&(e.push({type:"line",p:[c,u]}),a=c,l=u),p=g;break}}}const v={commands:e};return i&&(v.warning="This SVG contains a compound path. Only the first subpath was imported."),v}function Kn(n,e,i,o=20){if(n.length===0)return n;let s=1/0,r=1/0,a=-1/0,l=-1/0;const c=(b,E)=>{s=Math.min(s,b),r=Math.min(r,E),a=Math.max(a,b),l=Math.max(l,E)};for(const b of n)b.type==="move"||b.type==="line"?c(b.p[0],b.p[1]):b.type==="bezier"&&(c(b.p1[0],b.p1[1]),c(b.p2[0],b.p2[1]),c(b.p3[0],b.p3[1]));const u=a-s,d=l-r,h=e-2*o,p=i-2*o,f=Math.min(h/u,p/d),y=u*f,v=d*f,g=o+(h-y)/2-s*f,w=o+(p-v)/2-r*f,x=[];for(const b of n)b.type==="move"||b.type==="line"?x.push({...b,p:[b.p[0]*f+g,b.p[1]*f+w]}):b.type==="bezier"&&x.push({type:"bezier",p1:[b.p1[0]*f+g,b.p1[1]*f+w],p2:[b.p2[0]*f+g,b.p2[1]*f+w],p3:[b.p3[0]*f+g,b.p3[1]*f+w]});return x}const Zn=({attrs:n})=>{const e={el:null,currentAttrs:null,lastNotifiedOpen:n.open,cleanup:()=>{}},i=a=>{e.el&&e.el.open!==a&&(e.el.open=a)},o=a=>{e.lastNotifiedOpen!==a&&(e.lastNotifiedOpen=a,e.currentAttrs?.onStateChanged?.(a))},s=()=>o(!0),r=()=>o(!1);return{oncreate:({attrs:a,dom:l})=>{e.el=l,e.currentAttrs=a,i(a.open),e.el.addEventListener("wa-after-show",s),e.el.addEventListener("wa-after-hide",r),e.cleanup=()=>{e.el?.removeEventListener("wa-after-show",s),e.el?.removeEventListener("wa-after-hide",r),e.el=null,e.currentAttrs=null}},onupdate:({attrs:a})=>{e.currentAttrs=a,i(a.open)},onremove:()=>{e.cleanup()},view:({attrs:a,children:l})=>m("wa-dialog",{id:a.id,label:a.title,class:a.class??a.className,style:{"--width":a.width},open:a.open},a.contentKey!=null?m("div",{key:a.contentKey},l):l)}},fo=()=>{const n={initialPath:[],path:[],name:"",validation:{isValid:!1,errors:[]},prevOpen:!1,prevPieceId:null,contentKey:"initial"};let e=null;const i=l=>{l.piece?(n.contentKey=l.piece.id,n.initialPath=l.piece.path,n.path=l.piece.path,n.name=l.piece.name??"",n.validation=dn(n.path)):(n.contentKey=`new-${Date.now()}`,n.initialPath=[],n.path=[],n.name="",n.validation={isValid:!1,errors:[]})},o=l=>{if(n.path=l,l.length===0)n.validation={isValid:!1,errors:[]};else{const c=dn(l);n.validation=c}},s=l=>{n.name=l},r=l=>{n.validation.isValid&&l.onSave(n.path,n.name.length>0?n.name:void 0)},a=(l,c,u)=>{if(!l||l.length===0)return;const d=l[0];if(!d.name.endsWith(".svg")){console.error("Please select an SVG file");return}const h=new FileReader;h.onload=p=>{const f=p.target?.result;if(f){const y=Yn(f);if(y.warning&&console.warn("SVG import warning:",y.warning),y.commands.length>0){const v=Kn(y.commands,c,u);if(n.initialPath=v,o(v),!n.name){const g=d.name.replace(/\.svg$/i,"");s(g)}m.redraw()}else console.error("Failed to parse SVG file")}},h.readAsText(d)};return{view:({attrs:l})=>{const c=l.piece?.id??null,u=l.open&&!n.prevOpen,d=c!==n.prevPieceId;l.open&&(u||d)&&i(l),n.prevOpen=l.open,n.prevPieceId=c;const h=l.editorWidth??600,p=l.editorHeight??600;return m(Zn,{open:l.open,title:l.piece?"Edit Whimsy":"Create Whimsy",className:"custom-piece-editor",width:"50vw",contentKey:n.contentKey,onStateChanged:f=>{f||l.onCancel()}},[m(".editor-content",[m(Wn,{config:{type:"string",name:"name",label:"Piece Name (optional)",optional:!0},value:n.name,onChange:f=>{n.name=f??"",m.redraw()}}),n.path.length>0&&(n.validation.isValid?Xn(n.path)&&m(".validation-status",[m(".valid",[m("wa-icon",{library:"material",name:"check_circle",style:"color: green;"}),m("span","Valid piece")])]):n.validation.errors.length>0&&m(".validation-status",[m(".invalid",[m("wa-icon",{library:"material",name:"error",style:"color: red;"}),m("span",n.validation.errors.join(", "))])])),m(".editor-canvas",[m(Bn,{initialPath:n.initialPath,onPathChanged:o,width:h,height:p,strokeColor:n.validation.isValid?"#2196F3":"#f44336"})]),m(".import-controls",[m("input",{type:"file",accept:".svg",style:"display: none;",oncreate:f=>{e=f.dom},onchange:f=>{f.redraw=!1;const y=f.target;a(y.files,h,p),y.value=""}}),m("wa-button",{variant:"default",size:"small",onclick:f=>{f.redraw=!1,e?.click()}},"Import SVG")])]),m("div",{slot:"footer",style:"display: flex; gap: 8px; justify-content: flex-end;"},[m("wa-button",{variant:"default",onclick:f=>{f.redraw=!1,l.onCancel()}},"Cancel"),m("wa-button",{variant:"primary",disabled:!n.validation.isValid,onclick:f=>{f.redraw=!1,r(l)}},"Save")])])}}};function go(n,e,i,o,s=10){const r=document.createElement("canvas");r.width=e,r.height=i;const a=r.getContext("2d");if(!a||n.length===0)return"";a.clearRect(0,0,e,i);const l=mo(n);if(!l)return"";const[c,u,d,h]=l,p=d-c,f=h-u,y=e-2*s,v=i-2*s,g=Math.min(y/p,v/f),w=p*g,x=f*g,b=s+(y-w)/2-c*g,E=s+(v-x)/2-u*g,P=(I,z)=>[I*g+b,z*g+E];a.beginPath();for(const I of n)switch(I.type){case"move":{const[z,C]=P(I.p[0],I.p[1]);a.moveTo(z,C);break}case"line":{const[z,C]=P(I.p[0],I.p[1]);a.lineTo(z,C);break}case"bezier":{const[z,C]=P(I.p1[0],I.p1[1]),[S,_]=P(I.p2[0],I.p2[1]),[k,T]=P(I.p3[0],I.p3[1]);a.bezierCurveTo(z,C,S,_,k,T);break}case"arc":{const[z,C]=P(I.p[0],I.p[1]);a.lineTo(z,C);break}}return a.strokeStyle=o,a.lineWidth=2,a.stroke(),r.toDataURL("image/png")}function mo(n){if(n.length===0)return null;let e=1/0,i=1/0,o=-1/0,s=-1/0;const r=(a,l)=>{e=Math.min(e,a),i=Math.min(i,l),o=Math.max(o,a),s=Math.max(s,l)};for(const a of n)switch(a.type){case"move":case"line":case"arc":r(a.p[0],a.p[1]);break;case"bezier":r(a.p1[0],a.p1[1]),r(a.p2[0],a.p2[1]),r(a.p3[0],a.p3[1]);break}return e===1/0?null:[e,i,o,s]}const yo={view:({attrs:n})=>m(".custom-piece-tile",{key:n.piece.id,class:n.isSelected?"selected":"",onclick:e=>{e.redraw=!1,n.onClick()},ondblclick:e=>{e.redraw=!1,n.onDoubleClick()}},[m(".custom-piece-tile-thumbnail",n.thumbnail?m("img",{src:n.thumbnail,alt:n.piece.name??"Custom piece"}):m(".custom-piece-tile-placeholder",m("wa-icon",{name:"puzzle-piece"}))),m(".custom-piece-tile-name",n.piece.name??"Unnamed"),n.isSelected?m(".custom-piece-tile-selected-indicator",m("wa-icon",{name:"check-circle"})):null])};function vo(n){const e=document.createElement("div");document.body.appendChild(e);let i=!1;const o=c=>{i||(i=!0,s(),r(c))},s=()=>{try{m.mount(e,null)}catch(c){console.warn("confirm(): unable to mount Mithril component: ",c)}e.remove()};let r;const a=new Promise(c=>{r=c}),l=()=>{const c={open:!0,contentKey:Math.random()},u=h=>{c.open=!1,m.redraw(),d=h};let d=null;return{view(){return m(Zn,{id:n.id,title:n.title,width:n.width,open:c.open,contentKey:c.contentKey,onStateChanged:h=>{!h&&d!==null&&o(d),!h&&d===null&&i===!1&&o(!1)}},[m(".confirm-body",n.body??"Are you sure?"),m(".confirm-actions",{slot:"footer"},[m("wa-button.btn-cancel",{variant:"neutral",size:"small","data-dialog":"close",onclick:h=>{h.redraw=!1,u(!1)}},n.cancelLabel??"Cancel"),m("wa-button.btn-confirm",{variant:"brand",size:"small","data-dialog":"close",onclick:h=>{h.redraw=!1,u(!0)}},n.confirmLabel??"OK")])])}}};return m.mount(e,l),a}const wo=()=>{const n=new Map,e=(i,o)=>{const s=i.modified??i.created,r=`${i.id}-${s}-${o}`;if(!n.has(r)){const a=go(i.path,100,100,o);n.set(r,a)}return n.get(r)??""};return{view:({attrs:i})=>{const o=i.selectedPieceId!==null&&i.selectedPieceId!==void 0,s=o?i.pieces.find(r=>r.id===i.selectedPieceId):null;return m(".whimsy-manager",[m(".whimsy-manager-header",[m("h3","Whimsy Pieces"),m("wa-button",{variant:"primary",size:"small",onclick:r=>{r.redraw=!1,i.onAdd()}},[m("wa-icon",{name:"plus",slot:"prefix"}),"Add"])]),m(".whimsy-grid",i.pieces.length===0?m(".whimsy-empty-state",[m("wa-icon",{name:"puzzle-piece",style:"font-size: 48px; opacity: 0.3;"}),m("p","No whimsy pieces yet"),m("p.hint",'Click "Add" to create one')]):i.pieces.map(r=>{const a=r.id===i.selectedPieceId,l=e(r,i.pieceColor);return m(yo,{key:r.id,piece:r,isSelected:a,thumbnail:l,onClick:()=>{a?i.onSelect(null):i.onSelect(r.id)},onDoubleClick:()=>{i.onEdit(r.id)}})})),m(".whimsy-actions",[m("wa-button",{size:"small",disabled:!o,onclick:r=>{r.redraw=!1,s&&i.onEdit(s.id)}},[m("wa-icon",{name:"pencil",slot:"prefix"}),"Edit"]),m("wa-button",{size:"small",disabled:!o,onclick:r=>{r.redraw=!1,s&&i.onDuplicate(s.id)}},[m("wa-icon",{name:"copy",slot:"prefix"}),"Duplicate"]),m("wa-button",{size:"small",variant:"danger",disabled:!o,onclick:async r=>{r.redraw=!1,s&&await vo({title:"Delete piece?",body:`Are you sure you want to delete ${s.name??"this piece"}?`,confirmLabel:"Delete"})&&i.onDelete(s.id)}},[m("wa-icon",{name:"trash",slot:"start"}),"Delete"]),m("wa-button",{size:"small",disabled:!o,onclick:r=>{r.redraw=!1,s&&i.onPosition(s.id)}},[m("wa-icon",{name:"arrows-up-down-left-right",slot:"prefix"}),"Position"])])])}}};var xt,pn;function Jn(){if(pn)return xt;pn=1;function n(i){var o=i.length,s=1,r=new Array(o),a;for(a=o;a>0;a--)r[a-1]=s,s=s*i[a-1];return{stride:r,data:new Uint32Array(s)}}function e(i){var o=i.length,s=1,r=new Array(o),a=[],l,c;for(l=o;l>0;l--)r[l-1]=s,s=s*i[l-1];for(c=0;c<s;c++)a.push([]);return{stride:r,data:a}}return xt={integer:n,array:e},xt}var Pt,fn;function Qn(){if(fn)return Pt;fn=1,Pt=n;function n(e,i){var o=new Array(e),s=Math.floor(e/2)<<1,r=0,a,l,c,u,d;for(d=0;d<s;d+=2)a=-2*Math.log(i()),l=Math.sqrt(a),c=2*Math.PI*i(),r+=a,o[d]=l*Math.cos(c),o[d+1]=l*Math.sin(c);if(e%2){var h=Math.sqrt(-2*Math.log(i()))*Math.cos(2*Math.PI*i());o[e-1]=h,r+=Math.pow(h,2)}for(u=1/Math.sqrt(r),d=0;d<e;++d)o[d]*=u;return o}return Pt}var Ct,gn;function bo(){return gn||(gn=1,Ct=function(e,i){e=e||1,i=i||2;for(var o=e*2+1,s=Math.pow(o,i)-1,r=new Array(s),a=0;a<s;a++)for(var l=r[a]=new Array(i),c=a<s/2?a:a+1,u=1;u<=i;u++){var d=c%Math.pow(o,u);l[u-1]=d/Math.pow(o,u-1)-e,c-=d}return r}),Ct}var St,mn;function ei(){if(mn)return St;mn=1;var n=bo();function e(s){var r=n(2,s),a=[],l;for(r=r.filter(function(c){for(var u=0,d=0;d<s;d++)u+=Math.pow(Math.max(0,Math.abs(c[d])-1),2);return u<s}),l=0;l<s;l++)a.push(0);return r.push(a),r.sort(function(c,u){var d=0,h=0,p;for(p=0;p<s;p++)d+=Math.pow(c[p],2),h+=Math.pow(u[p],2);return d<h?-1:d>h?1:0}),r}var i={};function o(s){return i[s]||(i[s]=e(s)),i[s]}return St=o,St}var It,yn;function xo(){if(yn)return It;yn=1;var n=Jn().integer,e=Qn(),i=ei();function o(r,a){for(var l=0,c=0;c<r.length;c++)l+=Math.pow(r[c]-a[c],2);return l}function s(r,a){if(typeof r.distanceFunction=="function")throw new Error("PoissonDiskSampling: Tried to instantiate the fixed density implementation with a distanceFunction");this.shape=r.shape,this.minDistance=r.minDistance,this.maxDistance=r.maxDistance||r.minDistance*2,this.maxTries=Math.ceil(Math.max(1,r.tries||30)),this.rng=a||Math.random;for(var l=0,c=0;c<this.shape.length;c++)l=Math.max(l,this.shape[c]);var u=Math.max(1,l/128|0),d=1e-14*u;this.dimension=this.shape.length,this.squaredMinDistance=this.minDistance*this.minDistance,this.minDistancePlusEpsilon=this.minDistance+d,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.minDistance/Math.sqrt(this.dimension),this.neighbourhood=i(this.dimension),this.currentPoint=null,this.processList=[],this.samplePoints=[],this.gridShape=[];for(var c=0;c<this.dimension;c++)this.gridShape.push(Math.ceil(this.shape[c]/this.cellSize));this.grid=n(this.gridShape)}return s.prototype.shape=null,s.prototype.dimension=null,s.prototype.minDistance=null,s.prototype.maxDistance=null,s.prototype.minDistancePlusEpsilon=null,s.prototype.squaredMinDistance=null,s.prototype.deltaDistance=null,s.prototype.cellSize=null,s.prototype.maxTries=null,s.prototype.rng=null,s.prototype.neighbourhood=null,s.prototype.currentPoint=null,s.prototype.processList=null,s.prototype.samplePoints=null,s.prototype.gridShape=null,s.prototype.grid=null,s.prototype.addRandomPoint=function(){for(var r=new Array(this.dimension),a=0;a<this.dimension;a++)r[a]=this.rng()*this.shape[a];return this.directAddPoint(r)},s.prototype.addPoint=function(r){var a,l=!0;if(r.length===this.dimension)for(a=0;a<this.dimension&&l;a++)l=r[a]>=0&&r[a]<this.shape[a];else l=!1;return l?this.directAddPoint(r):null},s.prototype.directAddPoint=function(r){var a=0,l=this.grid.stride,c;for(this.processList.push(r),this.samplePoints.push(r),c=0;c<this.dimension;c++)a+=(r[c]/this.cellSize|0)*l[c];return this.grid.data[a]=this.samplePoints.length,r},s.prototype.inNeighbourhood=function(r){var a=this.dimension,l=this.grid.stride,c,u,d,h,p;for(c=0;c<this.neighbourhood.length;c++){for(u=0,d=0;d<a;d++){if(h=(r[d]/this.cellSize|0)+this.neighbourhood[c][d],h<0||h>=this.gridShape[d]){u=-1;break}u+=h*l[d]}if(u!==-1&&this.grid.data[u]!==0&&(p=this.samplePoints[this.grid.data[u]-1],o(r,p)<this.squaredMinDistance))return!0}return!1},s.prototype.next=function(){for(var r,a,l,c,u,d,h;this.processList.length>0;){for(this.currentPoint===null&&(this.currentPoint=this.processList.shift()),c=this.currentPoint,r=0;r<this.maxTries;r++){for(d=!0,l=this.minDistancePlusEpsilon+this.deltaDistance*this.rng(),this.dimension===2?(a=this.rng()*Math.PI*2,u=[Math.cos(a),Math.sin(a)]):u=e(this.dimension,this.rng),h=0;d&&h<this.dimension;h++)u[h]=c[h]+u[h]*l,d=u[h]>=0&&u[h]<this.shape[h];if(d&&!this.inNeighbourhood(u))return this.directAddPoint(u)}r===this.maxTries&&(this.currentPoint=null)}return null},s.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},s.prototype.getAllPoints=function(){return this.samplePoints},s.prototype.getAllPointsWithDistance=function(){throw new Error("PoissonDiskSampling: getAllPointsWithDistance() is not available in fixed-density implementation")},s.prototype.reset=function(){var r=this.grid.data,a=0;for(a=0;a<r.length;a++)r[a]=0;this.samplePoints=[],this.currentPoint=null,this.processList.length=0},It=s,It}var zt,vn;function Po(){if(vn)return zt;vn=1;var n=Jn().array,e=Qn(),i=ei();function o(r,a){for(var l=0,c=0;c<r.length;c++)l+=Math.pow(r[c]-a[c],2);return Math.sqrt(l)}function s(r,a){if(typeof r.distanceFunction!="function")throw new Error("PoissonDiskSampling: Tried to instantiate the variable density implementation without a distanceFunction");this.shape=r.shape,this.minDistance=r.minDistance,this.maxDistance=r.maxDistance||r.minDistance*2,this.maxTries=Math.ceil(Math.max(1,r.tries||30)),this.distanceFunction=r.distanceFunction,this.bias=Math.max(0,Math.min(1,r.bias||0)),this.rng=a||Math.random;for(var l=0,c=0;c<this.shape.length;c++)l=Math.max(l,this.shape[c]);var u=Math.max(1,l/128|0),d=1e-14*u;this.dimension=this.shape.length,this.minDistancePlusEpsilon=this.minDistance+d,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.maxDistance/Math.sqrt(this.dimension),this.neighbourhood=i(this.dimension),this.currentPoint=null,this.currentDistance=0,this.processList=[],this.samplePoints=[],this.sampleDistance=[],this.gridShape=[];for(var c=0;c<this.dimension;c++)this.gridShape.push(Math.ceil(this.shape[c]/this.cellSize));this.grid=n(this.gridShape)}return s.prototype.shape=null,s.prototype.dimension=null,s.prototype.minDistance=null,s.prototype.maxDistance=null,s.prototype.minDistancePlusEpsilon=null,s.prototype.deltaDistance=null,s.prototype.cellSize=null,s.prototype.maxTries=null,s.prototype.distanceFunction=null,s.prototype.bias=null,s.prototype.rng=null,s.prototype.neighbourhood=null,s.prototype.currentPoint=null,s.prototype.currentDistance=null,s.prototype.processList=null,s.prototype.samplePoints=null,s.prototype.sampleDistance=null,s.prototype.gridShape=null,s.prototype.grid=null,s.prototype.addRandomPoint=function(){for(var r=new Array(this.dimension),a=0;a<this.dimension;a++)r[a]=this.rng()*this.shape[a];return this.directAddPoint(r)},s.prototype.addPoint=function(r){var a,l=!0;if(r.length===this.dimension)for(a=0;a<this.dimension&&l;a++)l=r[a]>=0&&r[a]<this.shape[a];else l=!1;return l?this.directAddPoint(r):null},s.prototype.directAddPoint=function(r){var a=0,l=this.grid.stride,c=this.samplePoints.length,u;for(this.processList.push(c),this.samplePoints.push(r),this.sampleDistance.push(this.distanceFunction(r)),u=0;u<this.dimension;u++)a+=(r[u]/this.cellSize|0)*l[u];return this.grid.data[a].push(c),r},s.prototype.inNeighbourhood=function(r){var a=this.dimension,l=this.grid.stride,c,u,d,h,p,f,y=this.distanceFunction(r);for(c=0;c<this.neighbourhood.length;c++){for(u=0,d=0;d<a;d++){if(h=(r[d]/this.cellSize|0)+this.neighbourhood[c][d],h<0||h>=this.gridShape[d]){u=-1;break}u+=h*l[d]}if(u!==-1&&this.grid.data[u].length>0)for(var v=0;v<this.grid.data[u].length;v++){p=this.samplePoints[this.grid.data[u][v]],f=this.sampleDistance[this.grid.data[u][v]];var g=Math.min(f,y),w=Math.max(f,y),x=g+(w-g)*this.bias;if(o(r,p)<this.minDistance+this.deltaDistance*x)return!0}}return!1},s.prototype.next=function(){for(var r,a,l,c,u,d,h,p;this.processList.length>0;){if(this.currentPoint===null){var f=this.processList.shift();this.currentPoint=this.samplePoints[f],this.currentDistance=this.sampleDistance[f]}for(c=this.currentPoint,u=this.currentDistance,r=0;r<this.maxTries;r++){for(h=!0,l=this.minDistancePlusEpsilon+this.deltaDistance*(u+(1-u)*this.bias),this.dimension===2?(a=this.rng()*Math.PI*2,d=[Math.cos(a),Math.sin(a)]):d=e(this.dimension,this.rng),p=0;h&&p<this.dimension;p++)d[p]=c[p]+d[p]*l,h=d[p]>=0&&d[p]<this.shape[p];if(h&&!this.inNeighbourhood(d))return this.directAddPoint(d)}r===this.maxTries&&(this.currentPoint=null)}return null},s.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},s.prototype.getAllPoints=function(){return this.samplePoints},s.prototype.getAllPointsWithDistance=function(){var r=new Array(this.samplePoints.length),a=0,l=0,c;for(a=0;a<this.samplePoints.length;a++){for(c=new Array(this.dimension+1),l=0;l<this.dimension;l++)c[l]=this.samplePoints[a][l];c[this.dimension]=this.sampleDistance[a],r[a]=c}return r},s.prototype.reset=function(){var r=this.grid.data,a=0;for(a=0;a<r.length;a++)r[a]=[];this.samplePoints=[],this.currentPoint=null,this.processList.length=0},zt=s,zt}var Et,wn;function Co(){if(wn)return Et;wn=1;var n=xo(),e=Po();function i(o,s){this.shape=o.shape,typeof o.distanceFunction=="function"?this.implementation=new e(o,s):this.implementation=new n(o,s)}return i.prototype.implementation=null,i.prototype.addRandomPoint=function(){return this.implementation.addRandomPoint()},i.prototype.addPoint=function(o){return this.implementation.addPoint(o)},i.prototype.next=function(){return this.implementation.next()},i.prototype.fill=function(){return this.implementation.fill()},i.prototype.getAllPoints=function(){return this.implementation.getAllPoints()},i.prototype.getAllPointsWithDistance=function(){return this.implementation.getAllPointsWithDistance()},i.prototype.reset=function(){this.implementation.reset()},Et=i,Et}var So=Co();const Io=_n(So),Ut="PoissonPointGenerator",zo={name:Ut,displayName:"Poisson",description:"Generate seed points using Poisson disk sampling. The algorithm produces points that are tightly-packed, but no closer to each other than a specified minimum distance (the piece size), resulting in a natural, organic look.",sortHint:1,controls:[]},Eo=(n,e,i)=>({generatePoints(s){const{width:r,height:a,pieceSize:l,random:c,border:u}=s;return new Io({shape:[r,a],minDistance:l,tries:20},c).fill().filter(f=>Vt(f,u))}});$e.register(Ut,Eo,zo);const Z=11102230246251565e-32,U=134217729,_o=(3+8*Z)*Z;function _t(n,e,i,o,s){let r,a,l,c,u=e[0],d=o[0],h=0,p=0;d>u==d>-u?(r=u,u=e[++h]):(r=d,d=o[++p]);let f=0;if(h<n&&p<i)for(d>u==d>-u?(a=u+r,l=r-(a-u),u=e[++h]):(a=d+r,l=r-(a-d),d=o[++p]),r=a,l!==0&&(s[f++]=l);h<n&&p<i;)d>u==d>-u?(a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h]):(a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p]),r=a,l!==0&&(s[f++]=l);for(;h<n;)a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h],r=a,l!==0&&(s[f++]=l);for(;p<i;)a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p],r=a,l!==0&&(s[f++]=l);return(r!==0||f===0)&&(s[f++]=r),f}function ko(n,e){let i=e[0];for(let o=1;o<n;o++)i+=e[o];return i}function Fe(n){return new Float64Array(n)}const Mo=(3+16*Z)*Z,To=(2+12*Z)*Z,Do=(9+64*Z)*Z*Z,he=Fe(4),bn=Fe(8),xn=Fe(12),Pn=Fe(16),G=Fe(4);function Ro(n,e,i,o,s,r,a){let l,c,u,d,h,p,f,y,v,g,w,x,b,E,P,I,z,C;const S=n-s,_=i-s,k=e-r,T=o-r;E=S*T,p=U*S,f=p-(p-S),y=S-f,p=U*T,v=p-(p-T),g=T-v,P=y*g-(E-f*v-y*v-f*g),I=k*_,p=U*k,f=p-(p-k),y=k-f,p=U*_,v=p-(p-_),g=_-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,he[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,he[1]=b-(w+h)+(h-I),C=x+w,h=C-x,he[2]=x-(C-h)+(w-h),he[3]=C;let D=ko(4,he),R=To*a;if(D>=R||-D>=R||(h=n-S,l=n-(S+h)+(h-s),h=i-_,u=i-(_+h)+(h-s),h=e-k,c=e-(k+h)+(h-r),h=o-T,d=o-(T+h)+(h-r),l===0&&c===0&&u===0&&d===0)||(R=Do*a+_o*Math.abs(D),D+=S*d+T*l-(k*u+_*c),D>=R||-D>=R))return D;E=l*T,p=U*l,f=p-(p-l),y=l-f,p=U*T,v=p-(p-T),g=T-v,P=y*g-(E-f*v-y*v-f*g),I=c*_,p=U*c,f=p-(p-c),y=c-f,p=U*_,v=p-(p-_),g=_-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,G[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,G[1]=b-(w+h)+(h-I),C=x+w,h=C-x,G[2]=x-(C-h)+(w-h),G[3]=C;const L=_t(4,he,4,G,bn);E=S*d,p=U*S,f=p-(p-S),y=S-f,p=U*d,v=p-(p-d),g=d-v,P=y*g-(E-f*v-y*v-f*g),I=k*u,p=U*k,f=p-(p-k),y=k-f,p=U*u,v=p-(p-u),g=u-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,G[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,G[1]=b-(w+h)+(h-I),C=x+w,h=C-x,G[2]=x-(C-h)+(w-h),G[3]=C;const A=_t(L,bn,4,G,xn);E=l*d,p=U*l,f=p-(p-l),y=l-f,p=U*d,v=p-(p-d),g=d-v,P=y*g-(E-f*v-y*v-f*g),I=c*u,p=U*c,f=p-(p-c),y=c-f,p=U*u,v=p-(p-u),g=u-v,z=y*g-(I-f*v-y*v-f*g),w=P-z,h=P-w,G[0]=P-(w+h)+(h-z),x=E+w,h=x-E,b=E-(x-h)+(w-h),w=b-I,h=b-w,G[1]=b-(w+h)+(h-I),C=x+w,h=C-x,G[2]=x-(C-h)+(w-h),G[3]=C;const O=_t(A,xn,4,G,Pn);return Pn[O-1]}function Ye(n,e,i,o,s,r){const a=(e-r)*(i-s),l=(n-s)*(o-r),c=a-l,u=Math.abs(a+l);return Math.abs(c)>=Mo*u?c:-Ro(n,e,i,o,s,r,u)}const Cn=Math.pow(2,-52),Ke=new Uint32Array(512);class at{static from(e,i=$o,o=Ho){const s=e.length,r=new Float64Array(s*2);for(let a=0;a<s;a++){const l=e[a];r[2*a]=i(l),r[2*a+1]=o(l)}return new at(r)}constructor(e){const i=e.length>>1;if(i>0&&typeof e[0]!="number")throw new Error("Expected coords to contain numbers.");this.coords=e;const o=Math.max(2*i-5,0);this._triangles=new Uint32Array(o*3),this._halfedges=new Int32Array(o*3),this._hashSize=Math.ceil(Math.sqrt(i)),this._hullPrev=new Uint32Array(i),this._hullNext=new Uint32Array(i),this._hullTri=new Uint32Array(i),this._hullHash=new Int32Array(this._hashSize),this._ids=new Uint32Array(i),this._dists=new Float64Array(i),this.update()}update(){const{coords:e,_hullPrev:i,_hullNext:o,_hullTri:s,_hullHash:r}=this,a=e.length>>1;let l=1/0,c=1/0,u=-1/0,d=-1/0;for(let S=0;S<a;S++){const _=e[2*S],k=e[2*S+1];_<l&&(l=_),k<c&&(c=k),_>u&&(u=_),k>d&&(d=k),this._ids[S]=S}const h=(l+u)/2,p=(c+d)/2;let f,y,v;for(let S=0,_=1/0;S<a;S++){const k=kt(h,p,e[2*S],e[2*S+1]);k<_&&(f=S,_=k)}const g=e[2*f],w=e[2*f+1];for(let S=0,_=1/0;S<a;S++){if(S===f)continue;const k=kt(g,w,e[2*S],e[2*S+1]);k<_&&k>0&&(y=S,_=k)}let x=e[2*y],b=e[2*y+1],E=1/0;for(let S=0;S<a;S++){if(S===f||S===y)continue;const _=Oo(g,w,x,b,e[2*S],e[2*S+1]);_<E&&(v=S,E=_)}let P=e[2*v],I=e[2*v+1];if(E===1/0){for(let k=0;k<a;k++)this._dists[k]=e[2*k]-e[0]||e[2*k+1]-e[1];ge(this._ids,this._dists,0,a-1);const S=new Uint32Array(a);let _=0;for(let k=0,T=-1/0;k<a;k++){const D=this._ids[k],R=this._dists[D];R>T&&(S[_++]=D,T=R)}this.hull=S.subarray(0,_),this.triangles=new Uint32Array(0),this.halfedges=new Uint32Array(0);return}if(Ye(g,w,x,b,P,I)<0){const S=y,_=x,k=b;y=v,x=P,b=I,v=S,P=_,I=k}const z=No(g,w,x,b,P,I);this._cx=z.x,this._cy=z.y;for(let S=0;S<a;S++)this._dists[S]=kt(e[2*S],e[2*S+1],z.x,z.y);ge(this._ids,this._dists,0,a-1),this._hullStart=f;let C=3;o[f]=i[v]=y,o[y]=i[f]=v,o[v]=i[y]=f,s[f]=0,s[y]=1,s[v]=2,r.fill(-1),r[this._hashKey(g,w)]=f,r[this._hashKey(x,b)]=y,r[this._hashKey(P,I)]=v,this.trianglesLen=0,this._addTriangle(f,y,v,-1,-1,-1);for(let S=0,_,k;S<this._ids.length;S++){const T=this._ids[S],D=e[2*T],R=e[2*T+1];if(S>0&&Math.abs(D-_)<=Cn&&Math.abs(R-k)<=Cn||(_=D,k=R,T===f||T===y||T===v))continue;let L=0;for(let q=0,ye=this._hashKey(D,R);q<this._hashSize&&(L=r[(ye+q)%this._hashSize],!(L!==-1&&L!==o[L]));q++);L=i[L];let A=L,O;for(;O=o[A],Ye(D,R,e[2*A],e[2*A+1],e[2*O],e[2*O+1])>=0;)if(A=O,A===L){A=-1;break}if(A===-1)continue;let H=this._addTriangle(A,T,o[A],-1,-1,s[A]);s[T]=this._legalize(H+2),s[A]=H,C++;let $=o[A];for(;O=o[$],Ye(D,R,e[2*$],e[2*$+1],e[2*O],e[2*O+1])<0;)H=this._addTriangle($,T,O,s[T],-1,s[$]),s[T]=this._legalize(H+2),o[$]=$,C--,$=O;if(A===L)for(;O=i[A],Ye(D,R,e[2*O],e[2*O+1],e[2*A],e[2*A+1])<0;)H=this._addTriangle(O,T,A,-1,s[A],s[O]),this._legalize(H+2),s[O]=H,o[A]=A,C--,A=O;this._hullStart=i[T]=A,o[A]=i[$]=T,o[T]=$,r[this._hashKey(D,R)]=T,r[this._hashKey(e[2*A],e[2*A+1])]=A}this.hull=new Uint32Array(C);for(let S=0,_=this._hullStart;S<C;S++)this.hull[S]=_,_=o[_];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(e,i){return Math.floor(Ao(e-this._cx,i-this._cy)*this._hashSize)%this._hashSize}_legalize(e){const{_triangles:i,_halfedges:o,coords:s}=this;let r=0,a=0;for(;;){const l=o[e],c=e-e%3;if(a=c+(e+2)%3,l===-1){if(r===0)break;e=Ke[--r];continue}const u=l-l%3,d=c+(e+1)%3,h=u+(l+2)%3,p=i[a],f=i[e],y=i[d],v=i[h];if(Lo(s[2*p],s[2*p+1],s[2*f],s[2*f+1],s[2*y],s[2*y+1],s[2*v],s[2*v+1])){i[e]=v,i[l]=p;const w=o[h];if(w===-1){let b=this._hullStart;do{if(this._hullTri[b]===h){this._hullTri[b]=e;break}b=this._hullPrev[b]}while(b!==this._hullStart)}this._link(e,w),this._link(l,o[a]),this._link(a,h);const x=u+(l+1)%3;r<Ke.length&&(Ke[r++]=x)}else{if(r===0)break;e=Ke[--r]}}return a}_link(e,i){this._halfedges[e]=i,i!==-1&&(this._halfedges[i]=e)}_addTriangle(e,i,o,s,r,a){const l=this.trianglesLen;return this._triangles[l]=e,this._triangles[l+1]=i,this._triangles[l+2]=o,this._link(l,s),this._link(l+1,r),this._link(l+2,a),this.trianglesLen+=3,l}}function Ao(n,e){const i=n/(Math.abs(n)+Math.abs(e));return(e>0?3-i:1+i)/4}function kt(n,e,i,o){const s=n-i,r=e-o;return s*s+r*r}function Lo(n,e,i,o,s,r,a,l){const c=n-a,u=e-l,d=i-a,h=o-l,p=s-a,f=r-l,y=c*c+u*u,v=d*d+h*h,g=p*p+f*f;return c*(h*g-v*f)-u*(d*g-v*p)+y*(d*f-h*p)<0}function Oo(n,e,i,o,s,r){const a=i-n,l=o-e,c=s-n,u=r-e,d=a*a+l*l,h=c*c+u*u,p=.5/(a*u-l*c),f=(u*d-l*h)*p,y=(a*h-c*d)*p;return f*f+y*y}function No(n,e,i,o,s,r){const a=i-n,l=o-e,c=s-n,u=r-e,d=a*a+l*l,h=c*c+u*u,p=.5/(a*u-l*c),f=n+(u*d-l*h)*p,y=e+(a*h-c*d)*p;return{x:f,y}}function ge(n,e,i,o){if(o-i<=20)for(let s=i+1;s<=o;s++){const r=n[s],a=e[r];let l=s-1;for(;l>=i&&e[n[l]]>a;)n[l+1]=n[l--];n[l+1]=r}else{const s=i+o>>1;let r=i+1,a=o;Se(n,s,r),e[n[i]]>e[n[o]]&&Se(n,i,o),e[n[r]]>e[n[o]]&&Se(n,r,o),e[n[i]]>e[n[r]]&&Se(n,i,r);const l=n[r],c=e[l];for(;;){do r++;while(e[n[r]]<c);do a--;while(e[n[a]]>c);if(a<r)break;Se(n,r,a)}n[i+1]=n[a],n[a]=l,o-r+1>=a-i?(ge(n,e,r,o),ge(n,e,i,a-1)):(ge(n,e,i,a-1),ge(n,e,r,o))}}function Se(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function $o(n){return n[0]}function Ho(n){return n[1]}const Sn=1e-6;class ae{constructor(){this._x0=this._y0=this._x1=this._y1=null,this._=""}moveTo(e,i){this._+=`M${this._x0=this._x1=+e},${this._y0=this._y1=+i}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")}lineTo(e,i){this._+=`L${this._x1=+e},${this._y1=+i}`}arc(e,i,o){e=+e,i=+i,o=+o;const s=e+o,r=i;if(o<0)throw new Error("negative radius");this._x1===null?this._+=`M${s},${r}`:(Math.abs(this._x1-s)>Sn||Math.abs(this._y1-r)>Sn)&&(this._+="L"+s+","+r),o&&(this._+=`A${o},${o},0,1,1,${e-o},${i}A${o},${o},0,1,1,${this._x1=s},${this._y1=r}`)}rect(e,i,o,s){this._+=`M${this._x0=this._x1=+e},${this._y0=this._y1=+i}h${+o}v${+s}h${-o}Z`}value(){return this._||null}}class Nt{constructor(){this._=[]}moveTo(e,i){this._.push([e,i])}closePath(){this._.push(this._[0].slice())}lineTo(e,i){this._.push([e,i])}value(){return this._.length?this._:null}}class Vo{constructor(e,[i,o,s,r]=[0,0,960,500]){if(!((s=+s)>=(i=+i))||!((r=+r)>=(o=+o)))throw new Error("invalid bounds");this.delaunay=e,this._circumcenters=new Float64Array(e.points.length*2),this.vectors=new Float64Array(e.points.length*2),this.xmax=s,this.xmin=i,this.ymax=r,this.ymin=o,this._init()}update(){return this.delaunay.update(),this._init(),this}_init(){const{delaunay:{points:e,hull:i,triangles:o},vectors:s}=this;let r,a;const l=this.circumcenters=this._circumcenters.subarray(0,o.length/3*2);for(let v=0,g=0,w=o.length,x,b;v<w;v+=3,g+=2){const E=o[v]*2,P=o[v+1]*2,I=o[v+2]*2,z=e[E],C=e[E+1],S=e[P],_=e[P+1],k=e[I],T=e[I+1],D=S-z,R=_-C,L=k-z,A=T-C,O=(D*A-R*L)*2;if(Math.abs(O)<1e-9){if(r===void 0){r=a=0;for(const $ of i)r+=e[$*2],a+=e[$*2+1];r/=i.length,a/=i.length}const H=1e9*Math.sign((r-z)*A-(a-C)*L);x=(z+k)/2-H*A,b=(C+T)/2+H*L}else{const H=1/O,$=D*D+R*R,q=L*L+A*A;x=z+(A*$-R*q)*H,b=C+(D*q-L*$)*H}l[g]=x,l[g+1]=b}let c=i[i.length-1],u,d=c*4,h,p=e[2*c],f,y=e[2*c+1];s.fill(0);for(let v=0;v<i.length;++v)c=i[v],u=d,h=p,f=y,d=c*4,p=e[2*c],y=e[2*c+1],s[u+2]=s[d]=f-y,s[u+3]=s[d+1]=p-h}render(e){const i=e==null?e=new ae:void 0,{delaunay:{halfedges:o,inedges:s,hull:r},circumcenters:a,vectors:l}=this;if(r.length<=1)return null;for(let d=0,h=o.length;d<h;++d){const p=o[d];if(p<d)continue;const f=Math.floor(d/3)*2,y=Math.floor(p/3)*2,v=a[f],g=a[f+1],w=a[y],x=a[y+1];this._renderSegment(v,g,w,x,e)}let c,u=r[r.length-1];for(let d=0;d<r.length;++d){c=u,u=r[d];const h=Math.floor(s[u]/3)*2,p=a[h],f=a[h+1],y=c*4,v=this._project(p,f,l[y+2],l[y+3]);v&&this._renderSegment(p,f,v[0],v[1],e)}return i&&i.value()}renderBounds(e){const i=e==null?e=new ae:void 0;return e.rect(this.xmin,this.ymin,this.xmax-this.xmin,this.ymax-this.ymin),i&&i.value()}renderCell(e,i){const o=i==null?i=new ae:void 0,s=this._clip(e);if(s===null||!s.length)return;i.moveTo(s[0],s[1]);let r=s.length;for(;s[0]===s[r-2]&&s[1]===s[r-1]&&r>1;)r-=2;for(let a=2;a<r;a+=2)(s[a]!==s[a-2]||s[a+1]!==s[a-1])&&i.lineTo(s[a],s[a+1]);return i.closePath(),o&&o.value()}*cellPolygons(){const{delaunay:{points:e}}=this;for(let i=0,o=e.length/2;i<o;++i){const s=this.cellPolygon(i);s&&(s.index=i,yield s)}}cellPolygon(e){const i=new Nt;return this.renderCell(e,i),i.value()}_renderSegment(e,i,o,s,r){let a;const l=this._regioncode(e,i),c=this._regioncode(o,s);l===0&&c===0?(r.moveTo(e,i),r.lineTo(o,s)):(a=this._clipSegment(e,i,o,s,l,c))&&(r.moveTo(a[0],a[1]),r.lineTo(a[2],a[3]))}contains(e,i,o){return i=+i,i!==i||(o=+o,o!==o)?!1:this.delaunay._step(e,i,o)===e}*neighbors(e){const i=this._clip(e);if(i)for(const o of this.delaunay.neighbors(e)){const s=this._clip(o);if(s){e:for(let r=0,a=i.length;r<a;r+=2)for(let l=0,c=s.length;l<c;l+=2)if(i[r]===s[l]&&i[r+1]===s[l+1]&&i[(r+2)%a]===s[(l+c-2)%c]&&i[(r+3)%a]===s[(l+c-1)%c]){yield o;break e}}}}_cell(e){const{circumcenters:i,delaunay:{inedges:o,halfedges:s,triangles:r}}=this,a=o[e];if(a===-1)return null;const l=[];let c=a;do{const u=Math.floor(c/3);if(l.push(i[u*2],i[u*2+1]),c=c%3===2?c-2:c+1,r[c]!==e)break;c=s[c]}while(c!==a&&c!==-1);return l}_clip(e){if(e===0&&this.delaunay.hull.length===1)return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];const i=this._cell(e);if(i===null)return null;const{vectors:o}=this,s=e*4;return this._simplify(o[s]||o[s+1]?this._clipInfinite(e,i,o[s],o[s+1],o[s+2],o[s+3]):this._clipFinite(e,i))}_clipFinite(e,i){const o=i.length;let s=null,r,a,l=i[o-2],c=i[o-1],u,d=this._regioncode(l,c),h,p=0;for(let f=0;f<o;f+=2)if(r=l,a=c,l=i[f],c=i[f+1],u=d,d=this._regioncode(l,c),u===0&&d===0)h=p,p=0,s?s.push(l,c):s=[l,c];else{let y,v,g,w,x;if(u===0){if((y=this._clipSegment(r,a,l,c,u,d))===null)continue;[v,g,w,x]=y}else{if((y=this._clipSegment(l,c,r,a,d,u))===null)continue;[w,x,v,g]=y,h=p,p=this._edgecode(v,g),h&&p&&this._edge(e,h,p,s,s.length),s?s.push(v,g):s=[v,g]}h=p,p=this._edgecode(w,x),h&&p&&this._edge(e,h,p,s,s.length),s?s.push(w,x):s=[w,x]}if(s)h=p,p=this._edgecode(s[0],s[1]),h&&p&&this._edge(e,h,p,s,s.length);else if(this.contains(e,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2))return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];return s}_clipSegment(e,i,o,s,r,a){const l=r<a;for(l&&([e,i,o,s,r,a]=[o,s,e,i,a,r]);;){if(r===0&&a===0)return l?[o,s,e,i]:[e,i,o,s];if(r&a)return null;let c,u,d=r||a;d&8?(c=e+(o-e)*(this.ymax-i)/(s-i),u=this.ymax):d&4?(c=e+(o-e)*(this.ymin-i)/(s-i),u=this.ymin):d&2?(u=i+(s-i)*(this.xmax-e)/(o-e),c=this.xmax):(u=i+(s-i)*(this.xmin-e)/(o-e),c=this.xmin),r?(e=c,i=u,r=this._regioncode(e,i)):(o=c,s=u,a=this._regioncode(o,s))}}_clipInfinite(e,i,o,s,r,a){let l=Array.from(i),c;if((c=this._project(l[0],l[1],o,s))&&l.unshift(c[0],c[1]),(c=this._project(l[l.length-2],l[l.length-1],r,a))&&l.push(c[0],c[1]),l=this._clipFinite(e,l))for(let u=0,d=l.length,h,p=this._edgecode(l[d-2],l[d-1]);u<d;u+=2)h=p,p=this._edgecode(l[u],l[u+1]),h&&p&&(u=this._edge(e,h,p,l,u),d=l.length);else this.contains(e,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)&&(l=[this.xmin,this.ymin,this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax]);return l}_edge(e,i,o,s,r){for(;i!==o;){let a,l;switch(i){case 5:i=4;continue;case 4:i=6,a=this.xmax,l=this.ymin;break;case 6:i=2;continue;case 2:i=10,a=this.xmax,l=this.ymax;break;case 10:i=8;continue;case 8:i=9,a=this.xmin,l=this.ymax;break;case 9:i=1;continue;case 1:i=5,a=this.xmin,l=this.ymin;break}(s[r]!==a||s[r+1]!==l)&&this.contains(e,a,l)&&(s.splice(r,0,a,l),r+=2)}return r}_project(e,i,o,s){let r=1/0,a,l,c;if(s<0){if(i<=this.ymin)return null;(a=(this.ymin-i)/s)<r&&(c=this.ymin,l=e+(r=a)*o)}else if(s>0){if(i>=this.ymax)return null;(a=(this.ymax-i)/s)<r&&(c=this.ymax,l=e+(r=a)*o)}if(o>0){if(e>=this.xmax)return null;(a=(this.xmax-e)/o)<r&&(l=this.xmax,c=i+(r=a)*s)}else if(o<0){if(e<=this.xmin)return null;(a=(this.xmin-e)/o)<r&&(l=this.xmin,c=i+(r=a)*s)}return[l,c]}_edgecode(e,i){return(e===this.xmin?1:e===this.xmax?2:0)|(i===this.ymin?4:i===this.ymax?8:0)}_regioncode(e,i){return(e<this.xmin?1:e>this.xmax?2:0)|(i<this.ymin?4:i>this.ymax?8:0)}_simplify(e){if(e&&e.length>4){for(let i=0;i<e.length;i+=2){const o=(i+2)%e.length,s=(i+4)%e.length;(e[i]===e[o]&&e[o]===e[s]||e[i+1]===e[o+1]&&e[o+1]===e[s+1])&&(e.splice(o,2),i-=2)}e.length||(e=null)}return e}}const Uo=2*Math.PI,de=Math.pow;function Fo(n){return n[0]}function Go(n){return n[1]}function jo(n){const{triangles:e,coords:i}=n;for(let o=0;o<e.length;o+=3){const s=2*e[o],r=2*e[o+1],a=2*e[o+2];if((i[a]-i[s])*(i[r+1]-i[s+1])-(i[r]-i[s])*(i[a+1]-i[s+1])>1e-10)return!1}return!0}function Wo(n,e,i){return[n+Math.sin(n+e)*i,e+Math.cos(n-e)*i]}class Ft{static from(e,i=Fo,o=Go,s){return new Ft("length"in e?qo(e,i,o,s):Float64Array.from(Bo(e,i,o,s)))}constructor(e){this._delaunator=new at(e),this.inedges=new Int32Array(e.length/2),this._hullIndex=new Int32Array(e.length/2),this.points=this._delaunator.coords,this._init()}update(){return this._delaunator.update(),this._init(),this}_init(){const e=this._delaunator,i=this.points;if(e.hull&&e.hull.length>2&&jo(e)){this.collinear=Int32Array.from({length:i.length/2},(p,f)=>f).sort((p,f)=>i[2*p]-i[2*f]||i[2*p+1]-i[2*f+1]);const c=this.collinear[0],u=this.collinear[this.collinear.length-1],d=[i[2*c],i[2*c+1],i[2*u],i[2*u+1]],h=1e-8*Math.hypot(d[3]-d[1],d[2]-d[0]);for(let p=0,f=i.length/2;p<f;++p){const y=Wo(i[2*p],i[2*p+1],h);i[2*p]=y[0],i[2*p+1]=y[1]}this._delaunator=new at(i)}else delete this.collinear;const o=this.halfedges=this._delaunator.halfedges,s=this.hull=this._delaunator.hull,r=this.triangles=this._delaunator.triangles,a=this.inedges.fill(-1),l=this._hullIndex.fill(-1);for(let c=0,u=o.length;c<u;++c){const d=r[c%3===2?c-2:c+1];(o[c]===-1||a[d]===-1)&&(a[d]=c)}for(let c=0,u=s.length;c<u;++c)l[s[c]]=c;s.length<=2&&s.length>0&&(this.triangles=new Int32Array(3).fill(-1),this.halfedges=new Int32Array(3).fill(-1),this.triangles[0]=s[0],a[s[0]]=1,s.length===2&&(a[s[1]]=0,this.triangles[1]=s[1],this.triangles[2]=s[1]))}voronoi(e){return new Vo(this,e)}*neighbors(e){const{inedges:i,hull:o,_hullIndex:s,halfedges:r,triangles:a,collinear:l}=this;if(l){const h=l.indexOf(e);h>0&&(yield l[h-1]),h<l.length-1&&(yield l[h+1]);return}const c=i[e];if(c===-1)return;let u=c,d=-1;do{if(yield d=a[u],u=u%3===2?u-2:u+1,a[u]!==e)return;if(u=r[u],u===-1){const h=o[(s[e]+1)%o.length];h!==d&&(yield h);return}}while(u!==c)}find(e,i,o=0){if(e=+e,e!==e||(i=+i,i!==i))return-1;const s=o;let r;for(;(r=this._step(o,e,i))>=0&&r!==o&&r!==s;)o=r;return r}_step(e,i,o){const{inedges:s,hull:r,_hullIndex:a,halfedges:l,triangles:c,points:u}=this;if(s[e]===-1||!u.length)return(e+1)%(u.length>>1);let d=e,h=de(i-u[e*2],2)+de(o-u[e*2+1],2);const p=s[e];let f=p;do{let y=c[f];const v=de(i-u[y*2],2)+de(o-u[y*2+1],2);if(v<h&&(h=v,d=y),f=f%3===2?f-2:f+1,c[f]!==e)break;if(f=l[f],f===-1){if(f=r[(a[e]+1)%r.length],f!==y&&de(i-u[f*2],2)+de(o-u[f*2+1],2)<h)return f;break}}while(f!==p);return d}render(e){const i=e==null?e=new ae:void 0,{points:o,halfedges:s,triangles:r}=this;for(let a=0,l=s.length;a<l;++a){const c=s[a];if(c<a)continue;const u=r[a]*2,d=r[c]*2;e.moveTo(o[u],o[u+1]),e.lineTo(o[d],o[d+1])}return this.renderHull(e),i&&i.value()}renderPoints(e,i){i===void 0&&(!e||typeof e.moveTo!="function")&&(i=e,e=null),i=i==null?2:+i;const o=e==null?e=new ae:void 0,{points:s}=this;for(let r=0,a=s.length;r<a;r+=2){const l=s[r],c=s[r+1];e.moveTo(l+i,c),e.arc(l,c,i,0,Uo)}return o&&o.value()}renderHull(e){const i=e==null?e=new ae:void 0,{hull:o,points:s}=this,r=o[0]*2,a=o.length;e.moveTo(s[r],s[r+1]);for(let l=1;l<a;++l){const c=2*o[l];e.lineTo(s[c],s[c+1])}return e.closePath(),i&&i.value()}hullPolygon(){const e=new Nt;return this.renderHull(e),e.value()}renderTriangle(e,i){const o=i==null?i=new ae:void 0,{points:s,triangles:r}=this,a=r[e*=3]*2,l=r[e+1]*2,c=r[e+2]*2;return i.moveTo(s[a],s[a+1]),i.lineTo(s[l],s[l+1]),i.lineTo(s[c],s[c+1]),i.closePath(),o&&o.value()}*trianglePolygons(){const{triangles:e}=this;for(let i=0,o=e.length/3;i<o;++i)yield this.trianglePolygon(i)}trianglePolygon(e){const i=new Nt;return this.renderTriangle(e,i),i.value()}}function qo(n,e,i,o){const s=n.length,r=new Float64Array(s*2);for(let a=0;a<s;++a){const l=n[a];r[a*2]=e.call(o,l,a,n),r[a*2+1]=i.call(o,l,a,n)}return r}function*Bo(n,e,i,o){let s=0;for(const r of n)yield e.call(o,r,s,n),yield i.call(o,r,s,n),++s}function ti(n){return{originalBorder:n,flattenedPolygon:Un(n)[0]}}function Xo(n){if(n.length===0)return[0,0];const e=n.reduce((i,o)=>[i[0]+o[0],i[1]+o[1]],[0,0]);return[e[0]/n.length,e[1]/n.length]}function ni(n,e,i){const o={id:n,site:Xo(e),halfEdge:-1,bounds:Lt(e)},s=Pr(e,n,i);return s.length>0&&(o.halfEdge=s[0].id),o}function ii(n,e){const o=n.map(r=>Vt(r,e.originalBorder)).filter(Boolean).length;return o===0?null:o===n.length?n:br(n,e.flattenedPolygon)?.[0]??null}const Gt="VoronoiPieceGenerator",Yo={name:Gt,displayName:"Voronoi",description:"Construct pieces by building a Voronoi diagram from the seed points. Each piece consists of all area of the plane closer to its seed point than any other seed point. In practice, this creates irregular polygons with 3-8 sides.",sortHint:1,controls:[]};function Ko(n){return`${n[0].toPrecision(7)},${n[1].toPrecision(7)}`}function In(n,e){const o=e.flattenedPolygon;for(let s=0;s<o.length;s++){const r=o[s],a=o[(s+1)%o.length];if(Zo(n,r,a)<.001)return!0}return!1}function Zo(n,e,i){const[o,s]=n,[r,a]=e,[l,c]=i,u=l-r,d=c-a,h=u*u+d*d;if(h===0)return Math.hypot(o-r,s-a);let p=((o-r)*u+(s-a)*d)/h;p=Math.max(0,Math.min(1,p));const f=r+p*u,y=a+p*d;return Math.hypot(o-f,s-y)}const Jo=(n,e,i)=>{const{width:o,height:s}=e,r=ti(n);return{generatePieces(l,c){const{border:u}=c;console.log(`VoronoiPieceGenerator using dimensions ${o}x${s}`);const h=Ft.from(l).voronoi([0,0,o,s]),p={vertices:[],pieces:new Map,edges:new Map,halfEdges:new Map,boundary:[],borderPath:u},f=new Map;let y=0;for(let g=0;g<l.length;g++){const w=l[g],x=h.cellPolygon(g);if(!x)continue;const b=ii(x,r);if(!b)continue;const E=y++,P=ni(E,b,p);P.site=w,p.pieces.set(E,P);const I=[];let z=P.halfEdge;if(z!==-1){const C=z;do{const S=p.halfEdges.get(z);I.push(S),z=S.next}while(z!==C)}Fn(I,p,f,(C,S)=>In(C,r)&&In(S,r))}const v=new Map;for(const g of p.halfEdges.values()){const w=Ko(g.origin);v.has(w)||v.set(w,g.origin)}return p.vertices=Array.from(v.values()),p}}};He.register(Gt,Jo,Yo);const lt="SimpleTabPlacementStrategy",Qo={name:lt,displayName:"Simple",description:"Creates a single tab in the center of each edge with a random orientation.",sortHint:1,controls:[{type:"range",name:"tabSize",label:"Tab Size",optional:!0,min:.01,max:1,step:.01,defaultValue:.5,helpText:"The width of the tab as a fraction of the edge length"},{type:"number",name:"minEdgeLength",label:"Minimum Edge Length",optional:!0,defaultValue:15,helpText:"Edges shorter than this value will not have a tab"},{type:"number",name:"maxTabSize",label:"Maximum Tab Size",helpText:"Maximum width of a generated tab"}]};function zn(n,e,i,o){if(n.tabs=void 0,!(n.heRight!==-1))return;const r=e.halfEdges.get(n.heLeft),a=e.halfEdges.get(n.heRight);if(!r||!a)return;const l=r.origin,c=a.origin,u=Math.hypot(c[0]-l[0],c[1]-l[1]);if(u>=i.minEdgeLength){let d=i.tabSize;i.maxTabSize&&u*d>i.maxTabSize&&(d=i.maxTabSize/u);const h={position:.5,size:d,convex:o()>.5};n.tabs=[h]}}const es=(n,e,i)=>{const{tabSize:o=.5,minEdgeLength:s=0,maxTabSize:r}=i,a={tabSize:o,minEdgeLength:s,maxTabSize:r};return{placeTabs(l){const{topology:c,random:u}=l;for(const d of c.edges.values())zn(d,c,a,u)},updateTabPlacements(l,c){const{topology:u,random:d}=c;for(const h of l)zn(h,u,a,d)}}};Ve.register(lt,es,Qo);const jt="TraditionalTabGenerator",ts={name:jt,displayName:"Traditional",description:"Creates a traditional rounded tab for each (internal) piece edge.",sortHint:1,controls:[{type:"range",name:"jitter",label:"Randomness",defaultValue:8,min:0,max:100,step:1,helpText:"Adds randomness to the tab shape. 0 means completely uniform tabs"},{type:"range",name:"heightToWidthRatio",label:"Tab Height",defaultValue:50,min:5,max:100,step:5,helpText:"The height of the tab as a percent of its width"}]};function ns(n,e,i,o,s,r=!1){const a=e[0]-n[0],l=e[1]-n[1],c=Math.hypot(a,l);if(c===0)return console.warn("Edge has zero length"),[];const u=[a/c,l/c],d=[-u[1],u[0]],h=(T,D)=>[n[0]+(u[0]*T+d[0]*D)*c,n[1]+(u[1]*T+d[1]*D)*c],p=i/100,f=()=>(s()*2-1)*p,y=f(),v=f(),g=f(),w=f(),x=f(),b=.1625,E=r?-1:1,P=o,I=P/3,C=[[0,0],[.2,y*I],[.5+v+w,E*(-I+g*P)],[.5-b+v,E*(I+g*P)],[.5-2*b+v-w,E*(P+g*P)],[.5+2*b+v-w,E*(P+g*P)],[.5+b+v,E*(I+g*P)],[.5+v+w,E*(-I+g*P)],[.8,x*I],[1,0]].map(([T,D])=>h(T,D)),S={type:"bezier",p1:C[1],p2:C[2],p3:C[3]},_={type:"bezier",p1:C[4],p2:C[5],p3:C[6]},k={type:"bezier",p1:C[7],p2:C[8],p3:C[9]};return[S,_,k]}const is=(n,e,i)=>{const{jitter:o=8,heightToWidthRatio:s=50}=i;return{createTabSegments(a,l,c,u){const d=!c.convex;return ns(a,l,o,s/100,u,d)}}};le.register(jt,is,ts);function rs(n){return new Worker("/puzzle-generator/assets/CheckGeometryWorker-B-2izMXZ.js",{name:n?.name})}function os(n,e){return new Promise((i,o)=>{const s=new rs;s.onmessage=a=>{const l=a.data;switch(l.type){case"progress":e?.(l.processed,l.total);break;case"done":i(l.results),s.terminate();break;case"error":o(new Error(l.message)),s.terminate();break}},s.onerror=a=>{o(new Error(a.message)),s.terminate()};const r={topology:gr(n)};s.postMessage(r)})}const ri="GridJitterPointGenerator",ss={name:ri,displayName:"Grid",description:"Generate seed points using a grid with optional random jitter. Has a uniform, regular look, especially with low randomness values.",sortHint:2,controls:[{type:"range",name:"jitter",label:"Randomness",min:0,max:100,step:5,defaultValue:50,helpText:"Amount of jitter to apply to each grid point (0 to 100%)"}]},as=(n,e,i)=>{const{jitter:o=50}=i;return{generatePoints(r){const{width:a,height:l,pieceSize:c,random:u,border:d}=r,h=[];for(let p=0;p<a;p+=c)for(let f=0;f<l;f+=c){const y=[p+c/2,f+c/2];o>0&&(y[0]+=(u()-.5)*(o/100)*c,y[1]+=(u()-.5)*(o/100)*c),Vt(y,d)&&h.push(y)}return h}}};$e.register(ri,as,ss);const oi="RectangularPieceGenerator",ls={name:oi,displayName:"Rectangular",description:"Construct pieces from a regular grid. All pieces have 4 sides and are the same size (except when the border is irregular). This generator ignores seed points.",sortHint:2,controls:[]},cs=(n,e,i)=>{const{width:o,height:s}=e,r=ti(n);return{generatePieces(l,c){const{pieceSize:u,border:d}=c,h={vertices:[],pieces:new Map,edges:new Map,halfEdges:new Map,boundary:[],borderPath:d},p=Math.ceil(o/u),f=Math.ceil(s/u),y=Math.round(o/p),v=Math.round(s/f),g=[];for(let x=0;x<=f;x++){const b=[];for(let E=0;E<=p;E++){const P=E*y,I=x*v;b.push([P,I])}g.push(b)}h.vertices=g.flat();const w=new Map;for(let x=0;x<f;x++)for(let b=0;b<p;b++){const E=x*p+b,P=g[x][b],I=g[x][b+1],z=g[x+1][b],C=g[x+1][b+1],_=ii([P,I,C,z],r);if(!_)continue;const k=ni(E,_,h);h.pieces.set(E,k);const T=[];let D=k.halfEdge;if(D!==-1){const R=D;do{const L=h.halfEdges.get(D);T.push(L),D=L.next}while(D!==R)}Fn(T,h,w,(R,L)=>{const A=(ye,ht)=>Math.abs(ye-ht)<1e-6,O=A(R[1],P[1])&&A(L[1],P[1]),H=A(R[0],I[0])&&A(L[0],I[0]),$=A(R[1],z[1])&&A(L[1],z[1]),q=A(R[0],P[0])&&A(L[0],P[0]);return!(O||H||$||q)})}return h}}};He.register(oi,cs,ls);const si="NullTabGenerator",us={name:si,displayName:"None",description:"Do not generate tabs. All pieces have straight edges.",sortHint:3,controls:[]},hs=(n,e,i)=>({createTabSegments(s,r,a,l){return[]}});le.register(si,hs,us);const ai="TriangleTabGenerator",ds={name:ai,displayName:"Triangle",description:"Creates a simple triangle between each (internal) piece edge.",sortHint:2,controls:[]},ps=(n,e,i)=>({createTabSegments(s,r,a,l){const c=[r[0]-s[0],r[1]-s[1]],u=Math.hypot(c[0],c[1]);if(u<1e-6)return[];const d=[c[0]/u,c[1]/u],h=[-d[1],d[0]],p=[s[0]+c[0]/2,s[1]+c[1]/2],f=a.convex?1:-1,y=u*a.size*f,v=[p[0]+h[0]*y,p[1]+h[1]*y],g=[];return g.push({type:"line",p:s}),g.push({type:"line",p:v}),g.push({type:"line",p:r}),g}});le.register(ai,ps,ds);let $t=!1;const fs=window.matchMedia("(prefers-color-scheme: dark)");fs.matches&&($t=!0);const gs=()=>{const i=Ut,o=Gt,s=jt,r={seed:new Date().getTime()%10240,canvasWidth:800,canvasHeight:600,aspectRatio:800/600,distance:40,color:$t?"#DDDDDD":"#333333",drawPoints:!1,pointColor:$t?"#FF0000":"#0000FF",borderShape:"rectangle",borderCornerRadius:50,geometryProblems:{autoCheck:!1,problems:void 0,progress:void 0},dirty:!0,generators:{point:{label:"Seed Points",registry:$e,name:i,config:$e.getDefaultConfig(i,800,600)},piece:{label:"Piece Generation",registry:He,name:o,config:He.getDefaultConfig(o,800,600)},placement:{label:"Tab Placement",registry:Ve,name:lt,config:Ve.getDefaultConfig(lt,800,600)},tab:{label:"Tabs",registry:le,name:s,config:le.getDefaultConfig(s,800,600)}},puzzle:void 0,backgroundImageUrl:void 0,backgroundImageName:"",customPieces:[],selectedCustomPieceId:null,customPieceEditorOpen:!1,editingCustomPieceId:void 0};function a(){const{canvasWidth:g,canvasHeight:w,borderShape:x,borderCornerRadius:b}=r;switch(x){case"rectangle":return Ot(g,w);case"circle":return Sr(Math.min(g,w));case"ellipse":return Ir(g,w);case"rounded-rect":return zr(g,w,b);default:return Ot(g,w)}}function l(){r.customPieceEditorOpen=!0,r.editingCustomPieceId=void 0,m.redraw()}function c(g,w){const x=new Date().toISOString();if(r.editingCustomPieceId)r.customPieces=r.customPieces.map(b=>b.id===r.editingCustomPieceId?{...b,name:w,path:g,modified:x}:b);else{const b={id:`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:w,path:g,transform:{position:[r.canvasWidth/2,r.canvasHeight/2],rotation:0,scale:[1,1]},created:x};r.customPieces=[...r.customPieces,b]}r.customPieceEditorOpen=!1,r.editingCustomPieceId=void 0,r.dirty=!0,m.redraw()}function u(){r.customPieceEditorOpen=!1,r.editingCustomPieceId=void 0,m.redraw()}function d(g){r.selectedCustomPieceId=g,m.redraw()}function h(g){r.customPieces.find(x=>x.id===g)&&(r.editingCustomPieceId=g,r.customPieceEditorOpen=!0,m.redraw())}function p(g){const w=r.customPieces.find(x=>x.id===g);if(w){const x=new Date().toISOString(),b=w.name?(()=>{const P=/^(.*?)\s*\((\d+)\)$/,I=w.name.match(P);if(I){const z=I[1],C=parseInt(I[2],10);return`${z} (${C+1})`}return`${w.name} (2)`})():void 0,E={id:`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:b,path:[...w.path],transform:{position:[w.transform.position[0]+20,w.transform.position[1]+20],rotation:w.transform.rotation,scale:[...w.transform.scale]},created:x};r.customPieces=[...r.customPieces,E],r.selectedCustomPieceId=E.id,r.dirty=!0,m.redraw()}}function f(g){r.customPieces=r.customPieces.filter(w=>w.id!==g),r.selectedCustomPieceId===g&&(r.selectedCustomPieceId=null),r.dirty=!0,m.redraw()}function y(g){console.log(`Position custom piece: ${g}`),alert("Whimsy positioning functionality will be available in Phase 5")}function v(){r.puzzle&&(r.geometryProblems.progress=0,m.redraw(),os(r.puzzle,(g,w)=>{r.geometryProblems.progress=g/w*100,m.redraw()}).then(g=>{r.geometryProblems.problems=g.length,r.geometryProblems.progress=void 0,r.puzzle&&(r.puzzle.problems=g),m.redraw()}).catch(g=>{r.geometryProblems.progress=void 0,console.error(g),m.redraw()}))}return{oncreate:()=>{rt({bounds:{width:r.canvasWidth,height:r.canvasHeight},border:a(),pieceSize:r.distance,pointConfig:r.generators.point.config,pieceConfig:r.generators.piece.config,placementConfig:r.generators.placement.config,tabConfig:r.generators.tab.config,seed:r.seed,customPieces:r.customPieces}).then(g=>{r.puzzle=g,m.redraw(),r.geometryProblems.autoCheck&&v()}).catch(g=>{console.error(g)})},onupdate:()=>{r.dirty&&(r.dirty=!1,rt({bounds:{width:r.canvasWidth,height:r.canvasHeight},border:a(),pieceSize:r.distance,pointConfig:r.generators.point.config,pieceConfig:r.generators.piece.config,placementConfig:r.generators.placement.config,tabConfig:r.generators.tab.config,seed:r.seed,customPieces:r.customPieces}).then(g=>{r.geometryProblems.problems=void 0,r.geometryProblems.progress=void 0,r.puzzle=g,m.redraw(),r.geometryProblems.autoCheck&&v()}).catch(g=>{console.error(g)}))},onremove:()=>{r.backgroundImageUrl&&(URL.revokeObjectURL(r.backgroundImageUrl),r.backgroundImageUrl=void 0)},view:()=>m(".page",[m("h1","Puzzle Generator"),m(".container",[r.puzzle&&m(".puzzle-stack",[m(Dr,{width:r.canvasWidth,height:r.canvasHeight,color:r.color,imageUrl:r.backgroundImageUrl,puzzle:r.puzzle,isDirty:r.dirty,pointColor:r.drawPoints?r.pointColor:void 0,onPuzzleChanged:g=>{r.puzzle=g,m.redraw()},onSeedPointMoved:(g,w)=>{r.dirty=!1,r.puzzle&&Cr(r.puzzle,g,w).then(x=>{r.geometryProblems.problems=void 0,r.geometryProblems.progress=void 0,r.puzzle=x,m.redraw(),r.geometryProblems.autoCheck&&v()}).catch(x=>{console.error("Failed to rebuild puzzle with updated seed point:",x)})}}),m(".actions",[m(Lr,{puzzle:r.puzzle,width:r.canvasWidth,height:r.canvasHeight,color:r.color}),m(Or,{autoCheck:r.geometryProblems.autoCheck,problems:r.geometryProblems.problems,progressPercent:r.geometryProblems.progress,onCheckRequested:()=>{r.dirty||v(),m.redraw()},onAutocheckChanged:g=>{g!==r.geometryProblems.autoCheck&&(r.geometryProblems.autoCheck=g,m.redraw())}})])]),m(".controls",[m(".background-image",[m($r,{label:"Background Image",onUpload:(g,w,x,b)=>{r.backgroundImageUrl&&URL.revokeObjectURL(r.backgroundImageUrl),r.canvasWidth=x,r.canvasHeight=b,r.aspectRatio=x/b,r.backgroundImageUrl=g,r.backgroundImageName=w,r.dirty=!0,m.redraw()},onClear:()=>{r.backgroundImageUrl&&URL.revokeObjectURL(r.backgroundImageUrl),r.backgroundImageUrl=void 0,r.backgroundImageName="",r.dirty=!0,m.redraw()}})]),m(Ur,{ratio:r.aspectRatio,disabled:r.backgroundImageUrl!==void 0,onChange:g=>{r.aspectRatio=g,r.canvasWidth=r.canvasHeight*g,r.dirty=!0,m.redraw()}}),m(Gr,{shape:r.borderShape,disabled:r.backgroundImageUrl!==void 0,onChange:g=>{r.borderShape=g,r.dirty=!0,m.redraw()}}),r.borderShape==="rounded-rect"&&m(Je,{config:{name:"cornerRadius",label:"Corner Radius",type:"number"},value:r.borderCornerRadius,onChange:g=>{r.borderCornerRadius=g??50,r.dirty=!0,m.redraw()}}),m(Je,{config:{name:"seed",label:"Seed",type:"number"},value:r.seed,onChange:g=>{r.seed=g??0,r.dirty=!0,m.redraw()}}),m(Je,{config:{name:"pieceSize",label:"Piece size",type:"number"},value:r.distance,onChange:g=>{r.distance=g??0,r.dirty=!0,m.redraw()}}),m(cn,{label:"Piece color",color:r.color,size:"small",onUpdate:g=>{r.color=g,m.redraw()}}),m(".draw-points",[m(jn,{config:{name:"drawPoints",label:"Draw seed points",type:"boolean"},value:r.drawPoints,onChange:g=>{r.drawPoints=g,m.redraw()}}),r.drawPoints&&m(cn,{label:"Seed points color",color:r.pointColor,size:"small",onUpdate:g=>{r.pointColor=g,m.redraw()}})]),m(wo,{pieces:r.customPieces,selectedPieceId:r.selectedCustomPieceId,pieceColor:r.color,onAdd:l,onSelect:d,onEdit:h,onDuplicate:p,onDelete:f,onPosition:y}),...Object.entries(r.generators).map(([g,w])=>m("label",[w.label+":",m(Vr,{generator:w.name,registry:w.registry,config:w.config,onGeneratorChange:x=>{x!=w.name&&(console.log(`${g} generator changed to ${x}`),w.name=x,r.generators[g].config=w.registry.getDefaultConfig(x,r.canvasWidth,r.canvasHeight),r.dirty=!0,m.redraw())},onConfigChange:(x,b)=>{console.log(`${g} generator config "${x}" changed to ${String(b)}`),w.config[x]=b,r.dirty=!0,m.redraw()}})]))])]),m(fo,{open:r.customPieceEditorOpen,piece:r.editingCustomPieceId?r.customPieces.find(g=>g.id===r.editingCustomPieceId):void 0,onSave:c,onCancel:u})])}},ms=()=>{const n={initialPathToLoad:[],pathCommands:[],pathDataDisplay:"No path data yet",svgInputElement:void 0,importStatus:""},e=r=>{n.pathCommands=r,n.pathDataDisplay=JSON.stringify(r,null,2)},i=()=>{n.initialPathToLoad=[],n.pathCommands=[],n.pathDataDisplay="No path data yet",m.redraw()},o=()=>{const r=[{type:"move",p:[469.48276150227287,198.61914195331622]},{type:"line",p:[147.27539529214673,525.2460501911088]},{type:"bezier",p1:[119.6268609401618,551.2189519643504],p2:[149.62606858643616,580],p3:[178.36644877954177,551.7150560673149]},{type:"line",p:[206.99671887066515,523.5384839302747]},{type:"line",p:[241.34793037003863,560.4031774534698]},{type:"line",p:[264.8072838080452,537.7816545144234]},{type:"line",p:[232.96958275167054,503.43044775157955]},{type:"line",p:[252.23977895834645,484.99810098998205]},{type:"line",p:[268.15862475000426,500.91691362593315]},{type:"line",p:[287.4288209566801,483.32241157288445]},{type:"line",p:[273.1856361629428,466.5657068630892]},{type:"line",p:[296.07185058171,443.34292886551395]},{type:"line",p:[330.2814730038454,480.0802571096493]},{type:"line",p:[357.19242550437104,453.43183149484946]},{type:"line",p:[323.7943979441297,416.6172978193763]},{type:"line",p:[501.07659759926975,235.32345658662825]},{type:"bezier",p1:[501.07659759926975,235.32345658662825],p2:[558.04932730116,263.8097503896305],p3:[597.4275549500016,248.7287824622282]},{type:"bezier",p1:[636.805782598843,233.64776716953054],p2:[670.3190972878429,209.35060217868192],p3:[675.3461181738405,165.78319835239148]},{type:"bezier",p1:[680.3731390598382,122.21579452610115],p2:[659.4273055378894,78.6484143824585],p3:[625.9138961182989,49.324204822964475]},{type:"bezier",p1:[592.4005340640038,20],p2:[537.9412437571693,20.837830498960273],p3:[499.4008608168767,39.27018673361687]},{type:"bezier",p1:[460.8604778765839,57.70254770480301],p2:[438.239021248951,92.89158496660718],p3:[437.40117180387267,127.24280120251018]},{type:"bezier",p1:[436.5633223587943,161.59402217494272],p2:[469.4827615022728,198.61914195331644],p3:[469.4827615022728,198.61914195331644]},{type:"line",p:[469.48276150227287,198.61914195331622]}];n.initialPathToLoad=r,n.pathCommands=r,n.pathDataDisplay=JSON.stringify(r,null,2),m.redraw()},s=r=>{if(r.redraw=!1,!n.svgInputElement)return;const a=n.svgInputElement.files?.[0];if(!a)return;if(a.type!=="image/svg+xml"&&!a.name.endsWith(".svg")){n.importStatus="Error: Please select an SVG file",m.redraw();return}const l=new FileReader;l.onload=c=>{const u=c.target?.result;if(!u){n.importStatus="Error: Could not read file",m.redraw();return}const d=Yn(u);if(!d){n.importStatus="Error: Could not parse SVG path",m.redraw();return}const h=Kn(d.commands,800,600);n.initialPathToLoad=h,n.pathCommands=h,n.pathDataDisplay=JSON.stringify(h,null,2),d.warning?n.importStatus=`Warning: ${d.warning}`:n.importStatus=`Imported: ${a.name}`,m.redraw()},l.onerror=()=>{n.importStatus="Error: Failed to read file",m.redraw()},l.readAsText(a),n.svgInputElement.value=""};return{view:()=>m(".page",[m("h1","Path Editor"),m("p","Testing the PathEditor component."),m(".test-page",[m(".test-area",[m(Bn,{width:800,height:600,initialPath:n.initialPathToLoad,onPathChanged:e,strokeColor:"#000000ff"})]),m(".controls",[m("h2","Controls"),m(".button-group",[m("button",{onclick:i,style:"background: #f44336;"},"Clear Canvas"),m("button",{onclick:o,style:"background: #4CAF50;"},"Load Sample Path"),m("button",{onclick:()=>{n.svgInputElement&&n.svgInputElement.click()},style:"background: #2196F3;"},"Import SVG"),m("input[type=file]",{style:{display:"none"},accept:".svg,image/svg+xml",oncreate:({dom:r})=>{n.svgInputElement=r},onchange:s})]),n.importStatus&&m("p",{style:`margin-top: 0.5rem; color: ${n.importStatus.startsWith("Error")?"#f44336":n.importStatus.startsWith("Warning")?"#FF9800":"#4CAF50"};`},n.importStatus),m(".instructions",[m("h3",{style:"margin-top: 1rem;"},"Instructions:"),m("p","The editor has two modes:"),m("ul",{style:"margin: 0.5rem 0;"},[m("li",m("strong","Drawing Mode"),": Click to add points (straight lines), or click-drag to add points with smooth bezier curves"),m("ul",{style:"margin-left: 1rem;"},[m("li","Move near the first point to see a green circle indicator - click to close the path"),m("li","Closing the path automatically switches to Edit mode"),m("li","Or click ",m("strong","End Drawing")," to finish without closing")]),m("li",m("strong","Editing Mode"),":"),m("ul",{style:"margin-left: 1rem;"},[m("li","Click anywhere on the path to select it and show all vertices"),m("li","Click a specific vertex to select it (turns blue), then drag to move it"),m("li","Drag curve handles to adjust curve shape"),m("li","Hold ",m("strong","Shift")," and click on the path to insert a new point"),m("li","Select a vertex and press ",m("strong","Delete")," or ",m("strong","Backspace")," to remove it"),m("li","Click empty space to deselect")]),m("li","The mode indicator below the canvas shows the current mode")]),m("h3",{style:"margin-top: 1rem;"},"Pan and Zoom:"),m("ul",{style:"margin: 0.5rem 0;"},[m("li","Hold ",m("strong","Spacebar")," and drag to pan the canvas"),m("li","Use ",m("strong","mouse wheel")," to zoom in/out (zooms toward cursor position)"),m("li","Use the ",m("strong","Zoom dropdown")," to select preset zoom levels (25%, 50%, 100%, 200%, 400%)"),m("li","Click the ",m("strong","Recenter button")," to reset view to 100% zoom and center position")])])]),m(".data-display",[m("h2","Path Data"),m("h3","PathCommand[] Format:"),m("textarea",{readonly:!0,value:n.pathDataDisplay,rows:15,style:"font-family: monospace; font-size: 12px; width: 100%;"})])])])}};function ys(){const n=window.matchMedia("(prefers-color-scheme: dark)");function e(){n.matches?document.documentElement.classList.add("wa-dark"):document.documentElement.classList.remove("wa-dark")}e(),n.addEventListener("change",e)}ys();const En={view:n=>[m(ui,{link:"https://github.com/weevilgenius/puzzle-generator"}),m(hi),n.children]};li("material",{resolver:n=>{const e=n.match(/^(.*?)(_(rounded|sharp))?$/);return e?`https://cdn.jsdelivr.net/npm/@material-symbols/svg-400@0.32.0/${e[3]??"outlined"}/${e[1]}.svg`:""},mutator:n=>n.setAttribute("fill","currentColor")});m.route(document.body,"/puzzle",{"/puzzle":{render:()=>m(En,m(gs))},"/test":{render:()=>m(En,m(ms))}});
//# sourceMappingURL=index-DLMBskof.js.map
