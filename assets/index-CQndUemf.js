import{m as g,a as _n}from"./mithril-CdZ0BR3D.js";import{r as pi}from"./webawesome-DgEd3PYa.js";import{P as fi}from"./paper-rdR45VFZ.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const mi={view:({attrs:i})=>g("a.github-corner",{href:i.link,"aria-label":"View source on GitHub",title:"View source on GitHub",target:"_blank"},g("svg",{width:80,height:80,viewBox:"0 0 250 250","aria-hidden":"true"},[g("path",{d:"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"}),g("path.octo-arm",{fill:"currentColor",style:"transform-origin: 130px 106px;",d:"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"}),g("path.octo-body",{fill:"currentColor",d:"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"})]))},gi={view:()=>{const i=g.route.get();return g("nav.navigation",[g("div.nav-links",g("wa-radio-group",{orientation:"horizontal",value:i,onchange:e=>{e.redraw=!1;const n=e.target;g.route.set(String(n.value))}},[g("wa-radio",{appearance:"button",value:"/puzzle"},"Puzzle Generator"),g("wa-radio",{appearance:"button",value:"/test"},"Test Harness")]))])}},Bt=50,Yt=5,yi=Yt*Yt,vi=.1,wi=10,dt=1,Pi=.025,bi=[.25,.5,1,2,4],xi=["25%","50%","100%","200%","400%"];function nt(i,e){const n=!!i&&!!i.project&&!!i.project.activeLayer&&!!i.view&&!!i.view._context&&i.view._visible!==!1;return n||console.warn(`[${e}] Paper not ready`,{hasScope:!!i,hasProject:!!i?.project,hasLayer:!!i?.project?.activeLayer,hasView:!!i?.view,ctx:!!i?.view?._context,visible:i?.view?._visible}),n}function V(i,e,n){try{return i.scope.activate(),n()}catch(o){console.error(`[${e}] block in paper scope failed`,o)}}function Dn(i,e,n){const o=new fi.PaperScope;return o.setup(i),o.view.viewSize=new o.Size(e,n),{scope:o}}function Ci(i){const e=[];if(i.segments.length===0)return e;const n=i.segments[0],o={type:"move",p:[n.point.x,n.point.y]};e.push(o);for(let s=1;s<i.segments.length;s++){const r=i.segments[s-1],a=i.segments[s];if(r.handleOut&&r.handleOut.length>0||a.handleIn&&a.handleIn.length>0){const c=r.handleOut?[r.point.x+r.handleOut.x,r.point.y+r.handleOut.y]:[r.point.x,r.point.y],u=a.handleIn?[a.point.x+a.handleIn.x,a.point.y+a.handleIn.y]:[a.point.x,a.point.y],d={type:"bezier",p1:c,p2:u,p3:[a.point.x,a.point.y]};e.push(d)}else{const c={type:"line",p:[a.point.x,a.point.y]};e.push(c)}}if(i.closed&&i.segments.length>=2){const s=i.segments[i.segments.length-1],r=i.segments[0];if(s.handleOut&&s.handleOut.length>0||r.handleIn&&r.handleIn.length>0){const l=s.handleOut?[s.point.x+s.handleOut.x,s.point.y+s.handleOut.y]:[s.point.x,s.point.y],c=r.handleIn?[r.point.x+r.handleIn.x,r.point.y+r.handleIn.y]:[r.point.x,r.point.y],u={type:"bezier",p1:l,p2:c,p3:[r.point.x,r.point.y]};e.push(u)}else{const l={type:"line",p:[r.point.x,r.point.y]};e.push(l)}}return e}function _t(i,e){const n=e.scope,o=new n.Path;if(i.length===0)return o;let s=null;for(const r of i)switch(r.type){case"move":{const[a,l]=r.p;s=new n.Point(a,l),o.moveTo(s);break}case"line":{const[a,l]=r.p;s=new n.Point(a,l),o.lineTo(s);break}case"bezier":{if(!s){console.warn("paperUtils: CurveTo command without a current point, skipping");break}const[a,l]=r.p1,[c,u]=r.p2,[d,h]=r.p3,p=new n.Point(d,h),f=new n.Point(a,l),y=new n.Point(c,u);o.add(p);const w=o.lastSegment,m=y.subtract(p);if(w.handleIn=m,o.segments.length>=2){const v=f.subtract(s);o.segments[o.segments.length-2].handleOut=v}s=p;break}case"arc":console.warn("paperUtils: Arc commands not yet supported, skipping arc command");break}return o}function Ii(i,e,n){const o=n.scope,s=new o.Group,r=_t(i.borderPath,n);r.strokeColor=new o.Color(e),r.strokeWidth=1,r.data.isBorder=!0,s.addChild(r);for(const a of i.pieces.values()){const l=Si(a,i,n);l.strokeColor=new o.Color(e),l.strokeWidth=1,l.data.pieceId=a.id,s.addChild(l)}return s}function Si(i,e,n){const o=n.scope,s=new o.Path;let r=e.halfEdges.get(i.halfEdge);if(!r)return s;const a=r.id;s.moveTo(new o.Point(r.origin[0],r.origin[1]));do{if(r.segments)for(const l of r.segments)zi(s,l,n);else{const l=e.halfEdges.get(r.next);s.lineTo(new o.Point(l.origin[0],l.origin[1]))}r=e.halfEdges.get(r.next)}while(r.id!==a);return s}function zi(i,e,n){const o=n.scope;switch(e.type){case"line":{i.lineTo(new o.Point(e.p[0],e.p[1]));break}case"bezier":{i.cubicCurveTo(new o.Point(e.p1[0],e.p1[1]),new o.Point(e.p2[0],e.p2[1]),new o.Point(e.p3[0],e.p3[1]));break}}}function Ei(i,e,n,o){if(e.removeChildren(),!n)return;const s=o.scope;for(const r of i.pieces.values()){const[a,l]=r.site,c=new s.Path.Circle(new s.Point(a,l),3);c.fillColor=new s.Color(n),c.data.pieceId=r.id,e.addChild(c)}}function Ti(i,e,n){if(e.removeChildren(),!i.problems||i.problems.length===0)return;const o=n.scope;for(const s of i.problems){const[r,a]=s,l=new o.Path.Circle(new o.Point(r,a),8);l.strokeColor=new o.Color("red"),l.strokeWidth=2,e.addChild(l)}}function ki(i,e){return e()}async function Mi(i,e){return e()}function _i(i,e,n,o){o.paperCtx=Dn(i,e,n),o.paperCtx||console.error("PuzzleRenderer: Failed to create Paper.js context")}function it(i,e,n,o){if(!i.paperCtx){console.error("PuzzleRenderer: Cannot render - Paper.js context not initialized");return}ki("Paper.js Rendering",()=>{V(i.paperCtx,"PuzzleRenderer:renderPuzzle",()=>{const s=i.paperCtx.scope;if(!nt(s,"PuzzleRenderer:renderPuzzle")){console.error("PuzzleRenderer: Paper.js not ready - canvas may have been replaced");return}i.puzzleLayer&&i.puzzleLayer.activate(),i.paperPath&&(i.paperPath.remove(),i.paperPath=null),i.paperPath=Ii(e,n,i.paperCtx),i.verticesLayer&&i.verticesLayer.activate(),Li(e,i),i.seedPointsLayer&&i.seedPointsLayer.activate(),i.seedPointItems&&i.paperCtx&&Ei(e,i.seedPointItems,o,i.paperCtx),i.problemsLayer&&i.problemsLayer.activate(),i.problemItems&&i.paperCtx&&Ti(e,i.problemItems,i.paperCtx),s.view.update()})})}function Di(i){if(!i.paperCtx){console.error("PuzzleRenderer: Cannot create layers - Paper.js context not initialized");return}V(i.paperCtx,"PuzzleRenderer:createPaperLayers",()=>{const e=i.paperCtx.scope;if(!nt(e,"PuzzleRenderer:createPaperLayers")){console.error("PuzzleRenderer: Paper.js not ready - canvas may have been replaced");return}i.puzzleLayer=new e.Layer,i.customPiecesLayer=new e.Layer,i.customHandlesLayer=new e.Layer,i.seedPointsLayer=new e.Layer,i.verticesLayer=new e.Layer,i.problemsLayer=new e.Layer,i.puzzleLayer.activate(),i.backgroundRaster=null,i.paperPath=null,i.seedPointsLayer.activate(),i.seedPointItems=new e.Group,i.problemsLayer.activate(),i.problemItems=new e.Group,i.verticesLayer.activate(),i.vertexItems=new e.Group,i.puzzleLayer.activate()})}function Kt(i,e,n,o){if(!i.paperCtx){console.error("PuzzleRenderer: Cannot update background - Paper.js context not initialized");return}V(i.paperCtx,"PuzzleRenderer:updateBackgroundImage",()=>{const s=i.paperCtx.scope;if(i.puzzleLayer&&i.puzzleLayer.activate(),i.backgroundRaster&&(i.backgroundRaster.remove(),i.backgroundRaster=null),e){const r=new s.Raster(e);r.position=new s.Point(n/2,o/2),r.onLoad=()=>{if(r.width&&r.height){const a=n/r.width,l=o/r.height;r.scale(a,l)}},r.sendToBack(),i.backgroundRaster=r}})}function Ln(i){const e=new Set;for(const n of i.halfEdges.values())if(n.twin===-1){const o=i.vertices.findIndex(s=>s[0]===n.origin[0]&&s[1]===n.origin[1]);o>=0&&e.add(o)}return e}function Li(i,e){if(!e.vertexItems||!e.paperCtx)return;const n=e.paperCtx.scope;e.vertexItems.removeChildren();const o=Ln(i);for(let s=0;s<i.vertices.length;s++){if(o.has(s))continue;const[r,a]=i.vertices[s],l=new n.Path.Circle(new n.Point(r,a),4);l.fillColor=new n.Color("#4363d8"),l.strokeColor=new n.Color("#ffffff"),l.strokeWidth=1,l.visible=!1,l.data.vertexId=s,e.vertexItems.addChild(l)}}function An(i,e){const n=new e.Path;for(const o of i)switch(o.type){case"move":n.moveTo(new e.Point(o.p[0],o.p[1]));break;case"line":n.lineTo(new e.Point(o.p[0],o.p[1]));break;case"bezier":n.cubicCurveTo(new e.Point(o.p1[0],o.p1[1]),new e.Point(o.p2[0],o.p2[1]),new e.Point(o.p3[0],o.p3[1]));break;case"arc":n.lineTo(new e.Point(o.p[0],o.p[1]));break}return n}function Dt(i,e,n,o){!i.paperCtx||!i.customPiecesLayer||V(i.paperCtx,"PuzzleRenderer:renderCustomPieces",()=>{const s=i.paperCtx.scope;i.customPiecesLayer.activate(),i.customPiecesLayer.removeChildren();for(const r of e){const a=An(r.path,s),{position:l,rotation:c,scale:u}=r.transform;a.position=new s.Point(0,0),a.scale(u[0],u[1]),a.rotate(c*(180/Math.PI)),a.position=new s.Point(l[0],l[1]),r.id===o?(a.fillColor=new s.Color(0,.5,1,.3),a.strokeColor=new s.Color(0,.5,1),a.strokeWidth=2):(a.fillColor=null,a.strokeColor=new s.Color(n),a.strokeWidth=1),a.data.customPieceId=r.id}})}function Lt(i,e){!i.paperCtx||!i.customHandlesLayer||V(i.paperCtx,"PuzzleRenderer:renderCustomPieceHandles",()=>{const n=i.paperCtx.scope;i.customHandlesLayer.activate(),i.customHandlesLayer.removeChildren();const o=An(e.path,n);o.position=new n.Point(0,0);const s=o.bounds;o.remove();const{scale:r,rotation:a,position:l}=e.transform,u=[s.topLeft,s.topRight,s.bottomRight,s.bottomLeft].map(D=>{const L=D.x*r[0],R=D.y*r[1],A=Math.cos(a),O=Math.sin(a),$=L*A-R*O,N=L*O+R*A;return new n.Point($+l[0],N+l[1])}),d=new n.Path;d.moveTo(u[0]),d.lineTo(u[1]),d.lineTo(u[2]),d.lineTo(u[3]),d.closePath(),d.strokeColor=new n.Color(0,.5,1),d.strokeWidth=1,d.dashArray=[4,4],d.data.handleType="bbox",i.customHandlesLayer.addChild(d);const h=4,p=["nw","ne","se","sw"];u.forEach((D,L)=>{const R=new n.Path.Circle(D,h);R.fillColor=new n.Color(1,1,1),R.strokeColor=new n.Color(0,.5,1),R.strokeWidth=2,R.data.handleType="scale",R.data.corner=p[L],i.customHandlesLayer.addChild(R)});const f=40,y=new n.Point(s.center.x,s.top),w=y.x*r[0],m=y.y*r[1],v=Math.cos(a),b=Math.sin(a),P=w*v-m*b,E=w*b+m*v,x=new n.Point(P+l[0],E+l[1]),S=0,z=-f,C=S*v-z*b,I=S*b+z*v,T=new n.Point(x.x+C,x.y+I),k=new n.Path.Line(x,T);k.strokeColor=new n.Color(0,.5,1),k.strokeWidth=1,k.dashArray=[4,4],k.data.handleType="rotation-line",i.customHandlesLayer.addChild(k);const M=new n.Path.Circle(T,h);M.fillColor=new n.Color(1,1,1),M.strokeColor=new n.Color(0,.5,1),M.strokeWidth=2,M.data.handleType="rotation",i.customHandlesLayer.addChild(M)})}function pt(i){i.customHandlesLayer&&i.customHandlesLayer.removeChildren()}function Ai(i){i.backgroundRaster&&(i.backgroundRaster.remove(),i.backgroundRaster=null),i.paperPath&&(i.paperPath.remove(),i.paperPath=null),i.seedPointItems&&(i.seedPointItems.remove(),i.seedPointItems=null),i.problemItems&&(i.problemItems.remove(),i.problemItems=null),i.vertexItems&&(i.vertexItems.remove(),i.vertexItems=null),i.puzzleLayer&&(i.puzzleLayer.remove(),i.puzzleLayer=null),i.customPiecesLayer&&(i.customPiecesLayer.remove(),i.customPiecesLayer=null),i.customHandlesLayer&&(i.customHandlesLayer.remove(),i.customHandlesLayer=null),i.seedPointsLayer&&(i.seedPointsLayer.remove(),i.seedPointsLayer=null),i.verticesLayer&&(i.verticesLayer.remove(),i.verticesLayer=null),i.problemsLayer&&(i.problemsLayer.remove(),i.problemsLayer=null),i.paperCtx&&i.paperCtx.scope.project.remove()}class ut{generators=new Map;register(e,n,o){this.generators.has(e)&&console.warn(`Generator "${e}" is already registered, overwriting`),this.generators.set(e,{factory:n,uiMetadata:o})}create(e,n,o){const s=this.generators.get(o.name);if(!s)throw new Error(`Unknown generator "${o.name}". Is it registered?`);return s.factory(e,n,o)}getAvailableGenerators(){return Array.from(this.generators.values()).sort((e,n)=>e.uiMetadata.sortHint-n.uiMetadata.sortHint).map(e=>({name:e.uiMetadata.name,displayName:e.uiMetadata.displayName}))}getUIMetadata(e){return this.generators.get(e)?.uiMetadata}getDefaultConfig(e,n,o){const s={name:e,width:n,height:o},r=this.getUIMetadata(e);if(r)for(const a of r.controls)s[a.name]=a.defaultValue;return s}}const Ue=new ut,Fe=new ut,Ve=new ut,ce=new ut;let Ri=0;function Rn(){return Ri++}const{abs:Pe,cos:Y,sin:ue,acos:Oi,atan2:be,sqrt:J,pow:W}=Math;function xe(i){return i<0?-W(-i,1/3):W(i,1/3)}const On=Math.PI,qe=2*On,Q=On/2,Hi=1e-6,ft=Number.MAX_SAFE_INTEGER||9007199254740991,mt=Number.MIN_SAFE_INTEGER||-9007199254740991,Ni={x:0,y:0,z:0},_={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(i,e){const n=e(i);let o=n.x*n.x+n.y*n.y;return typeof n.z<"u"&&(o+=n.z*n.z),J(o)},compute:function(i,e,n){if(i===0)return e[0].t=0,e[0];const o=e.length-1;if(i===1)return e[o].t=1,e[o];const s=1-i;let r=e;if(o===0)return e[0].t=i,e[0];if(o===1){const l={x:s*r[0].x+i*r[1].x,y:s*r[0].y+i*r[1].y,t:i};return n&&(l.z=s*r[0].z+i*r[1].z),l}if(o<4){let l=s*s,c=i*i,u,d,h,p=0;o===2?(r=[r[0],r[1],r[2],Ni],u=l,d=s*i*2,h=c):o===3&&(u=l*s,d=l*i*3,h=s*c*3,p=i*c);const f={x:u*r[0].x+d*r[1].x+h*r[2].x+p*r[3].x,y:u*r[0].y+d*r[1].y+h*r[2].y+p*r[3].y,t:i};return n&&(f.z=u*r[0].z+d*r[1].z+h*r[2].z+p*r[3].z),f}const a=JSON.parse(JSON.stringify(e));for(;a.length>1;){for(let l=0;l<a.length-1;l++)a[l]={x:a[l].x+(a[l+1].x-a[l].x)*i,y:a[l].y+(a[l+1].y-a[l].y)*i},typeof a[l].z<"u"&&(a[l].z=a[l].z+(a[l+1].z-a[l].z)*i);a.splice(a.length-1,1)}return a[0].t=i,a[0]},computeWithRatios:function(i,e,n,o){const s=1-i,r=n,a=e;let l=r[0],c=r[1],u=r[2],d=r[3],h;if(l*=s,c*=i,a.length===2)return h=l+c,{x:(l*a[0].x+c*a[1].x)/h,y:(l*a[0].y+c*a[1].y)/h,z:o?(l*a[0].z+c*a[1].z)/h:!1,t:i};if(l*=s,c*=2*s,u*=i*i,a.length===3)return h=l+c+u,{x:(l*a[0].x+c*a[1].x+u*a[2].x)/h,y:(l*a[0].y+c*a[1].y+u*a[2].y)/h,z:o?(l*a[0].z+c*a[1].z+u*a[2].z)/h:!1,t:i};if(l*=s,c*=1.5*s,u*=3*s,d*=i*i*i,a.length===4)return h=l+c+u+d,{x:(l*a[0].x+c*a[1].x+u*a[2].x+d*a[3].x)/h,y:(l*a[0].y+c*a[1].y+u*a[2].y+d*a[3].y)/h,z:o?(l*a[0].z+c*a[1].z+u*a[2].z+d*a[3].z)/h:!1,t:i}},derive:function(i,e){const n=[];for(let o=i,s=o.length,r=s-1;s>1;s--,r--){const a=[];for(let l=0,c;l<r;l++)c={x:r*(o[l+1].x-o[l].x),y:r*(o[l+1].y-o[l].y)},e&&(c.z=r*(o[l+1].z-o[l].z)),a.push(c);n.push(a),o=a}return n},between:function(i,e,n){return e<=i&&i<=n||_.approximately(i,e)||_.approximately(i,n)},approximately:function(i,e,n){return Pe(i-e)<=(n||Hi)},length:function(i){const n=_.Tvalues.length;let o=0;for(let s=0,r;s<n;s++)r=.5*_.Tvalues[s]+.5,o+=_.Cvalues[s]*_.arcfn(r,i);return .5*o},map:function(i,e,n,o,s){const r=n-e,a=s-o,l=i-e,c=l/r;return o+a*c},lerp:function(i,e,n){const o={x:e.x+i*(n.x-e.x),y:e.y+i*(n.y-e.y)};return e.z!==void 0&&n.z!==void 0&&(o.z=e.z+i*(n.z-e.z)),o},pointToString:function(i){let e=i.x+"/"+i.y;return typeof i.z<"u"&&(e+="/"+i.z),e},pointsToString:function(i){return"["+i.map(_.pointToString).join(", ")+"]"},copy:function(i){return JSON.parse(JSON.stringify(i))},angle:function(i,e,n){const o=e.x-i.x,s=e.y-i.y,r=n.x-i.x,a=n.y-i.y,l=o*a-s*r,c=o*r+s*a;return be(l,c)},round:function(i,e){const n=""+i,o=n.indexOf(".");return parseFloat(n.substring(0,o+1+e))},dist:function(i,e){const n=i.x-e.x,o=i.y-e.y;return J(n*n+o*o)},closest:function(i,e){let n=W(2,63),o,s;return i.forEach(function(r,a){s=_.dist(e,r),s<n&&(n=s,o=a)}),{mdist:n,mpos:o}},abcratio:function(i,e){if(e!==2&&e!==3)return!1;if(typeof i>"u")i=.5;else if(i===0||i===1)return i;const n=W(i,e)+W(1-i,e),o=n-1;return Pe(o/n)},projectionratio:function(i,e){if(e!==2&&e!==3)return!1;if(typeof i>"u")i=.5;else if(i===0||i===1)return i;const n=W(1-i,e),o=W(i,e)+n;return n/o},lli8:function(i,e,n,o,s,r,a,l){const c=(i*o-e*n)*(s-a)-(i-n)*(s*l-r*a),u=(i*o-e*n)*(r-l)-(e-o)*(s*l-r*a),d=(i-n)*(r-l)-(e-o)*(s-a);return d==0?!1:{x:c/d,y:u/d}},lli4:function(i,e,n,o){const s=i.x,r=i.y,a=e.x,l=e.y,c=n.x,u=n.y,d=o.x,h=o.y;return _.lli8(s,r,a,l,c,u,d,h)},lli:function(i,e){return _.lli4(i,i.c,e,e.c)},makeline:function(i,e){return new H(i.x,i.y,(i.x+e.x)/2,(i.y+e.y)/2,e.x,e.y)},findbbox:function(i){let e=ft,n=ft,o=mt,s=mt;return i.forEach(function(r){const a=r.bbox();e>a.x.min&&(e=a.x.min),n>a.y.min&&(n=a.y.min),o<a.x.max&&(o=a.x.max),s<a.y.max&&(s=a.y.max)}),{x:{min:e,mid:(e+o)/2,max:o,size:o-e},y:{min:n,mid:(n+s)/2,max:s,size:s-n}}},shapeintersections:function(i,e,n,o,s){if(!_.bboxoverlap(e,o))return[];const r=[],a=[i.startcap,i.forward,i.back,i.endcap],l=[n.startcap,n.forward,n.back,n.endcap];return a.forEach(function(c){c.virtual||l.forEach(function(u){if(u.virtual)return;const d=c.intersects(u,s);d.length>0&&(d.c1=c,d.c2=u,d.s1=i,d.s2=n,r.push(d))})}),r},makeshape:function(i,e,n){const o=e.points.length,s=i.points.length,r=_.makeline(e.points[o-1],i.points[0]),a=_.makeline(i.points[s-1],e.points[0]),l={startcap:r,forward:i,back:e,endcap:a,bbox:_.findbbox([r,i,e,a])};return l.intersections=function(c){return _.shapeintersections(l,l.bbox,c,c.bbox,n)},l},getminmax:function(i,e,n){if(!n)return{min:0,max:0};let o=ft,s=mt,r,a;n.indexOf(0)===-1&&(n=[0].concat(n)),n.indexOf(1)===-1&&n.push(1);for(let l=0,c=n.length;l<c;l++)r=n[l],a=i.get(r),a[e]<o&&(o=a[e]),a[e]>s&&(s=a[e]);return{min:o,mid:(o+s)/2,max:s,size:s-o}},align:function(i,e){const n=e.p1.x,o=e.p1.y,s=-be(e.p2.y-o,e.p2.x-n),r=function(a){return{x:(a.x-n)*Y(s)-(a.y-o)*ue(s),y:(a.x-n)*ue(s)+(a.y-o)*Y(s)}};return i.map(r)},roots:function(i,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const n=i.length-1,o=_.align(i,e),s=function(z){return 0<=z&&z<=1};if(n===2){const z=o[0].y,C=o[1].y,I=o[2].y,T=z-2*C+I;if(T!==0){const k=-J(C*C-z*I),M=-z+C,D=-(k+M)/T,L=-(-k+M)/T;return[D,L].filter(s)}else if(C!==I&&T===0)return[(2*C-I)/(2*C-2*I)].filter(s);return[]}const r=o[0].y,a=o[1].y,l=o[2].y,c=o[3].y;let u=-r+3*a-3*l+c,d=3*r-6*a+3*l,h=-3*r+3*a,p=r;if(_.approximately(u,0)){if(_.approximately(d,0))return _.approximately(h,0)?[]:[-p/h].filter(s);const z=J(h*h-4*d*p),C=2*d;return[(z-h)/C,(-h-z)/C].filter(s)}d/=u,h/=u,p/=u;const f=(3*h-d*d)/3,y=f/3,w=(2*d*d*d-9*d*h+27*p)/27,m=w/2,v=m*m+y*y*y;let b,P,E,x,S;if(v<0){const z=-f/3,C=z*z*z,I=J(C),T=-w/(2*I),k=T<-1?-1:T>1?1:T,M=Oi(k),D=xe(I),L=2*D;return E=L*Y(M/3)-d/3,x=L*Y((M+qe)/3)-d/3,S=L*Y((M+2*qe)/3)-d/3,[E,x,S].filter(s)}else{if(v===0)return b=m<0?xe(-m):-xe(m),E=2*b-d/3,x=-b-d/3,[E,x].filter(s);{const z=J(v);return b=xe(-m+z),P=xe(m+z),[b-P-d/3].filter(s)}}},droots:function(i){if(i.length===3){const e=i[0],n=i[1],o=i[2],s=e-2*n+o;if(s!==0){const r=-J(n*n-e*o),a=-e+n,l=-(r+a)/s,c=-(-r+a)/s;return[l,c]}else if(n!==o&&s===0)return[(2*n-o)/(2*(n-o))];return[]}if(i.length===2){const e=i[0],n=i[1];return e!==n?[e/(e-n)]:[]}return[]},curvature:function(i,e,n,o,s){let r,a,l,c,u=0,d=0;const h=_.compute(i,e),p=_.compute(i,n),f=h.x*h.x+h.y*h.y;if(o?(r=J(W(h.y*p.z-p.y*h.z,2)+W(h.z*p.x-p.z*h.x,2)+W(h.x*p.y-p.x*h.y,2)),a=W(f+h.z*h.z,3/2)):(r=h.x*p.y-h.y*p.x,a=W(f,3/2)),r===0||a===0)return{k:0,r:0};if(u=r/a,d=a/r,!s){const y=_.curvature(i-.001,e,n,o,!0).k,w=_.curvature(i+.001,e,n,o,!0).k;c=(w-u+(u-y))/2,l=(Pe(w-u)+Pe(u-y))/2}return{k:u,r:d,dk:c,adk:l}},inflections:function(i){if(i.length<4)return[];const e=_.align(i,{p1:i[0],p2:i.slice(-1)[0]}),n=e[2].x*e[1].y,o=e[3].x*e[1].y,s=e[1].x*e[2].y,r=e[3].x*e[2].y,a=18*(-3*n+2*o+3*s-r),l=18*(3*n-o-3*s),c=18*(s-n);if(_.approximately(a,0)){if(!_.approximately(l,0)){let p=-c/l;if(0<=p&&p<=1)return[p]}return[]}const u=2*a;if(_.approximately(u,0))return[];const d=l*l-4*a*c;if(d<0)return[];const h=Math.sqrt(d);return[(h-l)/u,-(l+h)/u].filter(function(p){return 0<=p&&p<=1})},bboxoverlap:function(i,e){const n=["x","y"],o=n.length;for(let s=0,r,a,l,c;s<o;s++)if(r=n[s],a=i[r].mid,l=e[r].mid,c=(i[r].size+e[r].size)/2,Pe(a-l)>=c)return!1;return!0},expandbox:function(i,e){e.x.min<i.x.min&&(i.x.min=e.x.min),e.y.min<i.y.min&&(i.y.min=e.y.min),e.z&&e.z.min<i.z.min&&(i.z.min=e.z.min),e.x.max>i.x.max&&(i.x.max=e.x.max),e.y.max>i.y.max&&(i.y.max=e.y.max),e.z&&e.z.max>i.z.max&&(i.z.max=e.z.max),i.x.mid=(i.x.min+i.x.max)/2,i.y.mid=(i.y.min+i.y.max)/2,i.z&&(i.z.mid=(i.z.min+i.z.max)/2),i.x.size=i.x.max-i.x.min,i.y.size=i.y.max-i.y.min,i.z&&(i.z.size=i.z.max-i.z.min)},pairiteration:function(i,e,n){const o=i.bbox(),s=e.bbox(),r=1e5,a=n||.5;if(o.x.size+o.y.size<a&&s.x.size+s.y.size<a)return[(r*(i._t1+i._t2)/2|0)/r+"/"+(r*(e._t1+e._t2)/2|0)/r];let l=i.split(.5),c=e.split(.5),u=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];u=u.filter(function(h){return _.bboxoverlap(h.left.bbox(),h.right.bbox())});let d=[];return u.length===0||(u.forEach(function(h){d=d.concat(_.pairiteration(h.left,h.right,a))}),d=d.filter(function(h,p){return d.indexOf(h)===p})),d},getccenter:function(i,e,n){const o=e.x-i.x,s=e.y-i.y,r=n.x-e.x,a=n.y-e.y,l=o*Y(Q)-s*ue(Q),c=o*ue(Q)+s*Y(Q),u=r*Y(Q)-a*ue(Q),d=r*ue(Q)+a*Y(Q),h=(i.x+e.x)/2,p=(i.y+e.y)/2,f=(e.x+n.x)/2,y=(e.y+n.y)/2,w=h+l,m=p+c,v=f+u,b=y+d,P=_.lli8(h,p,w,m,f,y,v,b),E=_.dist(P,i);let x=be(i.y-P.y,i.x-P.x),S=be(e.y-P.y,e.x-P.x),z=be(n.y-P.y,n.x-P.x),C;return x<z?((x>S||S>z)&&(x+=qe),x>z&&(C=z,z=x,x=C)):z<S&&S<x?(C=z,z=x,x=C):z+=qe,P.s=x,P.e=z,P.r=E,P},numberSort:function(i,e){return i-e}};class Ee{constructor(e){this.curves=[],this._3d=!1,e&&(this.curves=e,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(e){return _.pointsToString(e.points)}).join(", ")+"]"}addCurve(e){this.curves.push(e),this._3d=this._3d||e._3d}length(){return this.curves.map(function(e){return e.length()}).reduce(function(e,n){return e+n})}curve(e){return this.curves[e]}bbox(){const e=this.curves;for(var n=e[0].bbox(),o=1;o<e.length;o++)_.expandbox(n,e[o].bbox());return n}offset(e){const n=[];return this.curves.forEach(function(o){n.push(...o.offset(e))}),new Ee(n)}}const{abs:Ce,min:Zt,max:Jt,cos:$i,sin:Ui,acos:Fi,sqrt:Ie}=Math,Vi=Math.PI;class H{constructor(e){let n=e&&e.forEach?e:Array.from(arguments).slice(),o=!1;if(typeof n[0]=="object"){o=n.length;const f=[];n.forEach(function(y){["x","y","z"].forEach(function(w){typeof y[w]<"u"&&f.push(y[w])})}),n=f}let s=!1;const r=n.length;if(o){if(o>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");s=!0}}else if(r!==6&&r!==8&&r!==9&&r!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const a=this._3d=!s&&(r===9||r===12)||e&&e[0]&&typeof e[0].z<"u",l=this.points=[];for(let f=0,y=a?3:2;f<r;f+=y){var c={x:n[f],y:n[f+1]};a&&(c.z=n[f+2]),l.push(c)}const u=this.order=l.length-1,d=this.dims=["x","y"];a&&d.push("z"),this.dimlen=d.length;const h=_.align(l,{p1:l[0],p2:l[u]}),p=_.dist(l[0],l[u]);this._linear=h.reduce((f,y)=>f+Ce(y.y),0)<p/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(e,n,o,s){if(typeof s>"u"&&(s=.5),s===0)return new H(n,n,o);if(s===1)return new H(e,n,n);const r=H.getABC(2,e,n,o,s);return new H(e,r.A,o)}static cubicFromPoints(e,n,o,s,r){typeof s>"u"&&(s=.5);const a=H.getABC(3,e,n,o,s);typeof r>"u"&&(r=_.dist(n,a.C));const l=r*(1-s)/s,c=_.dist(e,o),u=(o.x-e.x)/c,d=(o.y-e.y)/c,h=r*u,p=r*d,f=l*u,y=l*d,w={x:n.x-h,y:n.y-p},m={x:n.x+f,y:n.y+y},v=a.A,b={x:v.x+(w.x-v.x)/(1-s),y:v.y+(w.y-v.y)/(1-s)},P={x:v.x+(m.x-v.x)/s,y:v.y+(m.y-v.y)/s},E={x:e.x+(b.x-e.x)/s,y:e.y+(b.y-e.y)/s},x={x:o.x+(P.x-o.x)/(1-s),y:o.y+(P.y-o.y)/(1-s)};return new H(e,E,x,o)}static getUtils(){return _}getUtils(){return H.getUtils()}static get PolyBezier(){return Ee}valueOf(){return this.toString()}toString(){return _.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const e=this.points,n=e[0].x,o=e[0].y,s=["M",n,o,this.order===2?"Q":"C"];for(let r=1,a=e.length;r<a;r++)s.push(e[r].x),s.push(e[r].y);return s.join(" ")}setRatios(e){if(e.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=e,this._lut=[]}verify(){const e=this.coordDigest();e!==this._print&&(this._print=e,this.update())}coordDigest(){return this.points.map(function(e,n){return""+n+e.x+e.y+(e.z?e.z:0)}).join("")}update(){this._lut=[],this.dpoints=_.derive(this.points,this._3d),this.computedirection()}computedirection(){const e=this.points,n=_.angle(e[0],e[this.order],e[1]);this.clockwise=n>0}length(){return _.length(this.derivative.bind(this))}static getABC(e=2,n,o,s,r=.5){const a=_.projectionratio(r,e),l=1-a,c={x:a*n.x+l*s.x,y:a*n.y+l*s.y},u=_.abcratio(r,e);return{A:{x:o.x+(o.x-c.x)/u,y:o.y+(o.y-c.y)/u},B:o,C:c,S:n,E:s}}getABC(e,n){n=n||this.get(e);let o=this.points[0],s=this.points[this.order];return H.getABC(this.order,o,n,s,e)}getLUT(e){if(this.verify(),e=e||100,this._lut.length===e+1)return this._lut;this._lut=[],e++,this._lut=[];for(let n=0,o,s;n<e;n++)s=n/(e-1),o=this.compute(s),o.t=s,this._lut.push(o);return this._lut}on(e,n){n=n||5;const o=this.getLUT(),s=[];for(let r=0,a,l=0;r<o.length;r++)a=o[r],_.dist(a,e)<n&&(s.push(a),l+=r/o.length);return s.length?t/=s.length:!1}project(e){const n=this.getLUT(),o=n.length-1,s=_.closest(n,e),r=s.mpos,a=(r-1)/o,l=(r+1)/o,c=.1/o;let u=s.mdist,d=a,h=d,p;u+=1;for(let f;d<l+c;d+=c)p=this.compute(d),f=_.dist(e,p),f<u&&(u=f,h=d);return h=h<0?0:h>1?1:h,p=this.compute(h),p.t=h,p.d=u,p}get(e){return this.compute(e)}point(e){return this.points[e]}compute(e){return this.ratios?_.computeWithRatios(e,this.points,this.ratios,this._3d):_.compute(e,this.points,this._3d,this.ratios)}raise(){const e=this.points,n=[e[0]],o=e.length;for(let s=1,r,a;s<o;s++)r=e[s],a=e[s-1],n[s]={x:(o-s)/o*r.x+s/o*a.x,y:(o-s)/o*r.y+s/o*a.y};return n[o]=e[o-1],new H(n)}derivative(e){return _.compute(e,this.dpoints[0],this._3d)}dderivative(e){return _.compute(e,this.dpoints[1],this._3d)}align(){let e=this.points;return new H(_.align(e,{p1:e[0],p2:e[e.length-1]}))}curvature(e){return _.curvature(e,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return _.inflections(this.points)}normal(e){return this._3d?this.__normal3(e):this.__normal2(e)}__normal2(e){const n=this.derivative(e),o=Ie(n.x*n.x+n.y*n.y);return{t:e,x:-n.y/o,y:n.x/o}}__normal3(e){const n=this.derivative(e),o=this.derivative(e+.01),s=Ie(n.x*n.x+n.y*n.y+n.z*n.z),r=Ie(o.x*o.x+o.y*o.y+o.z*o.z);n.x/=s,n.y/=s,n.z/=s,o.x/=r,o.y/=r,o.z/=r;const a={x:o.y*n.z-o.z*n.y,y:o.z*n.x-o.x*n.z,z:o.x*n.y-o.y*n.x},l=Ie(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=l,a.y/=l,a.z/=l;const c=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return{t:e,x:c[0]*n.x+c[1]*n.y+c[2]*n.z,y:c[3]*n.x+c[4]*n.y+c[5]*n.z,z:c[6]*n.x+c[7]*n.y+c[8]*n.z}}hull(e){let n=this.points,o=[],s=[],r=0;for(s[r++]=n[0],s[r++]=n[1],s[r++]=n[2],this.order===3&&(s[r++]=n[3]);n.length>1;){o=[];for(let a=0,l,c=n.length-1;a<c;a++)l=_.lerp(e,n[a],n[a+1]),s[r++]=l,o.push(l);n=o}return s}split(e,n){if(e===0&&n)return this.split(n).left;if(n===1)return this.split(e).right;const o=this.hull(e),s={left:this.order===2?new H([o[0],o[3],o[5]]):new H([o[0],o[4],o[7],o[9]]),right:this.order===2?new H([o[5],o[4],o[2]]):new H([o[9],o[8],o[6],o[3]]),span:o};return s.left._t1=_.map(0,0,1,this._t1,this._t2),s.left._t2=_.map(e,0,1,this._t1,this._t2),s.right._t1=_.map(e,0,1,this._t1,this._t2),s.right._t2=_.map(1,0,1,this._t1,this._t2),n?(n=_.map(n,e,1,0,1),s.right.split(n).left):s}extrema(){const e={};let n=[];return this.dims.forEach((function(o){let s=function(a){return a[o]},r=this.dpoints[0].map(s);e[o]=_.droots(r),this.order===3&&(r=this.dpoints[1].map(s),e[o]=e[o].concat(_.droots(r))),e[o]=e[o].filter(function(a){return a>=0&&a<=1}),n=n.concat(e[o].sort(_.numberSort))}).bind(this)),e.values=n.sort(_.numberSort).filter(function(o,s){return n.indexOf(o)===s}),e}bbox(){const e=this.extrema(),n={};return this.dims.forEach((function(o){n[o]=_.getminmax(this,o,e[o])}).bind(this)),n}overlaps(e){const n=this.bbox(),o=e.bbox();return _.bboxoverlap(n,o)}offset(e,n){if(typeof n<"u"){const o=this.get(e),s=this.normal(e),r={c:o,n:s,x:o.x+s.x*n,y:o.y+s.y*n};return this._3d&&(r.z=o.z+s.z*n),r}if(this._linear){const o=this.normal(0),s=this.points.map(function(r){const a={x:r.x+e*o.x,y:r.y+e*o.y};return r.z&&o.z&&(a.z=r.z+e*o.z),a});return[new H(s)]}return this.reduce().map(function(o){return o._linear?o.offset(e)[0]:o.scale(e)})}simple(){if(this.order===3){const s=_.angle(this.points[0],this.points[3],this.points[1]),r=_.angle(this.points[0],this.points[3],this.points[2]);if(s>0&&r<0||s<0&&r>0)return!1}const e=this.normal(0),n=this.normal(1);let o=e.x*n.x+e.y*n.y;return this._3d&&(o+=e.z*n.z),Ce(Fi(o))<Vi/3}reduce(){let e,n=0,o=0,s=.01,r,a=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),n=c[0],e=1;e<c.length;e++)o=c[e],r=this.split(n,o),r._t1=n,r._t2=o,a.push(r),n=o;return a.forEach(function(u){for(n=0,o=0;o<=1;)for(o=n+s;o<=1+s;o+=s)if(r=u.split(n,o),!r.simple()){if(o-=s,Ce(n-o)<s)return[];r=u.split(n,o),r._t1=_.map(n,0,1,u._t1,u._t2),r._t2=_.map(o,0,1,u._t1,u._t2),l.push(r),n=o;break}n<1&&(r=u.split(n,1),r._t1=_.map(n,0,1,u._t1,u._t2),r._t2=u._t2,l.push(r))}),l}translate(e,n,o){o=typeof o=="number"?o:n;const s=this.order;let r=this.points.map((a,l)=>(1-l/s)*n+l/s*o);return new H(this.points.map((a,l)=>({x:a.x+e.x*r[l],y:a.y+e.y*r[l]})))}scale(e){const n=this.order;let o=!1;if(typeof e=="function"&&(o=e),o&&n===2)return this.raise().scale(o);const s=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),o?o(0):e,o?o(1):e);const a=o?o(0):e,l=o?o(1):e,c=[this.offset(0,10),this.offset(1,10)],u=[],d=_.lli4(c[0],c[0].c,c[1],c[1].c);if(!d)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(h){const p=u[h*n]=_.copy(r[h*n]);p.x+=(h?l:a)*c[h].n.x,p.y+=(h?l:a)*c[h].n.y}),o?([0,1].forEach(function(h){if(!(n===2&&h)){var p=r[h+1],f={x:p.x-d.x,y:p.y-d.y},y=o?o((h+1)/n):e;o&&!s&&(y=-y);var w=Ie(f.x*f.x+f.y*f.y);f.x/=w,f.y/=w,u[h+1]={x:p.x+y*f.x,y:p.y+y*f.y}}}),new H(u)):([0,1].forEach(h=>{if(n===2&&h)return;const p=u[h*n],f=this.derivative(h),y={x:p.x+f.x,y:p.y+f.y};u[h+1]=_.lli4(p,y,d,r[h+1])}),new H(u))}outline(e,n,o,s){if(n=n===void 0?e:n,this._linear){const x=this.normal(0),S=this.points[0],z=this.points[this.points.length-1];let C,I,T;o===void 0&&(o=e,s=n),C={x:S.x+x.x*e,y:S.y+x.y*e},T={x:z.x+x.x*o,y:z.y+x.y*o},I={x:(C.x+T.x)/2,y:(C.y+T.y)/2};const k=[C,I,T];C={x:S.x-x.x*n,y:S.y-x.y*n},T={x:z.x-x.x*s,y:z.y-x.y*s},I={x:(C.x+T.x)/2,y:(C.y+T.y)/2};const M=[T,I,C],D=_.makeline(M[2],k[0]),L=_.makeline(k[2],M[0]),R=[D,new H(k),L,new H(M)];return new Ee(R)}const r=this.reduce(),a=r.length,l=[];let c=[],u,d=0,h=this.length();const p=typeof o<"u"&&typeof s<"u";function f(x,S,z,C,I){return function(T){const k=C/z,M=(C+I)/z,D=S-x;return _.map(T,0,1,x+k*D,x+M*D)}}r.forEach(function(x){const S=x.length();p?(l.push(x.scale(f(e,o,h,d,S))),c.push(x.scale(f(-n,-s,h,d,S)))):(l.push(x.scale(e)),c.push(x.scale(-n))),d+=S}),c=c.map(function(x){return u=x.points,u[3]?x.points=[u[3],u[2],u[1],u[0]]:x.points=[u[2],u[1],u[0]],x}).reverse();const y=l[0].points[0],w=l[a-1].points[l[a-1].points.length-1],m=c[a-1].points[c[a-1].points.length-1],v=c[0].points[0],b=_.makeline(m,y),P=_.makeline(w,v),E=[b].concat(l).concat([P]).concat(c);return new Ee(E)}outlineshapes(e,n,o){n=n||e;const s=this.outline(e,n).curves,r=[];for(let a=1,l=s.length;a<l/2;a++){const c=_.makeshape(s[a],s[l-a],o);c.startcap.virtual=a>1,c.endcap.virtual=a<l/2-1,r.push(c)}return r}intersects(e,n){return e?e.p1&&e.p2?this.lineIntersects(e):(e instanceof H&&(e=e.reduce()),this.curveintersects(this.reduce(),e,n)):this.selfintersects(n)}lineIntersects(e){const n=Zt(e.p1.x,e.p2.x),o=Zt(e.p1.y,e.p2.y),s=Jt(e.p1.x,e.p2.x),r=Jt(e.p1.y,e.p2.y);return _.roots(this.points,e).filter(a=>{var l=this.get(a);return _.between(l.x,n,s)&&_.between(l.y,o,r)})}selfintersects(e){const n=this.reduce(),o=n.length-2,s=[];for(let r=0,a,l,c;r<o;r++)l=n.slice(r,r+1),c=n.slice(r+2),a=this.curveintersects(l,c,e),s.push(...a);return s}curveintersects(e,n,o){const s=[];e.forEach(function(a){n.forEach(function(l){a.overlaps(l)&&s.push({left:a,right:l})})});let r=[];return s.forEach(function(a){const l=_.pairiteration(a.left,a.right,o);l.length>0&&(r=r.concat(l))}),r}arcs(e){return e=e||.5,this._iterate(e,[])}_error(e,n,o,s){const r=(s-o)/4,a=this.get(o+r),l=this.get(s-r),c=_.dist(e,n),u=_.dist(e,a),d=_.dist(e,l);return Ce(u-c)+Ce(d-c)}_iterate(e,n){let o=0,s=1,r;do{r=0,s=1;let a=this.get(o),l,c,u,d,h=!1,p=!1,f,y=s,w=1;do if(p=h,d=u,y=(o+s)/2,l=this.get(y),c=this.get(s),u=_.getccenter(a,l,c),u.interval={start:o,end:s},h=this._error(u,a,o,s)<=e,f=p&&!h,f||(w=s),h){if(s>=1){if(u.interval.end=w=1,d=u,s>1){let v={x:u.x+u.r*$i(u.e),y:u.y+u.r*Ui(u.e)};u.e+=_.angle({x:u.x,y:u.y},v,this.get(1))}break}s=s+(s-o)/2}else s=y;while(!f&&r++<100);if(r>=100)break;d=d||u,n.push(d),o=w}while(s<1);return n}}var Gi=(function(){function i(e,n){var o=[],s=!0,r=!1,a=void 0;try{for(var l=e[Symbol.iterator](),c;!(s=(c=l.next()).done)&&(o.push(c.value),!(n&&o.length===n));s=!0);}catch(u){r=!0,a=u}finally{try{!s&&l.return&&l.return()}finally{if(r)throw a}}return o}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return i(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}})(),Te=Math.PI*2,gt=function(e,n,o,s,r,a,l){var c=e.x,u=e.y;c*=n,u*=o;var d=s*c-r*u,h=r*c+s*u;return{x:d+a,y:h+l}},ji=function(e,n){var o=n===1.5707963267948966?.551915024494:n===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(n/4),s=Math.cos(e),r=Math.sin(e),a=Math.cos(e+n),l=Math.sin(e+n);return[{x:s-r*o,y:r+s*o},{x:a+l*o,y:l-a*o},{x:a,y:l}]},Qt=function(e,n,o,s){var r=e*s-n*o<0?-1:1,a=e*o+n*s;return a>1&&(a=1),a<-1&&(a=-1),r*Math.acos(a)},Wi=function(e,n,o,s,r,a,l,c,u,d,h,p){var f=Math.pow(r,2),y=Math.pow(a,2),w=Math.pow(h,2),m=Math.pow(p,2),v=f*y-f*m-y*w;v<0&&(v=0),v/=f*m+y*w,v=Math.sqrt(v)*(l===c?-1:1);var b=v*r/a*p,P=v*-a/r*h,E=d*b-u*P+(e+o)/2,x=u*b+d*P+(n+s)/2,S=(h-b)/r,z=(p-P)/a,C=(-h-b)/r,I=(-p-P)/a,T=Qt(1,0,S,z),k=Qt(S,z,C,I);return c===0&&k>0&&(k-=Te),c===1&&k<0&&(k+=Te),[E,x,T,k]},qi=function(e){var n=e.px,o=e.py,s=e.cx,r=e.cy,a=e.rx,l=e.ry,c=e.xAxisRotation,u=c===void 0?0:c,d=e.largeArcFlag,h=d===void 0?0:d,p=e.sweepFlag,f=p===void 0?0:p,y=[];if(a===0||l===0)return[];var w=Math.sin(u*Te/360),m=Math.cos(u*Te/360),v=m*(n-s)/2+w*(o-r)/2,b=-w*(n-s)/2+m*(o-r)/2;if(v===0&&b===0)return[];a=Math.abs(a),l=Math.abs(l);var P=Math.pow(v,2)/Math.pow(a,2)+Math.pow(b,2)/Math.pow(l,2);P>1&&(a*=Math.sqrt(P),l*=Math.sqrt(P));var E=Wi(n,o,s,r,a,l,h,f,w,m,v,b),x=Gi(E,4),S=x[0],z=x[1],C=x[2],I=x[3],T=Math.abs(I)/(Te/4);Math.abs(1-T)<1e-7&&(T=1);var k=Math.max(Math.ceil(T),1);I/=k;for(var M=0;M<k;M++)y.push(ji(C,I)),C+=I;return y.map(function(D){var L=gt(D[0],a,l,m,w,S,z),R=L.x,A=L.y,O=gt(D[1],a,l,m,w,S,z),$=O.x,N=O.y,q=gt(D[2],a,l,m,w,S,z),we=q.x,ht=q.y;return{x1:R,y1:A,x2:$,y2:N,x:we,y:ht}})};function Xi(i,e){return i>e?1:i<e?-1:0}class Vt{constructor(e=Xi,n=!1){this._compare=e,this._root=null,this._size=0,this._noDuplicates=!!n}rotateLeft(e){var n=e.right;n&&(e.right=n.left,n.left&&(n.left.parent=e),n.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=n:e.parent.right=n:this._root=n,n&&(n.left=e),e.parent=n}rotateRight(e){var n=e.left;n&&(e.left=n.right,n.right&&(n.right.parent=e),n.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=n:e.parent.right=n:this._root=n,n&&(n.right=e),e.parent=n}_splay(e){for(;e.parent;){var n=e.parent;n.parent?n.left===e&&n.parent.left===n?(this.rotateRight(n.parent),this.rotateRight(n)):n.right===e&&n.parent.right===n?(this.rotateLeft(n.parent),this.rotateLeft(n)):n.left===e&&n.parent.right===n?(this.rotateRight(n),this.rotateLeft(n)):(this.rotateLeft(n),this.rotateRight(n)):n.left===e?this.rotateRight(n):this.rotateLeft(n)}}splay(e){for(var n,o,s,r,a;e.parent;)n=e.parent,o=n.parent,o&&o.parent?(s=o.parent,s.left===o?s.left=e:s.right=e,e.parent=s):(e.parent=null,this._root=e),r=e.left,a=e.right,e===n.left?(o&&(o.left===n?(n.right?(o.left=n.right,o.left.parent=o):o.left=null,n.right=o,o.parent=n):(r?(o.right=r,r.parent=o):o.right=null,e.left=o,o.parent=e)),a?(n.left=a,a.parent=n):n.left=null,e.right=n,n.parent=e):(o&&(o.right===n?(n.left?(o.right=n.left,o.right.parent=o):o.right=null,n.left=o,o.parent=n):(a?(o.left=a,a.parent=o):o.left=null,e.right=o,o.parent=e)),r?(n.right=r,r.parent=n):n.right=null,e.left=n,n.parent=e)}replace(e,n){e.parent?e===e.parent.left?e.parent.left=n:e.parent.right=n:this._root=n,n&&(n.parent=e.parent)}minNode(e=this._root){if(e)for(;e.left;)e=e.left;return e}maxNode(e=this._root){if(e)for(;e.right;)e=e.right;return e}insert(e,n){var o=this._root,s=null,r=this._compare,a;if(this._noDuplicates)for(;o;){if(s=o,a=r(o.key,e),a===0)return;r(o.key,e)<0?o=o.right:o=o.left}else for(;o;)s=o,r(o.key,e)<0?o=o.right:o=o.left;return o={key:e,data:n,left:null,right:null,parent:s},s?r(s.key,o.key)<0?s.right=o:s.left=o:this._root=o,this.splay(o),this._size++,o}find(e){for(var n=this._root,o=this._compare;n;){var s=o(n.key,e);if(s<0)n=n.right;else if(s>0)n=n.left;else return n}return null}contains(e){for(var n=this._root,o=this._compare;n;){var s=o(e,n.key);if(s===0)return!0;s<0?n=n.left:n=n.right}return!1}remove(e){var n=this.find(e);if(!n)return!1;if(this.splay(n),!n.left)this.replace(n,n.right);else if(!n.right)this.replace(n,n.left);else{var o=this.minNode(n.right);o.parent!==n&&(this.replace(o,o.right),o.right=n.right,o.right.parent=o),this.replace(n,o),o.left=n.left,o.left.parent=o}return this._size--,!0}removeNode(e){if(!e)return!1;if(this.splay(e),!e.left)this.replace(e,e.right);else if(!e.right)this.replace(e,e.left);else{var n=this.minNode(e.right);n.parent!==e&&(this.replace(n,n.right),n.right=e.right,n.right.parent=n),this.replace(e,n),n.left=e.left,n.left.parent=n}return this._size--,!0}erase(e){var n=this.find(e);if(n){this.splay(n);var o=n.left,s=n.right,r=null;o&&(o.parent=null,r=this.maxNode(o),this.splay(r),this._root=r),s&&(o?r.right=s:this._root=s,s.parent=r),this._size--}}pop(){var e=this._root,n=null;if(e){for(;e.left;)e=e.left;n={key:e.key,data:e.data},this.remove(e.key)}return n}next(e){var n=e;if(n)if(n.right)for(n=n.right;n&&n.left;)n=n.left;else for(n=e.parent;n&&n.right===e;)e=n,n=n.parent;return n}prev(e){var n=e;if(n)if(n.left)for(n=n.left;n&&n.right;)n=n.right;else for(n=e.parent;n&&n.left===e;)e=n,n=n.parent;return n}forEach(e){for(var n=this._root,o=[],s=!1,r=0;!s;)n?(o.push(n),n=n.left):o.length>0?(n=o.pop(),e(n,r++),n=n.right):s=!0;return this}range(e,n,o,s){const r=[],a=this._compare;let l=this._root,c;for(;r.length!==0||l;)if(l)r.push(l),l=l.left;else{if(l=r.pop(),c=a(l.key,n),c>0)break;if(a(l.key,e)>=0&&o.call(s,l))return this;l=l.right}return this}keys(){for(var e=this._root,n=[],o=[],s=!1;!s;)e?(n.push(e),e=e.left):n.length>0?(e=n.pop(),o.push(e.key),e=e.right):s=!0;return o}values(){for(var e=this._root,n=[],o=[],s=!1;!s;)e?(n.push(e),e=e.left):n.length>0?(e=n.pop(),o.push(e.data),e=e.right):s=!0;return o}at(e){for(var n=this._root,o=[],s=!1,r=0;!s;)if(n)o.push(n),n=n.left;else if(o.length>0){if(n=o.pop(),r===e)return n;r++,n=n.right}else s=!0;return null}load(e=[],n=[],o=!1){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const s=e.length;return o&&Rt(e,n,0,s-1,this._compare),this._root=At(null,e,n,0,s),this._size=s,this}min(){var e=this.minNode(this._root);return e?e.key:null}max(){var e=this.maxNode(this._root);return e?e.key:null}isEmpty(){return this._root===null}get size(){return this._size}static createTree(e,n,o,s,r){return new Vt(o,r).load(e,n,s)}}function At(i,e,n,o,s){const r=s-o;if(r>0){const a=o+Math.floor(r/2),l=e[a],c=n[a],u={key:l,data:c,parent:i};return u.left=At(u,e,n,o,a),u.right=At(u,e,n,a+1,s),u}return null}function Rt(i,e,n,o,s){if(n>=o)return;const r=i[n+o>>1];let a=n-1,l=o+1;for(;;){do a++;while(s(i[a],r)<0);do l--;while(s(i[l],r)>0);if(a>=l)break;let c=i[a];i[a]=i[l],i[l]=c,c=e[a],e[a]=e[l],e[l]=c}Rt(i,e,n,l,s),Rt(i,e,l+1,o,s)}const Hn=0,Nn=1,$n=2,Un=3,rt=0,Ot=1,ot=2,Fn=3;function Se(i,e,n){e===null?(i.inOut=!1,i.otherInOut=!0):(i.isSubject===e.isSubject?(i.inOut=!e.inOut,i.otherInOut=e.otherInOut):(i.inOut=!e.otherInOut,i.otherInOut=e.isVertical()?!e.inOut:e.inOut),e&&(i.prevInResult=!en(e,n)||e.isVertical()?e.prevInResult:e)),en(i,n)?i.resultTransition=Bi(i,n):i.resultTransition=0}function en(i,e){switch(i.type){case Hn:switch(e){case rt:return!i.otherInOut;case Ot:return i.otherInOut;case ot:return i.isSubject&&i.otherInOut||!i.isSubject&&!i.otherInOut;case Fn:return!0}break;case $n:return e===rt||e===Ot;case Un:return e===ot;case Nn:return!1}return!1}function Bi(i,e){let n=!i.inOut,o=!i.otherInOut,s;switch(e){case rt:s=n&&o;break;case Ot:s=n||o;break;case Fn:s=n^o;break;case ot:i.isSubject?s=n&&!o:s=o&&!n;break}return s?1:-1}class ve{constructor(e,n,o,s,r){this.left=n,this.point=e,this.otherEvent=o,this.isSubject=s,this.type=r||Hn,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0}isBelow(e){const n=this.point,o=this.otherEvent.point;return this.left?(n[0]-e[0])*(o[1]-e[1])-(o[0]-e[0])*(n[1]-e[1])>0:(o[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(o[1]-e[1])>0}isAbove(e){return!this.isBelow(e)}isVertical(){return this.point[0]===this.otherEvent.point[0]}get inResult(){return this.resultTransition!==0}clone(){const e=new ve(this.point,this.left,this.otherEvent,this.isSubject,this.type);return e.contourId=this.contourId,e.resultTransition=this.resultTransition,e.prevInResult=this.prevInResult,e.isExteriorRing=this.isExteriorRing,e.inOut=this.inOut,e.otherInOut=this.otherInOut,e}}function B(i,e){return i[0]===e[0]?i[1]===e[1]:!1}const K=11102230246251565e-32,U=134217729,Yi=(3+8*K)*K;function yt(i,e,n,o,s){let r,a,l,c,u=e[0],d=o[0],h=0,p=0;d>u==d>-u?(r=u,u=e[++h]):(r=d,d=o[++p]);let f=0;if(h<i&&p<n)for(d>u==d>-u?(a=u+r,l=r-(a-u),u=e[++h]):(a=d+r,l=r-(a-d),d=o[++p]),r=a,l!==0&&(s[f++]=l);h<i&&p<n;)d>u==d>-u?(a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h]):(a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p]),r=a,l!==0&&(s[f++]=l);for(;h<i;)a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h],r=a,l!==0&&(s[f++]=l);for(;p<n;)a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p],r=a,l!==0&&(s[f++]=l);return(r!==0||f===0)&&(s[f++]=r),f}function Ki(i,e){let n=e[0];for(let o=1;o<i;o++)n+=e[o];return n}function je(i){return new Float64Array(i)}const Zi=(3+16*K)*K,Ji=(2+12*K)*K,Qi=(9+64*K)*K*K,he=je(4),tn=je(8),nn=je(12),rn=je(16),G=je(4);function er(i,e,n,o,s,r,a){let l,c,u,d,h,p,f,y,w,m,v,b,P,E,x,S,z,C;const I=i-s,T=n-s,k=e-r,M=o-r;E=I*M,p=U*I,f=p-(p-I),y=I-f,p=U*M,w=p-(p-M),m=M-w,x=y*m-(E-f*w-y*w-f*m),S=k*T,p=U*k,f=p-(p-k),y=k-f,p=U*T,w=p-(p-T),m=T-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,he[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,he[1]=P-(v+h)+(h-S),C=b+v,h=C-b,he[2]=b-(C-h)+(v-h),he[3]=C;let D=Ki(4,he),L=Ji*a;if(D>=L||-D>=L||(h=i-I,l=i-(I+h)+(h-s),h=n-T,u=n-(T+h)+(h-s),h=e-k,c=e-(k+h)+(h-r),h=o-M,d=o-(M+h)+(h-r),l===0&&c===0&&u===0&&d===0)||(L=Qi*a+Yi*Math.abs(D),D+=I*d+M*l-(k*u+T*c),D>=L||-D>=L))return D;E=l*M,p=U*l,f=p-(p-l),y=l-f,p=U*M,w=p-(p-M),m=M-w,x=y*m-(E-f*w-y*w-f*m),S=c*T,p=U*c,f=p-(p-c),y=c-f,p=U*T,w=p-(p-T),m=T-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,G[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,G[1]=P-(v+h)+(h-S),C=b+v,h=C-b,G[2]=b-(C-h)+(v-h),G[3]=C;const R=yt(4,he,4,G,tn);E=I*d,p=U*I,f=p-(p-I),y=I-f,p=U*d,w=p-(p-d),m=d-w,x=y*m-(E-f*w-y*w-f*m),S=k*u,p=U*k,f=p-(p-k),y=k-f,p=U*u,w=p-(p-u),m=u-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,G[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,G[1]=P-(v+h)+(h-S),C=b+v,h=C-b,G[2]=b-(C-h)+(v-h),G[3]=C;const A=yt(R,tn,4,G,nn);E=l*d,p=U*l,f=p-(p-l),y=l-f,p=U*d,w=p-(p-d),m=d-w,x=y*m-(E-f*w-y*w-f*m),S=c*u,p=U*c,f=p-(p-c),y=c-f,p=U*u,w=p-(p-u),m=u-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,G[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,G[1]=P-(v+h)+(h-S),C=b+v,h=C-b,G[2]=b-(C-h)+(v-h),G[3]=C;const O=yt(A,nn,4,G,rn);return rn[O-1]}function tr(i,e,n,o,s,r){const a=(e-r)*(n-s),l=(i-s)*(o-r),c=a-l;if(a===0||l===0||a>0!=l>0)return c;const u=Math.abs(a+l);return Math.abs(c)>=Zi*u?c:-er(i,e,n,o,s,r,u)}function Ht(i,e,n){const o=tr(i[0],i[1],e[0],e[1],n[0],n[1]);return o>0?-1:o<0?1:0}function te(i,e){const n=i.point,o=e.point;return n[0]>o[0]?1:n[0]<o[0]?-1:n[1]!==o[1]?n[1]>o[1]?1:-1:nr(i,e,n)}function nr(i,e,n,o){return i.left!==e.left?i.left?1:-1:Ht(n,i.otherEvent.point,e.otherEvent.point)!==0?i.isBelow(e.otherEvent.point)?-1:1:!i.isSubject&&e.isSubject?1:-1}function ee(i,e,n){const o=new ve(e,!1,i,i.isSubject),s=new ve(e,!0,i.otherEvent,i.isSubject);return B(i.point,i.otherEvent.point)&&console.warn("what is that, a collapsed segment?",i),o.contourId=s.contourId=i.contourId,te(s,i.otherEvent)>0&&(i.otherEvent.left=!0,s.left=!1),i.otherEvent.otherEvent=s,i.otherEvent=o,n.push(s),n.push(o),n}function Xe(i,e){return i[0]*e[1]-i[1]*e[0]}function vt(i,e){return i[0]*e[0]+i[1]*e[1]}function ir(i,e,n,o,s){const r=[e[0]-i[0],e[1]-i[1]],a=[o[0]-n[0],o[1]-n[1]];function l(m,v,b){return[m[0]+v*b[0],m[1]+v*b[1]]}const c=[n[0]-i[0],n[1]-i[1]];let u=Xe(r,a),d=u*u;const h=vt(r,r);if(d>0){const m=Xe(c,a)/u;if(m<0||m>1)return null;const v=Xe(c,r)/u;return v<0||v>1?null:m===0||m===1?[l(i,m,r)]:v===0||v===1?[l(n,v,a)]:[l(i,m,r)]}if(u=Xe(c,r),d=u*u,d>0)return null;const p=vt(r,c)/h,f=p+vt(r,a)/h,y=Math.min(p,f),w=Math.max(p,f);return y<=1&&w>=0?y===1?[l(i,y>0?y:0,r)]:w===0?[l(i,w<1?w:1,r)]:[l(i,y>0?y:0,r),l(i,w<1?w:1,r)]:null}function wt(i,e,n){const o=ir(i.point,i.otherEvent.point,e.point,e.otherEvent.point),s=o?o.length:0;if(s===0||s===1&&(B(i.point,e.point)||B(i.otherEvent.point,e.otherEvent.point))||s===2&&i.isSubject===e.isSubject)return 0;if(s===1)return!B(i.point,o[0])&&!B(i.otherEvent.point,o[0])&&ee(i,o[0],n),!B(e.point,o[0])&&!B(e.otherEvent.point,o[0])&&ee(e,o[0],n),1;const r=[];let a=!1,l=!1;return B(i.point,e.point)?a=!0:te(i,e)===1?r.push(e,i):r.push(i,e),B(i.otherEvent.point,e.otherEvent.point)?l=!0:te(i.otherEvent,e.otherEvent)===1?r.push(e.otherEvent,i.otherEvent):r.push(i.otherEvent,e.otherEvent),a&&l||a?(e.type=Nn,i.type=e.inOut===i.inOut?$n:Un,a&&!l&&ee(r[1].otherEvent,r[0].point,n),2):l?(ee(r[0],r[1].point,n),3):r[0]!==r[3].otherEvent?(ee(r[0],r[1].point,n),ee(r[1],r[2].point,n),3):(ee(r[0],r[1].point,n),ee(r[3].otherEvent,r[2].point,n),3)}function rr(i,e){if(i===e)return 0;if(Ht(i.point,i.otherEvent.point,e.point)!==0||Ht(i.point,i.otherEvent.point,e.otherEvent.point)!==0)return B(i.point,e.point)?i.isBelow(e.otherEvent.point)?-1:1:i.point[0]===e.point[0]?i.point[1]<e.point[1]?-1:1:te(i,e)===1?e.isAbove(i.point)?-1:1:i.isBelow(e.point)?-1:1;if(i.isSubject===e.isSubject){let n=i.point,o=e.point;if(n[0]===o[0]&&n[1]===o[1])return n=i.otherEvent.point,o=e.otherEvent.point,n[0]===o[0]&&n[1]===o[1]?0:i.contourId>e.contourId?1:-1}else return i.isSubject?-1:1;return te(i,e)===1?1:-1}function or(i,e,n,o,s,r){const a=new Vt(rr),l=[],c=Math.min(o[2],s[2]);let u,d,h;for(;i.length!==0;){let p=i.pop();if(l.push(p),p.point[0]>c||r===ot)break;if(p.left){d=u=a.insert(p),h=a.minNode(),u!==h?u=a.prev(u):u=null,d=a.next(d);const f=u?u.key:null;let y;if(Se(p,f,r),d&&wt(p,d.key,i)===2&&(Se(p,f,r),Se(d.key,p,r)),u&&wt(u.key,p,i)===2){let w=u;w!==h?w=a.prev(w):w=null,y=w?w.key:null,Se(f,y,r),Se(p,f,r)}}else p=p.otherEvent,d=u=a.find(p),u&&d&&(u!==h?u=a.prev(u):u=null,d=a.next(d),a.remove(p),d&&u&&wt(u.key,d.key,i))}return l}class sr{constructor(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null}isExterior(){return this.holeOf==null}}function ar(i){let e,n,o,s;const r=[];for(n=0,o=i.length;n<o;n++)e=i[n],(e.left&&e.inResult||!e.left&&e.otherEvent.inResult)&&r.push(e);let a=!1;for(;!a;)for(a=!0,n=0,o=r.length;n<o;n++)n+1<o&&te(r[n],r[n+1])===1&&(s=r[n],r[n]=r[n+1],r[n+1]=s,a=!1);for(n=0,o=r.length;n<o;n++)e=r[n],e.otherPos=n;for(n=0,o=r.length;n<o;n++)e=r[n],e.left||(s=e.otherPos,e.otherPos=e.otherEvent.otherPos,e.otherEvent.otherPos=s);return r}function lr(i,e,n,o){let s=i+1,r=e[i].point,a;const l=e.length;for(s<l&&(a=e[s].point);s<l&&a[0]===r[0]&&a[1]===r[1];){if(n[s])s++;else return s;s<l&&(a=e[s].point)}for(s=i-1;n[s]&&s>o;)s--;return s}function cr(i,e,n){const o=new sr;if(i.prevInResult!=null){const s=i.prevInResult,r=s.outputContourId;if(s.resultTransition>0){const l=e[r];if(l.holeOf!=null){const c=l.holeOf;e[c].holeIds.push(n),o.holeOf=c,o.depth=e[r].depth}else e[r].holeIds.push(n),o.holeOf=r,o.depth=e[r].depth+1}else o.holeOf=null,o.depth=e[r].depth}else o.holeOf=null,o.depth=0;return o}function ur(i){let e,n;const o=ar(i),s={},r=[];for(e=0,n=o.length;e<n;e++){if(s[e])continue;const a=r.length,l=cr(o[e],r,a),c=p=>{s[p]=!0,p<o.length&&o[p]&&(o[p].outputContourId=a)};let u=e,d=e;const h=o[e].point;for(l.points.push(h);c(u),u=o[u].otherPos,c(u),l.points.push(o[u].point),u=lr(u,o,s,d),!(u==d||u>=o.length||!o[u]););r.push(l)}return r}var Be={exports:{}},on;function hr(){if(on)return Be.exports;on=1,Be.exports=i,Be.exports.default=i;function i(n,o){if(!(this instanceof i))return new i(n,o);if(this.data=n||[],this.length=this.data.length,this.compare=o||e,this.length>0)for(var s=(this.length>>1)-1;s>=0;s--)this._down(s)}function e(n,o){return n<o?-1:n>o?1:0}return i.prototype={push:function(n){this.data.push(n),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var n=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),n}},peek:function(){return this.data[0]},_up:function(n){for(var o=this.data,s=this.compare,r=o[n];n>0;){var a=n-1>>1,l=o[a];if(s(r,l)>=0)break;o[n]=l,n=a}o[n]=r},_down:function(n){for(var o=this.data,s=this.compare,r=this.length>>1,a=o[n];n<r;){var l=(n<<1)+1,c=l+1,u=o[l];if(c<this.length&&s(o[c],u)<0&&(l=c,u=o[c]),s(u,a)>=0)break;o[n]=u,n=l}o[n]=a}},Be.exports}var dr=hr();const pr=_n(dr),sn=Math.max,an=Math.min;let Ye=0;function ln(i,e,n,o,s,r){let a,l,c,u,d,h;for(a=0,l=i.length-1;a<l;a++){if(c=i[a],u=i[a+1],d=new ve(c,!1,void 0,e),h=new ve(u,!1,d,e),d.otherEvent=h,c[0]===u[0]&&c[1]===u[1])continue;d.contourId=h.contourId=n,r||(d.isExteriorRing=!1,h.isExteriorRing=!1),te(d,h)>0?h.left=!0:d.left=!0;const p=c[0],f=c[1];s[0]=an(s[0],p),s[1]=an(s[1],f),s[2]=sn(s[2],p),s[3]=sn(s[3],f),o.push(d),o.push(h)}}function fr(i,e,n,o,s){const r=new pr(null,te);let a,l,c,u,d,h;for(c=0,u=i.length;c<u;c++)for(a=i[c],d=0,h=a.length;d<h;d++)l=d===0,l&&Ye++,ln(a[d],!0,Ye,r,n,l);for(c=0,u=e.length;c<u;c++)for(a=e[c],d=0,h=a.length;d<h;d++)l=d===0,l&&Ye++,ln(a[d],!1,Ye,r,o,l);return r}const st=[];function mr(i,e,n){let o=null;return i.length*e.length===0&&(o=st),o}function gr(i,e,n,o,s){let r=null;return(n[0]>o[2]||o[0]>n[2]||n[1]>o[3]||o[1]>n[3])&&(r=st),r}function yr(i,e,n){typeof i[0][0][0]=="number"&&(i=[i]),typeof e[0][0][0]=="number"&&(e=[e]);let o=mr(i,e);if(o)return o===st?null:o;const s=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],a=fr(i,e,s,r);if(o=gr(i,e,s,r),o)return o===st?null:o;const l=or(a,i,e,s,r,n),c=ur(l),u=[];for(let d=0;d<c.length;d++){let h=c[d];if(h.isExterior()){let p=[h.points];for(let f=0;f<h.holeIds.length;f++){let y=h.holeIds[f];p.push(c[y].points)}u.push(p)}}return u}function vr(i,e){return yr(i,e,rt)}function wr(i,e){const n=i[0]-e[0],o=i[1]-e[1];return n*n+o*o}function Pr(i){return{vertices:i.vertices,pieces:Array.from(i.pieces.entries()),edges:Array.from(i.edges.entries()),halfEdges:Array.from(i.halfEdges.entries()),boundary:i.boundary,borderPath:i.borderPath}}function Vn(i,e){let[n,o]=i,[s,r]=i;const a=l=>{n=Math.min(n,l[0]),o=Math.min(o,l[1]),s=Math.max(s,l[0]),r=Math.max(r,l[1])};for(const l of e)l.type==="line"?a(l.p):(a(l.p1),a(l.p2),a(l.p3));return[n,o,s,r]}function Gn(i,e){let n=1/0,o=1/0,s=-1/0,r=-1/0;const a=i.halfEdge;let l=e.halfEdges.get(a);if(!l)return i.bounds;const c=u=>{n=Math.min(n,u[0]),o=Math.min(o,u[1]),s=Math.max(s,u[0]),r=Math.max(r,u[1])};do{if(c(l.origin),l.segments){const u=Vn(l.origin,l.segments);c([u[0],u[1]]),c([u[2],u[3]])}l=e.halfEdges.get(l.next)}while(l&&l.id!==a);return[n,o,s,r]}function Nt(i){if(i.length===0)return[0,0,0,0];let e=i[0][0],n=i[0][1],o=e,s=n;for(let r=1;r<i.length;r++){const a=i[r];e=Math.min(e,a[0]),n=Math.min(n,a[1]),o=Math.max(o,a[0]),s=Math.max(s,a[1])}return[e,n,o,s]}function br(i,e){return Math.abs(i[0]-e[0])<1e-6&&Math.abs(i[1]-e[1])<1e-6}function jn(i,e,n,o){if(!i.tabs)return;const s=e.halfEdges.get(i.heLeft),r=e.halfEdges.get(i.heRight),a=s.origin,l=r.origin,c=[];let u=a;i.tabs.sort((d,h)=>d.position-h.position);for(const d of i.tabs){const h=d.position-d.size/2,p=[a[0]+(l[0]-a[0])*h,a[1]+(l[1]-a[1])*h];Math.hypot(p[0]-u[0],p[1]-u[1])>1e-6&&c.push({type:"line",p});const f=[a[0]+(l[0]-a[0])*(h+d.size),a[1]+(l[1]-a[1])*(h+d.size)],y=n.createTabSegments(p,f,d,o);c.push(...y),u=f}Math.hypot(l[0]-u[0],l[1]-u[1])>1e-6&&c.push({type:"line",p:l}),s.segments=c,r.segments=xr(c,a),i.bounds=Vn(a,c)}function xr(i,e){const n=[];for(let o=i.length-1;o>=0;o--){const s=i[o];let r=e;if(o>0){const a=i[o-1];r=a.type==="line"?a.p:a.p3}s.type==="line"?n.push({type:"line",p:r}):n.push({type:"bezier",p1:s.p2,p2:s.p1,p3:r})}return n}function Cr(i,e){const{p:n,radii:o,rotation:s,largeArc:r,sweep:a}=e,[l,c]=i,[u,d]=n,[h,p]=o;return qi({px:l,py:c,cx:u,cy:d,rx:h,ry:p,xAxisRotation:s,largeArcFlag:r?1:0,sweepFlag:a?1:0}).map(w=>({type:"bezier",p1:[w.x1,w.y1],p2:[w.x2,w.y2],p3:[w.x,w.y]}))}function Wn(i){const e=[];let n=[];if(i.length===0||i[0].type!=="move")return[];let o=[0,0];for(const s of i)switch(s.type){case"move":n.length>0&&e.push(n),o=s.p,n=[o];break;case"line":n.push(s.p),o=s.p;break;case"bezier":{const{p1:r,p2:a,p3:l}=s,u=new H([...o,...r,...a,...l]).getLUT(100);n.push(...u.slice(1).map(d=>[d.x,d.y])),o=l;break}case"arc":{const r=Cr(o,s);let a=o;for(const l of r){const u=new H([...a,...l.p1,...l.p2,...l.p3]).getLUT(100);n.push(...u.slice(1).map(d=>[d.x,d.y])),a=l.p3}o=s.p;break}}return n.length>0&&e.push(n),e}function Gt(i,e,n){if(e.length>0&&e[0].type!=="move")throw new Error("Boundary path must start with a 'move' command.");const o=Wn(e);let s=0;for(const r of o)zr(i,r)&&s++;return s%2===1}function Ir(i){return Array.isArray(i[0])&&Array.isArray(i[0][0])&&typeof i[0][0][0]=="number"}function Sr(i,e){const n=[i.map(r=>[r[0],r[1]])],o=[e.map(r=>[r[0],r[1]])],s=vr(n,o);return!s||s.length===0?null:Ir(s)?s:s.map(r=>r[0].map(a=>[a[0],a[1]]))}function zr(i,e){const[n,o]=i;let s=!1;for(let r=0,a=e.length-1;r<e.length;a=r++){const[l,c]=e[r],[u,d]=e[a];c>o!=d>o&&n<(u-l)*(o-c)/(d-c)+l&&(s=!s)}return s}function Er(i,e,n){const o=[];for(const r of i)n.vertices.find(a=>br(a,r))||n.vertices.push(r);for(const r of i){const a={id:Rn(),origin:r,twin:-1,next:-1,prev:-1,piece:e};o.push(a)}const s=o.length;for(let r=0;r<s;r++){const a=(r+1)%s,l=(r+s-1)%s;o[r].next=o[a].id,o[r].prev=o[l].id}return o.forEach(r=>n.halfEdges.set(r.id,r)),o}function qn(i,e,n,o){const s=(a,l)=>`${a[0]},${a[1]}-${l[0]},${l[1]}`,r=i.length;for(let a=0;a<r;a++){const l=i[a],c=l.origin,u=e.halfEdges.get(l.next).origin,d=s(u,c),h=n.get(d),p=Rn();let f;if(h!==void 0){const y=e.halfEdges.get(h);l.twin=y.id,y.twin=l.id,f={id:p,heLeft:y.id,heRight:l.id,bounds:Nt([c,u])},n.delete(d)}else{const y=s(c,u);if(n.set(y,l.id),o(c,u))f={id:p,heLeft:l.id,heRight:-1,bounds:Nt([c,u])},e.boundary.push(p);else continue}e.edges.set(p,f)}}function Xn(i){return function(){let e=i+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}async function ke(i){return Mi("Puzzle Generation",()=>{const{bounds:e,pieceSize:n,border:o}=i,{pointConfig:s,pieceConfig:r,placementConfig:a,tabConfig:l}=i;console.log(`rebuilding puzzle with dimensions ${e.width}x${e.height}, piece size ${n}`);const c=Ue.create(o,e,s),u=Fe.create(o,e,r),d=Ve.create(o,e,a),h=ce.create(o,e,l),p=i.seed??new Date().getTime(),f=Xn(p),y=i.seedPoints??c.generatePoints({width:e.width,height:e.height,pieceSize:n,random:f,border:o});console.log(`${i.seedPoints?"Using":"Generated"} ${y.length} points`);const w=u.generatePieces(y,{random:f,pieceSize:n,border:o,bounds:e,customPieces:i.customPieces});if(console.log(`Generated ${w.pieces.size} pieces`),!i.skipTabs){d.placeTabs({topology:w,random:f});for(const v of w.edges.values())v.heRight!==-1&&v.tabs&&v.tabs.length>0&&jn(v,w,h,f)}const m={created:new Date().toISOString(),seed:p,width:e.width,height:e.height,pieceSize:n,pointConfig:s,pieceConfig:r,placementConfig:a,tabConfig:l,seedPoints:y,vertices:w.vertices,boundary:w.boundary,borderPath:w.borderPath,pieces:w.pieces,edges:w.edges,halfEdges:w.halfEdges,customPieces:i.customPieces};return Promise.resolve(m)})}async function Tr(i,e,n){const o=[...i.seedPoints];let s=0;for(const r of i.pieces.values()){if(r.id===e){o[s]=n;break}s++}return ke({bounds:{width:i.width,height:i.height},border:i.borderPath,pieceSize:i.pieceSize,pointConfig:i.pointConfig,pieceConfig:i.pieceConfig,placementConfig:i.placementConfig,tabConfig:i.tabConfig,seed:i.seed,seedPoints:o,customPieces:i.customPieces,skipTabs:!1})}function $t(i,e){return[{type:"move",p:[0,0]},{type:"line",p:[i,0]},{type:"line",p:[i,e]},{type:"line",p:[0,e]},{type:"line",p:[0,0]}]}function kr(i){const e=i/2,n=e;return[{type:"move",p:[0,n]},{type:"arc",p:[i,n],radii:[e,e],rotation:0,largeArc:!1,sweep:!0},{type:"arc",p:[0,n],radii:[e,e],rotation:0,largeArc:!1,sweep:!0}]}function Mr(i,e){const n=i/2,o=e/2;return[{type:"move",p:[0,o]},{type:"arc",p:[i,o],radii:[n,o],rotation:0,largeArc:!1,sweep:!0},{type:"arc",p:[0,o],radii:[n,o],rotation:0,largeArc:!1,sweep:!0}]}function _r(i,e,n){const o=Math.min(i,e)/2,s=Math.min(n,o);return[{type:"move",p:[s,0]},{type:"line",p:[i-s,0]},{type:"arc",p:[i,s],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[i,e-s]},{type:"arc",p:[i-s,e],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[s,e]},{type:"arc",p:[0,e-s],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[0,s]},{type:"arc",p:[s,0],radii:[s,s],rotation:0,largeArc:!1,sweep:!0}]}function Dr(i,e,n){if(e<0||e>=i.vertices.length){console.warn("moveVertex called with invalid vertex index:",e);return}const o=i.vertices[e];i.vertices[e]=n;const s=[];for(const l of i.halfEdges.values())l.origin[0]===o[0]&&l.origin[1]===o[1]&&s.push(l);const r=new Set,a=[n[0]-o[0],n[1]-o[1]];for(const l of s){l.origin=n,r.add(l.piece);const c=i.halfEdges.get(l.prev);if(c?.segments){const u=c.segments[c.segments.length-1];u.type==="line"?u.p=n:(u.p3=n,u.p1=[u.p1[0]+a[0],u.p1[1]+a[1]],u.p2=[u.p2[0]+a[0],u.p2[1]+a[1]]),r.add(c.piece)}}Lr(i,e);for(const l of r){const c=i.pieces.get(l);c&&(c.bounds=Gn(c,i))}}function Lr(i,e){const{seed:n,width:o,height:s,placementConfig:r,tabConfig:a}=i,l=Xn(n),c=$t(o,s),u={width:o,height:s},d=Ve.create(c,u,r),h=ce.create(c,u,a),p=new Set,f=i.vertices[e],y=new Map;for(const m of i.edges.values())y.set(m.heLeft,m),m.heRight!==-1&&y.set(m.heRight,m);for(const m of i.halfEdges.values()){const v=i.halfEdges.get(m.next)?.origin;if(m.origin===f||v===f){const E=y.get(m.id);E&&p.add(E)}}d.updateTabPlacements(Array.from(p),{topology:i,random:l});const w=new Set;for(const m of p)if(m.heRight!==-1){const b=i.halfEdges.get(m.heLeft);b&&(b.segments=void 0,w.add(i.pieces.get(b.piece)));const P=i.halfEdges.get(m.heRight);P&&(P.segments=void 0,w.add(i.pieces.get(P.piece))),jn(m,i,h,l)}for(const m of w)m.bounds=Gn(m,i)}let Me=null,_e=null,De=null,Le=null,Ae=null,re=null,fe=!1,ne=null;function Ar(i,e){Me=n=>{const o=n.target;o.tagName==="INPUT"||o.tagName==="WA-INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable||n.code==="Space"&&(n.preventDefault(),i.isSpacebarPressed||(i.isSpacebarPressed=!0,Ke(i)))},_e=n=>{const o=n.target;o.tagName==="INPUT"||o.tagName==="WA-INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable||n.code==="Space"&&(i.isSpacebarPressed=!1,Ke(i),n.preventDefault())},De=n=>{if(n.preventDefault(),!i.paperCtx)return;const o=i.paperCtx.scope,s=-Math.sign(n.deltaY)*Pi,r=Math.max(vi,Math.min(wi,i.zoom+s));if(r!==i.zoom){const a=new o.Point(n.offsetX,n.offsetY),l=o.view.viewToProject(a),c=r/i.zoom;o.view.scale(c,l),i.zoom=r,e&&e(r),g.redraw()}},Le=n=>{i.isSpacebarPressed&&(fe=!0,ne={x:n.clientX,y:n.clientY},Ke(i),n.preventDefault())},Ae=n=>{if(i.isSpacebarPressed&&n.preventDefault(),fe&&ne){if(!i.paperCtx)return;const o=i.paperCtx.scope,s=n.clientX-ne.x,r=n.clientY-ne.y,a=s/i.zoom,l=r/i.zoom;o.view.translate(new o.Point(a,l)),ne={x:n.clientX,y:n.clientY}}},re=()=>{fe&&(fe=!1,ne=null,Ke(i))},window.addEventListener("keydown",Me),window.addEventListener("keyup",_e),i.canvas&&(i.canvas.addEventListener("wheel",De,{passive:!1}),i.canvas.addEventListener("mousedown",Le),i.canvas.addEventListener("mousemove",Ae),i.canvas.addEventListener("mouseup",re),i.canvas.addEventListener("mouseleave",re))}function Rr(i){Me&&(window.removeEventListener("keydown",Me),Me=null),_e&&(window.removeEventListener("keyup",_e),_e=null),i&&(De&&(i.removeEventListener("wheel",De),De=null),Le&&(i.removeEventListener("mousedown",Le),Le=null),Ae&&(i.removeEventListener("mousemove",Ae),Ae=null),re&&(i.removeEventListener("mouseup",re),i.removeEventListener("mouseleave",re),re=null)),fe=!1,ne=null}function Ke(i){if(i.canvas){if(i.isSpacebarPressed){i.canvas.style.cursor=fe?"grabbing":"grab";return}if(i.isDragging){i.canvas.style.cursor="grabbing";return}i.canvas.style.cursor="default"}}function et(i,e){for(const n of i.children)if(n.data.vertexId===e)return n;return null}function Ge(i,e,n){if(!n.paperCtx)return null;const o=n.paperCtx.scope,s=e.getBoundingClientRect();let r,a;if(i instanceof TouchEvent){if(i.changedTouches.length===0)return null;const c=i.changedTouches[0];r=c.clientX,a=c.clientY}else r=i.clientX,a=i.clientY;const l=new o.Point(r-s.left,a-s.top);return o.view.viewToProject(l)}function at(i){return[i.x,i.y]}function cn(i,e,n,o){const s=[...i.puzzle.seedPoints];let r=0;for(const a of i.puzzle.pieces.values()){if(a.id===n){s[r]=o;break}r++}ke({bounds:{width:i.puzzle.width,height:i.puzzle.height},border:i.puzzle.borderPath,pieceSize:i.puzzle.pieceSize,pointConfig:i.puzzle.pointConfig,pieceConfig:i.puzzle.pieceConfig,placementConfig:i.puzzle.placementConfig,tabConfig:i.puzzle.tabConfig,seed:i.puzzle.seed,seedPoints:s,skipTabs:!0}).then(a=>{e.draggedSeedPointId===n&&it(e,a,i.color,i.pointColor)}).catch(a=>{console.error("Failed to regenerate preview:",a)})}function Or(i,e,n){if(i.redraw=!1,n.isDragging||n.isSpacebarPressed||!n.canvas)return;const o=Ge(i,n.canvas,n);if(!o)return;let s=!1;const r=at(o);if(n.vertexItems){let a=-1,l=yi;const c=Ln(e.puzzle);for(let u=0;u<e.puzzle.vertices.length;u++){if(c.has(u))continue;const d=wr(e.puzzle.vertices[u],r);d<l&&(l=d,a=u)}if(a>=0){if(n.hoveredVertexId!==a){if(n.hoveredVertexId>=0){const d=et(n.vertexItems,n.hoveredVertexId);d&&(d.visible=!1)}const u=et(n.vertexItems,a);u&&(u.visible=!0,n.hoveredVertexId=a)}s=!0}else if(n.hoveredVertexId>=0){const u=et(n.vertexItems,n.hoveredVertexId);u&&(u.visible=!1,n.hoveredVertexId=-1)}}e.pointColor&&n.seedPointItems&&n.seedPointItems.hitTest(o,{fill:!0,tolerance:5})&&(s=!0),n.canvas.style.cursor=s?"grab":"default"}function Hr(i,e,n){if(!n.draggedCustomPieceId||!n.customPieceDragStart||!n.customPieceInitialTransform||!e.customPieces||!e.customPieces.find(u=>u.id===n.draggedCustomPieceId))return;const s=[i.x,i.y],r=s[0]-n.customPieceDragStart[0],a=s[1]-n.customPieceDragStart[1];let l;if(n.draggedHandleType==="piece")l={...n.customPieceInitialTransform,position:[n.customPieceInitialTransform.position[0]+r,n.customPieceInitialTransform.position[1]+a]};else if(n.draggedHandleType==="rotation"&&n.customPieceInitialAngle!==null){const u=n.customPieceInitialTransform.position,h=Math.atan2(s[1]-u[1],s[0]-u[0])-n.customPieceInitialAngle;l={...n.customPieceInitialTransform,rotation:n.customPieceInitialTransform.rotation+h}}else if(n.draggedHandleType==="scale"&&n.draggedCorner){const u=n.customPieceInitialTransform.position,d=Math.hypot(n.customPieceDragStart[0]-u[0],n.customPieceDragStart[1]-u[1]),p=Math.hypot(s[0]-u[0],s[1]-u[1])/d;l={...n.customPieceInitialTransform,scale:[n.customPieceInitialTransform.scale[0]*p,n.customPieceInitialTransform.scale[1]*p]}}else return;const c=e.customPieces.map(u=>u.id===n.draggedCustomPieceId?{...u,transform:l}:u);if(n.paperCtx){Dt(n,c,e.color,e.selectedCustomPieceId);const u=c.find(d=>d.id===n.draggedCustomPieceId);u&&Lt(n,u)}}function un(i,e,n){if(i.redraw=!1,!n.canvas||n.isSpacebarPressed)return;if(i instanceof TouchEvent&&i.touches.length>1){n.isDragging=!1,n.draggedVertexId=-1,n.draggedSeedPointId=-1;return}if(i instanceof MouseEvent&&i.button!==0)return;const o=Ge(i,n.canvas,n);if(o){if(e.selectedCustomPieceId&&n.customHandlesLayer){const s=n.customHandlesLayer.hitTest(o,{fill:!0,stroke:!0,tolerance:5});if(s?.item.data.handleType){const r=s.item.data.handleType;if(r==="rotation"||r==="scale"||r==="bbox"){const a=e.customPieces?.find(l=>l.id===e.selectedCustomPieceId);if(a){if(n.draggedCustomPieceId=e.selectedCustomPieceId,n.draggedHandleType=r==="bbox"?"piece":r==="rotation"?"rotation":"scale",n.draggedCorner=s.item.data.corner,n.customPieceDragStart=[o.x,o.y],n.customPieceInitialTransform={...a.transform},n.draggedHandleType==="rotation"){const l=a.transform.position;n.customPieceInitialAngle=Math.atan2(o.y-l[1],o.x-l[0])}else n.customPieceInitialAngle=null;n.isDragging=!0,i instanceof MouseEvent&&(n.documentMouseMove=l=>{const c=l;c.redraw=!1,me(c,e,n)},n.documentMouseUp=l=>{const c=l;c.redraw=!1,oe(c,e,n)},document.addEventListener("mousemove",n.documentMouseMove),document.addEventListener("mouseup",n.documentMouseUp));return}}}}if(e.customPieces&&n.customPiecesLayer){const s=n.customPiecesLayer.hitTest(o,{fill:!0,stroke:!0,tolerance:5});if(s?.item.data.customPieceId){const r=s.item.data.customPieceId;if(r!==e.selectedCustomPieceId){e.onCustomPieceSelected&&e.onCustomPieceSelected(r);return}const a=e.customPieces.find(l=>l.id===r);if(a){n.draggedCustomPieceId=r,n.draggedHandleType="piece",n.draggedCorner=null,n.customPieceDragStart=[o.x,o.y],n.customPieceInitialTransform={...a.transform},n.customPieceInitialAngle=null,n.isDragging=!0,i instanceof MouseEvent&&(n.documentMouseMove=l=>{const c=l;c.redraw=!1,me(c,e,n)},n.documentMouseUp=l=>{const c=l;c.redraw=!1,oe(c,e,n)},document.addEventListener("mousemove",n.documentMouseMove),document.addEventListener("mouseup",n.documentMouseUp));return}}}if(e.pointColor&&n.seedPointItems){const s=n.seedPointItems.hitTest(o,{fill:!0,tolerance:5});if(s?.item.data.pieceId!==void 0){n.draggedSeedPointId=s.item.data.pieceId,n.isDragging=!1,i instanceof MouseEvent&&(n.documentMouseMove=r=>{const a=r;a.redraw=!1,me(a,e,n)},n.documentMouseUp=r=>{const a=r;a.redraw=!1,oe(a,e,n)},document.addEventListener("mousemove",n.documentMouseMove),document.addEventListener("mouseup",n.documentMouseUp));return}}if(n.vertexItems){const s=n.vertexItems.hitTest(o,{fill:!0,tolerance:8});if(s?.item.data.vertexId!==void 0){n.draggedVertexId=s.item.data.vertexId,n.isDragging=!1,i instanceof MouseEvent&&(n.documentMouseMove=r=>{const a=r;a.redraw=!1,me(a,e,n)},n.documentMouseUp=r=>{const a=r;a.redraw=!1,oe(a,e,n)},document.addEventListener("mousemove",n.documentMouseMove),document.addEventListener("mouseup",n.documentMouseUp));return}}}}function me(i,e,n){if(i.redraw=!1,!n.canvas)return;const o=Ge(i,n.canvas,n);if(o){if(n.draggedCustomPieceId){n.isDragging=!0,i.preventDefault(),n.canvas.style.cursor="grabbing",Hr(o,e,n);return}if(n.draggedVertexId>=0){n.isDragging=!0,i.preventDefault(),n.canvas.style.cursor="grabbing";const s=at(o);if(Dr(e.puzzle,n.draggedVertexId,s),n.vertexItems){const r=et(n.vertexItems,n.draggedVertexId);r&&(r.position=o)}it(n,e.puzzle,e.color,e.pointColor);return}if(n.draggedSeedPointId>=0){n.isDragging=!0,i.preventDefault(),n.canvas.style.cursor="grabbing";const s=at(o),r=performance.now();if(r-n.lastRegenerationTime<Bt){n.pendingRegeneration&&clearTimeout(n.pendingRegeneration),n.pendingRegeneration=window.setTimeout(()=>{cn(e,n,n.draggedSeedPointId,s)},Bt);return}n.lastRegenerationTime=r,cn(e,n,n.draggedSeedPointId,s)}}}function oe(i,e,n){if(i.redraw=!1,!n.canvas)return;n.pendingRegeneration&&(clearTimeout(n.pendingRegeneration),n.pendingRegeneration=null);const o=n.draggedCustomPieceId&&n.isDragging,s=n.draggedVertexId>=0&&n.isDragging,r=n.draggedSeedPointId>=0&&n.isDragging;if(o){i.preventDefault();const a=Ge(i,n.canvas,n);if(a&&n.customPieceInitialTransform&&e.onCustomPieceTransformed){const l=[a.x,a.y],c=l[0]-n.customPieceDragStart[0],u=l[1]-n.customPieceDragStart[1];let d;if(n.draggedHandleType==="piece")d={...n.customPieceInitialTransform,position:[n.customPieceInitialTransform.position[0]+c,n.customPieceInitialTransform.position[1]+u]};else if(n.draggedHandleType==="rotation"&&n.customPieceInitialAngle!==null){const h=n.customPieceInitialTransform.position,f=Math.atan2(l[1]-h[1],l[0]-h[0])-n.customPieceInitialAngle;d={...n.customPieceInitialTransform,rotation:n.customPieceInitialTransform.rotation+f}}else if(n.draggedHandleType==="scale"){const h=n.customPieceInitialTransform.position,p=Math.hypot(n.customPieceDragStart[0]-h[0],n.customPieceDragStart[1]-h[1]),y=Math.hypot(l[0]-h[0],l[1]-h[1])/p;d={...n.customPieceInitialTransform,scale:[n.customPieceInitialTransform.scale[0]*y,n.customPieceInitialTransform.scale[1]*y]}}else d=n.customPieceInitialTransform;n.draggedCustomPieceId&&e.onCustomPieceTransformed(n.draggedCustomPieceId,d)}}if(s&&(i.preventDefault(),e.onPuzzleChanged(e.puzzle)),r){i.preventDefault();const a=n.draggedSeedPointId,l=Ge(i,n.canvas,n);if(l&&e.onSeedPointMoved){const c=at(l);e.onSeedPointMoved(a,c)}}n.documentMouseMove&&(document.removeEventListener("mousemove",n.documentMouseMove),n.documentMouseMove=null),n.documentMouseUp&&(document.removeEventListener("mouseup",n.documentMouseUp),n.documentMouseUp=null),n.isDragging=!1,n.draggedVertexId=-1,n.draggedSeedPointId=-1,n.draggedCustomPieceId=null,n.draggedHandleType=null,n.draggedCorner=null,n.customPieceDragStart=null,n.customPieceInitialTransform=null,n.customPieceInitialAngle=null,n.canvas.style.cursor="default"}const Nr=()=>{const i={canvas:null,isDragging:!1,draggedVertexId:-1,draggedSeedPointId:-1,lastRegenerationTime:0,pendingRegeneration:null,documentMouseMove:null,documentMouseUp:null,paperCtx:null,backgroundRaster:null,puzzleLayer:null,customPiecesLayer:null,customHandlesLayer:null,seedPointsLayer:null,verticesLayer:null,problemsLayer:null,paperPath:null,seedPointItems:null,problemItems:null,vertexItems:null,hoveredVertexId:-1,selectedPieceId:-1,draggedCustomPieceId:null,draggedHandleType:null,draggedCorner:null,customPieceDragStart:null,customPieceInitialTransform:null,customPieceInitialAngle:null,zoom:dt,isSpacebarPressed:!1},e=(r,a)=>{if(r===i.zoom||!i.paperCtx)return;const l=i.paperCtx.scope,c=r/i.zoom;l.view.scale(c,l.view.center),i.zoom=r,a?.onZoomChanged&&a.onZoomChanged(r),g.redraw()},n=()=>{if(!i.paperCtx)return;const r=i.paperCtx.scope,a=dt/i.zoom;r.view.scale(a,r.view.center),i.zoom=dt,r.view.center=new r.Point(r.view.viewSize.width/2,r.view.viewSize.height/2),g.redraw()},o=()=>`${Math.round(i.zoom*100)}%`;let s;return{oncreate:({dom:r,attrs:a})=>{if(i.canvas=r.querySelector("canvas.puzzle-renderer"),!i.canvas){console.error("PuzzleRenderer: couldn't get canvas element");return}if(_i(i.canvas,a.width,a.height,i),Di(i),Ar(i,a.onZoomChanged),Kt(i,a.imageUrl,a.width,a.height),s=a.imageUrl,a.isDirty||it(i,a.puzzle,a.color,a.pointColor),a.customPieces&&a.customPieces.length>0)if(Dt(i,a.customPieces,a.color,a.selectedCustomPieceId),a.selectedCustomPieceId){const l=a.customPieces.find(c=>c.id===a.selectedCustomPieceId);l&&Lt(i,l)}else pt(i)},onupdate:({attrs:r})=>{if(!i.canvas){console.error("PuzzleRenderer: couldn't get canvas element");return}if(r.imageUrl!==s&&(Kt(i,r.imageUrl,r.width,r.height),s=r.imageUrl),r.isDirty||it(i,r.puzzle,r.color,r.pointColor),r.customPieces&&r.customPieces.length>0)if(Dt(i,r.customPieces,r.color,r.selectedCustomPieceId),r.selectedCustomPieceId){const a=r.customPieces.find(l=>l.id===r.selectedCustomPieceId);a&&Lt(i,a)}else pt(i);else i.customPiecesLayer&&(i.customPiecesLayer.removeChildren(),pt(i))},onremove:()=>{i.documentMouseMove&&(document.removeEventListener("mousemove",i.documentMouseMove),i.documentMouseMove=null),i.documentMouseUp&&(document.removeEventListener("mouseup",i.documentMouseUp),i.documentMouseUp=null),Rr(i.canvas),Ai(i)},view:({attrs:r})=>{const a=o();return g(".puzzle-renderer-wrapper",[g("canvas.puzzle-renderer",{key:"puzzle-renderer-canvas",width:r.width,height:r.height,style:{width:`${r.width}px`,height:`${r.height}px`,touchAction:"manipulation"},onmousedown:l=>un(l,r,i),onmousemove:l=>{Or(l,r,i),me(l,r,i)},onmouseup:l=>oe(l,r,i),ontouchstart:l=>un(l,r,i),ontouchmove:l=>me(l,r,i),ontouchend:l=>oe(l,r,i),ontouchcancel:l=>oe(l,r,i)}),g(".puzzle-renderer-controls",{key:"puzzle-renderer-controls"},[g("wa-dropdown.zoom-control",{"onwa-select":l=>{l.redraw=!1;const c=l.detail.item.value;if(c&&typeof c=="string"){const u=parseFloat(c);isNaN(u)||e(u,r)}}},[g("wa-button",{slot:"trigger","with-caret":!0,size:"small",value:i.zoom},a),...bi.map((l,c)=>g("wa-dropdown-item",{type:"checkbox",checked:i.zoom==l?!0:void 0,value:l.toString()},xi[c]))]),g("wa-tooltip",{for:"recenter-button"},"Recenter view"),g("wa-button#recenter-button",{appearance:"plain",size:"large",onclick:()=>{n()}},g("wa-icon",{library:"material",name:"recenter",label:"Recenter view"}))])])}}};function $r(i,e,n,o="black"){const r=[];for(const c of i.edges.values()){const u=i.halfEdges.get(c.heLeft);if(u)if(r.push(`M ${u.origin[0].toFixed(3)} ${u.origin[1].toFixed(3)}`),u.segments)for(const d of u.segments)switch(d.type){case"bezier":r.push(`C ${d.p1[0].toFixed(3)} ${d.p1[1].toFixed(3)}, ${d.p2[0].toFixed(3)} ${d.p2[1].toFixed(3)}, ${d.p3[0].toFixed(3)} ${d.p3[1].toFixed(3)}`);break;case"line":r.push(`L ${d.p[0].toFixed(3)} ${d.p[1].toFixed(3)}`);break}else{let d;u.twin!==-1?d=i.halfEdges.get(u.twin).origin:d=i.halfEdges.get(u.next).origin,r.push(`L ${d[0].toFixed(3)} ${d[1].toFixed(3)}`)}}const a=r.join(" ");return`
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg
  width="${e}"
  height="${n}"
  viewBox="0 0 ${e} ${n}"
  xmlns="http://www.w3.org/2000/svg"
  version="1.1"
>
  <path
    d="${a}"
    fill="none"
    stroke="${o}"
    stroke-width="1"
    vector-effect="non-scaling-stroke"
  />
</svg>`.trim().replace(/\r\n/g,`
`)}function Ur(i,e="puzzle.svg"){const n=new Blob([i],{type:"image/svg+xml"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=e,s.hidden=!0,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(o),100)}const Fr={view:({attrs:i})=>g("wa-button.download-svg",{size:"small",onclick:()=>{const e=$r(i.puzzle,i.width,i.height,i.color);Ur(e,i.filename??"puzzle.svg")}},"Download SVG")},Vr={view:({attrs:i})=>{const e=i.progressPercent!==void 0&&i.progressPercent<100,n=!e&&i.problems!==void 0&&i.problems==0,o=!e&&i.problems!==void 0&&i.problems>0;return g(".geometry-check-indicator",[g(".label","Geometry Check:"),g("wa-tooltip",{for:"check-geometry-now"},"Check geometry now"),g("wa-button#check-geometry-now",{variant:"neutral",appearance:"plain",size:"small",disabled:e,onclick:s=>{s.redraw=!1,i.onCheckRequested?.()}},g("wa-icon",{library:"material",name:"editor_choice",label:"Check geometry now"})),g("wa-tooltip",{for:"auto-check-geometry"},"Check geometry after every change"),g("wa-checkbox#auto-check-geometry",{checked:i.autoCheck,disabled:e,size:"small",onchange:s=>{s.redraw=!1;const r=s.target;i.onAutocheckChanged?.(r.checked)}},"auto check"),e&&g("wa-progress-bar",{label:"Geometry check progress",value:i.progressPercent??0}),n&&g("wa-badge",{variant:"success",pill:!0},"OK"),o&&g("wa-badge",{variant:"danger",pill:!0},`${i.problems} issue${i.problems===1?"":"s"}`)])}};function Gr(i,e,n=800){if(i<=n)return{width:i,height:e};const o=e/i;return{width:n,height:Math.round(n*o)}}const jr=()=>{const i={inputElement:void 0,imageLoaded:!1,imageName:""};return{view:({attrs:e})=>[g("wa-button.upload-button",{size:"small",disabled:e.disabled===!0,onclick:()=>{i.inputElement&&i.inputElement.click()}},e.label??"Upload Image"),g("input[type=file]",{style:{display:"none"},accept:"image/*",oncreate:({dom:n})=>{i.inputElement=n},onchange:n=>{if(n.redraw=!1,i.inputElement){const o=i.inputElement.files?.[0];o?.type.startsWith("image/")&&createImageBitmap(o).then(s=>{const{width:r,height:a}=Gr(s.width,s.height),l=URL.createObjectURL(o);s.close(),i.imageName=o.name,e.onUpload(l,o.name,r,a),i.imageLoaded=!0}).catch(s=>{console.error("could not create a bitmap image: ",s)})}}}),g("span.background-image-label",i.imageName),i.imageLoaded&&g("wa-icon.clear-button",{library:"material",name:"close",label:"Clear background image",onclick:n=>{n.redraw=!1,!e.disabled&&(i.imageName="",i.imageLoaded=!1,e.onClear())}},"Clear")]}},Bn=()=>({view:({attrs:i})=>g("wa-checkbox.boolean-input",{hint:i.config.helpText,disabled:i.disabled,checked:i.value,onchange:e=>{const o=e.target.checked;i.onChange(o)}},i.config.label)}),tt=()=>({view:({attrs:i})=>g("wa-input.number-input",{label:i.config.label,hint:i.config.helpText,type:"number",inputmode:"numeric",size:"small",disabled:i.disabled,value:i.value,min:i.config.min,max:i.config.max,onchange:e=>{const n=e.target,o=parseFloat(n.value??"");i.onChange(isNaN(o)?void 0:o)}})}),Wr=()=>({view:({attrs:i})=>g("wa-slider.range-input",{label:i.config.label,hint:i.config.helpText,disabled:i.disabled,value:i.value,min:i.config.min,max:i.config.max,step:i.config.step,"with-tooltip":!0,onchange:e=>{const o=e.target.value;i.onChange(isNaN(o)?void 0:o)}})}),Yn=()=>({view:({attrs:i})=>g("wa-input.string-input",{label:i.config.label,hint:i.config.helpText,type:"text",size:"small",disabled:i.disabled,value:i.value,oninput:e=>{e.redraw=!1;const o=e.target.value??"";i.onChange(o.length>0?o:void 0)}})}),qr=()=>({view:({attrs:i})=>{const e=i.registry.getAvailableGenerators();return g(".generator-picker",g("wa-tab-group",{active:i.generator,"onwa-tab-show":n=>{const o=n.detail.name;i.generator!==o&&i.onGeneratorChange(o)}},[...e.map(n=>{const o=i.registry.getUIMetadata(n.name),s=g("wa-tab",{panel:n.name},n.displayName),r=g("wa-tab-panel",{name:n.name},g(".controls",[o?.description?g("p",o.description):null,...o?.controls.map(a=>{switch(a.type){case"range":return g(Wr,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:l=>{i.onConfigChange(a.name,l)}});case"boolean":return g(Bn,{config:a,value:(i.config?.[a.name]??a.defaultValue)===!0,onChange:l=>{i.onConfigChange(a.name,l)}});case"number":return g(tt,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:l=>{i.onConfigChange(a.name,l)}});case"string":return g(Yn,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:l=>{i.onConfigChange(a.name,l)}})}})??[],!o?.description&&o?.controls.length==0?g("p","No controls for this strategy."):null]));return[s,r]})]))}}),hn=[["Square","1:1",1],["Classic Photo","5:4",5/4],["Standard Photo","4:3",4/3],["35mm/DSLR","3:2",3/2],["Widescreen","16:9",16/9],["UltraWide","21:9",21/9],["Panorama","2:1",2/1],["Instagram Portrait","4:5",4/5],["Classic Portrait","3:4",3/4],["DSLR Portrait","2:3",2/3],["Phone Portrait","9:16",9/16],["Tall Poster","9:21",9/21],["Tall Panorama","1:2",1/2]],Xr={view:({attrs:i})=>{const e=!hn.some(([,,o])=>o===i.ratio),n=hn.map(([o,s,r])=>g("wa-option",{value:String(r)},`${o} [${s}]`));return e&&n.unshift(g("wa-option",{value:"custom"},"Custom")),g(".aspect-ratio-picker",[g("wa-select",{label:"Aspect Ratio",size:"small",disabled:i.disabled,value:e?"custom":String(i.ratio),onchange:o=>{o.redraw=!1;const r=o.target.value;r&&r!=="custom"&&i.onChange(Number(r))}},n),g("wa-slider",{min:.25,max:4,step:.01,"with-tooltip":!0,size:"small",disabled:i.disabled,value:i.ratio,onchange:o=>{o.redraw=!1;const s=o.target;i.onChange(s.value)}})])}},dn={view:({attrs:i})=>g("wa-color-picker",{label:i.label,value:i.color,size:i.size??"medium",format:"rgb",onchange:e=>{e.redraw=!1;const n=e.target;i.onUpdate(n.value??"")}})},Br=[["rectangle","Rectangle"],["circle","Circle"],["ellipse","Ellipse"],["rounded-rect","Rounded Rectangle"]],Yr={view:({attrs:i})=>{const e=Br.map(([n,o])=>g("wa-option",{value:n},o));return g("wa-select",{label:"Border Shape",size:"small",disabled:i.disabled,value:i.shape,onchange:n=>{n.redraw=!1;const s=n.target.value;s&&i.onChange(s)}},e)}},se=10,Pt="#2196F3",pn=2,Kr="#999999",Zr=1,Jr=[4,4],fn=.5,Qr=15,eo=10,to="#4CAF50",no=2,io=.1,ro=10,bt=1,oo=.025,so=[.25,.5,1,2,4],ao=["25%","50%","100%","200%","400%"];let Re=null,Oe=null,He=null,Ne=null,$e=null,ae=null,ge=!1,ie=null;function lo(i,e,n){if(!i.paperCtx)throw new Error("PathEditor: Cannot setup mouse handling - Paper.js context not initialized");const o=V(i.paperCtx,"PathEditor:setupTool",()=>{const s=i.paperCtx.scope;return new s.Tool});return Re=s=>{const r=s.target;r.tagName==="INPUT"||r.tagName==="WA-INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable||(s.code==="Space"?(s.preventDefault(),i.isSpacebarPressed||(i.isSpacebarPressed=!0,X(i))):s.key==="Shift"&&!i.isShiftPressed?(i.isShiftPressed=!0,X(i)):(s.code==="Delete"||s.code==="Backspace")&&(i.mode==="edit"&&i.selectedSegment&&i.path&&i.paperCtx&&i.path.segments.length>2&&(i.selectedSegment.remove(),i.selectedSegment=null,i.selectedHandle=null,V(i.paperCtx,"PathEditor:deleteSegment",()=>{e()})),s.preventDefault()))},Oe=s=>{const r=s.target;r.tagName==="INPUT"||r.tagName==="WA-INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable||(s.code==="Space"?(i.isSpacebarPressed=!1,X(i),s.preventDefault()):s.key==="Shift"&&(i.isShiftPressed=!1,X(i)))},He=s=>{if(s.preventDefault(),!i.paperCtx)return;const r=i.paperCtx.scope,a=-Math.sign(s.deltaY)*oo,l=Math.max(io,Math.min(ro,i.zoom+a));if(l!==i.zoom){const c=new r.Point(s.offsetX,s.offsetY),u=r.view.viewToProject(c),d=l/i.zoom;r.view.scale(d,u),i.zoom=l,n()}},Ne=s=>{i.isSpacebarPressed&&(ge=!0,ie={x:s.clientX,y:s.clientY},X(i),s.preventDefault())},$e=s=>{if(i.isSpacebarPressed&&s.preventDefault(),ge&&ie){if(!i.paperCtx)return;const r=i.paperCtx.scope,a=s.clientX-ie.x,l=s.clientY-ie.y,c=a/i.zoom,u=l/i.zoom;r.view.translate(new r.Point(c,u)),ie={x:s.clientX,y:s.clientY}}},ae=()=>{ge&&(ge=!1,ie=null,X(i))},window.addEventListener("keydown",Re),window.addEventListener("keyup",Oe),i.canvas&&(i.canvas.addEventListener("wheel",He,{passive:!1}),i.canvas.addEventListener("mousedown",Ne),i.canvas.addEventListener("mousemove",$e),i.canvas.addEventListener("mouseup",ae),i.canvas.addEventListener("mouseleave",ae)),o.onMouseDown=s=>{i.isSpacebarPressed||(i.mode==="draw"?uo(i,s,e):po(i,s))},o.onMouseDrag=s=>{i.isSpacebarPressed||(i.mode==="draw"?ho(i,s):fo(i,s))},o.onMouseUp=()=>{i.isSpacebarPressed||(i.mode==="draw"?i.pendingPoint&&i.path&&i.paperCtx&&(V(i.paperCtx,"PathEditor:onMouseUp",()=>{const s=i.paperCtx.scope;if(i.isDraggingCurve&&i.previewPath&&i.previewPath.segments.length>0){const r=i.previewPath.lastSegment,a=new s.Segment(i.pendingPoint,r.handleIn,r.handleOut);if(i.path.add(a),i.path.segments.length>1&&i.previewPath.segments.length>1){const l=i.path.segments[i.path.segments.length-2],c=i.previewPath.segments[0];l.handleOut=c.handleOut}}else i.path.add(i.pendingPoint);i.pendingPoint=null,i.isDraggingCurve=!1,i.previewPath&&(i.previewPath.removeSegments(),i.previewPath.visible=!1),e()}),X(i)):i.paperCtx&&V(i.paperCtx,"PathEditor:onMouseUp-editMode",()=>{e()}))},o.onMouseMove=s=>{i.isSpacebarPressed||(i.mode==="draw"?Kn(i,s.point):i.mode==="edit"&&X(i,s.point))},o.activate(),o}function co(i){Re&&(window.removeEventListener("keydown",Re),Re=null),Oe&&(window.removeEventListener("keyup",Oe),Oe=null),i&&(He&&(i.removeEventListener("wheel",He),He=null),Ne&&(i.removeEventListener("mousedown",Ne),Ne=null),$e&&(i.removeEventListener("mousemove",$e),$e=null),ae&&(i.removeEventListener("mouseup",ae),i.removeEventListener("mouseleave",ae),ae=null)),ge=!1,ie=null}function X(i,e){if(i.canvas){if(i.isSpacebarPressed){i.canvas.style.cursor=ge?"grabbing":"grab";return}if(i.mode==="draw"){i.isNearFirstPoint?i.canvas.style.cursor="copy":i.canvas.style.cursor="crosshair";return}if(i.mode==="edit"){if(i.isShiftPressed){i.canvas.style.cursor="crosshair";return}if(e&&i.path){if(i.selectedSegment!==null||i.path.fullySelected){const r=i.path.hitTest(e,{handles:!0,tolerance:se});if(r?.type==="handle-in"||r?.type==="handle-out"){i.canvas.style.cursor="pointer";return}}if(i.path.hitTest(e,{segments:!0,tolerance:se})?.segment){i.canvas.style.cursor="move";return}if(i.path.hitTest(e,{stroke:!0,tolerance:se})){i.canvas.style.cursor="pointer";return}}}i.canvas.style.cursor="default"}}function uo(i,e,n){if(!(!i.path||!i.paperCtx)){if(i.isNearFirstPoint&&i.path.segments.length>=2){i.path.closed=!0,i.snapIndicator&&(i.snapIndicator.visible=!1),i.mode="edit",i.isNearFirstPoint=!1,i.previewPath&&(i.previewPath.removeSegments(),i.previewPath.visible=!1),V(i.paperCtx,"PathEditor:closePathBySnapping",()=>{n()});return}i.path.segments.length>0&&V(i.paperCtx,"PathEditor:handleDrawModeDown",()=>{const o=i.paperCtx.scope,s=i.path.lastSegment;s.handleOut&&s.handleOut.length>0&&(s.handleOut=new o.Point(0,0))}),i.pendingPoint=e.point.clone(),i.isDraggingCurve=!1,Kn(i,e.point)}}function ho(i,e){!i.path||!i.previewPath||!i.pendingPoint||!i.paperCtx||V(i.paperCtx,"PathEditor:handleDrawModeDrag",()=>{const n=i.paperCtx.scope;i.isDraggingCurve=!0;const o=i.pendingPoint,s=e.point.subtract(o),r=s.multiply(fn),a=s.multiply(-fn);let l=new n.Point(0,0);if(i.path.segments.length>0){const c=i.path.lastSegment,u=o.subtract(c.point);if(i.path.segments.length>1)if(c.handleIn&&c.handleIn.length>0){const f=c.handleIn.normalize(),y=u.length;l=f.multiply(-y)}else if(i.path.segments.length>1){const f=i.path.segments[i.path.segments.length-2];l=c.point.subtract(f.point).multiply(.33)}else l=u.multiply(.33);i.previewPath.removeSegments();const d=new n.Segment(c.point,new n.Point(0,0),l);i.previewPath.add(d);const h=new n.Segment(o,a,r);i.previewPath.add(h),i.previewPath.visible=!0}else{i.previewPath.removeSegments();const c=new n.Segment(o,a,r);i.previewPath.add(c),i.previewPath.visible=!0}})}function Kn(i,e){!i.previewPath||!i.path||!i.paperCtx||V(i.paperCtx,"PathEditor:updatePreviewPath",()=>{const n=i.paperCtx.scope;if(i.previewPath.removeSegments(),i.isNearFirstPoint=!1,i.snapIndicator&&(i.snapIndicator.visible=!1),i.path.segments.length>0){const o=i.path.lastSegment.point;if(i.path.segments.length>=2){const s=i.path.firstSegment.point;if(e.getDistance(s)<Qr){i.isNearFirstPoint=!0,i.previewPath.moveTo(o),i.previewPath.lineTo(s),i.previewPath.visible=!0,i.snapIndicator?(i.snapIndicator.position=s,i.snapIndicator.visible=!0):i.snapIndicator=new n.Path.Circle({center:s,radius:eo,strokeColor:new n.Color(to),strokeWidth:no,fillColor:null}),X(i);return}}i.previewPath.moveTo(o),i.previewPath.lineTo(e),i.previewPath.visible=!0,X(i)}else i.previewPath.visible=!1,X(i)})}function po(i,e){if(!i.path)return;if(i.isShiftPressed){const r=i.path.hitTest(e.point,{stroke:!0,tolerance:se});if(r?.location){const a=r.location,l=i.path.insert(a.index+1,a.point);for(const c of i.path.segments)c.selected=!1;l.selected=!0,i.selectedSegment=l,i.selectedHandle=null,i.path.fullySelected=!1;return}return}if(i.selectedSegment!==null||i.path.fullySelected){const r=i.path.hitTest(e.point,{handles:!0,tolerance:se});if(r?.type==="handle-in"||r?.type==="handle-out"){i.selectedHandle={segment:r.segment,type:r.type==="handle-in"?"handleIn":"handleOut"},i.selectedSegment=null;return}}const o=i.path.hitTest(e.point,{segments:!0,tolerance:se});if(o?.segment){for(const r of i.path.segments)r.selected=!1;i.selectedSegment=o.segment,i.selectedSegment.selected=!0,i.selectedHandle=null;return}if(i.path.hitTest(e.point,{stroke:!0,tolerance:se})){i.path.fullySelected=!0,i.selectedSegment=null,i.selectedHandle=null;return}i.selectedSegment=null,i.selectedHandle=null,i.path.selected=!1,i.path.fullySelected=!1;for(const r of i.path.segments)r.selected=!1}function fo(i,e){if(i.selectedSegment)i.selectedSegment.point=i.selectedSegment.point.add(e.delta);else if(i.selectedHandle){const{segment:n,type:o}=i.selectedHandle,s=e.point.subtract(n.point);o==="handleOut"?n.handleOut=s:n.handleIn=s}}const Zn=()=>{const i={canvas:null,paperCtx:null,path:null,previewPath:null,mode:"draw",selectedSegment:null,selectedHandle:null,zoom:bt,isSpacebarPressed:!1,isShiftPressed:!1,pendingPoint:null,isDraggingCurve:!1,isNearFirstPoint:!1,snapIndicator:null};let e=null,n;const o=(u,d)=>{if(i.paperCtx=Dn(u,d.width,d.height),i.canvas=u,!i.paperCtx){console.error("PathEditor: Failed to create Paper.js context");return}V(i.paperCtx,"PathEditor:initializePaper",()=>{const h=i.paperCtx.scope;if(!nt(h,"PathEditor:initializePaper")){console.error("PathEditor: Paper.js not ready - canvas may have been replaced");return}h.settings.handleSize=8;const p=d.initialPath&&d.initialPath.length>0;if(i.mode=p?"edit":"draw",i.path=new h.Path,i.path.strokeColor=new h.Color(d.strokeColor??Pt),i.path.strokeWidth=pn,p&&d.initialPath){const f=_t(d.initialPath,i.paperCtx);i.path.segments=f.segments,i.path.strokeColor=new h.Color(d.strokeColor??Pt),i.path.strokeWidth=pn}i.previewPath=new h.Path,i.previewPath.strokeColor=new h.Color(Kr),i.previewPath.strokeWidth=Zr,i.previewPath.dashArray=Jr,i.previewPath.visible=!1,e=lo(i,()=>{s(d)},()=>{g.redraw()})})},s=u=>{if(i.path){const d=Ci(i.path);u.onPathChanged(d)}g.redraw()},r=u=>{i.mode==="draw"&&(i.mode="edit",i.pendingPoint=null,i.isDraggingCurve=!1,i.isNearFirstPoint=!1,i.previewPath&&(i.previewPath.removeSegments(),i.previewPath.visible=!1),i.snapIndicator&&(i.snapIndicator.visible=!1),s(u))},a=()=>{e&&(e.remove(),e=null),co(i.canvas),i.paperCtx&&i.paperCtx.scope.project.remove(),i.canvas=null,i.paperCtx=null,i.path=null,i.previewPath=null,i.snapIndicator=null,i.selectedSegment=null,i.selectedHandle=null},l=u=>{if(u===i.zoom||!i.paperCtx)return;const d=i.paperCtx.scope,h=u/i.zoom;d.view.scale(h,d.view.center),i.zoom=u,g.redraw()},c=()=>`${Math.round(i.zoom*100)}%`;return{oncreate:({dom:u,attrs:d})=>{const h=u.querySelector("canvas");h&&(o(h,d),n=d.initialPath)},onremove:()=>{a()},onupdate:({attrs:u})=>{if(!i.path||!i.paperCtx||(u.strokeColor&&(i.path.strokeColor=new i.paperCtx.scope.Color(u.strokeColor)),u.initialPath===n))return;const d=n?.length??0,h=u.initialPath?.length??0;if(n=u.initialPath,d===h)return;u.initialPath&&u.initialPath.length>0?u.initialPath&&i.paperCtx&&V(i.paperCtx,"PathEditor:onupdate-loadPath",()=>{const f=i.paperCtx.scope;if(!nt(f,"PathEditor:onupdate-loadPath")){console.error("PathEditor: Paper.js not ready during path reload - canvas may have been replaced");return}i.path.removeSegments();const y=_t(u.initialPath,i.paperCtx);i.path.segments=y.segments,i.path.strokeColor=new f.Color(u.strokeColor??Pt),i.mode="edit",i.selectedSegment=null,i.selectedHandle=null,i.pendingPoint=null,i.isDraggingCurve=!1,i.isNearFirstPoint=!1,i.snapIndicator&&(i.snapIndicator.visible=!1),g.redraw()}):(i.path.removeSegments(),i.mode="draw",i.selectedSegment=null,i.selectedHandle=null,i.pendingPoint=null,i.isDraggingCurve=!1,i.isNearFirstPoint=!1,i.snapIndicator&&(i.snapIndicator.visible=!1),g.redraw())},view:({attrs:u})=>{const d=c();return g(".path-editor",[g("canvas",{key:"path-editor-canvas",width:u.width,height:u.height,style:{width:`${u.width}px`,height:`${u.height}px`}}),g(".path-editor-controls",{key:"path-editor-controls"},[g(".mode-indicator",`Mode: ${i.mode==="draw"?"Drawing":"Editing"}`),i.mode==="draw"&&g("wa-button.end-drawing-button",{variant:"success",size:"small",onclick:()=>r(u)},"End Drawing"),g("wa-dropdown.zoom-control",{"onwa-select":h=>{h.redraw=!1;const p=h.detail.item.value;if(p&&typeof p=="string"){const f=parseFloat(p);isNaN(f)||l(f)}}},[g("wa-button",{slot:"trigger","with-caret":!0,size:"small",value:i.zoom},d),...so.map((h,p)=>g("wa-dropdown-item",{type:"checkbox",checked:i.zoom==h?!0:void 0,value:h.toString()},ao[p]))]),g("wa-tooltip",{for:"recenter-button"},"Recenter view"),g("wa-button#recenter-button",{appearance:"plain",size:"large",onclick:()=>{i.paperCtx&&V(i.paperCtx,"PathEditor:recenter",()=>{const h=i.paperCtx.scope,p=bt/i.zoom;h.view.scale(p,h.view.center),i.zoom=bt,h.view.center=new h.Point(h.view.viewSize.width/2,h.view.viewSize.height/2)})}},g("wa-icon",{library:"material",name:"recenter",label:"Recenter view"}))])])}}};function Jn(i,e=.5){const n=[];let o=[0,0];for(const s of i)switch(s.type){case"move":o=s.p,n.push(o);break;case"line":o=s.p,n.push(o);break;case"bezier":{const r=Math.max(8,Math.ceil(Math.hypot(s.p3[0]-o[0],s.p3[1]-o[1])/e));for(let a=1;a<=r;a++){const l=a/r,c=l*l,u=c*l,d=1-l,h=d*d,p=h*d,f=p*o[0]+3*h*l*s.p1[0]+3*d*c*s.p2[0]+u*s.p3[0],y=p*o[1]+3*h*l*s.p1[1]+3*d*c*s.p2[1]+u*s.p3[1];n.push([f,y])}o=s.p3;break}case"arc":{const r=Math.max(8,Math.ceil(Math.hypot(s.p[0]-o[0],s.p[1]-o[1])/e));for(let a=1;a<=r;a++){const l=a/r,c=o[0]+l*(s.p[0]-o[0]),u=o[1]+l*(s.p[1]-o[1]);n.push([c,u])}o=s.p;break}}return n}function mo(i){const e=Jn(i);if(e.length===0)return[0,0,0,0];let n=e[0][0],o=e[0][1],s=e[0][0],r=e[0][1];for(let a=1;a<e.length;a++){const[l,c]=e[a];l<n&&(n=l),l>s&&(s=l),c<o&&(o=c),c>r&&(r=c)}return[n,o,s,r]}function go(i,e,n,o){const[s,r,a,l]=mo(i),c=a-s,u=l-r,d=Math.max(c,u),h=d>0?o/d:1;return{position:[e/2,n/2],rotation:0,scale:[h,h]}}function Qn(i,e=.01){if(i.length<2)return!1;let n=null;for(const l of i)if(l.type==="move"){n=l.p;break}if(!n)return!1;let o=null;for(let l=i.length-1;l>=0;l--){const c=i[l];switch(c.type){case"move":case"line":o=c.p;break;case"bezier":o=c.p3;break;case"arc":o=c.p;break}if(o)break}if(!o)return!1;const s=n[0]-o[0],r=n[1]-o[1];return Math.sqrt(s*s+r*r)<=e}function yo(i,e,n,o){const[s,r]=i,[a,l]=e,[c,u]=n,[d,h]=o,p=(s-a)*(u-h)-(r-l)*(c-d);if(Math.abs(p)<1e-10)return null;const f=((s-c)*(u-h)-(r-u)*(c-d))/p,y=-((s-a)*(r-u)-(r-l)*(s-c))/p;if(f>0&&f<1&&y>0&&y<1){const w=s+f*(a-s),m=r+f*(l-r);return[w,m]}return null}function Ze(i,e,n){const o=i[0]-e[0],s=i[1]-e[1];return Math.sqrt(o*o+s*s)<=n}function vo(i,e,n,o,s){return Ze(i,n,s)||Ze(i,o,s)||Ze(e,n,s)||Ze(e,o,s)}function wo(i){const e=Jn(i);if(e.length<4)return[];const n=[],o=1;for(let s=0;s<e.length-1;s++)for(let r=s+2;r<e.length-1;r++){const a=e[s],l=e[s+1],c=e[r],u=e[r+1];if(vo(a,l,c,u,o))continue;const d=yo(a,l,c,u);d&&n.push(d)}return n}function mn(i){const e=[];let n;Qn(i)||e.push("Path must be closed (first point must equal last point)");const o=wo(i);return o.length>0&&(e.push(`Path has ${o.length} self-intersection${o.length>1?"s":""}`),n=o),{isValid:e.length===0,errors:e,intersections:n}}function ei(i){try{const n=new DOMParser().parseFromString(i,"image/svg+xml"),o=n.querySelector("parsererror");if(o)return console.error("[SVGParser] XML parsing error:",o.textContent),{commands:[],warning:"Failed to parse SVG"};const s=n.querySelector("path");if(!s)return console.error("[SVGParser] No path element found in SVG"),{commands:[],warning:"Failed to parse SVG: no path element"};const r=s.getAttribute("d");return r?Po(r):(console.error("[SVGParser] Path element has no d attribute"),{commands:[],warning:"Failed to parse SVG: Path element has no d attribute"})}catch(e){return console.error("[SVGParser] Error parsing SVG:",e),{commands:[],warning:"Failed to parse SVG"}}}function Po(i){const e=[];let n=!1;const s=i.replace(/([MmLlHhVvCcSsQqTtAaZz])/g," $1 ").replace(/(\d)-/g,"$1 -").replace(/,/g," ").replace(/\s+/g," ").trim().split(" ").filter(m=>m.length>0);let r=0,a=0,l=0,c=0,u=0,d=0,h=0,p="",f=!0;const y=()=>{const m=parseFloat(s[r]);return r++,m};for(;r<s.length;){let m=s[r];isNaN(parseFloat(m))?r++:p==="M"?m="L":p==="m"?m="l":m=p;const v=m===m.toLowerCase();switch(m.toUpperCase()){case"M":{if(!f){n=!0,r=s.length;break}f=!1;const P=y(),E=y();v?(a+=P,l+=E):(a=P,l=E),c=a,u=l,e.push({type:"move",p:[a,l]}),p=m;break}case"L":{const P=y(),E=y();v?(a+=P,l+=E):(a=P,l=E),e.push({type:"line",p:[a,l]}),d=a,h=l,p=m;break}case"H":{const P=y();v?a+=P:a=P,e.push({type:"line",p:[a,l]}),d=a,h=l,p=m;break}case"V":{const P=y();v?l+=P:l=P,e.push({type:"line",p:[a,l]}),d=a,h=l,p=m;break}case"C":{const P=y(),E=y(),x=y(),S=y(),z=y(),C=y();let I=P,T=E,k=x,M=S,D=z,L=C;v&&(I+=a,T+=l,k+=a,M+=l,D+=a,L+=l),e.push({type:"bezier",p1:[I,T],p2:[k,M],p3:[D,L]}),d=k,h=M,a=D,l=L,p=m;break}case"S":{const P=y(),E=y(),x=y(),S=y(),z=2*a-d,C=2*l-h;let I=P,T=E,k=x,M=S;v&&(I+=a,T+=l,k+=a,M+=l),e.push({type:"bezier",p1:[z,C],p2:[I,T],p3:[k,M]}),d=I,h=T,a=k,l=M,p=m;break}case"Q":{const P=y(),E=y(),x=y(),S=y();let z=P,C=E,I=x,T=S;v&&(z+=a,C+=l,I+=a,T+=l);const k=a+2/3*(z-a),M=l+2/3*(C-l),D=I+2/3*(z-I),L=T+2/3*(C-T);e.push({type:"bezier",p1:[k,M],p2:[D,L],p3:[I,T]}),d=z,h=C,a=I,l=T,p=m;break}case"T":{const P=y(),E=y(),x=2*a-d,S=2*l-h;let z=P,C=E;v&&(z+=a,C+=l);const I=a+2/3*(x-a),T=l+2/3*(S-l),k=z+2/3*(x-z),M=C+2/3*(S-C);e.push({type:"bezier",p1:[I,T],p2:[k,M],p3:[z,C]}),d=x,h=S,a=z,l=C,p=m;break}case"A":{y(),y(),y(),y(),y();const P=y(),E=y();let x=P,S=E;v&&(x+=a,S+=l),e.push({type:"line",p:[x,S]}),a=x,l=S,d=x,h=S,p=m;break}case"Z":{(a!==c||l!==u)&&(e.push({type:"line",p:[c,u]}),a=c,l=u),p=m;break}}}const w={commands:e};return n&&(w.warning="This SVG contains a compound path. Only the first subpath was imported."),w}function ti(i,e,n,o=20){if(i.length===0)return i;let s=1/0,r=1/0,a=-1/0,l=-1/0;const c=(P,E)=>{s=Math.min(s,P),r=Math.min(r,E),a=Math.max(a,P),l=Math.max(l,E)};for(const P of i)P.type==="move"||P.type==="line"?c(P.p[0],P.p[1]):P.type==="bezier"&&(c(P.p1[0],P.p1[1]),c(P.p2[0],P.p2[1]),c(P.p3[0],P.p3[1]));const u=a-s,d=l-r,h=e-2*o,p=n-2*o,f=Math.min(h/u,p/d),y=u*f,w=d*f,m=o+(h-y)/2-s*f,v=o+(p-w)/2-r*f,b=[];for(const P of i)P.type==="move"||P.type==="line"?b.push({...P,p:[P.p[0]*f+m,P.p[1]*f+v]}):P.type==="bezier"&&b.push({type:"bezier",p1:[P.p1[0]*f+m,P.p1[1]*f+v],p2:[P.p2[0]*f+m,P.p2[1]*f+v],p3:[P.p3[0]*f+m,P.p3[1]*f+v]});return b}const ni=({attrs:i})=>{const e={el:null,currentAttrs:null,lastNotifiedOpen:i.open,cleanup:()=>{}},n=a=>{e.el&&e.el.open!==a&&(e.el.open=a)},o=a=>{e.lastNotifiedOpen!==a&&(e.lastNotifiedOpen=a,e.currentAttrs?.onStateChanged?.(a))},s=()=>o(!0),r=()=>o(!1);return{oncreate:({attrs:a,dom:l})=>{e.el=l,e.currentAttrs=a,n(a.open),e.el.addEventListener("wa-after-show",s),e.el.addEventListener("wa-after-hide",r),e.cleanup=()=>{e.el?.removeEventListener("wa-after-show",s),e.el?.removeEventListener("wa-after-hide",r),e.el=null,e.currentAttrs=null}},onupdate:({attrs:a})=>{e.currentAttrs=a,n(a.open)},onremove:()=>{e.cleanup()},view:({attrs:a,children:l})=>g("wa-dialog",{id:a.id,label:a.title,class:a.class??a.className,style:{"--width":a.width},open:a.open},a.contentKey!=null?g("div",{key:a.contentKey},l):l)}},bo=()=>{const i={initialPath:[],path:[],name:"",validation:{isValid:!1,errors:[]},prevOpen:!1,prevPieceId:null,contentKey:"initial"};let e=null;const n=l=>{l.piece?(i.contentKey=l.piece.id,i.initialPath=l.piece.path,i.path=l.piece.path,i.name=l.piece.name??"",i.validation=mn(i.path)):(i.contentKey=`new-${Date.now()}`,i.initialPath=[],i.path=[],i.name="",i.validation={isValid:!1,errors:[]})},o=l=>{if(i.path=l,l.length===0)i.validation={isValid:!1,errors:[]};else{const c=mn(l);i.validation=c}},s=l=>{i.name=l},r=l=>{i.validation.isValid&&l.onSave(i.path,i.name.length>0?i.name:void 0)},a=(l,c,u)=>{if(!l||l.length===0)return;const d=l[0];if(!d.name.endsWith(".svg")){console.error("Please select an SVG file");return}const h=new FileReader;h.onload=p=>{const f=p.target?.result;if(f){const y=ei(f);if(y.warning&&console.warn("SVG import warning:",y.warning),y.commands.length>0){const w=ti(y.commands,c,u);if(i.initialPath=w,o(w),!i.name){const m=d.name.replace(/\.svg$/i,"");s(m)}g.redraw()}else console.error("Failed to parse SVG file")}},h.readAsText(d)};return{view:({attrs:l})=>{const c=l.piece?.id??null,u=l.open&&!i.prevOpen,d=c!==i.prevPieceId;l.open&&(u||d)&&n(l),i.prevOpen=l.open,i.prevPieceId=c;const h=l.editorWidth??600,p=l.editorHeight??600;return g(ni,{open:l.open,title:l.piece?"Edit Whimsy":"Create Whimsy",className:"custom-piece-editor",width:"50vw",contentKey:i.contentKey,onStateChanged:f=>{f||l.onCancel()}},[g(".editor-content",[g(Yn,{config:{type:"string",name:"name",label:"Piece Name (optional)",optional:!0},value:i.name,onChange:f=>{i.name=f??"",g.redraw()}}),i.path.length>0&&(i.validation.isValid?Qn(i.path)&&g(".validation-status",[g(".valid",[g("wa-icon",{library:"material",name:"check_circle",style:"color: green;"}),g("span","Valid piece")])]):i.validation.errors.length>0&&g(".validation-status",[g(".invalid",[g("wa-icon",{library:"material",name:"error",style:"color: red;"}),g("span",i.validation.errors.join(", "))])])),g(".editor-canvas",[g(Zn,{initialPath:i.initialPath,onPathChanged:o,width:h,height:p,strokeColor:i.validation.isValid?"#2196F3":"#f44336"})]),g(".import-controls",[g("input",{type:"file",accept:".svg",style:"display: none;",oncreate:f=>{e=f.dom},onchange:f=>{f.redraw=!1;const y=f.target;a(y.files,h,p),y.value=""}}),g("wa-button",{variant:"default",size:"small",onclick:f=>{f.redraw=!1,e?.click()}},"Import SVG")])]),g("div",{slot:"footer",style:"display: flex; gap: 8px; justify-content: flex-end;"},[g("wa-button",{variant:"default",onclick:f=>{f.redraw=!1,l.onCancel()}},"Cancel"),g("wa-button",{variant:"primary",disabled:!i.validation.isValid,onclick:f=>{f.redraw=!1,r(l)}},"Save")])])}}};function xo(i,e,n,o,s=10){const r=document.createElement("canvas");r.width=e,r.height=n;const a=r.getContext("2d");if(!a||i.length===0)return"";a.clearRect(0,0,e,n);const l=Co(i);if(!l)return"";const[c,u,d,h]=l,p=d-c,f=h-u,y=e-2*s,w=n-2*s,m=Math.min(y/p,w/f),v=p*m,b=f*m,P=s+(y-v)/2-c*m,E=s+(w-b)/2-u*m,x=(S,z)=>[S*m+P,z*m+E];a.beginPath();for(const S of i)switch(S.type){case"move":{const[z,C]=x(S.p[0],S.p[1]);a.moveTo(z,C);break}case"line":{const[z,C]=x(S.p[0],S.p[1]);a.lineTo(z,C);break}case"bezier":{const[z,C]=x(S.p1[0],S.p1[1]),[I,T]=x(S.p2[0],S.p2[1]),[k,M]=x(S.p3[0],S.p3[1]);a.bezierCurveTo(z,C,I,T,k,M);break}case"arc":{const[z,C]=x(S.p[0],S.p[1]);a.lineTo(z,C);break}}return a.strokeStyle=o,a.lineWidth=2,a.stroke(),r.toDataURL("image/png")}function Co(i){if(i.length===0)return null;let e=1/0,n=1/0,o=-1/0,s=-1/0;const r=(a,l)=>{e=Math.min(e,a),n=Math.min(n,l),o=Math.max(o,a),s=Math.max(s,l)};for(const a of i)switch(a.type){case"move":case"line":case"arc":r(a.p[0],a.p[1]);break;case"bezier":r(a.p1[0],a.p1[1]),r(a.p2[0],a.p2[1]),r(a.p3[0],a.p3[1]);break}return e===1/0?null:[e,n,o,s]}const Io={view:({attrs:i})=>g(".custom-piece-tile",{key:i.piece.id,class:i.isSelected?"selected":"",onclick:e=>{e.redraw=!1,i.onClick()},ondblclick:e=>{e.redraw=!1,i.onDoubleClick()}},[g(".custom-piece-tile-thumbnail",i.thumbnail?g("img",{src:i.thumbnail,alt:i.piece.name??"Custom piece"}):g(".custom-piece-tile-placeholder",g("wa-icon",{name:"puzzle-piece"}))),g(".custom-piece-tile-name",i.piece.name??"Unnamed"),i.isSelected?g(".custom-piece-tile-selected-indicator",g("wa-icon",{name:"check-circle"})):null])};function So(i){const e=document.createElement("div");document.body.appendChild(e);let n=!1;const o=c=>{n||(n=!0,s(),r(c))},s=()=>{try{g.mount(e,null)}catch(c){console.warn("confirm(): unable to mount Mithril component: ",c)}e.remove()};let r;const a=new Promise(c=>{r=c}),l=()=>{const c={open:!0,contentKey:Math.random()},u=h=>{c.open=!1,g.redraw(),d=h};let d=null;return{view(){return g(ni,{id:i.id,title:i.title,width:i.width,open:c.open,contentKey:c.contentKey,onStateChanged:h=>{!h&&d!==null&&o(d),!h&&d===null&&n===!1&&o(!1)}},[g(".confirm-body",i.body??"Are you sure?"),g(".confirm-actions",{slot:"footer"},[g("wa-button.btn-cancel",{variant:"neutral",size:"small","data-dialog":"close",onclick:h=>{h.redraw=!1,u(!1)}},i.cancelLabel??"Cancel"),g("wa-button.btn-confirm",{variant:"brand",size:"small","data-dialog":"close",onclick:h=>{h.redraw=!1,u(!0)}},i.confirmLabel??"OK")])])}}};return g.mount(e,l),a}const zo=()=>{const i=new Map,e=(n,o)=>{const s=n.modified??n.created,r=`${n.id}-${s}-${o}`;if(!i.has(r)){const a=xo(n.path,100,100,o);i.set(r,a)}return i.get(r)??""};return{view:({attrs:n})=>{const o=n.selectedPieceId!==null&&n.selectedPieceId!==void 0,s=o?n.pieces.find(r=>r.id===n.selectedPieceId):null;return g(".whimsy-manager",[g(".whimsy-manager-header",[g("h3","Whimsy Pieces"),g("wa-button",{variant:"primary",size:"small",onclick:r=>{r.redraw=!1,n.onAdd()}},[g("wa-icon",{name:"plus",slot:"prefix"}),"Add"])]),g(".whimsy-grid",n.pieces.length===0?g(".whimsy-empty-state",[g("wa-icon",{name:"puzzle-piece",style:"font-size: 48px; opacity: 0.3;"}),g("p","No whimsy pieces yet"),g("p.hint",'Click "Add" to create one')]):n.pieces.map(r=>{const a=r.id===n.selectedPieceId,l=e(r,n.pieceColor);return g(Io,{key:r.id,piece:r,isSelected:a,thumbnail:l,onClick:()=>{a?n.onSelect(null):n.onSelect(r.id)},onDoubleClick:()=>{n.onEdit(r.id)}})})),g(".whimsy-actions",[g("wa-button",{size:"small",disabled:!o,onclick:r=>{r.redraw=!1,s&&n.onEdit(s.id)}},[g("wa-icon",{name:"pencil",slot:"prefix"}),"Edit"]),g("wa-button",{size:"small",disabled:!o,onclick:r=>{r.redraw=!1,s&&n.onDuplicate(s.id)}},[g("wa-icon",{name:"copy",slot:"prefix"}),"Duplicate"]),g("wa-button",{size:"small",variant:"danger",disabled:!o,onclick:async r=>{r.redraw=!1,s&&await So({title:"Delete piece?",body:`Are you sure you want to delete ${s.name??"this piece"}?`,confirmLabel:"Delete"})&&n.onDelete(s.id)}},[g("wa-icon",{name:"trash",slot:"start"}),"Delete"]),g("wa-button",{size:"small",disabled:!o,onclick:r=>{r.redraw=!1,s&&n.onPosition(s.id)}},[g("wa-icon",{name:"arrows-up-down-left-right",slot:"prefix"}),"Position"])])])}}};var xt,gn;function ii(){if(gn)return xt;gn=1;function i(n){var o=n.length,s=1,r=new Array(o),a;for(a=o;a>0;a--)r[a-1]=s,s=s*n[a-1];return{stride:r,data:new Uint32Array(s)}}function e(n){var o=n.length,s=1,r=new Array(o),a=[],l,c;for(l=o;l>0;l--)r[l-1]=s,s=s*n[l-1];for(c=0;c<s;c++)a.push([]);return{stride:r,data:a}}return xt={integer:i,array:e},xt}var Ct,yn;function ri(){if(yn)return Ct;yn=1,Ct=i;function i(e,n){var o=new Array(e),s=Math.floor(e/2)<<1,r=0,a,l,c,u,d;for(d=0;d<s;d+=2)a=-2*Math.log(n()),l=Math.sqrt(a),c=2*Math.PI*n(),r+=a,o[d]=l*Math.cos(c),o[d+1]=l*Math.sin(c);if(e%2){var h=Math.sqrt(-2*Math.log(n()))*Math.cos(2*Math.PI*n());o[e-1]=h,r+=Math.pow(h,2)}for(u=1/Math.sqrt(r),d=0;d<e;++d)o[d]*=u;return o}return Ct}var It,vn;function Eo(){return vn||(vn=1,It=function(e,n){e=e||1,n=n||2;for(var o=e*2+1,s=Math.pow(o,n)-1,r=new Array(s),a=0;a<s;a++)for(var l=r[a]=new Array(n),c=a<s/2?a:a+1,u=1;u<=n;u++){var d=c%Math.pow(o,u);l[u-1]=d/Math.pow(o,u-1)-e,c-=d}return r}),It}var St,wn;function oi(){if(wn)return St;wn=1;var i=Eo();function e(s){var r=i(2,s),a=[],l;for(r=r.filter(function(c){for(var u=0,d=0;d<s;d++)u+=Math.pow(Math.max(0,Math.abs(c[d])-1),2);return u<s}),l=0;l<s;l++)a.push(0);return r.push(a),r.sort(function(c,u){var d=0,h=0,p;for(p=0;p<s;p++)d+=Math.pow(c[p],2),h+=Math.pow(u[p],2);return d<h?-1:d>h?1:0}),r}var n={};function o(s){return n[s]||(n[s]=e(s)),n[s]}return St=o,St}var zt,Pn;function To(){if(Pn)return zt;Pn=1;var i=ii().integer,e=ri(),n=oi();function o(r,a){for(var l=0,c=0;c<r.length;c++)l+=Math.pow(r[c]-a[c],2);return l}function s(r,a){if(typeof r.distanceFunction=="function")throw new Error("PoissonDiskSampling: Tried to instantiate the fixed density implementation with a distanceFunction");this.shape=r.shape,this.minDistance=r.minDistance,this.maxDistance=r.maxDistance||r.minDistance*2,this.maxTries=Math.ceil(Math.max(1,r.tries||30)),this.rng=a||Math.random;for(var l=0,c=0;c<this.shape.length;c++)l=Math.max(l,this.shape[c]);var u=Math.max(1,l/128|0),d=1e-14*u;this.dimension=this.shape.length,this.squaredMinDistance=this.minDistance*this.minDistance,this.minDistancePlusEpsilon=this.minDistance+d,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.minDistance/Math.sqrt(this.dimension),this.neighbourhood=n(this.dimension),this.currentPoint=null,this.processList=[],this.samplePoints=[],this.gridShape=[];for(var c=0;c<this.dimension;c++)this.gridShape.push(Math.ceil(this.shape[c]/this.cellSize));this.grid=i(this.gridShape)}return s.prototype.shape=null,s.prototype.dimension=null,s.prototype.minDistance=null,s.prototype.maxDistance=null,s.prototype.minDistancePlusEpsilon=null,s.prototype.squaredMinDistance=null,s.prototype.deltaDistance=null,s.prototype.cellSize=null,s.prototype.maxTries=null,s.prototype.rng=null,s.prototype.neighbourhood=null,s.prototype.currentPoint=null,s.prototype.processList=null,s.prototype.samplePoints=null,s.prototype.gridShape=null,s.prototype.grid=null,s.prototype.addRandomPoint=function(){for(var r=new Array(this.dimension),a=0;a<this.dimension;a++)r[a]=this.rng()*this.shape[a];return this.directAddPoint(r)},s.prototype.addPoint=function(r){var a,l=!0;if(r.length===this.dimension)for(a=0;a<this.dimension&&l;a++)l=r[a]>=0&&r[a]<this.shape[a];else l=!1;return l?this.directAddPoint(r):null},s.prototype.directAddPoint=function(r){var a=0,l=this.grid.stride,c;for(this.processList.push(r),this.samplePoints.push(r),c=0;c<this.dimension;c++)a+=(r[c]/this.cellSize|0)*l[c];return this.grid.data[a]=this.samplePoints.length,r},s.prototype.inNeighbourhood=function(r){var a=this.dimension,l=this.grid.stride,c,u,d,h,p;for(c=0;c<this.neighbourhood.length;c++){for(u=0,d=0;d<a;d++){if(h=(r[d]/this.cellSize|0)+this.neighbourhood[c][d],h<0||h>=this.gridShape[d]){u=-1;break}u+=h*l[d]}if(u!==-1&&this.grid.data[u]!==0&&(p=this.samplePoints[this.grid.data[u]-1],o(r,p)<this.squaredMinDistance))return!0}return!1},s.prototype.next=function(){for(var r,a,l,c,u,d,h;this.processList.length>0;){for(this.currentPoint===null&&(this.currentPoint=this.processList.shift()),c=this.currentPoint,r=0;r<this.maxTries;r++){for(d=!0,l=this.minDistancePlusEpsilon+this.deltaDistance*this.rng(),this.dimension===2?(a=this.rng()*Math.PI*2,u=[Math.cos(a),Math.sin(a)]):u=e(this.dimension,this.rng),h=0;d&&h<this.dimension;h++)u[h]=c[h]+u[h]*l,d=u[h]>=0&&u[h]<this.shape[h];if(d&&!this.inNeighbourhood(u))return this.directAddPoint(u)}r===this.maxTries&&(this.currentPoint=null)}return null},s.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},s.prototype.getAllPoints=function(){return this.samplePoints},s.prototype.getAllPointsWithDistance=function(){throw new Error("PoissonDiskSampling: getAllPointsWithDistance() is not available in fixed-density implementation")},s.prototype.reset=function(){var r=this.grid.data,a=0;for(a=0;a<r.length;a++)r[a]=0;this.samplePoints=[],this.currentPoint=null,this.processList.length=0},zt=s,zt}var Et,bn;function ko(){if(bn)return Et;bn=1;var i=ii().array,e=ri(),n=oi();function o(r,a){for(var l=0,c=0;c<r.length;c++)l+=Math.pow(r[c]-a[c],2);return Math.sqrt(l)}function s(r,a){if(typeof r.distanceFunction!="function")throw new Error("PoissonDiskSampling: Tried to instantiate the variable density implementation without a distanceFunction");this.shape=r.shape,this.minDistance=r.minDistance,this.maxDistance=r.maxDistance||r.minDistance*2,this.maxTries=Math.ceil(Math.max(1,r.tries||30)),this.distanceFunction=r.distanceFunction,this.bias=Math.max(0,Math.min(1,r.bias||0)),this.rng=a||Math.random;for(var l=0,c=0;c<this.shape.length;c++)l=Math.max(l,this.shape[c]);var u=Math.max(1,l/128|0),d=1e-14*u;this.dimension=this.shape.length,this.minDistancePlusEpsilon=this.minDistance+d,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.maxDistance/Math.sqrt(this.dimension),this.neighbourhood=n(this.dimension),this.currentPoint=null,this.currentDistance=0,this.processList=[],this.samplePoints=[],this.sampleDistance=[],this.gridShape=[];for(var c=0;c<this.dimension;c++)this.gridShape.push(Math.ceil(this.shape[c]/this.cellSize));this.grid=i(this.gridShape)}return s.prototype.shape=null,s.prototype.dimension=null,s.prototype.minDistance=null,s.prototype.maxDistance=null,s.prototype.minDistancePlusEpsilon=null,s.prototype.deltaDistance=null,s.prototype.cellSize=null,s.prototype.maxTries=null,s.prototype.distanceFunction=null,s.prototype.bias=null,s.prototype.rng=null,s.prototype.neighbourhood=null,s.prototype.currentPoint=null,s.prototype.currentDistance=null,s.prototype.processList=null,s.prototype.samplePoints=null,s.prototype.sampleDistance=null,s.prototype.gridShape=null,s.prototype.grid=null,s.prototype.addRandomPoint=function(){for(var r=new Array(this.dimension),a=0;a<this.dimension;a++)r[a]=this.rng()*this.shape[a];return this.directAddPoint(r)},s.prototype.addPoint=function(r){var a,l=!0;if(r.length===this.dimension)for(a=0;a<this.dimension&&l;a++)l=r[a]>=0&&r[a]<this.shape[a];else l=!1;return l?this.directAddPoint(r):null},s.prototype.directAddPoint=function(r){var a=0,l=this.grid.stride,c=this.samplePoints.length,u;for(this.processList.push(c),this.samplePoints.push(r),this.sampleDistance.push(this.distanceFunction(r)),u=0;u<this.dimension;u++)a+=(r[u]/this.cellSize|0)*l[u];return this.grid.data[a].push(c),r},s.prototype.inNeighbourhood=function(r){var a=this.dimension,l=this.grid.stride,c,u,d,h,p,f,y=this.distanceFunction(r);for(c=0;c<this.neighbourhood.length;c++){for(u=0,d=0;d<a;d++){if(h=(r[d]/this.cellSize|0)+this.neighbourhood[c][d],h<0||h>=this.gridShape[d]){u=-1;break}u+=h*l[d]}if(u!==-1&&this.grid.data[u].length>0)for(var w=0;w<this.grid.data[u].length;w++){p=this.samplePoints[this.grid.data[u][w]],f=this.sampleDistance[this.grid.data[u][w]];var m=Math.min(f,y),v=Math.max(f,y),b=m+(v-m)*this.bias;if(o(r,p)<this.minDistance+this.deltaDistance*b)return!0}}return!1},s.prototype.next=function(){for(var r,a,l,c,u,d,h,p;this.processList.length>0;){if(this.currentPoint===null){var f=this.processList.shift();this.currentPoint=this.samplePoints[f],this.currentDistance=this.sampleDistance[f]}for(c=this.currentPoint,u=this.currentDistance,r=0;r<this.maxTries;r++){for(h=!0,l=this.minDistancePlusEpsilon+this.deltaDistance*(u+(1-u)*this.bias),this.dimension===2?(a=this.rng()*Math.PI*2,d=[Math.cos(a),Math.sin(a)]):d=e(this.dimension,this.rng),p=0;h&&p<this.dimension;p++)d[p]=c[p]+d[p]*l,h=d[p]>=0&&d[p]<this.shape[p];if(h&&!this.inNeighbourhood(d))return this.directAddPoint(d)}r===this.maxTries&&(this.currentPoint=null)}return null},s.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},s.prototype.getAllPoints=function(){return this.samplePoints},s.prototype.getAllPointsWithDistance=function(){var r=new Array(this.samplePoints.length),a=0,l=0,c;for(a=0;a<this.samplePoints.length;a++){for(c=new Array(this.dimension+1),l=0;l<this.dimension;l++)c[l]=this.samplePoints[a][l];c[this.dimension]=this.sampleDistance[a],r[a]=c}return r},s.prototype.reset=function(){var r=this.grid.data,a=0;for(a=0;a<r.length;a++)r[a]=[];this.samplePoints=[],this.currentPoint=null,this.processList.length=0},Et=s,Et}var Tt,xn;function Mo(){if(xn)return Tt;xn=1;var i=To(),e=ko();function n(o,s){this.shape=o.shape,typeof o.distanceFunction=="function"?this.implementation=new e(o,s):this.implementation=new i(o,s)}return n.prototype.implementation=null,n.prototype.addRandomPoint=function(){return this.implementation.addRandomPoint()},n.prototype.addPoint=function(o){return this.implementation.addPoint(o)},n.prototype.next=function(){return this.implementation.next()},n.prototype.fill=function(){return this.implementation.fill()},n.prototype.getAllPoints=function(){return this.implementation.getAllPoints()},n.prototype.getAllPointsWithDistance=function(){return this.implementation.getAllPointsWithDistance()},n.prototype.reset=function(){this.implementation.reset()},Tt=n,Tt}var _o=Mo();const Do=_n(_o),jt="PoissonPointGenerator",Lo={name:jt,displayName:"Poisson",description:"Generate seed points using Poisson disk sampling. The algorithm produces points that are tightly-packed, but no closer to each other than a specified minimum distance (the piece size), resulting in a natural, organic look.",sortHint:1,controls:[]},Ao=(i,e,n)=>({generatePoints(s){const{width:r,height:a,pieceSize:l,random:c,border:u}=s;return new Do({shape:[r,a],minDistance:l,tries:20},c).fill().filter(f=>Gt(f,u))}});Ue.register(jt,Ao,Lo);const Z=11102230246251565e-32,F=134217729,Ro=(3+8*Z)*Z;function kt(i,e,n,o,s){let r,a,l,c,u=e[0],d=o[0],h=0,p=0;d>u==d>-u?(r=u,u=e[++h]):(r=d,d=o[++p]);let f=0;if(h<i&&p<n)for(d>u==d>-u?(a=u+r,l=r-(a-u),u=e[++h]):(a=d+r,l=r-(a-d),d=o[++p]),r=a,l!==0&&(s[f++]=l);h<i&&p<n;)d>u==d>-u?(a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h]):(a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p]),r=a,l!==0&&(s[f++]=l);for(;h<i;)a=r+u,c=a-r,l=r-(a-c)+(u-c),u=e[++h],r=a,l!==0&&(s[f++]=l);for(;p<n;)a=r+d,c=a-r,l=r-(a-c)+(d-c),d=o[++p],r=a,l!==0&&(s[f++]=l);return(r!==0||f===0)&&(s[f++]=r),f}function Oo(i,e){let n=e[0];for(let o=1;o<i;o++)n+=e[o];return n}function We(i){return new Float64Array(i)}const Ho=(3+16*Z)*Z,No=(2+12*Z)*Z,$o=(9+64*Z)*Z*Z,de=We(4),Cn=We(8),In=We(12),Sn=We(16),j=We(4);function Uo(i,e,n,o,s,r,a){let l,c,u,d,h,p,f,y,w,m,v,b,P,E,x,S,z,C;const I=i-s,T=n-s,k=e-r,M=o-r;E=I*M,p=F*I,f=p-(p-I),y=I-f,p=F*M,w=p-(p-M),m=M-w,x=y*m-(E-f*w-y*w-f*m),S=k*T,p=F*k,f=p-(p-k),y=k-f,p=F*T,w=p-(p-T),m=T-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,de[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,de[1]=P-(v+h)+(h-S),C=b+v,h=C-b,de[2]=b-(C-h)+(v-h),de[3]=C;let D=Oo(4,de),L=No*a;if(D>=L||-D>=L||(h=i-I,l=i-(I+h)+(h-s),h=n-T,u=n-(T+h)+(h-s),h=e-k,c=e-(k+h)+(h-r),h=o-M,d=o-(M+h)+(h-r),l===0&&c===0&&u===0&&d===0)||(L=$o*a+Ro*Math.abs(D),D+=I*d+M*l-(k*u+T*c),D>=L||-D>=L))return D;E=l*M,p=F*l,f=p-(p-l),y=l-f,p=F*M,w=p-(p-M),m=M-w,x=y*m-(E-f*w-y*w-f*m),S=c*T,p=F*c,f=p-(p-c),y=c-f,p=F*T,w=p-(p-T),m=T-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,j[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,j[1]=P-(v+h)+(h-S),C=b+v,h=C-b,j[2]=b-(C-h)+(v-h),j[3]=C;const R=kt(4,de,4,j,Cn);E=I*d,p=F*I,f=p-(p-I),y=I-f,p=F*d,w=p-(p-d),m=d-w,x=y*m-(E-f*w-y*w-f*m),S=k*u,p=F*k,f=p-(p-k),y=k-f,p=F*u,w=p-(p-u),m=u-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,j[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,j[1]=P-(v+h)+(h-S),C=b+v,h=C-b,j[2]=b-(C-h)+(v-h),j[3]=C;const A=kt(R,Cn,4,j,In);E=l*d,p=F*l,f=p-(p-l),y=l-f,p=F*d,w=p-(p-d),m=d-w,x=y*m-(E-f*w-y*w-f*m),S=c*u,p=F*c,f=p-(p-c),y=c-f,p=F*u,w=p-(p-u),m=u-w,z=y*m-(S-f*w-y*w-f*m),v=x-z,h=x-v,j[0]=x-(v+h)+(h-z),b=E+v,h=b-E,P=E-(b-h)+(v-h),v=P-S,h=P-v,j[1]=P-(v+h)+(h-S),C=b+v,h=C-b,j[2]=b-(C-h)+(v-h),j[3]=C;const O=kt(A,In,4,j,Sn);return Sn[O-1]}function Je(i,e,n,o,s,r){const a=(e-r)*(n-s),l=(i-s)*(o-r),c=a-l,u=Math.abs(a+l);return Math.abs(c)>=Ho*u?c:-Uo(i,e,n,o,s,r,u)}const zn=Math.pow(2,-52),Qe=new Uint32Array(512);class lt{static from(e,n=Wo,o=qo){const s=e.length,r=new Float64Array(s*2);for(let a=0;a<s;a++){const l=e[a];r[2*a]=n(l),r[2*a+1]=o(l)}return new lt(r)}constructor(e){const n=e.length>>1;if(n>0&&typeof e[0]!="number")throw new Error("Expected coords to contain numbers.");this.coords=e;const o=Math.max(2*n-5,0);this._triangles=new Uint32Array(o*3),this._halfedges=new Int32Array(o*3),this._hashSize=Math.ceil(Math.sqrt(n)),this._hullPrev=new Uint32Array(n),this._hullNext=new Uint32Array(n),this._hullTri=new Uint32Array(n),this._hullHash=new Int32Array(this._hashSize),this._ids=new Uint32Array(n),this._dists=new Float64Array(n),this.update()}update(){const{coords:e,_hullPrev:n,_hullNext:o,_hullTri:s,_hullHash:r}=this,a=e.length>>1;let l=1/0,c=1/0,u=-1/0,d=-1/0;for(let I=0;I<a;I++){const T=e[2*I],k=e[2*I+1];T<l&&(l=T),k<c&&(c=k),T>u&&(u=T),k>d&&(d=k),this._ids[I]=I}const h=(l+u)/2,p=(c+d)/2;let f,y,w;for(let I=0,T=1/0;I<a;I++){const k=Mt(h,p,e[2*I],e[2*I+1]);k<T&&(f=I,T=k)}const m=e[2*f],v=e[2*f+1];for(let I=0,T=1/0;I<a;I++){if(I===f)continue;const k=Mt(m,v,e[2*I],e[2*I+1]);k<T&&k>0&&(y=I,T=k)}let b=e[2*y],P=e[2*y+1],E=1/0;for(let I=0;I<a;I++){if(I===f||I===y)continue;const T=Go(m,v,b,P,e[2*I],e[2*I+1]);T<E&&(w=I,E=T)}let x=e[2*w],S=e[2*w+1];if(E===1/0){for(let k=0;k<a;k++)this._dists[k]=e[2*k]-e[0]||e[2*k+1]-e[1];ye(this._ids,this._dists,0,a-1);const I=new Uint32Array(a);let T=0;for(let k=0,M=-1/0;k<a;k++){const D=this._ids[k],L=this._dists[D];L>M&&(I[T++]=D,M=L)}this.hull=I.subarray(0,T),this.triangles=new Uint32Array(0),this.halfedges=new Uint32Array(0);return}if(Je(m,v,b,P,x,S)<0){const I=y,T=b,k=P;y=w,b=x,P=S,w=I,x=T,S=k}const z=jo(m,v,b,P,x,S);this._cx=z.x,this._cy=z.y;for(let I=0;I<a;I++)this._dists[I]=Mt(e[2*I],e[2*I+1],z.x,z.y);ye(this._ids,this._dists,0,a-1),this._hullStart=f;let C=3;o[f]=n[w]=y,o[y]=n[f]=w,o[w]=n[y]=f,s[f]=0,s[y]=1,s[w]=2,r.fill(-1),r[this._hashKey(m,v)]=f,r[this._hashKey(b,P)]=y,r[this._hashKey(x,S)]=w,this.trianglesLen=0,this._addTriangle(f,y,w,-1,-1,-1);for(let I=0,T,k;I<this._ids.length;I++){const M=this._ids[I],D=e[2*M],L=e[2*M+1];if(I>0&&Math.abs(D-T)<=zn&&Math.abs(L-k)<=zn||(T=D,k=L,M===f||M===y||M===w))continue;let R=0;for(let q=0,we=this._hashKey(D,L);q<this._hashSize&&(R=r[(we+q)%this._hashSize],!(R!==-1&&R!==o[R]));q++);R=n[R];let A=R,O;for(;O=o[A],Je(D,L,e[2*A],e[2*A+1],e[2*O],e[2*O+1])>=0;)if(A=O,A===R){A=-1;break}if(A===-1)continue;let $=this._addTriangle(A,M,o[A],-1,-1,s[A]);s[M]=this._legalize($+2),s[A]=$,C++;let N=o[A];for(;O=o[N],Je(D,L,e[2*N],e[2*N+1],e[2*O],e[2*O+1])<0;)$=this._addTriangle(N,M,O,s[M],-1,s[N]),s[M]=this._legalize($+2),o[N]=N,C--,N=O;if(A===R)for(;O=n[A],Je(D,L,e[2*O],e[2*O+1],e[2*A],e[2*A+1])<0;)$=this._addTriangle(O,M,A,-1,s[A],s[O]),this._legalize($+2),s[O]=$,o[A]=A,C--,A=O;this._hullStart=n[M]=A,o[A]=n[N]=M,o[M]=N,r[this._hashKey(D,L)]=M,r[this._hashKey(e[2*A],e[2*A+1])]=A}this.hull=new Uint32Array(C);for(let I=0,T=this._hullStart;I<C;I++)this.hull[I]=T,T=o[T];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(e,n){return Math.floor(Fo(e-this._cx,n-this._cy)*this._hashSize)%this._hashSize}_legalize(e){const{_triangles:n,_halfedges:o,coords:s}=this;let r=0,a=0;for(;;){const l=o[e],c=e-e%3;if(a=c+(e+2)%3,l===-1){if(r===0)break;e=Qe[--r];continue}const u=l-l%3,d=c+(e+1)%3,h=u+(l+2)%3,p=n[a],f=n[e],y=n[d],w=n[h];if(Vo(s[2*p],s[2*p+1],s[2*f],s[2*f+1],s[2*y],s[2*y+1],s[2*w],s[2*w+1])){n[e]=w,n[l]=p;const v=o[h];if(v===-1){let P=this._hullStart;do{if(this._hullTri[P]===h){this._hullTri[P]=e;break}P=this._hullPrev[P]}while(P!==this._hullStart)}this._link(e,v),this._link(l,o[a]),this._link(a,h);const b=u+(l+1)%3;r<Qe.length&&(Qe[r++]=b)}else{if(r===0)break;e=Qe[--r]}}return a}_link(e,n){this._halfedges[e]=n,n!==-1&&(this._halfedges[n]=e)}_addTriangle(e,n,o,s,r,a){const l=this.trianglesLen;return this._triangles[l]=e,this._triangles[l+1]=n,this._triangles[l+2]=o,this._link(l,s),this._link(l+1,r),this._link(l+2,a),this.trianglesLen+=3,l}}function Fo(i,e){const n=i/(Math.abs(i)+Math.abs(e));return(e>0?3-n:1+n)/4}function Mt(i,e,n,o){const s=i-n,r=e-o;return s*s+r*r}function Vo(i,e,n,o,s,r,a,l){const c=i-a,u=e-l,d=n-a,h=o-l,p=s-a,f=r-l,y=c*c+u*u,w=d*d+h*h,m=p*p+f*f;return c*(h*m-w*f)-u*(d*m-w*p)+y*(d*f-h*p)<0}function Go(i,e,n,o,s,r){const a=n-i,l=o-e,c=s-i,u=r-e,d=a*a+l*l,h=c*c+u*u,p=.5/(a*u-l*c),f=(u*d-l*h)*p,y=(a*h-c*d)*p;return f*f+y*y}function jo(i,e,n,o,s,r){const a=n-i,l=o-e,c=s-i,u=r-e,d=a*a+l*l,h=c*c+u*u,p=.5/(a*u-l*c),f=i+(u*d-l*h)*p,y=e+(a*h-c*d)*p;return{x:f,y}}function ye(i,e,n,o){if(o-n<=20)for(let s=n+1;s<=o;s++){const r=i[s],a=e[r];let l=s-1;for(;l>=n&&e[i[l]]>a;)i[l+1]=i[l--];i[l+1]=r}else{const s=n+o>>1;let r=n+1,a=o;ze(i,s,r),e[i[n]]>e[i[o]]&&ze(i,n,o),e[i[r]]>e[i[o]]&&ze(i,r,o),e[i[n]]>e[i[r]]&&ze(i,n,r);const l=i[r],c=e[l];for(;;){do r++;while(e[i[r]]<c);do a--;while(e[i[a]]>c);if(a<r)break;ze(i,r,a)}i[n+1]=i[a],i[a]=l,o-r+1>=a-n?(ye(i,e,r,o),ye(i,e,n,a-1)):(ye(i,e,n,a-1),ye(i,e,r,o))}}function ze(i,e,n){const o=i[e];i[e]=i[n],i[n]=o}function Wo(i){return i[0]}function qo(i){return i[1]}const En=1e-6;class le{constructor(){this._x0=this._y0=this._x1=this._y1=null,this._=""}moveTo(e,n){this._+=`M${this._x0=this._x1=+e},${this._y0=this._y1=+n}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")}lineTo(e,n){this._+=`L${this._x1=+e},${this._y1=+n}`}arc(e,n,o){e=+e,n=+n,o=+o;const s=e+o,r=n;if(o<0)throw new Error("negative radius");this._x1===null?this._+=`M${s},${r}`:(Math.abs(this._x1-s)>En||Math.abs(this._y1-r)>En)&&(this._+="L"+s+","+r),o&&(this._+=`A${o},${o},0,1,1,${e-o},${n}A${o},${o},0,1,1,${this._x1=s},${this._y1=r}`)}rect(e,n,o,s){this._+=`M${this._x0=this._x1=+e},${this._y0=this._y1=+n}h${+o}v${+s}h${-o}Z`}value(){return this._||null}}class Ut{constructor(){this._=[]}moveTo(e,n){this._.push([e,n])}closePath(){this._.push(this._[0].slice())}lineTo(e,n){this._.push([e,n])}value(){return this._.length?this._:null}}class Xo{constructor(e,[n,o,s,r]=[0,0,960,500]){if(!((s=+s)>=(n=+n))||!((r=+r)>=(o=+o)))throw new Error("invalid bounds");this.delaunay=e,this._circumcenters=new Float64Array(e.points.length*2),this.vectors=new Float64Array(e.points.length*2),this.xmax=s,this.xmin=n,this.ymax=r,this.ymin=o,this._init()}update(){return this.delaunay.update(),this._init(),this}_init(){const{delaunay:{points:e,hull:n,triangles:o},vectors:s}=this;let r,a;const l=this.circumcenters=this._circumcenters.subarray(0,o.length/3*2);for(let w=0,m=0,v=o.length,b,P;w<v;w+=3,m+=2){const E=o[w]*2,x=o[w+1]*2,S=o[w+2]*2,z=e[E],C=e[E+1],I=e[x],T=e[x+1],k=e[S],M=e[S+1],D=I-z,L=T-C,R=k-z,A=M-C,O=(D*A-L*R)*2;if(Math.abs(O)<1e-9){if(r===void 0){r=a=0;for(const N of n)r+=e[N*2],a+=e[N*2+1];r/=n.length,a/=n.length}const $=1e9*Math.sign((r-z)*A-(a-C)*R);b=(z+k)/2-$*A,P=(C+M)/2+$*R}else{const $=1/O,N=D*D+L*L,q=R*R+A*A;b=z+(A*N-L*q)*$,P=C+(D*q-R*N)*$}l[m]=b,l[m+1]=P}let c=n[n.length-1],u,d=c*4,h,p=e[2*c],f,y=e[2*c+1];s.fill(0);for(let w=0;w<n.length;++w)c=n[w],u=d,h=p,f=y,d=c*4,p=e[2*c],y=e[2*c+1],s[u+2]=s[d]=f-y,s[u+3]=s[d+1]=p-h}render(e){const n=e==null?e=new le:void 0,{delaunay:{halfedges:o,inedges:s,hull:r},circumcenters:a,vectors:l}=this;if(r.length<=1)return null;for(let d=0,h=o.length;d<h;++d){const p=o[d];if(p<d)continue;const f=Math.floor(d/3)*2,y=Math.floor(p/3)*2,w=a[f],m=a[f+1],v=a[y],b=a[y+1];this._renderSegment(w,m,v,b,e)}let c,u=r[r.length-1];for(let d=0;d<r.length;++d){c=u,u=r[d];const h=Math.floor(s[u]/3)*2,p=a[h],f=a[h+1],y=c*4,w=this._project(p,f,l[y+2],l[y+3]);w&&this._renderSegment(p,f,w[0],w[1],e)}return n&&n.value()}renderBounds(e){const n=e==null?e=new le:void 0;return e.rect(this.xmin,this.ymin,this.xmax-this.xmin,this.ymax-this.ymin),n&&n.value()}renderCell(e,n){const o=n==null?n=new le:void 0,s=this._clip(e);if(s===null||!s.length)return;n.moveTo(s[0],s[1]);let r=s.length;for(;s[0]===s[r-2]&&s[1]===s[r-1]&&r>1;)r-=2;for(let a=2;a<r;a+=2)(s[a]!==s[a-2]||s[a+1]!==s[a-1])&&n.lineTo(s[a],s[a+1]);return n.closePath(),o&&o.value()}*cellPolygons(){const{delaunay:{points:e}}=this;for(let n=0,o=e.length/2;n<o;++n){const s=this.cellPolygon(n);s&&(s.index=n,yield s)}}cellPolygon(e){const n=new Ut;return this.renderCell(e,n),n.value()}_renderSegment(e,n,o,s,r){let a;const l=this._regioncode(e,n),c=this._regioncode(o,s);l===0&&c===0?(r.moveTo(e,n),r.lineTo(o,s)):(a=this._clipSegment(e,n,o,s,l,c))&&(r.moveTo(a[0],a[1]),r.lineTo(a[2],a[3]))}contains(e,n,o){return n=+n,n!==n||(o=+o,o!==o)?!1:this.delaunay._step(e,n,o)===e}*neighbors(e){const n=this._clip(e);if(n)for(const o of this.delaunay.neighbors(e)){const s=this._clip(o);if(s){e:for(let r=0,a=n.length;r<a;r+=2)for(let l=0,c=s.length;l<c;l+=2)if(n[r]===s[l]&&n[r+1]===s[l+1]&&n[(r+2)%a]===s[(l+c-2)%c]&&n[(r+3)%a]===s[(l+c-1)%c]){yield o;break e}}}}_cell(e){const{circumcenters:n,delaunay:{inedges:o,halfedges:s,triangles:r}}=this,a=o[e];if(a===-1)return null;const l=[];let c=a;do{const u=Math.floor(c/3);if(l.push(n[u*2],n[u*2+1]),c=c%3===2?c-2:c+1,r[c]!==e)break;c=s[c]}while(c!==a&&c!==-1);return l}_clip(e){if(e===0&&this.delaunay.hull.length===1)return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];const n=this._cell(e);if(n===null)return null;const{vectors:o}=this,s=e*4;return this._simplify(o[s]||o[s+1]?this._clipInfinite(e,n,o[s],o[s+1],o[s+2],o[s+3]):this._clipFinite(e,n))}_clipFinite(e,n){const o=n.length;let s=null,r,a,l=n[o-2],c=n[o-1],u,d=this._regioncode(l,c),h,p=0;for(let f=0;f<o;f+=2)if(r=l,a=c,l=n[f],c=n[f+1],u=d,d=this._regioncode(l,c),u===0&&d===0)h=p,p=0,s?s.push(l,c):s=[l,c];else{let y,w,m,v,b;if(u===0){if((y=this._clipSegment(r,a,l,c,u,d))===null)continue;[w,m,v,b]=y}else{if((y=this._clipSegment(l,c,r,a,d,u))===null)continue;[v,b,w,m]=y,h=p,p=this._edgecode(w,m),h&&p&&this._edge(e,h,p,s,s.length),s?s.push(w,m):s=[w,m]}h=p,p=this._edgecode(v,b),h&&p&&this._edge(e,h,p,s,s.length),s?s.push(v,b):s=[v,b]}if(s)h=p,p=this._edgecode(s[0],s[1]),h&&p&&this._edge(e,h,p,s,s.length);else if(this.contains(e,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2))return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];return s}_clipSegment(e,n,o,s,r,a){const l=r<a;for(l&&([e,n,o,s,r,a]=[o,s,e,n,a,r]);;){if(r===0&&a===0)return l?[o,s,e,n]:[e,n,o,s];if(r&a)return null;let c,u,d=r||a;d&8?(c=e+(o-e)*(this.ymax-n)/(s-n),u=this.ymax):d&4?(c=e+(o-e)*(this.ymin-n)/(s-n),u=this.ymin):d&2?(u=n+(s-n)*(this.xmax-e)/(o-e),c=this.xmax):(u=n+(s-n)*(this.xmin-e)/(o-e),c=this.xmin),r?(e=c,n=u,r=this._regioncode(e,n)):(o=c,s=u,a=this._regioncode(o,s))}}_clipInfinite(e,n,o,s,r,a){let l=Array.from(n),c;if((c=this._project(l[0],l[1],o,s))&&l.unshift(c[0],c[1]),(c=this._project(l[l.length-2],l[l.length-1],r,a))&&l.push(c[0],c[1]),l=this._clipFinite(e,l))for(let u=0,d=l.length,h,p=this._edgecode(l[d-2],l[d-1]);u<d;u+=2)h=p,p=this._edgecode(l[u],l[u+1]),h&&p&&(u=this._edge(e,h,p,l,u),d=l.length);else this.contains(e,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)&&(l=[this.xmin,this.ymin,this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax]);return l}_edge(e,n,o,s,r){for(;n!==o;){let a,l;switch(n){case 5:n=4;continue;case 4:n=6,a=this.xmax,l=this.ymin;break;case 6:n=2;continue;case 2:n=10,a=this.xmax,l=this.ymax;break;case 10:n=8;continue;case 8:n=9,a=this.xmin,l=this.ymax;break;case 9:n=1;continue;case 1:n=5,a=this.xmin,l=this.ymin;break}(s[r]!==a||s[r+1]!==l)&&this.contains(e,a,l)&&(s.splice(r,0,a,l),r+=2)}return r}_project(e,n,o,s){let r=1/0,a,l,c;if(s<0){if(n<=this.ymin)return null;(a=(this.ymin-n)/s)<r&&(c=this.ymin,l=e+(r=a)*o)}else if(s>0){if(n>=this.ymax)return null;(a=(this.ymax-n)/s)<r&&(c=this.ymax,l=e+(r=a)*o)}if(o>0){if(e>=this.xmax)return null;(a=(this.xmax-e)/o)<r&&(l=this.xmax,c=n+(r=a)*s)}else if(o<0){if(e<=this.xmin)return null;(a=(this.xmin-e)/o)<r&&(l=this.xmin,c=n+(r=a)*s)}return[l,c]}_edgecode(e,n){return(e===this.xmin?1:e===this.xmax?2:0)|(n===this.ymin?4:n===this.ymax?8:0)}_regioncode(e,n){return(e<this.xmin?1:e>this.xmax?2:0)|(n<this.ymin?4:n>this.ymax?8:0)}_simplify(e){if(e&&e.length>4){for(let n=0;n<e.length;n+=2){const o=(n+2)%e.length,s=(n+4)%e.length;(e[n]===e[o]&&e[o]===e[s]||e[n+1]===e[o+1]&&e[o+1]===e[s+1])&&(e.splice(o,2),n-=2)}e.length||(e=null)}return e}}const Bo=2*Math.PI,pe=Math.pow;function Yo(i){return i[0]}function Ko(i){return i[1]}function Zo(i){const{triangles:e,coords:n}=i;for(let o=0;o<e.length;o+=3){const s=2*e[o],r=2*e[o+1],a=2*e[o+2];if((n[a]-n[s])*(n[r+1]-n[s+1])-(n[r]-n[s])*(n[a+1]-n[s+1])>1e-10)return!1}return!0}function Jo(i,e,n){return[i+Math.sin(i+e)*n,e+Math.cos(i-e)*n]}class Wt{static from(e,n=Yo,o=Ko,s){return new Wt("length"in e?Qo(e,n,o,s):Float64Array.from(es(e,n,o,s)))}constructor(e){this._delaunator=new lt(e),this.inedges=new Int32Array(e.length/2),this._hullIndex=new Int32Array(e.length/2),this.points=this._delaunator.coords,this._init()}update(){return this._delaunator.update(),this._init(),this}_init(){const e=this._delaunator,n=this.points;if(e.hull&&e.hull.length>2&&Zo(e)){this.collinear=Int32Array.from({length:n.length/2},(p,f)=>f).sort((p,f)=>n[2*p]-n[2*f]||n[2*p+1]-n[2*f+1]);const c=this.collinear[0],u=this.collinear[this.collinear.length-1],d=[n[2*c],n[2*c+1],n[2*u],n[2*u+1]],h=1e-8*Math.hypot(d[3]-d[1],d[2]-d[0]);for(let p=0,f=n.length/2;p<f;++p){const y=Jo(n[2*p],n[2*p+1],h);n[2*p]=y[0],n[2*p+1]=y[1]}this._delaunator=new lt(n)}else delete this.collinear;const o=this.halfedges=this._delaunator.halfedges,s=this.hull=this._delaunator.hull,r=this.triangles=this._delaunator.triangles,a=this.inedges.fill(-1),l=this._hullIndex.fill(-1);for(let c=0,u=o.length;c<u;++c){const d=r[c%3===2?c-2:c+1];(o[c]===-1||a[d]===-1)&&(a[d]=c)}for(let c=0,u=s.length;c<u;++c)l[s[c]]=c;s.length<=2&&s.length>0&&(this.triangles=new Int32Array(3).fill(-1),this.halfedges=new Int32Array(3).fill(-1),this.triangles[0]=s[0],a[s[0]]=1,s.length===2&&(a[s[1]]=0,this.triangles[1]=s[1],this.triangles[2]=s[1]))}voronoi(e){return new Xo(this,e)}*neighbors(e){const{inedges:n,hull:o,_hullIndex:s,halfedges:r,triangles:a,collinear:l}=this;if(l){const h=l.indexOf(e);h>0&&(yield l[h-1]),h<l.length-1&&(yield l[h+1]);return}const c=n[e];if(c===-1)return;let u=c,d=-1;do{if(yield d=a[u],u=u%3===2?u-2:u+1,a[u]!==e)return;if(u=r[u],u===-1){const h=o[(s[e]+1)%o.length];h!==d&&(yield h);return}}while(u!==c)}find(e,n,o=0){if(e=+e,e!==e||(n=+n,n!==n))return-1;const s=o;let r;for(;(r=this._step(o,e,n))>=0&&r!==o&&r!==s;)o=r;return r}_step(e,n,o){const{inedges:s,hull:r,_hullIndex:a,halfedges:l,triangles:c,points:u}=this;if(s[e]===-1||!u.length)return(e+1)%(u.length>>1);let d=e,h=pe(n-u[e*2],2)+pe(o-u[e*2+1],2);const p=s[e];let f=p;do{let y=c[f];const w=pe(n-u[y*2],2)+pe(o-u[y*2+1],2);if(w<h&&(h=w,d=y),f=f%3===2?f-2:f+1,c[f]!==e)break;if(f=l[f],f===-1){if(f=r[(a[e]+1)%r.length],f!==y&&pe(n-u[f*2],2)+pe(o-u[f*2+1],2)<h)return f;break}}while(f!==p);return d}render(e){const n=e==null?e=new le:void 0,{points:o,halfedges:s,triangles:r}=this;for(let a=0,l=s.length;a<l;++a){const c=s[a];if(c<a)continue;const u=r[a]*2,d=r[c]*2;e.moveTo(o[u],o[u+1]),e.lineTo(o[d],o[d+1])}return this.renderHull(e),n&&n.value()}renderPoints(e,n){n===void 0&&(!e||typeof e.moveTo!="function")&&(n=e,e=null),n=n==null?2:+n;const o=e==null?e=new le:void 0,{points:s}=this;for(let r=0,a=s.length;r<a;r+=2){const l=s[r],c=s[r+1];e.moveTo(l+n,c),e.arc(l,c,n,0,Bo)}return o&&o.value()}renderHull(e){const n=e==null?e=new le:void 0,{hull:o,points:s}=this,r=o[0]*2,a=o.length;e.moveTo(s[r],s[r+1]);for(let l=1;l<a;++l){const c=2*o[l];e.lineTo(s[c],s[c+1])}return e.closePath(),n&&n.value()}hullPolygon(){const e=new Ut;return this.renderHull(e),e.value()}renderTriangle(e,n){const o=n==null?n=new le:void 0,{points:s,triangles:r}=this,a=r[e*=3]*2,l=r[e+1]*2,c=r[e+2]*2;return n.moveTo(s[a],s[a+1]),n.lineTo(s[l],s[l+1]),n.lineTo(s[c],s[c+1]),n.closePath(),o&&o.value()}*trianglePolygons(){const{triangles:e}=this;for(let n=0,o=e.length/3;n<o;++n)yield this.trianglePolygon(n)}trianglePolygon(e){const n=new Ut;return this.renderTriangle(e,n),n.value()}}function Qo(i,e,n,o){const s=i.length,r=new Float64Array(s*2);for(let a=0;a<s;++a){const l=i[a];r[a*2]=e.call(o,l,a,i),r[a*2+1]=n.call(o,l,a,i)}return r}function*es(i,e,n,o){let s=0;for(const r of i)yield e.call(o,r,s,i),yield n.call(o,r,s,i),++s}function si(i){return{originalBorder:i,flattenedPolygon:Wn(i)[0]}}function ts(i){if(i.length===0)return[0,0];const e=i.reduce((n,o)=>[n[0]+o[0],n[1]+o[1]],[0,0]);return[e[0]/i.length,e[1]/i.length]}function ai(i,e,n){const o={id:i,site:ts(e),halfEdge:-1,bounds:Nt(e)},s=Er(e,i,n);return s.length>0&&(o.halfEdge=s[0].id),o}function li(i,e){const o=i.map(r=>Gt(r,e.originalBorder)).filter(Boolean).length;return o===0?null:o===i.length?i:Sr(i,e.flattenedPolygon)?.[0]??null}const qt="VoronoiPieceGenerator",ns={name:qt,displayName:"Voronoi",description:"Construct pieces by building a Voronoi diagram from the seed points. Each piece consists of all area of the plane closer to its seed point than any other seed point. In practice, this creates irregular polygons with 3-8 sides.",sortHint:1,controls:[]};function is(i){return`${i[0].toPrecision(7)},${i[1].toPrecision(7)}`}function Tn(i,e){const o=e.flattenedPolygon;for(let s=0;s<o.length;s++){const r=o[s],a=o[(s+1)%o.length];if(rs(i,r,a)<.001)return!0}return!1}function rs(i,e,n){const[o,s]=i,[r,a]=e,[l,c]=n,u=l-r,d=c-a,h=u*u+d*d;if(h===0)return Math.hypot(o-r,s-a);let p=((o-r)*u+(s-a)*d)/h;p=Math.max(0,Math.min(1,p));const f=r+p*u,y=a+p*d;return Math.hypot(o-f,s-y)}const os=(i,e,n)=>{const{width:o,height:s}=e,r=si(i);return{generatePieces(l,c){const{border:u}=c;console.log(`VoronoiPieceGenerator using dimensions ${o}x${s}`);const h=Wt.from(l).voronoi([0,0,o,s]),p={vertices:[],pieces:new Map,edges:new Map,halfEdges:new Map,boundary:[],borderPath:u},f=new Map;let y=0;for(let m=0;m<l.length;m++){const v=l[m],b=h.cellPolygon(m);if(!b)continue;const P=li(b,r);if(!P)continue;const E=y++,x=ai(E,P,p);x.site=v,p.pieces.set(E,x);const S=[];let z=x.halfEdge;if(z!==-1){const C=z;do{const I=p.halfEdges.get(z);S.push(I),z=I.next}while(z!==C)}qn(S,p,f,(C,I)=>Tn(C,r)&&Tn(I,r))}const w=new Map;for(const m of p.halfEdges.values()){const v=is(m.origin);w.has(v)||w.set(v,m.origin)}return p.vertices=Array.from(w.values()),p}}};Fe.register(qt,os,ns);const ct="SimpleTabPlacementStrategy",ss={name:ct,displayName:"Simple",description:"Creates a single tab in the center of each edge with a random orientation.",sortHint:1,controls:[{type:"range",name:"tabSize",label:"Tab Size",optional:!0,min:.01,max:1,step:.01,defaultValue:.5,helpText:"The width of the tab as a fraction of the edge length"},{type:"number",name:"minEdgeLength",label:"Minimum Edge Length",optional:!0,defaultValue:15,helpText:"Edges shorter than this value will not have a tab"},{type:"number",name:"maxTabSize",label:"Maximum Tab Size",helpText:"Maximum width of a generated tab"}]};function kn(i,e,n,o){if(i.tabs=void 0,!(i.heRight!==-1))return;const r=e.halfEdges.get(i.heLeft),a=e.halfEdges.get(i.heRight);if(!r||!a)return;const l=r.origin,c=a.origin,u=Math.hypot(c[0]-l[0],c[1]-l[1]);if(u>=n.minEdgeLength){let d=n.tabSize;n.maxTabSize&&u*d>n.maxTabSize&&(d=n.maxTabSize/u);const h={position:.5,size:d,convex:o()>.5};i.tabs=[h]}}const as=(i,e,n)=>{const{tabSize:o=.5,minEdgeLength:s=0,maxTabSize:r}=n,a={tabSize:o,minEdgeLength:s,maxTabSize:r};return{placeTabs(l){const{topology:c,random:u}=l;for(const d of c.edges.values())kn(d,c,a,u)},updateTabPlacements(l,c){const{topology:u,random:d}=c;for(const h of l)kn(h,u,a,d)}}};Ve.register(ct,as,ss);const Xt="TraditionalTabGenerator",ls={name:Xt,displayName:"Traditional",description:"Creates a traditional rounded tab for each (internal) piece edge.",sortHint:1,controls:[{type:"range",name:"jitter",label:"Randomness",defaultValue:8,min:0,max:100,step:1,helpText:"Adds randomness to the tab shape. 0 means completely uniform tabs"},{type:"range",name:"heightToWidthRatio",label:"Tab Height",defaultValue:50,min:5,max:100,step:5,helpText:"The height of the tab as a percent of its width"}]};function cs(i,e,n,o,s,r=!1){const a=e[0]-i[0],l=e[1]-i[1],c=Math.hypot(a,l);if(c===0)return console.warn("Edge has zero length"),[];const u=[a/c,l/c],d=[-u[1],u[0]],h=(M,D)=>[i[0]+(u[0]*M+d[0]*D)*c,i[1]+(u[1]*M+d[1]*D)*c],p=n/100,f=()=>(s()*2-1)*p,y=f(),w=f(),m=f(),v=f(),b=f(),P=.1625,E=r?-1:1,x=o,S=x/3,C=[[0,0],[.2,y*S],[.5+w+v,E*(-S+m*x)],[.5-P+w,E*(S+m*x)],[.5-2*P+w-v,E*(x+m*x)],[.5+2*P+w-v,E*(x+m*x)],[.5+P+w,E*(S+m*x)],[.5+w+v,E*(-S+m*x)],[.8,b*S],[1,0]].map(([M,D])=>h(M,D)),I={type:"bezier",p1:C[1],p2:C[2],p3:C[3]},T={type:"bezier",p1:C[4],p2:C[5],p3:C[6]},k={type:"bezier",p1:C[7],p2:C[8],p3:C[9]};return[I,T,k]}const us=(i,e,n)=>{const{jitter:o=8,heightToWidthRatio:s=50}=n;return{createTabSegments(a,l,c,u){const d=!c.convex;return cs(a,l,o,s/100,u,d)}}};ce.register(Xt,us,ls);function hs(i){return new Worker("/puzzle-generator/assets/CheckGeometryWorker-B-2izMXZ.js",{name:i?.name})}function ds(i,e){return new Promise((n,o)=>{const s=new hs;s.onmessage=a=>{const l=a.data;switch(l.type){case"progress":e?.(l.processed,l.total);break;case"done":n(l.results),s.terminate();break;case"error":o(new Error(l.message)),s.terminate();break}},s.onerror=a=>{o(new Error(a.message)),s.terminate()};const r={topology:Pr(i)};s.postMessage(r)})}const ci="GridJitterPointGenerator",ps={name:ci,displayName:"Grid",description:"Generate seed points using a grid with optional random jitter. Has a uniform, regular look, especially with low randomness values.",sortHint:2,controls:[{type:"range",name:"jitter",label:"Randomness",min:0,max:100,step:5,defaultValue:50,helpText:"Amount of jitter to apply to each grid point (0 to 100%)"}]},fs=(i,e,n)=>{const{jitter:o=50}=n;return{generatePoints(r){const{width:a,height:l,pieceSize:c,random:u,border:d}=r,h=[];for(let p=0;p<a;p+=c)for(let f=0;f<l;f+=c){const y=[p+c/2,f+c/2];o>0&&(y[0]+=(u()-.5)*(o/100)*c,y[1]+=(u()-.5)*(o/100)*c),Gt(y,d)&&h.push(y)}return h}}};Ue.register(ci,fs,ps);const ui="RectangularPieceGenerator",ms={name:ui,displayName:"Rectangular",description:"Construct pieces from a regular grid. All pieces have 4 sides and are the same size (except when the border is irregular). This generator ignores seed points.",sortHint:2,controls:[]},gs=(i,e,n)=>{const{width:o,height:s}=e,r=si(i);return{generatePieces(l,c){const{pieceSize:u,border:d}=c,h={vertices:[],pieces:new Map,edges:new Map,halfEdges:new Map,boundary:[],borderPath:d},p=Math.ceil(o/u),f=Math.ceil(s/u),y=Math.round(o/p),w=Math.round(s/f),m=[];for(let b=0;b<=f;b++){const P=[];for(let E=0;E<=p;E++){const x=E*y,S=b*w;P.push([x,S])}m.push(P)}h.vertices=m.flat();const v=new Map;for(let b=0;b<f;b++)for(let P=0;P<p;P++){const E=b*p+P,x=m[b][P],S=m[b][P+1],z=m[b+1][P],C=m[b+1][P+1],T=li([x,S,C,z],r);if(!T)continue;const k=ai(E,T,h);h.pieces.set(E,k);const M=[];let D=k.halfEdge;if(D!==-1){const L=D;do{const R=h.halfEdges.get(D);M.push(R),D=R.next}while(D!==L)}qn(M,h,v,(L,R)=>{const A=(we,ht)=>Math.abs(we-ht)<1e-6,O=A(L[1],x[1])&&A(R[1],x[1]),$=A(L[0],S[0])&&A(R[0],S[0]),N=A(L[1],z[1])&&A(R[1],z[1]),q=A(L[0],x[0])&&A(R[0],x[0]);return!(O||$||N||q)})}return h}}};Fe.register(ui,gs,ms);const hi="NullTabGenerator",ys={name:hi,displayName:"None",description:"Do not generate tabs. All pieces have straight edges.",sortHint:3,controls:[]},vs=(i,e,n)=>({createTabSegments(s,r,a,l){return[]}});ce.register(hi,vs,ys);const di="TriangleTabGenerator",ws={name:di,displayName:"Triangle",description:"Creates a simple triangle between each (internal) piece edge.",sortHint:2,controls:[]},Ps=(i,e,n)=>({createTabSegments(s,r,a,l){const c=[r[0]-s[0],r[1]-s[1]],u=Math.hypot(c[0],c[1]);if(u<1e-6)return[];const d=[c[0]/u,c[1]/u],h=[-d[1],d[0]],p=[s[0]+c[0]/2,s[1]+c[1]/2],f=a.convex?1:-1,y=u*a.size*f,w=[p[0]+h[0]*y,p[1]+h[1]*y],m=[];return m.push({type:"line",p:s}),m.push({type:"line",p:w}),m.push({type:"line",p:r}),m}});ce.register(di,Ps,ws);let Ft=!1;const bs=window.matchMedia("(prefers-color-scheme: dark)");bs.matches&&(Ft=!0);const xs=()=>{const n=jt,o=qt,s=Xt,r={seed:new Date().getTime()%10240,canvasWidth:800,canvasHeight:600,aspectRatio:800/600,distance:40,color:Ft?"#DDDDDD":"#333333",drawPoints:!1,pointColor:Ft?"#FF0000":"#0000FF",borderShape:"rectangle",borderCornerRadius:50,geometryProblems:{autoCheck:!1,problems:void 0,progress:void 0},dirty:!0,generators:{point:{label:"Seed Points",registry:Ue,name:n,config:Ue.getDefaultConfig(n,800,600)},piece:{label:"Piece Generation",registry:Fe,name:o,config:Fe.getDefaultConfig(o,800,600)},placement:{label:"Tab Placement",registry:Ve,name:ct,config:Ve.getDefaultConfig(ct,800,600)},tab:{label:"Tabs",registry:ce,name:s,config:ce.getDefaultConfig(s,800,600)}},puzzle:void 0,backgroundImageUrl:void 0,backgroundImageName:"",customPieces:[],selectedCustomPieceId:null,customPieceEditorOpen:!1,editingCustomPieceId:void 0};function a(){const{canvasWidth:m,canvasHeight:v,borderShape:b,borderCornerRadius:P}=r;switch(b){case"rectangle":return $t(m,v);case"circle":return kr(Math.min(m,v));case"ellipse":return Mr(m,v);case"rounded-rect":return _r(m,v,P);default:return $t(m,v)}}function l(){r.customPieceEditorOpen=!0,r.editingCustomPieceId=void 0,g.redraw()}function c(m,v){const b=new Date().toISOString();if(r.editingCustomPieceId)r.customPieces=r.customPieces.map(P=>P.id===r.editingCustomPieceId?{...P,name:v,path:m,modified:b}:P);else{const P={id:`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:v,path:m,transform:go(m,r.canvasWidth,r.canvasHeight,r.distance),created:b};r.customPieces=[...r.customPieces,P]}r.customPieceEditorOpen=!1,r.editingCustomPieceId=void 0,r.dirty=!0,g.redraw()}function u(){r.customPieceEditorOpen=!1,r.editingCustomPieceId=void 0,g.redraw()}function d(m){r.selectedCustomPieceId=m,g.redraw()}function h(m){r.customPieces.find(b=>b.id===m)&&(r.editingCustomPieceId=m,r.customPieceEditorOpen=!0,g.redraw())}function p(m){const v=r.customPieces.find(b=>b.id===m);if(v){const b=new Date().toISOString(),P=v.name?(()=>{const x=/^(.*?)\s*\((\d+)\)$/,S=v.name.match(x);if(S){const z=S[1],C=parseInt(S[2],10);return`${z} (${C+1})`}return`${v.name} (2)`})():void 0,E={id:`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:P,path:[...v.path],transform:{position:[v.transform.position[0]+20,v.transform.position[1]+20],rotation:v.transform.rotation,scale:[...v.transform.scale]},created:b};r.customPieces=[...r.customPieces,E],r.selectedCustomPieceId=E.id,r.dirty=!0,g.redraw()}}function f(m){r.customPieces=r.customPieces.filter(v=>v.id!==m),r.selectedCustomPieceId===m&&(r.selectedCustomPieceId=null),r.dirty=!0,g.redraw()}function y(m){console.log(`Position custom piece: ${m}`),alert("Whimsy positioning functionality will be available in Phase 5")}function w(){r.puzzle&&(r.geometryProblems.progress=0,g.redraw(),ds(r.puzzle,(m,v)=>{r.geometryProblems.progress=m/v*100,g.redraw()}).then(m=>{r.geometryProblems.problems=m.length,r.geometryProblems.progress=void 0,r.puzzle&&(r.puzzle.problems=m),g.redraw()}).catch(m=>{r.geometryProblems.progress=void 0,console.error(m),g.redraw()}))}return{oncreate:()=>{ke({bounds:{width:r.canvasWidth,height:r.canvasHeight},border:a(),pieceSize:r.distance,pointConfig:r.generators.point.config,pieceConfig:r.generators.piece.config,placementConfig:r.generators.placement.config,tabConfig:r.generators.tab.config,seed:r.seed,customPieces:r.customPieces}).then(m=>{r.puzzle=m,g.redraw(),r.geometryProblems.autoCheck&&w()}).catch(m=>{console.error(m)})},onupdate:()=>{r.dirty&&(r.dirty=!1,ke({bounds:{width:r.canvasWidth,height:r.canvasHeight},border:a(),pieceSize:r.distance,pointConfig:r.generators.point.config,pieceConfig:r.generators.piece.config,placementConfig:r.generators.placement.config,tabConfig:r.generators.tab.config,seed:r.seed,customPieces:r.customPieces}).then(m=>{r.geometryProblems.problems=void 0,r.geometryProblems.progress=void 0,r.puzzle=m,g.redraw(),r.geometryProblems.autoCheck&&w()}).catch(m=>{console.error(m)}))},onremove:()=>{r.backgroundImageUrl&&(URL.revokeObjectURL(r.backgroundImageUrl),r.backgroundImageUrl=void 0)},view:()=>g(".page",[g("h1","Puzzle Generator"),g(".container",[r.puzzle&&g(".puzzle-stack",[g(Nr,{width:r.canvasWidth,height:r.canvasHeight,color:r.color,imageUrl:r.backgroundImageUrl,puzzle:r.puzzle,isDirty:r.dirty,pointColor:r.drawPoints?r.pointColor:void 0,customPieces:r.customPieces,selectedCustomPieceId:r.selectedCustomPieceId,onPuzzleChanged:m=>{r.puzzle=m,g.redraw()},onCustomPieceSelected:m=>{r.selectedCustomPieceId=m,g.redraw()},onCustomPieceTransformed:(m,v)=>{r.customPieces=r.customPieces.map(b=>b.id===m?{...b,transform:v}:b),r.dirty=!0,g.redraw(),ke({bounds:{width:r.canvasWidth,height:r.canvasHeight},border:a(),seed:r.seed,pieceSize:r.distance,pointConfig:r.generators.point.config,pieceConfig:r.generators.piece.config,placementConfig:r.generators.placement.config,tabConfig:r.generators.tab.config,customPieces:r.customPieces}).then(b=>{r.geometryProblems.problems=void 0,r.geometryProblems.progress=void 0,r.puzzle=b,r.dirty=!1,g.redraw(),r.geometryProblems.autoCheck&&w()}).catch(b=>{console.error("Failed to rebuild puzzle with custom pieces:",b),r.dirty=!1,g.redraw()})},onSeedPointMoved:(m,v)=>{r.dirty=!1,r.puzzle&&Tr(r.puzzle,m,v).then(b=>{r.geometryProblems.problems=void 0,r.geometryProblems.progress=void 0,r.puzzle=b,g.redraw(),r.geometryProblems.autoCheck&&w()}).catch(b=>{console.error("Failed to rebuild puzzle with updated seed point:",b)})}}),g(".actions",[g(Fr,{puzzle:r.puzzle,width:r.canvasWidth,height:r.canvasHeight,color:r.color}),g(Vr,{autoCheck:r.geometryProblems.autoCheck,problems:r.geometryProblems.problems,progressPercent:r.geometryProblems.progress,onCheckRequested:()=>{r.dirty||w(),g.redraw()},onAutocheckChanged:m=>{m!==r.geometryProblems.autoCheck&&(r.geometryProblems.autoCheck=m,g.redraw())}})])]),g(".controls",[g(".background-image",[g(jr,{label:"Background Image",onUpload:(m,v,b,P)=>{r.backgroundImageUrl&&URL.revokeObjectURL(r.backgroundImageUrl),r.canvasWidth=b,r.canvasHeight=P,r.aspectRatio=b/P,r.backgroundImageUrl=m,r.backgroundImageName=v,r.dirty=!0,g.redraw()},onClear:()=>{r.backgroundImageUrl&&URL.revokeObjectURL(r.backgroundImageUrl),r.backgroundImageUrl=void 0,r.backgroundImageName="",r.dirty=!0,g.redraw()}})]),g(Xr,{ratio:r.aspectRatio,disabled:r.backgroundImageUrl!==void 0,onChange:m=>{r.aspectRatio=m,r.canvasWidth=r.canvasHeight*m,r.dirty=!0,g.redraw()}}),g(Yr,{shape:r.borderShape,disabled:r.backgroundImageUrl!==void 0,onChange:m=>{r.borderShape=m,r.dirty=!0,g.redraw()}}),r.borderShape==="rounded-rect"&&g(tt,{config:{name:"cornerRadius",label:"Corner Radius",type:"number"},value:r.borderCornerRadius,onChange:m=>{r.borderCornerRadius=m??50,r.dirty=!0,g.redraw()}}),g(tt,{config:{name:"seed",label:"Seed",type:"number"},value:r.seed,onChange:m=>{r.seed=m??0,r.dirty=!0,g.redraw()}}),g(tt,{config:{name:"pieceSize",label:"Piece size",type:"number"},value:r.distance,onChange:m=>{r.distance=m??0,r.dirty=!0,g.redraw()}}),g(dn,{label:"Piece color",color:r.color,size:"small",onUpdate:m=>{r.color=m,g.redraw()}}),g(".draw-points",[g(Bn,{config:{name:"drawPoints",label:"Draw seed points",type:"boolean"},value:r.drawPoints,onChange:m=>{r.drawPoints=m,g.redraw()}}),r.drawPoints&&g(dn,{label:"Seed points color",color:r.pointColor,size:"small",onUpdate:m=>{r.pointColor=m,g.redraw()}})]),g(zo,{pieces:r.customPieces,selectedPieceId:r.selectedCustomPieceId,pieceColor:r.color,onAdd:l,onSelect:d,onEdit:h,onDuplicate:p,onDelete:f,onPosition:y}),...Object.entries(r.generators).map(([m,v])=>g("label",[v.label+":",g(qr,{generator:v.name,registry:v.registry,config:v.config,onGeneratorChange:b=>{b!=v.name&&(console.log(`${m} generator changed to ${b}`),v.name=b,r.generators[m].config=v.registry.getDefaultConfig(b,r.canvasWidth,r.canvasHeight),r.dirty=!0,g.redraw())},onConfigChange:(b,P)=>{console.log(`${m} generator config "${b}" changed to ${String(P)}`),v.config[b]=P,r.dirty=!0,g.redraw()}})]))])]),g(bo,{open:r.customPieceEditorOpen,piece:r.editingCustomPieceId?r.customPieces.find(m=>m.id===r.editingCustomPieceId):void 0,onSave:c,onCancel:u})])}},Cs=()=>{const i={initialPathToLoad:[],pathCommands:[],pathDataDisplay:"No path data yet",svgInputElement:void 0,importStatus:""},e=r=>{i.pathCommands=r,i.pathDataDisplay=JSON.stringify(r,null,2)},n=()=>{i.initialPathToLoad=[],i.pathCommands=[],i.pathDataDisplay="No path data yet",g.redraw()},o=()=>{const r=[{type:"move",p:[469.48276150227287,198.61914195331622]},{type:"line",p:[147.27539529214673,525.2460501911088]},{type:"bezier",p1:[119.6268609401618,551.2189519643504],p2:[149.62606858643616,580],p3:[178.36644877954177,551.7150560673149]},{type:"line",p:[206.99671887066515,523.5384839302747]},{type:"line",p:[241.34793037003863,560.4031774534698]},{type:"line",p:[264.8072838080452,537.7816545144234]},{type:"line",p:[232.96958275167054,503.43044775157955]},{type:"line",p:[252.23977895834645,484.99810098998205]},{type:"line",p:[268.15862475000426,500.91691362593315]},{type:"line",p:[287.4288209566801,483.32241157288445]},{type:"line",p:[273.1856361629428,466.5657068630892]},{type:"line",p:[296.07185058171,443.34292886551395]},{type:"line",p:[330.2814730038454,480.0802571096493]},{type:"line",p:[357.19242550437104,453.43183149484946]},{type:"line",p:[323.7943979441297,416.6172978193763]},{type:"line",p:[501.07659759926975,235.32345658662825]},{type:"bezier",p1:[501.07659759926975,235.32345658662825],p2:[558.04932730116,263.8097503896305],p3:[597.4275549500016,248.7287824622282]},{type:"bezier",p1:[636.805782598843,233.64776716953054],p2:[670.3190972878429,209.35060217868192],p3:[675.3461181738405,165.78319835239148]},{type:"bezier",p1:[680.3731390598382,122.21579452610115],p2:[659.4273055378894,78.6484143824585],p3:[625.9138961182989,49.324204822964475]},{type:"bezier",p1:[592.4005340640038,20],p2:[537.9412437571693,20.837830498960273],p3:[499.4008608168767,39.27018673361687]},{type:"bezier",p1:[460.8604778765839,57.70254770480301],p2:[438.239021248951,92.89158496660718],p3:[437.40117180387267,127.24280120251018]},{type:"bezier",p1:[436.5633223587943,161.59402217494272],p2:[469.4827615022728,198.61914195331644],p3:[469.4827615022728,198.61914195331644]},{type:"line",p:[469.48276150227287,198.61914195331622]}];i.initialPathToLoad=r,i.pathCommands=r,i.pathDataDisplay=JSON.stringify(r,null,2),g.redraw()},s=r=>{if(r.redraw=!1,!i.svgInputElement)return;const a=i.svgInputElement.files?.[0];if(!a)return;if(a.type!=="image/svg+xml"&&!a.name.endsWith(".svg")){i.importStatus="Error: Please select an SVG file",g.redraw();return}const l=new FileReader;l.onload=c=>{const u=c.target?.result;if(!u){i.importStatus="Error: Could not read file",g.redraw();return}const d=ei(u);if(!d){i.importStatus="Error: Could not parse SVG path",g.redraw();return}const h=ti(d.commands,800,600);i.initialPathToLoad=h,i.pathCommands=h,i.pathDataDisplay=JSON.stringify(h,null,2),d.warning?i.importStatus=`Warning: ${d.warning}`:i.importStatus=`Imported: ${a.name}`,g.redraw()},l.onerror=()=>{i.importStatus="Error: Failed to read file",g.redraw()},l.readAsText(a),i.svgInputElement.value=""};return{view:()=>g(".page",[g("h1","Path Editor"),g("p","Testing the PathEditor component."),g(".test-page",[g(".test-area",[g(Zn,{width:800,height:600,initialPath:i.initialPathToLoad,onPathChanged:e,strokeColor:"#000000ff"})]),g(".controls",[g("h2","Controls"),g(".button-group",[g("button",{onclick:n,style:"background: #f44336;"},"Clear Canvas"),g("button",{onclick:o,style:"background: #4CAF50;"},"Load Sample Path"),g("button",{onclick:()=>{i.svgInputElement&&i.svgInputElement.click()},style:"background: #2196F3;"},"Import SVG"),g("input[type=file]",{style:{display:"none"},accept:".svg,image/svg+xml",oncreate:({dom:r})=>{i.svgInputElement=r},onchange:s})]),i.importStatus&&g("p",{style:`margin-top: 0.5rem; color: ${i.importStatus.startsWith("Error")?"#f44336":i.importStatus.startsWith("Warning")?"#FF9800":"#4CAF50"};`},i.importStatus),g(".instructions",[g("h3",{style:"margin-top: 1rem;"},"Instructions:"),g("p","The editor has two modes:"),g("ul",{style:"margin: 0.5rem 0;"},[g("li",g("strong","Drawing Mode"),": Click to add points (straight lines), or click-drag to add points with smooth bezier curves"),g("ul",{style:"margin-left: 1rem;"},[g("li","Move near the first point to see a green circle indicator - click to close the path"),g("li","Closing the path automatically switches to Edit mode"),g("li","Or click ",g("strong","End Drawing")," to finish without closing")]),g("li",g("strong","Editing Mode"),":"),g("ul",{style:"margin-left: 1rem;"},[g("li","Click anywhere on the path to select it and show all vertices"),g("li","Click a specific vertex to select it (turns blue), then drag to move it"),g("li","Drag curve handles to adjust curve shape"),g("li","Hold ",g("strong","Shift")," and click on the path to insert a new point"),g("li","Select a vertex and press ",g("strong","Delete")," or ",g("strong","Backspace")," to remove it"),g("li","Click empty space to deselect")]),g("li","The mode indicator below the canvas shows the current mode")]),g("h3",{style:"margin-top: 1rem;"},"Pan and Zoom:"),g("ul",{style:"margin: 0.5rem 0;"},[g("li","Hold ",g("strong","Spacebar")," and drag to pan the canvas"),g("li","Use ",g("strong","mouse wheel")," to zoom in/out (zooms toward cursor position)"),g("li","Use the ",g("strong","Zoom dropdown")," to select preset zoom levels (25%, 50%, 100%, 200%, 400%)"),g("li","Click the ",g("strong","Recenter button")," to reset view to 100% zoom and center position")])])]),g(".data-display",[g("h2","Path Data"),g("h3","PathCommand[] Format:"),g("textarea",{readonly:!0,value:i.pathDataDisplay,rows:15,style:"font-family: monospace; font-size: 12px; width: 100%;"})])])])}};function Is(){const i=window.matchMedia("(prefers-color-scheme: dark)");function e(){i.matches?document.documentElement.classList.add("wa-dark"):document.documentElement.classList.remove("wa-dark")}e(),i.addEventListener("change",e)}Is();const Mn={view:i=>[g(mi,{link:"https://github.com/weevilgenius/puzzle-generator"}),g(gi),i.children]};pi("material",{resolver:i=>{const e=i.match(/^(.*?)(_(rounded|sharp))?$/);return e?`https://cdn.jsdelivr.net/npm/@material-symbols/svg-400@0.32.0/${e[3]??"outlined"}/${e[1]}.svg`:""},mutator:i=>i.setAttribute("fill","currentColor")});g.route(document.body,"/puzzle",{"/puzzle":{render:()=>g(Mn,g(xs))},"/test":{render:()=>g(Mn,g(Cs))}});
//# sourceMappingURL=index-CQndUemf.js.map
