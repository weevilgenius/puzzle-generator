import{m as P,a as Zn}from"./mithril-CkNsZ0QC.js";import{P as Di}from"./paper-dWT2ESzd.js";import{r as Ai}from"./webawesome-y1t-Oc9v.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const Li={view:({attrs:i})=>P("a.github-corner",{href:i.link,"aria-label":"View source on GitHub",title:"View source on GitHub",target:"_blank"},P("svg",{width:80,height:80,viewBox:"0 0 250 250","aria-hidden":"true"},[P("path",{d:"M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"}),P("path.octo-arm",{fill:"currentColor",style:"transform-origin: 130px 106px;",d:"M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"}),P("path.octo-body",{fill:"currentColor",d:"M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"})]))},gn=50,yn=5,Ri=yn*yn,Hi=.1,Oi=10,_t=1,$i=.025,Ni=[.25,.5,1,2,4],Fi=["25%","50%","100%","200%","400%"];function xt(i,n){const e=!!i&&!!i.project&&!!i.project.activeLayer&&!!i.view&&!!i.view._context&&i.view._visible!==!1;return e||console.warn(`[${n}] Paper not ready`,{hasScope:!!i,hasProject:!!i?.project,hasLayer:!!i?.project?.activeLayer,hasView:!!i?.view,ctx:!!i?.view?._context,visible:i?.view?._visible}),e}function W(i,n,e){try{return i.scope.activate(),e()}catch(r){console.error(`[${n}] block in paper scope failed`,r)}}function Qn(i,n,e){const r=new Di.PaperScope;return r.setup(i),r.view.viewSize=new r.Size(n,e),{scope:r}}function Vi(i){const n=[];if(i.segments.length===0)return n;const e=i.segments[0],r={type:"move",p:[e.point.x,e.point.y]};n.push(r);for(let s=1;s<i.segments.length;s++){const o=i.segments[s-1],a=i.segments[s];if(o.handleOut&&o.handleOut.length>0||a.handleIn&&a.handleIn.length>0){const l=o.handleOut?[o.point.x+o.handleOut.x,o.point.y+o.handleOut.y]:[o.point.x,o.point.y],u=a.handleIn?[a.point.x+a.handleIn.x,a.point.y+a.handleIn.y]:[a.point.x,a.point.y],d={type:"bezier",p1:l,p2:u,p3:[a.point.x,a.point.y]};n.push(d)}else{const l={type:"line",p:[a.point.x,a.point.y]};n.push(l)}}if(i.closed&&i.segments.length>=2){const s=i.segments[i.segments.length-1],o=i.segments[0];if(s.handleOut&&s.handleOut.length>0||o.handleIn&&o.handleIn.length>0){const c=s.handleOut?[s.point.x+s.handleOut.x,s.point.y+s.handleOut.y]:[s.point.x,s.point.y],l=o.handleIn?[o.point.x+o.handleIn.x,o.point.y+o.handleIn.y]:[o.point.x,o.point.y],u={type:"bezier",p1:c,p2:l,p3:[o.point.x,o.point.y]};n.push(u)}else{const c={type:"line",p:[o.point.x,o.point.y]};n.push(c)}}return n}function Kt(i,n){const e=n.scope,r=new e.Path;if(i.length===0)return r;let s=null;for(const o of i)switch(o.type){case"move":{const[a,c]=o.p;s=new e.Point(a,c),r.moveTo(s);break}case"line":{const[a,c]=o.p;s=new e.Point(a,c),r.lineTo(s);break}case"bezier":{if(!s){console.warn("paperUtils: CurveTo command without a current point, skipping");break}const[a,c]=o.p1,[l,u]=o.p2,[d,h]=o.p3,f=new e.Point(d,h),p=new e.Point(a,c),g=new e.Point(l,u);r.add(f);const y=r.lastSegment,m=g.subtract(f);if(y.handleIn=m,r.segments.length>=2){const v=p.subtract(s);r.segments[r.segments.length-2].handleOut=v}s=f;break}case"arc":console.warn("paperUtils: Arc commands not yet supported, skipping arc command");break}return r}function Ui(i,n,e){const r=e.scope,s=new r.Group,o=Kt(i.borderPath,e);o.strokeColor=new r.Color(n),o.strokeWidth=1,o.data.isBorder=!0,s.addChild(o);for(const a of i.pieces.values()){const c=Gi(a,i,e);c.strokeColor=new r.Color(n),c.strokeWidth=1,c.data.pieceId=a.id,s.addChild(c)}return s}function Gi(i,n,e){const r=e.scope,s=new r.Path;let o=n.halfEdges.get(i.halfEdge);if(!o)return s;const a=o.id;s.moveTo(new r.Point(o.origin[0],o.origin[1]));do{if(o.segments)for(const c of o.segments)ji(s,c,e);else{const c=n.halfEdges.get(o.next);s.lineTo(new r.Point(c.origin[0],c.origin[1]))}o=n.halfEdges.get(o.next)}while(o.id!==a);return s}function ji(i,n,e){const r=e.scope;switch(n.type){case"line":{i.lineTo(new r.Point(n.p[0],n.p[1]));break}case"bezier":{i.cubicCurveTo(new r.Point(n.p1[0],n.p1[1]),new r.Point(n.p2[0],n.p2[1]),new r.Point(n.p3[0],n.p3[1]));break}}}function Bi(i,n,e,r){if(n.removeChildren(),!e)return;const s=r.scope;for(const o of i.pieces.values()){const[a,c]=o.site,l=new s.Path.Circle(new s.Point(a,c),3);l.fillColor=new s.Color(e),l.data.pieceId=o.id,n.addChild(l)}}function Wi(i,n,e){if(n.removeChildren(),!i.problems||i.problems.length===0)return;const r=e.scope;for(const s of i.problems){const[o,a]=s,c=new r.Path.Circle(new r.Point(o,a),8);c.strokeColor=new r.Color("red"),c.strokeWidth=2,n.addChild(c)}}function qi(i,n){return n()}async function Xi(i,n){return n()}function Yi(i,n,e,r){r.paperCtx=Qn(i,n,e),r.paperCtx||console.error("PuzzleRenderer: Failed to create Paper.js context")}function bt(i,n,e,r){if(!i.paperCtx){console.error("PuzzleRenderer: Cannot render - Paper.js context not initialized");return}qi("Paper.js Rendering",()=>{W(i.paperCtx,"PuzzleRenderer:renderPuzzle",()=>{const s=i.paperCtx.scope;if(!xt(s,"PuzzleRenderer:renderPuzzle")){console.error("PuzzleRenderer: Paper.js not ready - canvas may have been replaced");return}i.puzzleLayer&&i.puzzleLayer.activate(),i.paperPath&&(i.paperPath.remove(),i.paperPath=null),i.paperPath=Ui(n,e,i.paperCtx),i.verticesLayer&&i.verticesLayer.activate(),Zi(n,i),i.seedPointsLayer&&i.seedPointsLayer.activate(),i.seedPointItems&&i.paperCtx&&Bi(n,i.seedPointItems,r,i.paperCtx),i.problemsLayer&&i.problemsLayer.activate(),i.problemItems&&i.paperCtx&&Wi(n,i.problemItems,i.paperCtx),s.view.update()})})}function Ki(i){if(!i.paperCtx){console.error("PuzzleRenderer: Cannot create layers - Paper.js context not initialized");return}W(i.paperCtx,"PuzzleRenderer:createPaperLayers",()=>{const n=i.paperCtx.scope;if(!xt(n,"PuzzleRenderer:createPaperLayers")){console.error("PuzzleRenderer: Paper.js not ready - canvas may have been replaced");return}i.puzzleLayer=new n.Layer,i.customPiecesLayer=new n.Layer,i.customHandlesLayer=new n.Layer,i.seedPointsLayer=new n.Layer,i.verticesLayer=new n.Layer,i.problemsLayer=new n.Layer,i.puzzleLayer.activate(),i.backgroundRaster=null,i.paperPath=null,i.seedPointsLayer.activate(),i.seedPointItems=new n.Group,i.problemsLayer.activate(),i.problemItems=new n.Group,i.verticesLayer.activate(),i.vertexItems=new n.Group,i.puzzleLayer.activate()})}function vn(i,n,e,r){if(!i.paperCtx){console.error("PuzzleRenderer: Cannot update background - Paper.js context not initialized");return}W(i.paperCtx,"PuzzleRenderer:updateBackgroundImage",()=>{const s=i.paperCtx.scope;if(i.puzzleLayer&&i.puzzleLayer.activate(),i.backgroundRaster&&(i.backgroundRaster.remove(),i.backgroundRaster=null),n){const o=new s.Raster(n);o.position=new s.Point(e/2,r/2),o.onLoad=()=>{if(o.width&&o.height){const a=e/o.width,c=r/o.height;o.scale(a,c)}},o.sendToBack(),i.backgroundRaster=o}})}function Jn(i){const n=new Set;for(const e of i.halfEdges.values())if(e.twin===-1){const r=i.vertices.findIndex(s=>s[0]===e.origin[0]&&s[1]===e.origin[1]);r>=0&&n.add(r)}return n}function Zi(i,n){if(!n.vertexItems||!n.paperCtx)return;const e=n.paperCtx.scope;n.vertexItems.removeChildren();const r=Jn(i);for(let s=0;s<i.vertices.length;s++){if(r.has(s))continue;const[o,a]=i.vertices[s],c=new e.Path.Circle(new e.Point(o,a),4);c.fillColor=new e.Color("#4363d8"),c.strokeColor=new e.Color("#ffffff"),c.strokeWidth=1,c.visible=!1,c.data.vertexId=s,n.vertexItems.addChild(c)}}function ei(i,n){const e=new n.Path;for(const r of i)switch(r.type){case"move":e.moveTo(new n.Point(r.p[0],r.p[1]));break;case"line":e.lineTo(new n.Point(r.p[0],r.p[1]));break;case"bezier":e.cubicCurveTo(new n.Point(r.p1[0],r.p1[1]),new n.Point(r.p2[0],r.p2[1]),new n.Point(r.p3[0],r.p3[1]));break;case"arc":e.lineTo(new n.Point(r.p[0],r.p[1]));break}return e}function Zt(i,n,e,r){!i.paperCtx||!i.customPiecesLayer||W(i.paperCtx,"PuzzleRenderer:renderCustomPieces",()=>{const s=i.paperCtx.scope;i.customPiecesLayer.activate(),i.customPiecesLayer.removeChildren();for(const o of n){const a=ei(o.path,s),{position:c,rotation:l,scale:u}=o.transform;a.position=new s.Point(0,0);const d=new s.Matrix;d.translate(new s.Point(c[0],c[1])),d.rotate(l*(180/Math.PI),new s.Point(0,0)),d.scale(u[0],u[1],new s.Point(0,0)),a.transform(d),o.id===r?(a.fillColor=new s.Color(0,.5,1,.3),a.strokeColor=new s.Color(0,.5,1),a.strokeWidth=2):(a.fillColor=null,a.strokeColor=new s.Color(e),a.strokeWidth=1),a.data.customPieceId=o.id}})}function Qt(i,n){!i.paperCtx||!i.customHandlesLayer||W(i.paperCtx,"PuzzleRenderer:renderCustomPieceHandles",()=>{const e=i.paperCtx.scope;i.customHandlesLayer.activate(),i.customHandlesLayer.removeChildren();const r=ei(n.path,e);r.position=new e.Point(0,0);const s=r.bounds;r.remove();const{scale:o,rotation:a,position:c}=n.transform,u=[s.topLeft,s.topRight,s.bottomRight,s.bottomLeft].map(_=>{const A=_.x*o[0],L=_.y*o[1],R=Math.cos(a),H=Math.sin(a),$=A*R-L*H,O=A*H+L*R;return new e.Point($+c[0],O+c[1])}),d=new e.Path;d.moveTo(u[0]),d.lineTo(u[1]),d.lineTo(u[2]),d.lineTo(u[3]),d.closePath(),d.strokeColor=new e.Color(0,.5,1),d.strokeWidth=1,d.dashArray=[4,4],d.data.handleType="bbox",i.customHandlesLayer.addChild(d);const h=4,f=["nw","ne","se","sw"];u.forEach((_,A)=>{const L=new e.Path.Circle(_,h);L.fillColor=new e.Color(1,1,1),L.strokeColor=new e.Color(0,.5,1),L.strokeWidth=2,L.data.handleType="scale",L.data.corner=f[A],i.customHandlesLayer.addChild(L)});const p=40,g=new e.Point(s.center.x,s.top),y=g.x*o[0],m=g.y*o[1],v=Math.cos(a),w=Math.sin(a),x=y*v-m*w,T=y*w+m*v,S=new e.Point(x+c[0],T+c[1]),I=0,E=-p,b=I*v-E*w,C=I*w+E*v,M=new e.Point(S.x+b,S.y+C),z=new e.Path.Line(S,M);z.strokeColor=new e.Color(0,.5,1),z.strokeWidth=1,z.dashArray=[4,4],z.data.handleType="rotation-line",i.customHandlesLayer.addChild(z);const k=new e.Path.Circle(M,h);k.fillColor=new e.Color(1,1,1),k.strokeColor=new e.Color(0,.5,1),k.strokeWidth=2,k.data.handleType="rotation",i.customHandlesLayer.addChild(k)})}function Dt(i){i.customHandlesLayer&&i.customHandlesLayer.removeChildren()}function Qi(i){i.backgroundRaster&&(i.backgroundRaster.remove(),i.backgroundRaster=null),i.paperPath&&(i.paperPath.remove(),i.paperPath=null),i.seedPointItems&&(i.seedPointItems.remove(),i.seedPointItems=null),i.problemItems&&(i.problemItems.remove(),i.problemItems=null),i.vertexItems&&(i.vertexItems.remove(),i.vertexItems=null),i.puzzleLayer&&(i.puzzleLayer.remove(),i.puzzleLayer=null),i.customPiecesLayer&&(i.customPiecesLayer.remove(),i.customPiecesLayer=null),i.customHandlesLayer&&(i.customHandlesLayer.remove(),i.customHandlesLayer=null),i.seedPointsLayer&&(i.seedPointsLayer.remove(),i.seedPointsLayer=null),i.verticesLayer&&(i.verticesLayer.remove(),i.verticesLayer=null),i.problemsLayer&&(i.problemsLayer.remove(),i.problemsLayer=null),i.paperCtx&&i.paperCtx.scope.project.remove()}class Mt{generators=new Map;register(n,e,r){this.generators.has(n)&&console.warn(`Generator "${n}" is already registered, overwriting`),this.generators.set(n,{factory:e,uiMetadata:r})}create(n,e,r){const s=this.generators.get(r.name);if(!s)throw new Error(`Unknown generator "${r.name}". Is it registered?`);return s.factory(n,e,r)}getAvailableGenerators(){return Array.from(this.generators.values()).sort((n,e)=>n.uiMetadata.sortHint-e.uiMetadata.sortHint).map(n=>({name:n.uiMetadata.name,displayName:n.uiMetadata.displayName}))}getUIMetadata(n){return this.generators.get(n)?.uiMetadata}getDefaultConfig(n,e,r){const s={name:n,width:e,height:r},o=this.getUIMetadata(n);if(o)for(const a of o.controls)s[a.name]=a.defaultValue;return s}}const nt=new Mt,it=new Mt,ot=new Mt,xe=new Mt;let Ji=0;function ti(){return Ji++}const{abs:Re,cos:te,sin:Ce,acos:eo,atan2:He,sqrt:se,pow:Y}=Math;function Oe(i){return i<0?-Y(-i,1/3):Y(i,1/3)}const ni=Math.PI,ut=2*ni,ae=ni/2,to=1e-6,At=Number.MAX_SAFE_INTEGER||9007199254740991,Lt=Number.MIN_SAFE_INTEGER||-9007199254740991,no={x:0,y:0,z:0},D={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(i,n){const e=n(i);let r=e.x*e.x+e.y*e.y;return typeof e.z<"u"&&(r+=e.z*e.z),se(r)},compute:function(i,n,e){if(i===0)return n[0].t=0,n[0];const r=n.length-1;if(i===1)return n[r].t=1,n[r];const s=1-i;let o=n;if(r===0)return n[0].t=i,n[0];if(r===1){const c={x:s*o[0].x+i*o[1].x,y:s*o[0].y+i*o[1].y,t:i};return e&&(c.z=s*o[0].z+i*o[1].z),c}if(r<4){let c=s*s,l=i*i,u,d,h,f=0;r===2?(o=[o[0],o[1],o[2],no],u=c,d=s*i*2,h=l):r===3&&(u=c*s,d=c*i*3,h=s*l*3,f=i*l);const p={x:u*o[0].x+d*o[1].x+h*o[2].x+f*o[3].x,y:u*o[0].y+d*o[1].y+h*o[2].y+f*o[3].y,t:i};return e&&(p.z=u*o[0].z+d*o[1].z+h*o[2].z+f*o[3].z),p}const a=JSON.parse(JSON.stringify(n));for(;a.length>1;){for(let c=0;c<a.length-1;c++)a[c]={x:a[c].x+(a[c+1].x-a[c].x)*i,y:a[c].y+(a[c+1].y-a[c].y)*i},typeof a[c].z<"u"&&(a[c].z=a[c].z+(a[c+1].z-a[c].z)*i);a.splice(a.length-1,1)}return a[0].t=i,a[0]},computeWithRatios:function(i,n,e,r){const s=1-i,o=e,a=n;let c=o[0],l=o[1],u=o[2],d=o[3],h;if(c*=s,l*=i,a.length===2)return h=c+l,{x:(c*a[0].x+l*a[1].x)/h,y:(c*a[0].y+l*a[1].y)/h,z:r?(c*a[0].z+l*a[1].z)/h:!1,t:i};if(c*=s,l*=2*s,u*=i*i,a.length===3)return h=c+l+u,{x:(c*a[0].x+l*a[1].x+u*a[2].x)/h,y:(c*a[0].y+l*a[1].y+u*a[2].y)/h,z:r?(c*a[0].z+l*a[1].z+u*a[2].z)/h:!1,t:i};if(c*=s,l*=1.5*s,u*=3*s,d*=i*i*i,a.length===4)return h=c+l+u+d,{x:(c*a[0].x+l*a[1].x+u*a[2].x+d*a[3].x)/h,y:(c*a[0].y+l*a[1].y+u*a[2].y+d*a[3].y)/h,z:r?(c*a[0].z+l*a[1].z+u*a[2].z+d*a[3].z)/h:!1,t:i}},derive:function(i,n){const e=[];for(let r=i,s=r.length,o=s-1;s>1;s--,o--){const a=[];for(let c=0,l;c<o;c++)l={x:o*(r[c+1].x-r[c].x),y:o*(r[c+1].y-r[c].y)},n&&(l.z=o*(r[c+1].z-r[c].z)),a.push(l);e.push(a),r=a}return e},between:function(i,n,e){return n<=i&&i<=e||D.approximately(i,n)||D.approximately(i,e)},approximately:function(i,n,e){return Re(i-n)<=(e||to)},length:function(i){const e=D.Tvalues.length;let r=0;for(let s=0,o;s<e;s++)o=.5*D.Tvalues[s]+.5,r+=D.Cvalues[s]*D.arcfn(o,i);return .5*r},map:function(i,n,e,r,s){const o=e-n,a=s-r,c=i-n,l=c/o;return r+a*l},lerp:function(i,n,e){const r={x:n.x+i*(e.x-n.x),y:n.y+i*(e.y-n.y)};return n.z!==void 0&&e.z!==void 0&&(r.z=n.z+i*(e.z-n.z)),r},pointToString:function(i){let n=i.x+"/"+i.y;return typeof i.z<"u"&&(n+="/"+i.z),n},pointsToString:function(i){return"["+i.map(D.pointToString).join(", ")+"]"},copy:function(i){return JSON.parse(JSON.stringify(i))},angle:function(i,n,e){const r=n.x-i.x,s=n.y-i.y,o=e.x-i.x,a=e.y-i.y,c=r*a-s*o,l=r*o+s*a;return He(c,l)},round:function(i,n){const e=""+i,r=e.indexOf(".");return parseFloat(e.substring(0,r+1+n))},dist:function(i,n){const e=i.x-n.x,r=i.y-n.y;return se(e*e+r*r)},closest:function(i,n){let e=Y(2,63),r,s;return i.forEach(function(o,a){s=D.dist(n,o),s<e&&(e=s,r=a)}),{mdist:e,mpos:r}},abcratio:function(i,n){if(n!==2&&n!==3)return!1;if(typeof i>"u")i=.5;else if(i===0||i===1)return i;const e=Y(i,n)+Y(1-i,n),r=e-1;return Re(r/e)},projectionratio:function(i,n){if(n!==2&&n!==3)return!1;if(typeof i>"u")i=.5;else if(i===0||i===1)return i;const e=Y(1-i,n),r=Y(i,n)+e;return e/r},lli8:function(i,n,e,r,s,o,a,c){const l=(i*r-n*e)*(s-a)-(i-e)*(s*c-o*a),u=(i*r-n*e)*(o-c)-(n-r)*(s*c-o*a),d=(i-e)*(o-c)-(n-r)*(s-a);return d==0?!1:{x:l/d,y:u/d}},lli4:function(i,n,e,r){const s=i.x,o=i.y,a=n.x,c=n.y,l=e.x,u=e.y,d=r.x,h=r.y;return D.lli8(s,o,a,c,l,u,d,h)},lli:function(i,n){return D.lli4(i,i.c,n,n.c)},makeline:function(i,n){return new F(i.x,i.y,(i.x+n.x)/2,(i.y+n.y)/2,n.x,n.y)},findbbox:function(i){let n=At,e=At,r=Lt,s=Lt;return i.forEach(function(o){const a=o.bbox();n>a.x.min&&(n=a.x.min),e>a.y.min&&(e=a.y.min),r<a.x.max&&(r=a.x.max),s<a.y.max&&(s=a.y.max)}),{x:{min:n,mid:(n+r)/2,max:r,size:r-n},y:{min:e,mid:(e+s)/2,max:s,size:s-e}}},shapeintersections:function(i,n,e,r,s){if(!D.bboxoverlap(n,r))return[];const o=[],a=[i.startcap,i.forward,i.back,i.endcap],c=[e.startcap,e.forward,e.back,e.endcap];return a.forEach(function(l){l.virtual||c.forEach(function(u){if(u.virtual)return;const d=l.intersects(u,s);d.length>0&&(d.c1=l,d.c2=u,d.s1=i,d.s2=e,o.push(d))})}),o},makeshape:function(i,n,e){const r=n.points.length,s=i.points.length,o=D.makeline(n.points[r-1],i.points[0]),a=D.makeline(i.points[s-1],n.points[0]),c={startcap:o,forward:i,back:n,endcap:a,bbox:D.findbbox([o,i,n,a])};return c.intersections=function(l){return D.shapeintersections(c,c.bbox,l,l.bbox,e)},c},getminmax:function(i,n,e){if(!e)return{min:0,max:0};let r=At,s=Lt,o,a;e.indexOf(0)===-1&&(e=[0].concat(e)),e.indexOf(1)===-1&&e.push(1);for(let c=0,l=e.length;c<l;c++)o=e[c],a=i.get(o),a[n]<r&&(r=a[n]),a[n]>s&&(s=a[n]);return{min:r,mid:(r+s)/2,max:s,size:s-r}},align:function(i,n){const e=n.p1.x,r=n.p1.y,s=-He(n.p2.y-r,n.p2.x-e),o=function(a){return{x:(a.x-e)*te(s)-(a.y-r)*Ce(s),y:(a.x-e)*Ce(s)+(a.y-r)*te(s)}};return i.map(o)},roots:function(i,n){n=n||{p1:{x:0,y:0},p2:{x:1,y:0}};const e=i.length-1,r=D.align(i,n),s=function(E){return 0<=E&&E<=1};if(e===2){const E=r[0].y,b=r[1].y,C=r[2].y,M=E-2*b+C;if(M!==0){const z=-se(b*b-E*C),k=-E+b,_=-(z+k)/M,A=-(-z+k)/M;return[_,A].filter(s)}else if(b!==C&&M===0)return[(2*b-C)/(2*b-2*C)].filter(s);return[]}const o=r[0].y,a=r[1].y,c=r[2].y,l=r[3].y;let u=-o+3*a-3*c+l,d=3*o-6*a+3*c,h=-3*o+3*a,f=o;if(D.approximately(u,0)){if(D.approximately(d,0))return D.approximately(h,0)?[]:[-f/h].filter(s);const E=se(h*h-4*d*f),b=2*d;return[(E-h)/b,(-h-E)/b].filter(s)}d/=u,h/=u,f/=u;const p=(3*h-d*d)/3,g=p/3,y=(2*d*d*d-9*d*h+27*f)/27,m=y/2,v=m*m+g*g*g;let w,x,T,S,I;if(v<0){const E=-p/3,b=E*E*E,C=se(b),M=-y/(2*C),z=M<-1?-1:M>1?1:M,k=eo(z),_=Oe(C),A=2*_;return T=A*te(k/3)-d/3,S=A*te((k+ut)/3)-d/3,I=A*te((k+2*ut)/3)-d/3,[T,S,I].filter(s)}else{if(v===0)return w=m<0?Oe(-m):-Oe(m),T=2*w-d/3,S=-w-d/3,[T,S].filter(s);{const E=se(v);return w=Oe(-m+E),x=Oe(m+E),[w-x-d/3].filter(s)}}},droots:function(i){if(i.length===3){const n=i[0],e=i[1],r=i[2],s=n-2*e+r;if(s!==0){const o=-se(e*e-n*r),a=-n+e,c=-(o+a)/s,l=-(-o+a)/s;return[c,l]}else if(e!==r&&s===0)return[(2*e-r)/(2*(e-r))];return[]}if(i.length===2){const n=i[0],e=i[1];return n!==e?[n/(n-e)]:[]}return[]},curvature:function(i,n,e,r,s){let o,a,c,l,u=0,d=0;const h=D.compute(i,n),f=D.compute(i,e),p=h.x*h.x+h.y*h.y;if(r?(o=se(Y(h.y*f.z-f.y*h.z,2)+Y(h.z*f.x-f.z*h.x,2)+Y(h.x*f.y-f.x*h.y,2)),a=Y(p+h.z*h.z,3/2)):(o=h.x*f.y-h.y*f.x,a=Y(p,3/2)),o===0||a===0)return{k:0,r:0};if(u=o/a,d=a/o,!s){const g=D.curvature(i-.001,n,e,r,!0).k,y=D.curvature(i+.001,n,e,r,!0).k;l=(y-u+(u-g))/2,c=(Re(y-u)+Re(u-g))/2}return{k:u,r:d,dk:l,adk:c}},inflections:function(i){if(i.length<4)return[];const n=D.align(i,{p1:i[0],p2:i.slice(-1)[0]}),e=n[2].x*n[1].y,r=n[3].x*n[1].y,s=n[1].x*n[2].y,o=n[3].x*n[2].y,a=18*(-3*e+2*r+3*s-o),c=18*(3*e-r-3*s),l=18*(s-e);if(D.approximately(a,0)){if(!D.approximately(c,0)){let f=-l/c;if(0<=f&&f<=1)return[f]}return[]}const u=2*a;if(D.approximately(u,0))return[];const d=c*c-4*a*l;if(d<0)return[];const h=Math.sqrt(d);return[(h-c)/u,-(c+h)/u].filter(function(f){return 0<=f&&f<=1})},bboxoverlap:function(i,n){const e=["x","y"],r=e.length;for(let s=0,o,a,c,l;s<r;s++)if(o=e[s],a=i[o].mid,c=n[o].mid,l=(i[o].size+n[o].size)/2,Re(a-c)>=l)return!1;return!0},expandbox:function(i,n){n.x.min<i.x.min&&(i.x.min=n.x.min),n.y.min<i.y.min&&(i.y.min=n.y.min),n.z&&n.z.min<i.z.min&&(i.z.min=n.z.min),n.x.max>i.x.max&&(i.x.max=n.x.max),n.y.max>i.y.max&&(i.y.max=n.y.max),n.z&&n.z.max>i.z.max&&(i.z.max=n.z.max),i.x.mid=(i.x.min+i.x.max)/2,i.y.mid=(i.y.min+i.y.max)/2,i.z&&(i.z.mid=(i.z.min+i.z.max)/2),i.x.size=i.x.max-i.x.min,i.y.size=i.y.max-i.y.min,i.z&&(i.z.size=i.z.max-i.z.min)},pairiteration:function(i,n,e){const r=i.bbox(),s=n.bbox(),o=1e5,a=e||.5;if(r.x.size+r.y.size<a&&s.x.size+s.y.size<a)return[(o*(i._t1+i._t2)/2|0)/o+"/"+(o*(n._t1+n._t2)/2|0)/o];let c=i.split(.5),l=n.split(.5),u=[{left:c.left,right:l.left},{left:c.left,right:l.right},{left:c.right,right:l.right},{left:c.right,right:l.left}];u=u.filter(function(h){return D.bboxoverlap(h.left.bbox(),h.right.bbox())});let d=[];return u.length===0||(u.forEach(function(h){d=d.concat(D.pairiteration(h.left,h.right,a))}),d=d.filter(function(h,f){return d.indexOf(h)===f})),d},getccenter:function(i,n,e){const r=n.x-i.x,s=n.y-i.y,o=e.x-n.x,a=e.y-n.y,c=r*te(ae)-s*Ce(ae),l=r*Ce(ae)+s*te(ae),u=o*te(ae)-a*Ce(ae),d=o*Ce(ae)+a*te(ae),h=(i.x+n.x)/2,f=(i.y+n.y)/2,p=(n.x+e.x)/2,g=(n.y+e.y)/2,y=h+c,m=f+l,v=p+u,w=g+d,x=D.lli8(h,f,y,m,p,g,v,w),T=D.dist(x,i);let S=He(i.y-x.y,i.x-x.x),I=He(n.y-x.y,n.x-x.x),E=He(e.y-x.y,e.x-x.x),b;return S<E?((S>I||I>E)&&(S+=ut),S>E&&(b=E,E=S,S=b)):E<I&&I<S?(b=E,E=S,S=b):E+=ut,x.s=S,x.e=E,x.r=T,x},numberSort:function(i,n){return i-n}};class Ue{constructor(n){this.curves=[],this._3d=!1,n&&(this.curves=n,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(n){return D.pointsToString(n.points)}).join(", ")+"]"}addCurve(n){this.curves.push(n),this._3d=this._3d||n._3d}length(){return this.curves.map(function(n){return n.length()}).reduce(function(n,e){return n+e})}curve(n){return this.curves[n]}bbox(){const n=this.curves;for(var e=n[0].bbox(),r=1;r<n.length;r++)D.expandbox(e,n[r].bbox());return e}offset(n){const e=[];return this.curves.forEach(function(r){e.push(...r.offset(n))}),new Ue(e)}}const{abs:$e,min:wn,max:Pn,cos:io,sin:oo,acos:ro,sqrt:Ne}=Math,so=Math.PI;class F{constructor(n){let e=n&&n.forEach?n:Array.from(arguments).slice(),r=!1;if(typeof e[0]=="object"){r=e.length;const p=[];e.forEach(function(g){["x","y","z"].forEach(function(y){typeof g[y]<"u"&&p.push(g[y])})}),e=p}let s=!1;const o=e.length;if(r){if(r>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");s=!0}}else if(o!==6&&o!==8&&o!==9&&o!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const a=this._3d=!s&&(o===9||o===12)||n&&n[0]&&typeof n[0].z<"u",c=this.points=[];for(let p=0,g=a?3:2;p<o;p+=g){var l={x:e[p],y:e[p+1]};a&&(l.z=e[p+2]),c.push(l)}const u=this.order=c.length-1,d=this.dims=["x","y"];a&&d.push("z"),this.dimlen=d.length;const h=D.align(c,{p1:c[0],p2:c[u]}),f=D.dist(c[0],c[u]);this._linear=h.reduce((p,g)=>p+$e(g.y),0)<f/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(n,e,r,s){if(typeof s>"u"&&(s=.5),s===0)return new F(e,e,r);if(s===1)return new F(n,e,e);const o=F.getABC(2,n,e,r,s);return new F(n,o.A,r)}static cubicFromPoints(n,e,r,s,o){typeof s>"u"&&(s=.5);const a=F.getABC(3,n,e,r,s);typeof o>"u"&&(o=D.dist(e,a.C));const c=o*(1-s)/s,l=D.dist(n,r),u=(r.x-n.x)/l,d=(r.y-n.y)/l,h=o*u,f=o*d,p=c*u,g=c*d,y={x:e.x-h,y:e.y-f},m={x:e.x+p,y:e.y+g},v=a.A,w={x:v.x+(y.x-v.x)/(1-s),y:v.y+(y.y-v.y)/(1-s)},x={x:v.x+(m.x-v.x)/s,y:v.y+(m.y-v.y)/s},T={x:n.x+(w.x-n.x)/s,y:n.y+(w.y-n.y)/s},S={x:r.x+(x.x-r.x)/(1-s),y:r.y+(x.y-r.y)/(1-s)};return new F(n,T,S,r)}static getUtils(){return D}getUtils(){return F.getUtils()}static get PolyBezier(){return Ue}valueOf(){return this.toString()}toString(){return D.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const n=this.points,e=n[0].x,r=n[0].y,s=["M",e,r,this.order===2?"Q":"C"];for(let o=1,a=n.length;o<a;o++)s.push(n[o].x),s.push(n[o].y);return s.join(" ")}setRatios(n){if(n.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=n,this._lut=[]}verify(){const n=this.coordDigest();n!==this._print&&(this._print=n,this.update())}coordDigest(){return this.points.map(function(n,e){return""+e+n.x+n.y+(n.z?n.z:0)}).join("")}update(){this._lut=[],this.dpoints=D.derive(this.points,this._3d),this.computedirection()}computedirection(){const n=this.points,e=D.angle(n[0],n[this.order],n[1]);this.clockwise=e>0}length(){return D.length(this.derivative.bind(this))}static getABC(n=2,e,r,s,o=.5){const a=D.projectionratio(o,n),c=1-a,l={x:a*e.x+c*s.x,y:a*e.y+c*s.y},u=D.abcratio(o,n);return{A:{x:r.x+(r.x-l.x)/u,y:r.y+(r.y-l.y)/u},B:r,C:l,S:e,E:s}}getABC(n,e){e=e||this.get(n);let r=this.points[0],s=this.points[this.order];return F.getABC(this.order,r,e,s,n)}getLUT(n){if(this.verify(),n=n||100,this._lut.length===n+1)return this._lut;this._lut=[],n++,this._lut=[];for(let e=0,r,s;e<n;e++)s=e/(n-1),r=this.compute(s),r.t=s,this._lut.push(r);return this._lut}on(n,e){e=e||5;const r=this.getLUT(),s=[];for(let o=0,a,c=0;o<r.length;o++)a=r[o],D.dist(a,n)<e&&(s.push(a),c+=o/r.length);return s.length?t/=s.length:!1}project(n){const e=this.getLUT(),r=e.length-1,s=D.closest(e,n),o=s.mpos,a=(o-1)/r,c=(o+1)/r,l=.1/r;let u=s.mdist,d=a,h=d,f;u+=1;for(let p;d<c+l;d+=l)f=this.compute(d),p=D.dist(n,f),p<u&&(u=p,h=d);return h=h<0?0:h>1?1:h,f=this.compute(h),f.t=h,f.d=u,f}get(n){return this.compute(n)}point(n){return this.points[n]}compute(n){return this.ratios?D.computeWithRatios(n,this.points,this.ratios,this._3d):D.compute(n,this.points,this._3d,this.ratios)}raise(){const n=this.points,e=[n[0]],r=n.length;for(let s=1,o,a;s<r;s++)o=n[s],a=n[s-1],e[s]={x:(r-s)/r*o.x+s/r*a.x,y:(r-s)/r*o.y+s/r*a.y};return e[r]=n[r-1],new F(e)}derivative(n){return D.compute(n,this.dpoints[0],this._3d)}dderivative(n){return D.compute(n,this.dpoints[1],this._3d)}align(){let n=this.points;return new F(D.align(n,{p1:n[0],p2:n[n.length-1]}))}curvature(n){return D.curvature(n,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return D.inflections(this.points)}normal(n){return this._3d?this.__normal3(n):this.__normal2(n)}__normal2(n){const e=this.derivative(n),r=Ne(e.x*e.x+e.y*e.y);return{t:n,x:-e.y/r,y:e.x/r}}__normal3(n){const e=this.derivative(n),r=this.derivative(n+.01),s=Ne(e.x*e.x+e.y*e.y+e.z*e.z),o=Ne(r.x*r.x+r.y*r.y+r.z*r.z);e.x/=s,e.y/=s,e.z/=s,r.x/=o,r.y/=o,r.z/=o;const a={x:r.y*e.z-r.z*e.y,y:r.z*e.x-r.x*e.z,z:r.x*e.y-r.y*e.x},c=Ne(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=c,a.y/=c,a.z/=c;const l=[a.x*a.x,a.x*a.y-a.z,a.x*a.z+a.y,a.x*a.y+a.z,a.y*a.y,a.y*a.z-a.x,a.x*a.z-a.y,a.y*a.z+a.x,a.z*a.z];return{t:n,x:l[0]*e.x+l[1]*e.y+l[2]*e.z,y:l[3]*e.x+l[4]*e.y+l[5]*e.z,z:l[6]*e.x+l[7]*e.y+l[8]*e.z}}hull(n){let e=this.points,r=[],s=[],o=0;for(s[o++]=e[0],s[o++]=e[1],s[o++]=e[2],this.order===3&&(s[o++]=e[3]);e.length>1;){r=[];for(let a=0,c,l=e.length-1;a<l;a++)c=D.lerp(n,e[a],e[a+1]),s[o++]=c,r.push(c);e=r}return s}split(n,e){if(n===0&&e)return this.split(e).left;if(e===1)return this.split(n).right;const r=this.hull(n),s={left:this.order===2?new F([r[0],r[3],r[5]]):new F([r[0],r[4],r[7],r[9]]),right:this.order===2?new F([r[5],r[4],r[2]]):new F([r[9],r[8],r[6],r[3]]),span:r};return s.left._t1=D.map(0,0,1,this._t1,this._t2),s.left._t2=D.map(n,0,1,this._t1,this._t2),s.right._t1=D.map(n,0,1,this._t1,this._t2),s.right._t2=D.map(1,0,1,this._t1,this._t2),e?(e=D.map(e,n,1,0,1),s.right.split(e).left):s}extrema(){const n={};let e=[];return this.dims.forEach((function(r){let s=function(a){return a[r]},o=this.dpoints[0].map(s);n[r]=D.droots(o),this.order===3&&(o=this.dpoints[1].map(s),n[r]=n[r].concat(D.droots(o))),n[r]=n[r].filter(function(a){return a>=0&&a<=1}),e=e.concat(n[r].sort(D.numberSort))}).bind(this)),n.values=e.sort(D.numberSort).filter(function(r,s){return e.indexOf(r)===s}),n}bbox(){const n=this.extrema(),e={};return this.dims.forEach((function(r){e[r]=D.getminmax(this,r,n[r])}).bind(this)),e}overlaps(n){const e=this.bbox(),r=n.bbox();return D.bboxoverlap(e,r)}offset(n,e){if(typeof e<"u"){const r=this.get(n),s=this.normal(n),o={c:r,n:s,x:r.x+s.x*e,y:r.y+s.y*e};return this._3d&&(o.z=r.z+s.z*e),o}if(this._linear){const r=this.normal(0),s=this.points.map(function(o){const a={x:o.x+n*r.x,y:o.y+n*r.y};return o.z&&r.z&&(a.z=o.z+n*r.z),a});return[new F(s)]}return this.reduce().map(function(r){return r._linear?r.offset(n)[0]:r.scale(n)})}simple(){if(this.order===3){const s=D.angle(this.points[0],this.points[3],this.points[1]),o=D.angle(this.points[0],this.points[3],this.points[2]);if(s>0&&o<0||s<0&&o>0)return!1}const n=this.normal(0),e=this.normal(1);let r=n.x*e.x+n.y*e.y;return this._3d&&(r+=n.z*e.z),$e(ro(r))<so/3}reduce(){let n,e=0,r=0,s=.01,o,a=[],c=[],l=this.extrema().values;for(l.indexOf(0)===-1&&(l=[0].concat(l)),l.indexOf(1)===-1&&l.push(1),e=l[0],n=1;n<l.length;n++)r=l[n],o=this.split(e,r),o._t1=e,o._t2=r,a.push(o),e=r;return a.forEach(function(u){for(e=0,r=0;r<=1;)for(r=e+s;r<=1+s;r+=s)if(o=u.split(e,r),!o.simple()){if(r-=s,$e(e-r)<s)return[];o=u.split(e,r),o._t1=D.map(e,0,1,u._t1,u._t2),o._t2=D.map(r,0,1,u._t1,u._t2),c.push(o),e=r;break}e<1&&(o=u.split(e,1),o._t1=D.map(e,0,1,u._t1,u._t2),o._t2=u._t2,c.push(o))}),c}translate(n,e,r){r=typeof r=="number"?r:e;const s=this.order;let o=this.points.map((a,c)=>(1-c/s)*e+c/s*r);return new F(this.points.map((a,c)=>({x:a.x+n.x*o[c],y:a.y+n.y*o[c]})))}scale(n){const e=this.order;let r=!1;if(typeof n=="function"&&(r=n),r&&e===2)return this.raise().scale(r);const s=this.clockwise,o=this.points;if(this._linear)return this.translate(this.normal(0),r?r(0):n,r?r(1):n);const a=r?r(0):n,c=r?r(1):n,l=[this.offset(0,10),this.offset(1,10)],u=[],d=D.lli4(l[0],l[0].c,l[1],l[1].c);if(!d)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(h){const f=u[h*e]=D.copy(o[h*e]);f.x+=(h?c:a)*l[h].n.x,f.y+=(h?c:a)*l[h].n.y}),r?([0,1].forEach(function(h){if(!(e===2&&h)){var f=o[h+1],p={x:f.x-d.x,y:f.y-d.y},g=r?r((h+1)/e):n;r&&!s&&(g=-g);var y=Ne(p.x*p.x+p.y*p.y);p.x/=y,p.y/=y,u[h+1]={x:f.x+g*p.x,y:f.y+g*p.y}}}),new F(u)):([0,1].forEach(h=>{if(e===2&&h)return;const f=u[h*e],p=this.derivative(h),g={x:f.x+p.x,y:f.y+p.y};u[h+1]=D.lli4(f,g,d,o[h+1])}),new F(u))}outline(n,e,r,s){if(e=e===void 0?n:e,this._linear){const S=this.normal(0),I=this.points[0],E=this.points[this.points.length-1];let b,C,M;r===void 0&&(r=n,s=e),b={x:I.x+S.x*n,y:I.y+S.y*n},M={x:E.x+S.x*r,y:E.y+S.y*r},C={x:(b.x+M.x)/2,y:(b.y+M.y)/2};const z=[b,C,M];b={x:I.x-S.x*e,y:I.y-S.y*e},M={x:E.x-S.x*s,y:E.y-S.y*s},C={x:(b.x+M.x)/2,y:(b.y+M.y)/2};const k=[M,C,b],_=D.makeline(k[2],z[0]),A=D.makeline(z[2],k[0]),L=[_,new F(z),A,new F(k)];return new Ue(L)}const o=this.reduce(),a=o.length,c=[];let l=[],u,d=0,h=this.length();const f=typeof r<"u"&&typeof s<"u";function p(S,I,E,b,C){return function(M){const z=b/E,k=(b+C)/E,_=I-S;return D.map(M,0,1,S+z*_,S+k*_)}}o.forEach(function(S){const I=S.length();f?(c.push(S.scale(p(n,r,h,d,I))),l.push(S.scale(p(-e,-s,h,d,I)))):(c.push(S.scale(n)),l.push(S.scale(-e))),d+=I}),l=l.map(function(S){return u=S.points,u[3]?S.points=[u[3],u[2],u[1],u[0]]:S.points=[u[2],u[1],u[0]],S}).reverse();const g=c[0].points[0],y=c[a-1].points[c[a-1].points.length-1],m=l[a-1].points[l[a-1].points.length-1],v=l[0].points[0],w=D.makeline(m,g),x=D.makeline(y,v),T=[w].concat(c).concat([x]).concat(l);return new Ue(T)}outlineshapes(n,e,r){e=e||n;const s=this.outline(n,e).curves,o=[];for(let a=1,c=s.length;a<c/2;a++){const l=D.makeshape(s[a],s[c-a],r);l.startcap.virtual=a>1,l.endcap.virtual=a<c/2-1,o.push(l)}return o}intersects(n,e){return n?n.p1&&n.p2?this.lineIntersects(n):(n instanceof F&&(n=n.reduce()),this.curveintersects(this.reduce(),n,e)):this.selfintersects(e)}lineIntersects(n){const e=wn(n.p1.x,n.p2.x),r=wn(n.p1.y,n.p2.y),s=Pn(n.p1.x,n.p2.x),o=Pn(n.p1.y,n.p2.y);return D.roots(this.points,n).filter(a=>{var c=this.get(a);return D.between(c.x,e,s)&&D.between(c.y,r,o)})}selfintersects(n){const e=this.reduce(),r=e.length-2,s=[];for(let o=0,a,c,l;o<r;o++)c=e.slice(o,o+1),l=e.slice(o+2),a=this.curveintersects(c,l,n),s.push(...a);return s}curveintersects(n,e,r){const s=[];n.forEach(function(a){e.forEach(function(c){a.overlaps(c)&&s.push({left:a,right:c})})});let o=[];return s.forEach(function(a){const c=D.pairiteration(a.left,a.right,r);c.length>0&&(o=o.concat(c))}),o}arcs(n){return n=n||.5,this._iterate(n,[])}_error(n,e,r,s){const o=(s-r)/4,a=this.get(r+o),c=this.get(s-o),l=D.dist(n,e),u=D.dist(n,a),d=D.dist(n,c);return $e(u-l)+$e(d-l)}_iterate(n,e){let r=0,s=1,o;do{o=0,s=1;let a=this.get(r),c,l,u,d,h=!1,f=!1,p,g=s,y=1;do if(f=h,d=u,g=(r+s)/2,c=this.get(g),l=this.get(s),u=D.getccenter(a,c,l),u.interval={start:r,end:s},h=this._error(u,a,r,s)<=n,p=f&&!h,p||(y=s),h){if(s>=1){if(u.interval.end=y=1,d=u,s>1){let v={x:u.x+u.r*io(u.e),y:u.y+u.r*oo(u.e)};u.e+=D.angle({x:u.x,y:u.y},v,this.get(1))}break}s=s+(s-r)/2}else s=g;while(!p&&o++<100);if(o>=100)break;d=d||u,e.push(d),r=y}while(s<1);return e}}var ao=(function(){function i(n,e){var r=[],s=!0,o=!1,a=void 0;try{for(var c=n[Symbol.iterator](),l;!(s=(l=c.next()).done)&&(r.push(l.value),!(e&&r.length===e));s=!0);}catch(u){o=!0,a=u}finally{try{!s&&c.return&&c.return()}finally{if(o)throw a}}return r}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return i(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}})(),Ge=Math.PI*2,Rt=function(n,e,r,s,o,a,c){var l=n.x,u=n.y;l*=e,u*=r;var d=s*l-o*u,h=o*l+s*u;return{x:d+a,y:h+c}},co=function(n,e){var r=e===1.5707963267948966?.551915024494:e===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(e/4),s=Math.cos(n),o=Math.sin(n),a=Math.cos(n+e),c=Math.sin(n+e);return[{x:s-o*r,y:o+s*r},{x:a+c*r,y:c-a*r},{x:a,y:c}]},xn=function(n,e,r,s){var o=n*s-e*r<0?-1:1,a=n*r+e*s;return a>1&&(a=1),a<-1&&(a=-1),o*Math.acos(a)},lo=function(n,e,r,s,o,a,c,l,u,d,h,f){var p=Math.pow(o,2),g=Math.pow(a,2),y=Math.pow(h,2),m=Math.pow(f,2),v=p*g-p*m-g*y;v<0&&(v=0),v/=p*m+g*y,v=Math.sqrt(v)*(c===l?-1:1);var w=v*o/a*f,x=v*-a/o*h,T=d*w-u*x+(n+r)/2,S=u*w+d*x+(e+s)/2,I=(h-w)/o,E=(f-x)/a,b=(-h-w)/o,C=(-f-x)/a,M=xn(1,0,I,E),z=xn(I,E,b,C);return l===0&&z>0&&(z-=Ge),l===1&&z<0&&(z+=Ge),[T,S,M,z]},uo=function(n){var e=n.px,r=n.py,s=n.cx,o=n.cy,a=n.rx,c=n.ry,l=n.xAxisRotation,u=l===void 0?0:l,d=n.largeArcFlag,h=d===void 0?0:d,f=n.sweepFlag,p=f===void 0?0:f,g=[];if(a===0||c===0)return[];var y=Math.sin(u*Ge/360),m=Math.cos(u*Ge/360),v=m*(e-s)/2+y*(r-o)/2,w=-y*(e-s)/2+m*(r-o)/2;if(v===0&&w===0)return[];a=Math.abs(a),c=Math.abs(c);var x=Math.pow(v,2)/Math.pow(a,2)+Math.pow(w,2)/Math.pow(c,2);x>1&&(a*=Math.sqrt(x),c*=Math.sqrt(x));var T=lo(e,r,s,o,a,c,h,p,y,m,v,w),S=ao(T,4),I=S[0],E=S[1],b=S[2],C=S[3],M=Math.abs(C)/(Ge/4);Math.abs(1-M)<1e-7&&(M=1);var z=Math.max(Math.ceil(M),1);C/=z;for(var k=0;k<z;k++)g.push(co(b,C)),b+=C;return g.map(function(_){var A=Rt(_[0],a,c,m,y,I,E),L=A.x,R=A.y,H=Rt(_[1],a,c,m,y,I,E),$=H.x,O=H.y,N=Rt(_[2],a,c,m,y,I,E),U=N.x,V=N.y;return{x1:L,y1:R,x2:$,y2:O,x:U,y:V}})};function ho(i,n){return i>n?1:i<n?-1:0}class an{constructor(n=ho,e=!1){this._compare=n,this._root=null,this._size=0,this._noDuplicates=!!e}rotateLeft(n){var e=n.right;e&&(n.right=e.left,e.left&&(e.left.parent=n),e.parent=n.parent),n.parent?n===n.parent.left?n.parent.left=e:n.parent.right=e:this._root=e,e&&(e.left=n),n.parent=e}rotateRight(n){var e=n.left;e&&(n.left=e.right,e.right&&(e.right.parent=n),e.parent=n.parent),n.parent?n===n.parent.left?n.parent.left=e:n.parent.right=e:this._root=e,e&&(e.right=n),n.parent=e}_splay(n){for(;n.parent;){var e=n.parent;e.parent?e.left===n&&e.parent.left===e?(this.rotateRight(e.parent),this.rotateRight(e)):e.right===n&&e.parent.right===e?(this.rotateLeft(e.parent),this.rotateLeft(e)):e.left===n&&e.parent.right===e?(this.rotateRight(e),this.rotateLeft(e)):(this.rotateLeft(e),this.rotateRight(e)):e.left===n?this.rotateRight(e):this.rotateLeft(e)}}splay(n){for(var e,r,s,o,a;n.parent;)e=n.parent,r=e.parent,r&&r.parent?(s=r.parent,s.left===r?s.left=n:s.right=n,n.parent=s):(n.parent=null,this._root=n),o=n.left,a=n.right,n===e.left?(r&&(r.left===e?(e.right?(r.left=e.right,r.left.parent=r):r.left=null,e.right=r,r.parent=e):(o?(r.right=o,o.parent=r):r.right=null,n.left=r,r.parent=n)),a?(e.left=a,a.parent=e):e.left=null,n.right=e,e.parent=n):(r&&(r.right===e?(e.left?(r.right=e.left,r.right.parent=r):r.right=null,e.left=r,r.parent=e):(a?(r.left=a,a.parent=r):r.left=null,n.right=r,r.parent=n)),o?(e.right=o,o.parent=e):e.right=null,n.left=e,e.parent=n)}replace(n,e){n.parent?n===n.parent.left?n.parent.left=e:n.parent.right=e:this._root=e,e&&(e.parent=n.parent)}minNode(n=this._root){if(n)for(;n.left;)n=n.left;return n}maxNode(n=this._root){if(n)for(;n.right;)n=n.right;return n}insert(n,e){var r=this._root,s=null,o=this._compare,a;if(this._noDuplicates)for(;r;){if(s=r,a=o(r.key,n),a===0)return;o(r.key,n)<0?r=r.right:r=r.left}else for(;r;)s=r,o(r.key,n)<0?r=r.right:r=r.left;return r={key:n,data:e,left:null,right:null,parent:s},s?o(s.key,r.key)<0?s.right=r:s.left=r:this._root=r,this.splay(r),this._size++,r}find(n){for(var e=this._root,r=this._compare;e;){var s=r(e.key,n);if(s<0)e=e.right;else if(s>0)e=e.left;else return e}return null}contains(n){for(var e=this._root,r=this._compare;e;){var s=r(n,e.key);if(s===0)return!0;s<0?e=e.left:e=e.right}return!1}remove(n){var e=this.find(n);if(!e)return!1;if(this.splay(e),!e.left)this.replace(e,e.right);else if(!e.right)this.replace(e,e.left);else{var r=this.minNode(e.right);r.parent!==e&&(this.replace(r,r.right),r.right=e.right,r.right.parent=r),this.replace(e,r),r.left=e.left,r.left.parent=r}return this._size--,!0}removeNode(n){if(!n)return!1;if(this.splay(n),!n.left)this.replace(n,n.right);else if(!n.right)this.replace(n,n.left);else{var e=this.minNode(n.right);e.parent!==n&&(this.replace(e,e.right),e.right=n.right,e.right.parent=e),this.replace(n,e),e.left=n.left,e.left.parent=e}return this._size--,!0}erase(n){var e=this.find(n);if(e){this.splay(e);var r=e.left,s=e.right,o=null;r&&(r.parent=null,o=this.maxNode(r),this.splay(o),this._root=o),s&&(r?o.right=s:this._root=s,s.parent=o),this._size--}}pop(){var n=this._root,e=null;if(n){for(;n.left;)n=n.left;e={key:n.key,data:n.data},this.remove(n.key)}return e}next(n){var e=n;if(e)if(e.right)for(e=e.right;e&&e.left;)e=e.left;else for(e=n.parent;e&&e.right===n;)n=e,e=e.parent;return e}prev(n){var e=n;if(e)if(e.left)for(e=e.left;e&&e.right;)e=e.right;else for(e=n.parent;e&&e.left===n;)n=e,e=e.parent;return e}forEach(n){for(var e=this._root,r=[],s=!1,o=0;!s;)e?(r.push(e),e=e.left):r.length>0?(e=r.pop(),n(e,o++),e=e.right):s=!0;return this}range(n,e,r,s){const o=[],a=this._compare;let c=this._root,l;for(;o.length!==0||c;)if(c)o.push(c),c=c.left;else{if(c=o.pop(),l=a(c.key,e),l>0)break;if(a(c.key,n)>=0&&r.call(s,c))return this;c=c.right}return this}keys(){for(var n=this._root,e=[],r=[],s=!1;!s;)n?(e.push(n),n=n.left):e.length>0?(n=e.pop(),r.push(n.key),n=n.right):s=!0;return r}values(){for(var n=this._root,e=[],r=[],s=!1;!s;)n?(e.push(n),n=n.left):e.length>0?(n=e.pop(),r.push(n.data),n=n.right):s=!0;return r}at(n){for(var e=this._root,r=[],s=!1,o=0;!s;)if(e)r.push(e),e=e.left;else if(r.length>0){if(e=r.pop(),o===n)return e;o++,e=e.right}else s=!0;return null}load(n=[],e=[],r=!1){if(this._size!==0)throw new Error("bulk-load: tree is not empty");const s=n.length;return r&&en(n,e,0,s-1,this._compare),this._root=Jt(null,n,e,0,s),this._size=s,this}min(){var n=this.minNode(this._root);return n?n.key:null}max(){var n=this.maxNode(this._root);return n?n.key:null}isEmpty(){return this._root===null}get size(){return this._size}static createTree(n,e,r,s,o){return new an(r,o).load(n,e,s)}}function Jt(i,n,e,r,s){const o=s-r;if(o>0){const a=r+Math.floor(o/2),c=n[a],l=e[a],u={key:c,data:l,parent:i};return u.left=Jt(u,n,e,r,a),u.right=Jt(u,n,e,a+1,s),u}return null}function en(i,n,e,r,s){if(e>=r)return;const o=i[e+r>>1];let a=e-1,c=r+1;for(;;){do a++;while(s(i[a],o)<0);do c--;while(s(i[c],o)>0);if(a>=c)break;let l=i[a];i[a]=i[c],i[c]=l,l=n[a],n[a]=n[c],n[c]=l}en(i,n,e,c,s),en(i,n,c+1,r,s)}const ii=0,oi=1,ri=2,si=3,be=0,_e=1,ue=2,Et=3;function Fe(i,n,e){n===null?(i.inOut=!1,i.otherInOut=!0):(i.isSubject===n.isSubject?(i.inOut=!n.inOut,i.otherInOut=n.otherInOut):(i.inOut=!n.otherInOut,i.otherInOut=n.isVertical()?!n.inOut:n.inOut),n&&(i.prevInResult=!bn(n,e)||n.isVertical()?n.prevInResult:n)),bn(i,e)?i.resultTransition=fo(i,e):i.resultTransition=0}function bn(i,n){switch(i.type){case ii:switch(n){case be:return!i.otherInOut;case _e:return i.otherInOut;case ue:return i.isSubject&&i.otherInOut||!i.isSubject&&!i.otherInOut;case Et:return!0}break;case ri:return n===be||n===_e;case si:return n===ue;case oi:return!1}return!1}function fo(i,n){let e=!i.inOut,r=!i.otherInOut,s;switch(n){case be:s=e&&r;break;case _e:s=e||r;break;case Et:s=e^r;break;case ue:i.isSubject?s=e&&!r:s=r&&!e;break}return s?1:-1}class De{constructor(n,e,r,s,o){this.left=e,this.point=n,this.otherEvent=r,this.isSubject=s,this.type=o||ii,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0}isBelow(n){const e=this.point,r=this.otherEvent.point;return this.left?(e[0]-n[0])*(r[1]-n[1])-(r[0]-n[0])*(e[1]-n[1])>0:(r[0]-n[0])*(e[1]-n[1])-(e[0]-n[0])*(r[1]-n[1])>0}isAbove(n){return!this.isBelow(n)}isVertical(){return this.point[0]===this.otherEvent.point[0]}get inResult(){return this.resultTransition!==0}clone(){const n=new De(this.point,this.left,this.otherEvent,this.isSubject,this.type);return n.contourId=this.contourId,n.resultTransition=this.resultTransition,n.prevInResult=this.prevInResult,n.isExteriorRing=this.isExteriorRing,n.inOut=this.inOut,n.otherInOut=this.otherInOut,n}}function J(i,n){return i[0]===n[0]?i[1]===n[1]:!1}const ne=11102230246251565e-32,j=134217729,po=(3+8*ne)*ne;function Ht(i,n,e,r,s){let o,a,c,l,u=n[0],d=r[0],h=0,f=0;d>u==d>-u?(o=u,u=n[++h]):(o=d,d=r[++f]);let p=0;if(h<i&&f<e)for(d>u==d>-u?(a=u+o,c=o-(a-u),u=n[++h]):(a=d+o,c=o-(a-d),d=r[++f]),o=a,c!==0&&(s[p++]=c);h<i&&f<e;)d>u==d>-u?(a=o+u,l=a-o,c=o-(a-l)+(u-l),u=n[++h]):(a=o+d,l=a-o,c=o-(a-l)+(d-l),d=r[++f]),o=a,c!==0&&(s[p++]=c);for(;h<i;)a=o+u,l=a-o,c=o-(a-l)+(u-l),u=n[++h],o=a,c!==0&&(s[p++]=c);for(;f<e;)a=o+d,l=a-o,c=o-(a-l)+(d-l),d=r[++f],o=a,c!==0&&(s[p++]=c);return(o!==0||p===0)&&(s[p++]=o),p}function mo(i,n){let e=n[0];for(let r=1;r<i;r++)e+=n[r];return e}function st(i){return new Float64Array(i)}const go=(3+16*ne)*ne,yo=(2+12*ne)*ne,vo=(9+64*ne)*ne*ne,Ie=st(4),Cn=st(8),In=st(12),Sn=st(16),q=st(4);function wo(i,n,e,r,s,o,a){let c,l,u,d,h,f,p,g,y,m,v,w,x,T,S,I,E,b;const C=i-s,M=e-s,z=n-o,k=r-o;T=C*k,f=j*C,p=f-(f-C),g=C-p,f=j*k,y=f-(f-k),m=k-y,S=g*m-(T-p*y-g*y-p*m),I=z*M,f=j*z,p=f-(f-z),g=z-p,f=j*M,y=f-(f-M),m=M-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,Ie[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,Ie[1]=x-(v+h)+(h-I),b=w+v,h=b-w,Ie[2]=w-(b-h)+(v-h),Ie[3]=b;let _=mo(4,Ie),A=yo*a;if(_>=A||-_>=A||(h=i-C,c=i-(C+h)+(h-s),h=e-M,u=e-(M+h)+(h-s),h=n-z,l=n-(z+h)+(h-o),h=r-k,d=r-(k+h)+(h-o),c===0&&l===0&&u===0&&d===0)||(A=vo*a+po*Math.abs(_),_+=C*d+k*c-(z*u+M*l),_>=A||-_>=A))return _;T=c*k,f=j*c,p=f-(f-c),g=c-p,f=j*k,y=f-(f-k),m=k-y,S=g*m-(T-p*y-g*y-p*m),I=l*M,f=j*l,p=f-(f-l),g=l-p,f=j*M,y=f-(f-M),m=M-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,q[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,q[1]=x-(v+h)+(h-I),b=w+v,h=b-w,q[2]=w-(b-h)+(v-h),q[3]=b;const L=Ht(4,Ie,4,q,Cn);T=C*d,f=j*C,p=f-(f-C),g=C-p,f=j*d,y=f-(f-d),m=d-y,S=g*m-(T-p*y-g*y-p*m),I=z*u,f=j*z,p=f-(f-z),g=z-p,f=j*u,y=f-(f-u),m=u-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,q[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,q[1]=x-(v+h)+(h-I),b=w+v,h=b-w,q[2]=w-(b-h)+(v-h),q[3]=b;const R=Ht(L,Cn,4,q,In);T=c*d,f=j*c,p=f-(f-c),g=c-p,f=j*d,y=f-(f-d),m=d-y,S=g*m-(T-p*y-g*y-p*m),I=l*u,f=j*l,p=f-(f-l),g=l-p,f=j*u,y=f-(f-u),m=u-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,q[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,q[1]=x-(v+h)+(h-I),b=w+v,h=b-w,q[2]=w-(b-h)+(v-h),q[3]=b;const H=Ht(R,In,4,q,Sn);return Sn[H-1]}function Po(i,n,e,r,s,o){const a=(n-o)*(e-s),c=(i-s)*(r-o),l=a-c;if(a===0||c===0||a>0!=c>0)return l;const u=Math.abs(a+c);return Math.abs(l)>=go*u?l:-wo(i,n,e,r,s,o,u)}function tn(i,n,e){const r=Po(i[0],i[1],n[0],n[1],e[0],e[1]);return r>0?-1:r<0?1:0}function he(i,n){const e=i.point,r=n.point;return e[0]>r[0]?1:e[0]<r[0]?-1:e[1]!==r[1]?e[1]>r[1]?1:-1:xo(i,n,e)}function xo(i,n,e,r){return i.left!==n.left?i.left?1:-1:tn(e,i.otherEvent.point,n.otherEvent.point)!==0?i.isBelow(n.otherEvent.point)?-1:1:!i.isSubject&&n.isSubject?1:-1}function ce(i,n,e){const r=new De(n,!1,i,i.isSubject),s=new De(n,!0,i.otherEvent,i.isSubject);return J(i.point,i.otherEvent.point)&&console.warn("what is that, a collapsed segment?",i),r.contourId=s.contourId=i.contourId,he(s,i.otherEvent)>0&&(i.otherEvent.left=!0,s.left=!1),i.otherEvent.otherEvent=s,i.otherEvent=r,e.push(s),e.push(r),e}function ht(i,n){return i[0]*n[1]-i[1]*n[0]}function Ot(i,n){return i[0]*n[0]+i[1]*n[1]}function bo(i,n,e,r,s){const o=[n[0]-i[0],n[1]-i[1]],a=[r[0]-e[0],r[1]-e[1]];function c(m,v,w){return[m[0]+v*w[0],m[1]+v*w[1]]}const l=[e[0]-i[0],e[1]-i[1]];let u=ht(o,a),d=u*u;const h=Ot(o,o);if(d>0){const m=ht(l,a)/u;if(m<0||m>1)return null;const v=ht(l,o)/u;return v<0||v>1?null:m===0||m===1?[c(i,m,o)]:v===0||v===1?[c(e,v,a)]:[c(i,m,o)]}if(u=ht(l,o),d=u*u,d>0)return null;const f=Ot(o,l)/h,p=f+Ot(o,a)/h,g=Math.min(f,p),y=Math.max(f,p);return g<=1&&y>=0?g===1?[c(i,g>0?g:0,o)]:y===0?[c(i,y<1?y:1,o)]:[c(i,g>0?g:0,o),c(i,y<1?y:1,o)]:null}function $t(i,n,e){const r=bo(i.point,i.otherEvent.point,n.point,n.otherEvent.point),s=r?r.length:0;if(s===0||s===1&&(J(i.point,n.point)||J(i.otherEvent.point,n.otherEvent.point))||s===2&&i.isSubject===n.isSubject)return 0;if(s===1)return!J(i.point,r[0])&&!J(i.otherEvent.point,r[0])&&ce(i,r[0],e),!J(n.point,r[0])&&!J(n.otherEvent.point,r[0])&&ce(n,r[0],e),1;const o=[];let a=!1,c=!1;return J(i.point,n.point)?a=!0:he(i,n)===1?o.push(n,i):o.push(i,n),J(i.otherEvent.point,n.otherEvent.point)?c=!0:he(i.otherEvent,n.otherEvent)===1?o.push(n.otherEvent,i.otherEvent):o.push(i.otherEvent,n.otherEvent),a&&c||a?(n.type=oi,i.type=n.inOut===i.inOut?ri:si,a&&!c&&ce(o[1].otherEvent,o[0].point,e),2):c?(ce(o[0],o[1].point,e),3):o[0]!==o[3].otherEvent?(ce(o[0],o[1].point,e),ce(o[1],o[2].point,e),3):(ce(o[0],o[1].point,e),ce(o[3].otherEvent,o[2].point,e),3)}function Co(i,n){if(i===n)return 0;if(tn(i.point,i.otherEvent.point,n.point)!==0||tn(i.point,i.otherEvent.point,n.otherEvent.point)!==0)return J(i.point,n.point)?i.isBelow(n.otherEvent.point)?-1:1:i.point[0]===n.point[0]?i.point[1]<n.point[1]?-1:1:he(i,n)===1?n.isAbove(i.point)?-1:1:i.isBelow(n.point)?-1:1;if(i.isSubject===n.isSubject){let e=i.point,r=n.point;if(e[0]===r[0]&&e[1]===r[1])return e=i.otherEvent.point,r=n.otherEvent.point,e[0]===r[0]&&e[1]===r[1]?0:i.contourId>n.contourId?1:-1}else return i.isSubject?-1:1;return he(i,n)===1?1:-1}function Io(i,n,e,r,s,o){const a=new an(Co),c=[],l=Math.min(r[2],s[2]);let u,d,h;for(;i.length!==0;){let f=i.pop();if(c.push(f),o===be&&f.point[0]>l||o===ue&&f.point[0]>r[2])break;if(f.left){d=u=a.insert(f),h=a.minNode(),u!==h?u=a.prev(u):u=null,d=a.next(d);const p=u?u.key:null;let g;if(Fe(f,p,o),d&&$t(f,d.key,i)===2&&(Fe(f,p,o),Fe(d.key,f,o)),u&&$t(u.key,f,i)===2){let y=u;y!==h?y=a.prev(y):y=null,g=y?y.key:null,Fe(p,g,o),Fe(f,p,o)}}else f=f.otherEvent,d=u=a.find(f),u&&d&&(u!==h?u=a.prev(u):u=null,d=a.next(d),a.remove(f),d&&u&&$t(u.key,d.key,i))}return c}class So{constructor(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null}isExterior(){return this.holeOf==null}}function zo(i){let n,e,r,s;const o=[];for(e=0,r=i.length;e<r;e++)n=i[e],(n.left&&n.inResult||!n.left&&n.otherEvent.inResult)&&o.push(n);let a=!1;for(;!a;)for(a=!0,e=0,r=o.length;e<r;e++)e+1<r&&he(o[e],o[e+1])===1&&(s=o[e],o[e]=o[e+1],o[e+1]=s,a=!1);for(e=0,r=o.length;e<r;e++)n=o[e],n.otherPos=e;for(e=0,r=o.length;e<r;e++)n=o[e],n.left||(s=n.otherPos,n.otherPos=n.otherEvent.otherPos,n.otherEvent.otherPos=s);return o}function Mo(i,n,e,r){let s=i+1,o=n[i].point,a;const c=n.length;for(s<c&&(a=n[s].point);s<c&&a[0]===o[0]&&a[1]===o[1];){if(e[s])s++;else return s;s<c&&(a=n[s].point)}for(s=i-1;e[s]&&s>r;)s--;return s}function Eo(i,n,e){const r=new So;if(i.prevInResult!=null){const s=i.prevInResult,o=s.outputContourId;if(s.resultTransition>0){const c=n[o];if(c.holeOf!=null){const l=c.holeOf;n[l].holeIds.push(e),r.holeOf=l,r.depth=n[o].depth}else n[o].holeIds.push(e),r.holeOf=o,r.depth=n[o].depth+1}else r.holeOf=null,r.depth=n[o].depth}else r.holeOf=null,r.depth=0;return r}function ko(i){let n,e;const r=zo(i),s={},o=[];for(n=0,e=r.length;n<e;n++){if(s[n])continue;const a=o.length,c=Eo(r[n],o,a),l=f=>{s[f]=!0,f<r.length&&r[f]&&(r[f].outputContourId=a)};let u=n,d=n;const h=r[n].point;for(c.points.push(h);l(u),u=r[u].otherPos,l(u),c.points.push(r[u].point),u=Mo(u,r,s,d),!(u==d||u>=r.length||!r[u]););o.push(c)}return o}var dt={exports:{}},zn;function To(){if(zn)return dt.exports;zn=1,dt.exports=i,dt.exports.default=i;function i(e,r){if(!(this instanceof i))return new i(e,r);if(this.data=e||[],this.length=this.data.length,this.compare=r||n,this.length>0)for(var s=(this.length>>1)-1;s>=0;s--)this._down(s)}function n(e,r){return e<r?-1:e>r?1:0}return i.prototype={push:function(e){this.data.push(e),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var e=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),e}},peek:function(){return this.data[0]},_up:function(e){for(var r=this.data,s=this.compare,o=r[e];e>0;){var a=e-1>>1,c=r[a];if(s(o,c)>=0)break;r[e]=c,e=a}r[e]=o},_down:function(e){for(var r=this.data,s=this.compare,o=this.length>>1,a=r[e];e<o;){var c=(e<<1)+1,l=c+1,u=r[c];if(l<this.length&&s(r[l],u)<0&&(c=l,u=r[l]),s(u,a)>=0)break;r[e]=u,e=c}r[e]=a}},dt.exports}var _o=To();const Do=Zn(_o),Mn=Math.max,En=Math.min;let ft=0;function kn(i,n,e,r,s,o){let a,c,l,u,d,h;for(a=0,c=i.length-1;a<c;a++){if(l=i[a],u=i[a+1],d=new De(l,!1,void 0,n),h=new De(u,!1,d,n),d.otherEvent=h,l[0]===u[0]&&l[1]===u[1])continue;d.contourId=h.contourId=e,o||(d.isExteriorRing=!1,h.isExteriorRing=!1),he(d,h)>0?h.left=!0:d.left=!0;const f=l[0],p=l[1];s[0]=En(s[0],f),s[1]=En(s[1],p),s[2]=Mn(s[2],f),s[3]=Mn(s[3],p),r.push(d),r.push(h)}}function Ao(i,n,e,r,s){const o=new Do(null,he);let a,c,l,u,d,h;for(l=0,u=i.length;l<u;l++)for(a=i[l],d=0,h=a.length;d<h;d++)c=d===0,c&&ft++,kn(a[d],!0,ft,o,e,c);for(l=0,u=n.length;l<u;l++)for(a=n[l],d=0,h=a.length;d<h;d++)c=d===0,s===ue&&(c=!1),c&&ft++,kn(a[d],!1,ft,o,r,c);return o}const Ct=[];function Lo(i,n,e){let r=null;return i.length*n.length===0&&(e===be?r=Ct:e===ue?r=i:(e===_e||e===Et)&&(r=i.length===0?n:i)),r}function Ro(i,n,e,r,s){let o=null;return(e[0]>r[2]||r[0]>e[2]||e[1]>r[3]||r[1]>e[3])&&(s===be?o=Ct:s===ue?o=i:(s===_e||s===Et)&&(o=i.concat(n))),o}function cn(i,n,e){typeof i[0][0][0]=="number"&&(i=[i]),typeof n[0][0][0]=="number"&&(n=[n]);let r=Lo(i,n,e);if(r)return r===Ct?null:r;const s=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],a=Ao(i,n,s,o,e);if(r=Ro(i,n,s,o,e),r)return r===Ct?null:r;const c=Io(a,i,n,s,o,e),l=ko(c),u=[];for(let d=0;d<l.length;d++){let h=l[d];if(h.isExterior()){let f=[h.points];for(let p=0;p<h.holeIds.length;p++){let g=h.holeIds[p];f.push(l[g].points)}u.push(f)}}return u}function Ho(i,n){return cn(i,n,_e)}function ai(i,n){return cn(i,n,ue)}function Oo(i,n){return cn(i,n,be)}function $o(i,n){const e=i[0]-n[0],r=i[1]-n[1];return e*e+r*r}function No(i){return{vertices:i.vertices,pieces:Array.from(i.pieces.entries()),edges:Array.from(i.edges.entries()),halfEdges:Array.from(i.halfEdges.entries()),boundary:i.boundary,borderPath:i.borderPath}}function ci(i,n){return!(i[2]<n[0]||i[0]>n[2]||i[3]<n[1]||i[1]>n[3])}function li(i,n){let[e,r]=i,[s,o]=i;const a=c=>{e=Math.min(e,c[0]),r=Math.min(r,c[1]),s=Math.max(s,c[0]),o=Math.max(o,c[1])};for(const c of n)c.type==="line"?a(c.p):(a(c.p1),a(c.p2),a(c.p3));return[e,r,s,o]}function ui(i,n){let e=1/0,r=1/0,s=-1/0,o=-1/0;const a=i.halfEdge;let c=n.halfEdges.get(a);if(!c)return i.bounds;const l=u=>{e=Math.min(e,u[0]),r=Math.min(r,u[1]),s=Math.max(s,u[0]),o=Math.max(o,u[1])};do{if(l(c.origin),c.segments){const u=li(c.origin,c.segments);l([u[0],u[1]]),l([u[2],u[3]])}c=n.halfEdges.get(c.next)}while(c&&c.id!==a);return[e,r,s,o]}function ee(i){if(i.length===0)return[0,0,0,0];let n=i[0][0],e=i[0][1],r=n,s=e;for(let o=1;o<i.length;o++){const a=i[o];n=Math.min(n,a[0]),e=Math.min(e,a[1]),r=Math.max(r,a[0]),s=Math.max(s,a[1])}return[n,e,r,s]}function Fo(i,n){return Math.abs(i[0]-n[0])<1e-6&&Math.abs(i[1]-n[1])<1e-6}function vt(i){if(i.length<3)return 0;let n=0;for(let e=0;e<i.length;e++){const r=(e+1)%i.length;n+=i[e][0]*i[r][1],n-=i[r][0]*i[e][1]}return Math.abs(n/2)}function Vo(i){if(i.length===0)return[0,0];const n=i.reduce((e,r)=>[e[0]+r[0],e[1]+r[1]],[0,0]);return[n[0]/i.length,n[1]/i.length]}function ie(i,n){const e=[],r=i.halfEdge;if(r===-1)return e;let s=r;do{const o=n.halfEdges.get(s);if(!o)break;e.push(o.origin),s=o.next}while(s!==r&&s!==-1);return e}function Tn(i,n){const e=[],r=i.halfEdge;if(r===-1)return e;let s=r;do{const o=n.halfEdges.get(s);if(!o)break;e.push(o),s=o.next}while(s!==r&&s!==-1);return e}function Uo(i,n,e=2){const r=new Map,s=i.halfEdge;if(s!==-1){let c=s;do{const l=n.halfEdges.get(c);if(!l)break;if(l.twin!==-1){const u=n.halfEdges.get(l.twin);if(u&&u.piece!==i.id){const d=n.pieces.get(u.piece);if(d&&!d.isCustomPiece){const h=n.halfEdges.get(l.next);if(h){const f=Math.hypot(h.origin[0]-l.origin[0],h.origin[1]-l.origin[1]),p=r.get(u.piece)??0;r.set(u.piece,p+f)}}}}c=l.next}while(c!==s&&c!==-1)}if(r.size>0)return Array.from(r.entries());const o=ie(i,n),a=i.bounds;for(const[c,l]of n.pieces){if(c===i.id||l.isCustomPiece)continue;const u=Math.max(a[0]-l.bounds[2],l.bounds[0]-a[2]),d=Math.max(a[1]-l.bounds[3],l.bounds[1]-a[3]);if(u<e&&d<e){const h=ie(l,n);let f=0;for(const p of o)for(let g=0;g<h.length;g++){const y=h[g],m=h[(g+1)%h.length];if(nn(p,y,m)<e){const w=Math.hypot(m[0]-y[0],m[1]-y[1]);f+=w;break}}f>0&&r.set(c,f)}}return Array.from(r.entries())}function Go(i,n,e=2){const r=i.halfEdge;if(r!==-1){let o=r;do{const a=n.halfEdges.get(o);if(!a)break;if(a.twin!==-1){const c=n.halfEdges.get(a.twin);if(c&&n.pieces.get(c.piece)?.isCustomPiece)return!0}o=a.next}while(o!==r&&o!==-1)}const s=Array.from(n.pieces.values()).filter(o=>o.isCustomPiece);if(s.length===0)return!1;for(const o of s){const a=Math.max(i.bounds[0]-o.bounds[2],o.bounds[0]-i.bounds[2]),c=Math.max(i.bounds[1]-o.bounds[3],o.bounds[1]-i.bounds[3]);if(a<e&&c<e){const l=ie(i,n),u=ie(o,n);for(const d of l)for(let h=0;h<u.length;h++){const f=u[h],p=u[(h+1)%u.length];if(nn(d,f,p)<e)return!0}for(const d of u)for(let h=0;h<l.length;h++){const f=l[h],p=l[(h+1)%l.length];if(nn(d,f,p)<e)return!0}}}return!1}function nn(i,n,e){const[r,s]=i,[o,a]=n,[c,l]=e,u=c-o,d=l-a,h=u*u+d*d;if(h===0)return Math.hypot(r-o,s-a);let f=((r-o)*u+(s-a)*d)/h;f=Math.max(0,Math.min(1,f));const p=o+f*u,g=a+f*d;return Math.hypot(r-p,s-g)}function jo(i,n,e,r,s){const o=e.pieces.get(i),a=e.pieces.get(n);if(!o||!a)return console.warn(`  Merge failed: piece not found (A: ${o?"ok":"missing"}, B: ${a?"ok":"missing"})`),!1;const c=ie(o,e),l=ie(a,e);if(c.length<3||l.length<3)return console.warn(`  Merge failed: invalid polygons (A: ${c.length} verts, B: ${l.length} verts)`),!1;const u=[c.map(m=>[m[0],m[1]])],d=[l.map(m=>[m[0],m[1]])],h=Ho(u,d);if(!h||h.length===0)return console.warn(`  Merge failed: union returned empty/null (polyA: ${c.length} verts, polyB: ${l.length} verts)`),!1;let f;if(pi(h))f=h[0].map(m=>[m[0],m[1]]);else{const m=h[0];if(!m||!Array.isArray(m[0]))return console.warn("  Merge failed: unexpected union format"),!1;f=m[0].map(v=>[v[0],v[1]])}if(f.length<3)return console.warn(`  Merge failed: merged polygon has ${f.length} vertices`),!1;const p=[...Tn(o,e),...Tn(a,e)],g=(m,v)=>`${m[0]},${m[1]}-${v[0]},${v[1]}`;for(const m of p){const v=e.halfEdges.get(m.next);if(v){const w=g(m.origin,v.origin);r.delete(w)}if(m.twin!==-1){const w=e.halfEdges.get(m.twin);if(w&&w.piece!==i&&w.piece!==n){w.twin=-1;const x=e.halfEdges.get(w.next);if(x){const T=g(w.origin,x.origin);r.set(T,w.id)}}}}for(const m of p){for(const[v,w]of e.edges)if(w.heLeft===m.id||w.heRight===m.id){e.edges.delete(v);const x=e.boundary.indexOf(v);x!==-1&&e.boundary.splice(x,1);break}e.halfEdges.delete(m.id)}e.pieces.delete(n);const y=un(f,i,e);return y.length===0?!1:(o.halfEdge=y[0].id,o.bounds=ee(f),o.site=Vo(f),Pe(y,e,r,s),!0)}function hi(i,n,e,r){const s=[];for(const a of i.pieces.values()){if(a.isCustomPiece)continue;const c=ie(a,i),l=vt(c);if(l<n){if(!Go(a,i)){console.log(`  Fragment ${a.id} (${l.toFixed(0)}px) is undersized but NOT adjacent to custom pieces (skipping)`);continue}s.push({pieceId:a.id,area:l})}}if(s.length===0)return 0;console.log(`Merge mode: found ${s.length} fragments to merge (< ${n.toFixed(0)}px)`),s.sort((a,c)=>a.area-c.area);let o=0;for(const a of s){const c=i.pieces.get(a.pieceId);if(!c)continue;const l=Uo(c,i);if(l.length===0){console.log(`  Skipping fragment ${a.pieceId}: no procedural neighbors`);continue}l.sort((h,f)=>{const p=i.pieces.get(h[0]),g=i.pieces.get(f[0]);if(!p||!g)return 0;const y=ie(p,i),m=ie(g,i),v=vt(y),w=vt(m);return v-w});const[u]=l[0];jo(u,a.pieceId,i,e,r)?o++:console.warn(`  Failed to merge fragment ${a.pieceId} into piece ${u}`)}return console.log(`Merge mode: successfully merged ${o} fragments`),o}function di(i,n,e,r){if(!i.tabs)return;const s=n.halfEdges.get(i.heLeft),o=n.halfEdges.get(i.heRight),a=s.origin,c=o.origin,l=[];let u=a;i.tabs.sort((d,h)=>d.position-h.position);for(const d of i.tabs){const h=d.position-d.size/2,f=[a[0]+(c[0]-a[0])*h,a[1]+(c[1]-a[1])*h];Math.hypot(f[0]-u[0],f[1]-u[1])>1e-6&&l.push({type:"line",p:f});const p=[a[0]+(c[0]-a[0])*(h+d.size),a[1]+(c[1]-a[1])*(h+d.size)],g=e.createTabSegments(f,p,d,r);l.push(...g),u=p}Math.hypot(c[0]-u[0],c[1]-u[1])>1e-6&&l.push({type:"line",p:c}),s.segments=l,o.segments=Bo(l,a),i.bounds=li(a,l)}function Bo(i,n){const e=[];for(let r=i.length-1;r>=0;r--){const s=i[r];let o=n;if(r>0){const a=i[r-1];o=a.type==="line"?a.p:a.p3}s.type==="line"?e.push({type:"line",p:o}):e.push({type:"bezier",p1:s.p2,p2:s.p1,p3:o})}return e}function Wo(i,n){const{p:e,radii:r,rotation:s,largeArc:o,sweep:a}=n,[c,l]=i,[u,d]=e,[h,f]=r;return uo({px:c,py:l,cx:u,cy:d,rx:h,ry:f,xAxisRotation:s,largeArcFlag:o?1:0,sweepFlag:a?1:0}).map(y=>({type:"bezier",p1:[y.x1,y.y1],p2:[y.x2,y.y2],p3:[y.x,y.y]}))}function fi(i){const n=[];let e=[];if(i.length===0||i[0].type!=="move")return[];let r=[0,0];for(const s of i)switch(s.type){case"move":e.length>0&&n.push(e),r=s.p,e=[r];break;case"line":e.push(s.p),r=s.p;break;case"bezier":{const{p1:o,p2:a,p3:c}=s,u=new F([...r,...o,...a,...c]).getLUT(100);e.push(...u.slice(1).map(d=>[d.x,d.y])),r=c;break}case"arc":{const o=Wo(r,s);let a=r;for(const c of o){const u=new F([...a,...c.p1,...c.p2,...c.p3]).getLUT(100);e.push(...u.slice(1).map(d=>[d.x,d.y])),a=c.p3}r=s.p;break}}return e.length>0&&n.push(e),n}function ln(i,n,e){if(n.length>0&&n[0].type!=="move")throw new Error("Boundary path must start with a 'move' command.");const r=fi(n);let s=0;for(const o of r)Ae(i,o)&&s++;return s%2===1}function pi(i){return Array.isArray(i[0])&&Array.isArray(i[0][0])&&typeof i[0][0][0]=="number"}function qo(i,n){const e=[i.map(o=>[o[0],o[1]])],r=[n.map(o=>[o[0],o[1]])],s=Oo(e,r);return!s||s.length===0?null:pi(s)?s:s.map(o=>o[0].map(a=>[a[0],a[1]]))}function Ae(i,n){const[e,r]=i;let s=!1;for(let o=0,a=n.length-1;o<n.length;a=o++){const[c,l]=n[o],[u,d]=n[a];l>r!=d>r&&e<(u-c)*(r-l)/(d-l)+c&&(s=!s)}return s}function un(i,n,e){const r=[];for(const o of i)e.vertices.find(a=>Fo(a,o))||e.vertices.push(o);for(const o of i){const a={id:ti(),origin:o,twin:-1,next:-1,prev:-1,piece:n};r.push(a)}const s=r.length;for(let o=0;o<s;o++){const a=(o+1)%s,c=(o+s-1)%s;r[o].next=r[a].id,r[o].prev=r[c].id}return r.forEach(o=>e.halfEdges.set(o.id,o)),r}function Pe(i,n,e,r){const s=(c,l)=>`${c[0]},${c[1]}-${l[0]},${l[1]}`,o=i.length,a=.1;for(let c=0;c<o;c++){const l=i[c],u=l.origin,d=n.halfEdges.get(l.next).origin,h=s(d,u),f=s(u,d);let p=e.get(h);if(p===void 0)for(const[m,v]of e.entries()){const w=n.halfEdges.get(v),x=w.origin,T=n.halfEdges.get(w.next).origin,S=Math.sqrt((u[0]-T[0])**2+(u[1]-T[1])**2),I=Math.sqrt((d[0]-x[0])**2+(d[1]-x[1])**2);if(S<a&&I<a){p=v,e.delete(m);break}}const g=ti();let y;if(p!==void 0){const m=n.halfEdges.get(p);l.twin=m.id,m.twin=l.id,y={id:g,heLeft:m.id,heRight:l.id,bounds:ee([u,d])},e.get(h)===p&&e.delete(h)}else if(e.set(f,l.id),r(u,d))y={id:g,heLeft:l.id,heRight:-1,bounds:ee([u,d])},n.boundary.push(g);else continue;n.edges.set(g,y)}}function Xo(i,n,e,r=20){if(i.length===0)return i;let s=1/0,o=1/0,a=-1/0,c=-1/0;const l=(x,T)=>{s=Math.min(s,x),o=Math.min(o,T),a=Math.max(a,x),c=Math.max(c,T)};for(const x of i)x.type==="move"||x.type==="line"?l(x.p[0],x.p[1]):x.type==="bezier"&&(l(x.p1[0],x.p1[1]),l(x.p2[0],x.p2[1]),l(x.p3[0],x.p3[1]));const u=a-s,d=c-o,h=n-2*r,f=e-2*r,p=Math.min(h/u,f/d),g=u*p,y=d*p,m=r+(h-g)/2-s*p,v=r+(f-y)/2-o*p,w=[];for(const x of i)x.type==="move"||x.type==="line"?w.push({...x,p:[x.p[0]*p+m,x.p[1]*p+v]}):x.type==="bezier"&&w.push({type:"bezier",p1:[x.p1[0]*p+m,x.p1[1]*p+v],p2:[x.p2[0]*p+m,x.p2[1]*p+v],p3:[x.p3[0]*p+m,x.p3[1]*p+v]});return w}function mi(i){return function(){let n=i+=1831565813;return n=Math.imul(n^n>>>15,n|1),n^=n+Math.imul(n^n>>>7,n|61),((n^n>>>14)>>>0)/4294967296}}async function je(i){return Xi("Puzzle Generation",()=>{const{bounds:n,pieceSize:e,border:r}=i,{pointConfig:s,pieceConfig:o,placementConfig:a,tabConfig:c}=i;console.log(`rebuilding puzzle with dimensions ${n.width}x${n.height}, piece size ${e}`);const l=nt.create(r,n,s),u=it.create(r,n,o),d=ot.create(r,n,a),h=xe.create(r,n,c),f=i.seed??new Date().getTime(),p=mi(f),g=i.seedPoints??l.generatePoints({width:n.width,height:n.height,pieceSize:e,random:p,border:r});console.log(`${i.seedPoints?"Using":"Generated"} ${g.length} points`);const y=u.generatePieces(g,{random:p,pieceSize:e,border:r,bounds:n,customPieces:i.customPieces});if(console.log(`Generated ${y.pieces.size} pieces`),!i.skipTabs){d.placeTabs({topology:y,random:p});for(const v of y.edges.values())v.heRight!==-1&&v.tabs&&v.tabs.length>0&&di(v,y,h,p)}const m={created:new Date().toISOString(),seed:f,width:n.width,height:n.height,pieceSize:e,pointConfig:s,pieceConfig:o,placementConfig:a,tabConfig:c,seedPoints:g,vertices:y.vertices,boundary:y.boundary,borderPath:y.borderPath,pieces:y.pieces,edges:y.edges,halfEdges:y.halfEdges,customPieces:i.customPieces};return Promise.resolve(m)})}async function Yo(i,n,e){const r=[...i.seedPoints];let s=0;for(const o of i.pieces.values()){if(o.id===n){r[s]=e;break}s++}return je({bounds:{width:i.width,height:i.height},border:i.borderPath,pieceSize:i.pieceSize,pointConfig:i.pointConfig,pieceConfig:i.pieceConfig,placementConfig:i.placementConfig,tabConfig:i.tabConfig,seed:i.seed,seedPoints:r,customPieces:i.customPieces,skipTabs:!1})}function on(i,n){return[{type:"move",p:[0,0]},{type:"line",p:[i,0]},{type:"line",p:[i,n]},{type:"line",p:[0,n]},{type:"line",p:[0,0]}]}function Ko(i){const n=i/2,e=n;return[{type:"move",p:[0,e]},{type:"arc",p:[i,e],radii:[n,n],rotation:0,largeArc:!1,sweep:!0},{type:"arc",p:[0,e],radii:[n,n],rotation:0,largeArc:!1,sweep:!0}]}function Zo(i,n){const e=i/2,r=n/2;return[{type:"move",p:[0,r]},{type:"arc",p:[i,r],radii:[e,r],rotation:0,largeArc:!1,sweep:!0},{type:"arc",p:[0,r],radii:[e,r],rotation:0,largeArc:!1,sweep:!0}]}function Qo(i,n,e){const r=Math.min(i,n)/2,s=Math.min(e,r);return[{type:"move",p:[s,0]},{type:"line",p:[i-s,0]},{type:"arc",p:[i,s],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[i,n-s]},{type:"arc",p:[i-s,n],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[s,n]},{type:"arc",p:[0,n-s],radii:[s,s],rotation:0,largeArc:!1,sweep:!0},{type:"line",p:[0,s]},{type:"arc",p:[s,0],radii:[s,s],rotation:0,largeArc:!1,sweep:!0}]}function Jo(i,n,e){if(n<0||n>=i.vertices.length){console.warn("moveVertex called with invalid vertex index:",n);return}const r=i.vertices[n];i.vertices[n]=e;const s=[];for(const c of i.halfEdges.values())c.origin[0]===r[0]&&c.origin[1]===r[1]&&s.push(c);const o=new Set,a=[e[0]-r[0],e[1]-r[1]];for(const c of s){c.origin=e,o.add(c.piece);const l=i.halfEdges.get(c.prev);if(l?.segments){const u=l.segments[l.segments.length-1];u.type==="line"?u.p=e:(u.p3=e,u.p1=[u.p1[0]+a[0],u.p1[1]+a[1]],u.p2=[u.p2[0]+a[0],u.p2[1]+a[1]]),o.add(l.piece)}}er(i,n);for(const c of o){const l=i.pieces.get(c);l&&(l.bounds=ui(l,i))}}function er(i,n){const{seed:e,width:r,height:s,placementConfig:o,tabConfig:a}=i,c=mi(e),l=on(r,s),u={width:r,height:s},d=ot.create(l,u,o),h=xe.create(l,u,a),f=new Set,p=i.vertices[n],g=new Map;for(const m of i.edges.values())g.set(m.heLeft,m),m.heRight!==-1&&g.set(m.heRight,m);for(const m of i.halfEdges.values()){const v=i.halfEdges.get(m.next)?.origin;if(m.origin===p||v===p){const T=g.get(m.id);T&&f.add(T)}}d.updateTabPlacements(Array.from(f),{topology:i,random:c});const y=new Set;for(const m of f)if(m.heRight!==-1){const w=i.halfEdges.get(m.heLeft);w&&(w.segments=void 0,y.add(i.pieces.get(w.piece)));const x=i.halfEdges.get(m.heRight);x&&(x.segments=void 0,y.add(i.pieces.get(x.piece))),di(m,i,h,c)}for(const m of y)m.bounds=ui(m,i)}let Be=null,We=null,qe=null,Xe=null,Ye=null,me=null,Me=!1,fe=null;function tr(i,n){Be=e=>{const r=e.target;r.tagName==="INPUT"||r.tagName==="WA-INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable||e.code==="Space"&&(e.preventDefault(),i.isSpacebarPressed||(i.isSpacebarPressed=!0,pt(i)))},We=e=>{const r=e.target;r.tagName==="INPUT"||r.tagName==="WA-INPUT"||r.tagName==="TEXTAREA"||r.isContentEditable||e.code==="Space"&&(i.isSpacebarPressed=!1,pt(i),e.preventDefault())},qe=e=>{if(e.preventDefault(),!i.paperCtx)return;const r=i.paperCtx.scope,s=-Math.sign(e.deltaY)*$i,o=Math.max(Hi,Math.min(Oi,i.zoom+s));if(o!==i.zoom){const a=new r.Point(e.offsetX,e.offsetY),c=r.view.viewToProject(a),l=o/i.zoom;r.view.scale(l,c),i.zoom=o,n&&n(o),P.redraw()}},Xe=e=>{i.isSpacebarPressed&&(Me=!0,fe={x:e.clientX,y:e.clientY},pt(i),e.preventDefault())},Ye=e=>{if(i.isSpacebarPressed&&e.preventDefault(),Me&&fe){if(!i.paperCtx)return;const r=i.paperCtx.scope,s=e.clientX-fe.x,o=e.clientY-fe.y,a=s/i.zoom,c=o/i.zoom;r.view.translate(new r.Point(a,c)),fe={x:e.clientX,y:e.clientY}}},me=()=>{Me&&(Me=!1,fe=null,pt(i))},window.addEventListener("keydown",Be),window.addEventListener("keyup",We),i.canvas&&(i.canvas.addEventListener("wheel",qe,{passive:!1}),i.canvas.addEventListener("mousedown",Xe),i.canvas.addEventListener("mousemove",Ye),i.canvas.addEventListener("mouseup",me),i.canvas.addEventListener("mouseleave",me))}function nr(i){Be&&(window.removeEventListener("keydown",Be),Be=null),We&&(window.removeEventListener("keyup",We),We=null),i&&(qe&&(i.removeEventListener("wheel",qe),qe=null),Xe&&(i.removeEventListener("mousedown",Xe),Xe=null),Ye&&(i.removeEventListener("mousemove",Ye),Ye=null),me&&(i.removeEventListener("mouseup",me),i.removeEventListener("mouseleave",me),me=null)),Me=!1,fe=null}function pt(i){if(i.canvas){if(i.isSpacebarPressed){i.canvas.style.cursor=Me?"grabbing":"grab";return}if(i.isDragging){i.canvas.style.cursor="grabbing";return}i.canvas.style.cursor="default"}}function wt(i,n){for(const e of i.children)if(e.data.vertexId===n)return e;return null}function rt(i,n,e){if(!e.paperCtx)return null;const r=e.paperCtx.scope,s=n.getBoundingClientRect();let o,a;if(i instanceof TouchEvent){if(i.changedTouches.length===0)return null;const l=i.changedTouches[0];o=l.clientX,a=l.clientY}else o=i.clientX,a=i.clientY;const c=new r.Point(o-s.left,a-s.top);return r.view.viewToProject(c)}function It(i){return[i.x,i.y]}function _n(i,n,e,r){const s=[...i.puzzle.seedPoints];let o=0;for(const a of i.puzzle.pieces.values()){if(a.id===e){s[o]=r;break}o++}je({bounds:{width:i.puzzle.width,height:i.puzzle.height},border:i.puzzle.borderPath,pieceSize:i.puzzle.pieceSize,pointConfig:i.puzzle.pointConfig,pieceConfig:i.puzzle.pieceConfig,placementConfig:i.puzzle.placementConfig,tabConfig:i.puzzle.tabConfig,seed:i.puzzle.seed,seedPoints:s,skipTabs:!0}).then(a=>{n.draggedSeedPointId===e&&bt(n,a,i.color,i.pointColor)}).catch(a=>{console.error("Failed to regenerate preview:",a)})}function ir(i,n,e){if(i.redraw=!1,e.isDragging||e.isSpacebarPressed||!e.canvas)return;const r=rt(i,e.canvas,e);if(!r)return;let s=!1;const o=It(r);if(e.vertexItems){let a=-1,c=Ri;const l=Jn(n.puzzle);for(let u=0;u<n.puzzle.vertices.length;u++){if(l.has(u))continue;const d=$o(n.puzzle.vertices[u],o);d<c&&(c=d,a=u)}if(a>=0){if(e.hoveredVertexId!==a){if(e.hoveredVertexId>=0){const d=wt(e.vertexItems,e.hoveredVertexId);d&&(d.visible=!1)}const u=wt(e.vertexItems,a);u&&(u.visible=!0,e.hoveredVertexId=a)}s=!0}else if(e.hoveredVertexId>=0){const u=wt(e.vertexItems,e.hoveredVertexId);u&&(u.visible=!1,e.hoveredVertexId=-1)}}n.pointColor&&e.seedPointItems&&e.seedPointItems.hitTest(r,{fill:!0,tolerance:5})&&(s=!0),e.canvas.style.cursor=s?"grab":"default"}function or(i,n,e){if(!e.draggedCustomPieceId||!e.customPieceDragStart||!e.customPieceInitialTransform||!n.customPieces||!n.customPieces.find(u=>u.id===e.draggedCustomPieceId))return;const s=[i.x,i.y],o=s[0]-e.customPieceDragStart[0],a=s[1]-e.customPieceDragStart[1];let c;if(e.draggedHandleType==="piece")c={...e.customPieceInitialTransform,position:[e.customPieceInitialTransform.position[0]+o,e.customPieceInitialTransform.position[1]+a]};else if(e.draggedHandleType==="rotation"&&e.customPieceInitialAngle!==null){const u=e.customPieceInitialTransform.position,h=Math.atan2(s[1]-u[1],s[0]-u[0])-e.customPieceInitialAngle;c={...e.customPieceInitialTransform,rotation:e.customPieceInitialTransform.rotation+h}}else if(e.draggedHandleType==="scale"&&e.draggedCorner){const u=e.customPieceInitialTransform.position,d=Math.hypot(e.customPieceDragStart[0]-u[0],e.customPieceDragStart[1]-u[1]),f=Math.hypot(s[0]-u[0],s[1]-u[1])/d;c={...e.customPieceInitialTransform,scale:[e.customPieceInitialTransform.scale[0]*f,e.customPieceInitialTransform.scale[1]*f]}}else return;const l=n.customPieces.map(u=>u.id===e.draggedCustomPieceId?{...u,transform:c}:u);if(e.paperCtx){Zt(e,l,n.color,n.selectedCustomPieceId);const u=l.find(d=>d.id===e.draggedCustomPieceId);u&&Qt(e,u)}}function Dn(i,n,e){if(i.redraw=!1,!e.canvas||e.isSpacebarPressed)return;if(i instanceof TouchEvent&&i.touches.length>1){e.isDragging=!1,e.draggedVertexId=-1,e.draggedSeedPointId=-1;return}if(i instanceof MouseEvent&&i.button!==0)return;const r=rt(i,e.canvas,e);if(r){if(n.selectedCustomPieceId&&e.customHandlesLayer){const s=e.customHandlesLayer.hitTest(r,{fill:!0,stroke:!0,tolerance:5});if(s?.item.data.handleType){const o=s.item.data.handleType;if(o==="rotation"||o==="scale"||o==="bbox"){const a=n.customPieces?.find(c=>c.id===n.selectedCustomPieceId);if(a){if(e.draggedCustomPieceId=n.selectedCustomPieceId,e.draggedHandleType=o==="bbox"?"piece":o==="rotation"?"rotation":"scale",e.draggedCorner=s.item.data.corner,e.customPieceDragStart=[r.x,r.y],e.customPieceInitialTransform={...a.transform},e.draggedHandleType==="rotation"){const c=a.transform.position;e.customPieceInitialAngle=Math.atan2(r.y-c[1],r.x-c[0])}else e.customPieceInitialAngle=null;e.isDragging=!0,i instanceof MouseEvent&&(e.documentMouseMove=c=>{const l=c;l.redraw=!1,Ee(l,n,e)},e.documentMouseUp=c=>{const l=c;l.redraw=!1,ge(l,n,e)},document.addEventListener("mousemove",e.documentMouseMove),document.addEventListener("mouseup",e.documentMouseUp));return}}}}if(n.customPieces&&e.customPiecesLayer){const s=e.customPiecesLayer.hitTest(r,{fill:!0,stroke:!0,tolerance:5});if(s?.item.data.customPieceId){const o=s.item.data.customPieceId;if(o!==n.selectedCustomPieceId){n.onCustomPieceSelected&&n.onCustomPieceSelected(o);return}const a=n.customPieces.find(c=>c.id===o);if(a){e.draggedCustomPieceId=o,e.draggedHandleType="piece",e.draggedCorner=null,e.customPieceDragStart=[r.x,r.y],e.customPieceInitialTransform={...a.transform},e.customPieceInitialAngle=null,e.isDragging=!0,i instanceof MouseEvent&&(e.documentMouseMove=c=>{const l=c;l.redraw=!1,Ee(l,n,e)},e.documentMouseUp=c=>{const l=c;l.redraw=!1,ge(l,n,e)},document.addEventListener("mousemove",e.documentMouseMove),document.addEventListener("mouseup",e.documentMouseUp));return}}}if(n.pointColor&&e.seedPointItems){const s=e.seedPointItems.hitTest(r,{fill:!0,tolerance:5});if(s?.item.data.pieceId!==void 0){e.draggedSeedPointId=s.item.data.pieceId,e.isDragging=!1,i instanceof MouseEvent&&(e.documentMouseMove=o=>{const a=o;a.redraw=!1,Ee(a,n,e)},e.documentMouseUp=o=>{const a=o;a.redraw=!1,ge(a,n,e)},document.addEventListener("mousemove",e.documentMouseMove),document.addEventListener("mouseup",e.documentMouseUp));return}}if(e.vertexItems){const s=e.vertexItems.hitTest(r,{fill:!0,tolerance:8});if(s?.item.data.vertexId!==void 0){e.draggedVertexId=s.item.data.vertexId,e.isDragging=!1,i instanceof MouseEvent&&(e.documentMouseMove=o=>{const a=o;a.redraw=!1,Ee(a,n,e)},e.documentMouseUp=o=>{const a=o;a.redraw=!1,ge(a,n,e)},document.addEventListener("mousemove",e.documentMouseMove),document.addEventListener("mouseup",e.documentMouseUp));return}}}}function Ee(i,n,e){if(i.redraw=!1,!e.canvas)return;const r=rt(i,e.canvas,e);if(r){if(e.draggedCustomPieceId){e.isDragging=!0,i.preventDefault(),e.canvas.style.cursor="grabbing",or(r,n,e);return}if(e.draggedVertexId>=0){e.isDragging=!0,i.preventDefault(),e.canvas.style.cursor="grabbing";const s=It(r);if(Jo(n.puzzle,e.draggedVertexId,s),e.vertexItems){const o=wt(e.vertexItems,e.draggedVertexId);o&&(o.position=r)}bt(e,n.puzzle,n.color,n.pointColor);return}if(e.draggedSeedPointId>=0){e.isDragging=!0,i.preventDefault(),e.canvas.style.cursor="grabbing";const s=It(r),o=performance.now();if(o-e.lastRegenerationTime<gn){e.pendingRegeneration&&clearTimeout(e.pendingRegeneration),e.pendingRegeneration=window.setTimeout(()=>{_n(n,e,e.draggedSeedPointId,s)},gn);return}e.lastRegenerationTime=o,_n(n,e,e.draggedSeedPointId,s)}}}function ge(i,n,e){if(i.redraw=!1,!e.canvas)return;e.pendingRegeneration&&(clearTimeout(e.pendingRegeneration),e.pendingRegeneration=null);const r=e.draggedCustomPieceId&&e.isDragging,s=e.draggedVertexId>=0&&e.isDragging,o=e.draggedSeedPointId>=0&&e.isDragging;if(r){i.preventDefault();const a=rt(i,e.canvas,e);if(a&&e.customPieceInitialTransform&&n.onCustomPieceTransformed){const c=[a.x,a.y],l=c[0]-e.customPieceDragStart[0],u=c[1]-e.customPieceDragStart[1];let d;if(e.draggedHandleType==="piece")d={...e.customPieceInitialTransform,position:[e.customPieceInitialTransform.position[0]+l,e.customPieceInitialTransform.position[1]+u]};else if(e.draggedHandleType==="rotation"&&e.customPieceInitialAngle!==null){const h=e.customPieceInitialTransform.position,p=Math.atan2(c[1]-h[1],c[0]-h[0])-e.customPieceInitialAngle;d={...e.customPieceInitialTransform,rotation:e.customPieceInitialTransform.rotation+p}}else if(e.draggedHandleType==="scale"){const h=e.customPieceInitialTransform.position,f=Math.hypot(e.customPieceDragStart[0]-h[0],e.customPieceDragStart[1]-h[1]),g=Math.hypot(c[0]-h[0],c[1]-h[1])/f;d={...e.customPieceInitialTransform,scale:[e.customPieceInitialTransform.scale[0]*g,e.customPieceInitialTransform.scale[1]*g]}}else d=e.customPieceInitialTransform;e.draggedCustomPieceId&&n.onCustomPieceTransformed(e.draggedCustomPieceId,d)}}if(s&&(i.preventDefault(),n.onPuzzleChanged(n.puzzle)),o){i.preventDefault();const a=e.draggedSeedPointId,c=rt(i,e.canvas,e);if(c&&n.onSeedPointMoved){const l=It(c);n.onSeedPointMoved(a,l)}}e.documentMouseMove&&(document.removeEventListener("mousemove",e.documentMouseMove),e.documentMouseMove=null),e.documentMouseUp&&(document.removeEventListener("mouseup",e.documentMouseUp),e.documentMouseUp=null),e.isDragging=!1,e.draggedVertexId=-1,e.draggedSeedPointId=-1,e.draggedCustomPieceId=null,e.draggedHandleType=null,e.draggedCorner=null,e.customPieceDragStart=null,e.customPieceInitialTransform=null,e.customPieceInitialAngle=null,e.canvas.style.cursor="default"}const rr=()=>{const i={canvas:null,isDragging:!1,draggedVertexId:-1,draggedSeedPointId:-1,lastRegenerationTime:0,pendingRegeneration:null,documentMouseMove:null,documentMouseUp:null,paperCtx:null,backgroundRaster:null,puzzleLayer:null,customPiecesLayer:null,customHandlesLayer:null,seedPointsLayer:null,verticesLayer:null,problemsLayer:null,paperPath:null,seedPointItems:null,problemItems:null,vertexItems:null,hoveredVertexId:-1,selectedPieceId:-1,draggedCustomPieceId:null,draggedHandleType:null,draggedCorner:null,customPieceDragStart:null,customPieceInitialTransform:null,customPieceInitialAngle:null,zoom:_t,isSpacebarPressed:!1},n=(o,a)=>{if(o===i.zoom||!i.paperCtx)return;const c=i.paperCtx.scope,l=o/i.zoom;c.view.scale(l,c.view.center),i.zoom=o,a?.onZoomChanged&&a.onZoomChanged(o),P.redraw()},e=()=>{if(!i.paperCtx)return;const o=i.paperCtx.scope,a=_t/i.zoom;o.view.scale(a,o.view.center),i.zoom=_t,o.view.center=new o.Point(o.view.viewSize.width/2,o.view.viewSize.height/2),P.redraw()},r=()=>`${Math.round(i.zoom*100)}%`;let s;return{oncreate:({dom:o,attrs:a})=>{if(i.canvas=o.querySelector("canvas.puzzle-renderer"),!i.canvas){console.error("PuzzleRenderer: couldn't get canvas element");return}if(Yi(i.canvas,a.width,a.height,i),Ki(i),tr(i,a.onZoomChanged),vn(i,a.imageUrl,a.width,a.height),s=a.imageUrl,a.isDirty||bt(i,a.puzzle,a.color,a.pointColor),a.customPieces&&a.customPieces.length>0)if(Zt(i,a.customPieces,a.color,a.selectedCustomPieceId),a.selectedCustomPieceId){const c=a.customPieces.find(l=>l.id===a.selectedCustomPieceId);c&&Qt(i,c)}else Dt(i)},onupdate:({attrs:o})=>{if(!i.canvas){console.error("PuzzleRenderer: couldn't get canvas element");return}if(o.imageUrl!==s&&(vn(i,o.imageUrl,o.width,o.height),s=o.imageUrl),o.isDirty||bt(i,o.puzzle,o.color,o.pointColor),o.customPieces&&o.customPieces.length>0)if(Zt(i,o.customPieces,o.color,o.selectedCustomPieceId),o.selectedCustomPieceId){const a=o.customPieces.find(c=>c.id===o.selectedCustomPieceId);a&&Qt(i,a)}else Dt(i);else i.customPiecesLayer&&(i.customPiecesLayer.removeChildren(),Dt(i))},onremove:()=>{i.documentMouseMove&&(document.removeEventListener("mousemove",i.documentMouseMove),i.documentMouseMove=null),i.documentMouseUp&&(document.removeEventListener("mouseup",i.documentMouseUp),i.documentMouseUp=null),nr(i.canvas),Qi(i)},view:({attrs:o})=>{const a=r();return P(".puzzle-renderer-wrapper",[P("canvas.puzzle-renderer",{key:"puzzle-renderer-canvas",width:o.width,height:o.height,style:{width:`${o.width}px`,height:`${o.height}px`,touchAction:"manipulation"},onmousedown:c=>Dn(c,o,i),onmousemove:c=>{ir(c,o,i),Ee(c,o,i)},onmouseup:c=>ge(c,o,i),ontouchstart:c=>Dn(c,o,i),ontouchmove:c=>Ee(c,o,i),ontouchend:c=>ge(c,o,i),ontouchcancel:c=>ge(c,o,i)}),P(".puzzle-renderer-controls",{key:"puzzle-renderer-controls"},[P("wa-dropdown.zoom-control",{"onwa-select":c=>{c.redraw=!1;const l=c.detail.item.value;if(l&&typeof l=="string"){const u=parseFloat(l);isNaN(u)||n(u,o)}}},[P("wa-button",{slot:"trigger","with-caret":!0,size:"small",value:i.zoom},a),...Ni.map((c,l)=>P("wa-dropdown-item",{type:"checkbox",checked:i.zoom==c?!0:void 0,value:c.toString()},Fi[l]))]),P("wa-tooltip",{for:"recenter-button"},"Recenter view"),P("wa-button#recenter-button",{appearance:"plain",size:"large",onclick:()=>{e()}},P("wa-icon",{library:"material",name:"recenter",label:"Recenter view"}))])])}}};function sr(i,n,e,r="black"){const o=[];for(const l of i.edges.values()){const u=i.halfEdges.get(l.heLeft);if(u)if(o.push(`M ${u.origin[0].toFixed(3)} ${u.origin[1].toFixed(3)}`),u.segments)for(const d of u.segments)switch(d.type){case"bezier":o.push(`C ${d.p1[0].toFixed(3)} ${d.p1[1].toFixed(3)}, ${d.p2[0].toFixed(3)} ${d.p2[1].toFixed(3)}, ${d.p3[0].toFixed(3)} ${d.p3[1].toFixed(3)}`);break;case"line":o.push(`L ${d.p[0].toFixed(3)} ${d.p[1].toFixed(3)}`);break}else{let d;u.twin!==-1?d=i.halfEdges.get(u.twin).origin:d=i.halfEdges.get(u.next).origin,o.push(`L ${d[0].toFixed(3)} ${d[1].toFixed(3)}`)}}const a=o.join(" ");return`
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg
  width="${n}"
  height="${e}"
  viewBox="0 0 ${n} ${e}"
  xmlns="http://www.w3.org/2000/svg"
  version="1.1"
>
  <path
    d="${a}"
    fill="none"
    stroke="${r}"
    stroke-width="1"
    vector-effect="non-scaling-stroke"
  />
</svg>`.trim().replace(/\r\n/g,`
`)}function ar(i,n="puzzle.svg"){const e=new Blob([i],{type:"image/svg+xml"}),r=URL.createObjectURL(e),s=document.createElement("a");s.href=r,s.download=n,s.hidden=!0,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(r),100)}const cr={view:({attrs:i})=>P("wa-button.download-svg",{size:"small",onclick:()=>{const n=sr(i.puzzle,i.width,i.height,i.color);ar(n,i.filename??"puzzle.svg")}},"Download SVG")},lr={view:({attrs:i})=>{const n=i.progressPercent!==void 0&&i.progressPercent<100,e=!n&&i.problems!==void 0&&i.problems==0,r=!n&&i.problems!==void 0&&i.problems>0;return P(".geometry-check-indicator",[P(".label","Geometry Check:"),P("wa-tooltip",{for:"check-geometry-now"},"Check geometry now"),P("wa-button#check-geometry-now",{variant:"neutral",appearance:"plain",size:"small",disabled:n,onclick:s=>{s.redraw=!1,i.onCheckRequested?.()}},P("wa-icon",{library:"material",name:"editor_choice",label:"Check geometry now"})),P("wa-tooltip",{for:"auto-check-geometry"},"Check geometry after every change"),P("wa-checkbox#auto-check-geometry",{checked:i.autoCheck,disabled:n,size:"small",onchange:s=>{s.redraw=!1;const o=s.target;i.onAutocheckChanged?.(o.checked)}},"auto check"),n&&P("wa-progress-bar",{label:"Geometry check progress",value:i.progressPercent??0}),e&&P("wa-badge",{variant:"success",pill:!0},"OK"),r&&P("wa-badge",{variant:"danger",pill:!0},`${i.problems} issue${i.problems===1?"":"s"}`)])}};function ur(i,n,e=800){if(i<=e)return{width:i,height:n};const r=n/i;return{width:e,height:Math.round(e*r)}}const hr=()=>{const i={inputElement:void 0,imageLoaded:!1,imageName:""};return{view:({attrs:n})=>[P("wa-button.upload-button",{size:"small",disabled:n.disabled===!0,onclick:()=>{i.inputElement&&i.inputElement.click()}},n.label??"Upload Image"),P("input[type=file]",{style:{display:"none"},accept:"image/*",oncreate:({dom:e})=>{i.inputElement=e},onchange:e=>{if(e.redraw=!1,i.inputElement){const r=i.inputElement.files?.[0];r?.type.startsWith("image/")&&createImageBitmap(r).then(s=>{const{width:o,height:a}=ur(s.width,s.height),c=URL.createObjectURL(r);s.close(),i.imageName=r.name,n.onUpload(c,r.name,o,a),i.imageLoaded=!0}).catch(s=>{console.error("could not create a bitmap image: ",s)})}}}),P("span.background-image-label",i.imageName),i.imageLoaded&&P("wa-icon.clear-button",{library:"material",name:"close",label:"Clear background image",onclick:e=>{e.redraw=!1,!n.disabled&&(i.imageName="",i.imageLoaded=!1,n.onClear())}},"Clear")]}},gi=()=>({view:({attrs:i})=>P("wa-checkbox.boolean-input",{hint:i.config.helpText,disabled:i.disabled,checked:i.value,onchange:n=>{const r=n.target.checked;i.onChange(r)}},i.config.label)}),dr=()=>({view:({attrs:i})=>{const n=i.config.choices.map(([o,a])=>P("wa-option",{value:o},a)),e=i.value??i.config.defaultValue,s=i.config.choices.find(([o])=>o===e)?.[2];return P(".choice-input-wrapper",[P("wa-select.choice-input",{label:i.config.label,hint:i.config.helpText,size:"small",disabled:i.disabled,value:e,onchange:o=>{o.redraw=!1;const c=o.target.value;i.onChange(c||void 0)}},n),s?P("p.choice-help-text",{style:{"margin-top":"0.25rem","font-size":"0.875rem",color:"var(--wa-form-control-hint-color)","line-height":"1.25rem"}},s):null])}}),Pt=()=>({view:({attrs:i})=>P("wa-input.number-input",{label:i.config.label,hint:i.config.helpText,type:"number",inputmode:"numeric",size:"small",disabled:i.disabled,value:i.value,min:i.config.min,max:i.config.max,onchange:n=>{const e=n.target,r=parseFloat(e.value??"");i.onChange(isNaN(r)?void 0:r)}})}),fr=()=>({view:({attrs:i})=>P("wa-slider.range-input",{label:i.config.label,hint:i.config.helpText,disabled:i.disabled,value:i.value,min:i.config.min,max:i.config.max,step:i.config.step,"with-tooltip":!0,onchange:n=>{const r=n.target.value;i.onChange(isNaN(r)?void 0:r)}})}),yi=()=>({view:({attrs:i})=>P("wa-input.string-input",{label:i.config.label,hint:i.config.helpText,type:"text",size:"small",disabled:i.disabled,value:i.value,oninput:n=>{n.redraw=!1;const r=n.target.value??"";i.onChange(r.length>0?r:void 0)}})}),pr=(i,n)=>!i.dependsOn||i.dependsOn.length===0?!0:i.dependsOn.some(e=>n[e.config]===e.value),mr=()=>({view:({attrs:i})=>{const n=i.registry.getAvailableGenerators();return P(".generator-picker",P("wa-tab-group",{active:i.generator,"onwa-tab-show":e=>{const r=e.detail.name;i.generator!==r&&i.onGeneratorChange(r)}},[...n.map(e=>{const r=i.registry.getUIMetadata(e.name),s=P("wa-tab",{panel:e.name},e.displayName),o=P("wa-tab-panel",{name:e.name},P(".controls",[r?.description?P("p",r.description):null,...r?.controls.filter(a=>pr(a,i.config)).map(a=>{switch(a.type){case"range":return P(fr,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:c=>{i.onConfigChange(a.name,c)}});case"boolean":return P(gi,{config:a,value:(i.config?.[a.name]??a.defaultValue)===!0,onChange:c=>{i.onConfigChange(a.name,c)}});case"number":return P(Pt,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:c=>{i.onConfigChange(a.name,c)}});case"string":return P(yi,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:c=>{i.onConfigChange(a.name,c)}});case"choice":return P(dr,{config:a,value:i.config?.[a.name]??a.defaultValue,onChange:c=>{i.onConfigChange(a.name,c)}})}})??[],!r?.description&&r?.controls.length==0?P("p","No controls for this strategy."):null]));return[s,o]})]))}}),An=[["Square","1:1",1],["Classic Photo","5:4",5/4],["Standard Photo","4:3",4/3],["35mm/DSLR","3:2",3/2],["Widescreen","16:9",16/9],["UltraWide","21:9",21/9],["Panorama","2:1",2/1],["Instagram Portrait","4:5",4/5],["Classic Portrait","3:4",3/4],["DSLR Portrait","2:3",2/3],["Phone Portrait","9:16",9/16],["Tall Poster","9:21",9/21],["Tall Panorama","1:2",1/2]],gr={view:({attrs:i})=>{const n=!An.some(([,,r])=>r===i.ratio),e=An.map(([r,s,o])=>P("wa-option",{value:String(o)},`${r} [${s}]`));return n&&e.unshift(P("wa-option",{value:"custom"},"Custom")),P(".aspect-ratio-picker",[P("wa-select",{label:"Aspect Ratio",size:"small",disabled:i.disabled,value:n?"custom":String(i.ratio),onchange:r=>{r.redraw=!1;const o=r.target.value;o&&o!=="custom"&&i.onChange(Number(o))}},e),P("wa-slider",{min:.25,max:4,step:.01,"with-tooltip":!0,size:"small",disabled:i.disabled,value:i.ratio,onchange:r=>{r.redraw=!1;const s=r.target;i.onChange(s.value)}})])}},Ln={view:({attrs:i})=>P("wa-color-picker",{label:i.label,value:i.color,size:i.size??"medium",format:"rgb",onchange:n=>{n.redraw=!1;const e=n.target;i.onUpdate(e.value??"")}})},yr=[["rectangle","Rectangle"],["circle","Circle"],["ellipse","Ellipse"],["rounded-rect","Rounded Rectangle"]],vr={view:({attrs:i})=>{const n=yr.map(([e,r])=>P("wa-option",{value:e},r));return P("wa-select",{label:"Border Shape",size:"small",disabled:i.disabled,value:i.shape,onchange:e=>{e.redraw=!1;const s=e.target.value;s&&i.onChange(s)}},n)}},ye=10,Nt="#2196F3",Rn=2,wr="#999999",Pr=1,xr=[4,4],Hn=.5,br=15,Cr=10,Ir="#4CAF50",Sr=2,zr=.1,Mr=10,Ft=1,Er=.025,kr=[.25,.5,1,2,4],Tr=["25%","50%","100%","200%","400%"];let Ke=null,Ze=null,Qe=null,Je=null,et=null,ve=null,ke=!1,pe=null;function _r(i,n,e){if(!i.paperCtx)throw new Error("PathEditor: Cannot setup mouse handling - Paper.js context not initialized");const r=W(i.paperCtx,"PathEditor:setupTool",()=>{const s=i.paperCtx.scope;return new s.Tool});return Ke=s=>{const o=s.target;o.tagName==="INPUT"||o.tagName==="WA-INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable||(s.code==="Space"?(s.preventDefault(),i.isSpacebarPressed||(i.isSpacebarPressed=!0,Z(i))):s.key==="Shift"&&!i.isShiftPressed?(i.isShiftPressed=!0,Z(i)):(s.code==="Delete"||s.code==="Backspace")&&(i.mode==="edit"&&i.selectedSegment&&i.path&&i.paperCtx&&i.path.segments.length>2&&(i.selectedSegment.remove(),i.selectedSegment=null,i.selectedHandle=null,W(i.paperCtx,"PathEditor:deleteSegment",()=>{n()})),s.preventDefault()))},Ze=s=>{const o=s.target;o.tagName==="INPUT"||o.tagName==="WA-INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable||(s.code==="Space"?(i.isSpacebarPressed=!1,Z(i),s.preventDefault()):s.key==="Shift"&&(i.isShiftPressed=!1,Z(i)))},Qe=s=>{if(s.preventDefault(),!i.paperCtx)return;const o=i.paperCtx.scope,a=-Math.sign(s.deltaY)*Er,c=Math.max(zr,Math.min(Mr,i.zoom+a));if(c!==i.zoom){const l=new o.Point(s.offsetX,s.offsetY),u=o.view.viewToProject(l),d=c/i.zoom;o.view.scale(d,u),i.zoom=c,e()}},Je=s=>{i.isSpacebarPressed&&(ke=!0,pe={x:s.clientX,y:s.clientY},Z(i),s.preventDefault())},et=s=>{if(i.isSpacebarPressed&&s.preventDefault(),ke&&pe){if(!i.paperCtx)return;const o=i.paperCtx.scope,a=s.clientX-pe.x,c=s.clientY-pe.y,l=a/i.zoom,u=c/i.zoom;o.view.translate(new o.Point(l,u)),pe={x:s.clientX,y:s.clientY}}},ve=()=>{ke&&(ke=!1,pe=null,Z(i))},window.addEventListener("keydown",Ke),window.addEventListener("keyup",Ze),i.canvas&&(i.canvas.addEventListener("wheel",Qe,{passive:!1}),i.canvas.addEventListener("mousedown",Je),i.canvas.addEventListener("mousemove",et),i.canvas.addEventListener("mouseup",ve),i.canvas.addEventListener("mouseleave",ve)),r.onMouseDown=s=>{i.isSpacebarPressed||(i.mode==="draw"?Ar(i,s,n):Rr(i,s))},r.onMouseDrag=s=>{i.isSpacebarPressed||(i.mode==="draw"?Lr(i,s):Hr(i,s))},r.onMouseUp=()=>{i.isSpacebarPressed||(i.mode==="draw"?i.pendingPoint&&i.path&&i.paperCtx&&(W(i.paperCtx,"PathEditor:onMouseUp",()=>{const s=i.paperCtx.scope;if(i.isDraggingCurve&&i.previewPath&&i.previewPath.segments.length>0){const o=i.previewPath.lastSegment,a=new s.Segment(i.pendingPoint,o.handleIn,o.handleOut);if(i.path.add(a),i.path.segments.length>1&&i.previewPath.segments.length>1){const c=i.path.segments[i.path.segments.length-2],l=i.previewPath.segments[0];c.handleOut=l.handleOut}}else i.path.add(i.pendingPoint);i.pendingPoint=null,i.isDraggingCurve=!1,i.previewPath&&(i.previewPath.removeSegments(),i.previewPath.visible=!1),n()}),Z(i)):i.paperCtx&&W(i.paperCtx,"PathEditor:onMouseUp-editMode",()=>{n()}))},r.onMouseMove=s=>{i.isSpacebarPressed||(i.mode==="draw"?vi(i,s.point):i.mode==="edit"&&Z(i,s.point))},r.activate(),r}function Dr(i){Ke&&(window.removeEventListener("keydown",Ke),Ke=null),Ze&&(window.removeEventListener("keyup",Ze),Ze=null),i&&(Qe&&(i.removeEventListener("wheel",Qe),Qe=null),Je&&(i.removeEventListener("mousedown",Je),Je=null),et&&(i.removeEventListener("mousemove",et),et=null),ve&&(i.removeEventListener("mouseup",ve),i.removeEventListener("mouseleave",ve),ve=null)),ke=!1,pe=null}function Z(i,n){if(i.canvas){if(i.isSpacebarPressed){i.canvas.style.cursor=ke?"grabbing":"grab";return}if(i.mode==="draw"){i.isNearFirstPoint?i.canvas.style.cursor="copy":i.canvas.style.cursor="crosshair";return}if(i.mode==="edit"){if(i.isShiftPressed){i.canvas.style.cursor="crosshair";return}if(n&&i.path){if(i.selectedSegment!==null||i.path.fullySelected){const o=i.path.hitTest(n,{handles:!0,tolerance:ye});if(o?.type==="handle-in"||o?.type==="handle-out"){i.canvas.style.cursor="pointer";return}}if(i.path.hitTest(n,{segments:!0,tolerance:ye})?.segment){i.canvas.style.cursor="move";return}if(i.path.hitTest(n,{stroke:!0,tolerance:ye})){i.canvas.style.cursor="pointer";return}}}i.canvas.style.cursor="default"}}function Ar(i,n,e){if(!(!i.path||!i.paperCtx)){if(i.isNearFirstPoint&&i.path.segments.length>=2){i.path.closed=!0,i.snapIndicator&&(i.snapIndicator.visible=!1),i.mode="edit",i.isNearFirstPoint=!1,i.previewPath&&(i.previewPath.removeSegments(),i.previewPath.visible=!1),W(i.paperCtx,"PathEditor:closePathBySnapping",()=>{e()});return}i.path.segments.length>0&&W(i.paperCtx,"PathEditor:handleDrawModeDown",()=>{const r=i.paperCtx.scope,s=i.path.lastSegment;s.handleOut&&s.handleOut.length>0&&(s.handleOut=new r.Point(0,0))}),i.pendingPoint=n.point.clone(),i.isDraggingCurve=!1,vi(i,n.point)}}function Lr(i,n){!i.path||!i.previewPath||!i.pendingPoint||!i.paperCtx||W(i.paperCtx,"PathEditor:handleDrawModeDrag",()=>{const e=i.paperCtx.scope;i.isDraggingCurve=!0;const r=i.pendingPoint,s=n.point.subtract(r),o=s.multiply(Hn),a=s.multiply(-Hn);let c=new e.Point(0,0);if(i.path.segments.length>0){const l=i.path.lastSegment,u=r.subtract(l.point);if(i.path.segments.length>1)if(l.handleIn&&l.handleIn.length>0){const p=l.handleIn.normalize(),g=u.length;c=p.multiply(-g)}else if(i.path.segments.length>1){const p=i.path.segments[i.path.segments.length-2];c=l.point.subtract(p.point).multiply(.33)}else c=u.multiply(.33);i.previewPath.removeSegments();const d=new e.Segment(l.point,new e.Point(0,0),c);i.previewPath.add(d);const h=new e.Segment(r,a,o);i.previewPath.add(h),i.previewPath.visible=!0}else{i.previewPath.removeSegments();const l=new e.Segment(r,a,o);i.previewPath.add(l),i.previewPath.visible=!0}})}function vi(i,n){!i.previewPath||!i.path||!i.paperCtx||W(i.paperCtx,"PathEditor:updatePreviewPath",()=>{const e=i.paperCtx.scope;if(i.previewPath.removeSegments(),i.isNearFirstPoint=!1,i.snapIndicator&&(i.snapIndicator.visible=!1),i.path.segments.length>0){const r=i.path.lastSegment.point;if(i.path.segments.length>=2){const s=i.path.firstSegment.point;if(n.getDistance(s)<br){i.isNearFirstPoint=!0,i.previewPath.moveTo(r),i.previewPath.lineTo(s),i.previewPath.visible=!0,i.snapIndicator?(i.snapIndicator.position=s,i.snapIndicator.visible=!0):i.snapIndicator=new e.Path.Circle({center:s,radius:Cr,strokeColor:new e.Color(Ir),strokeWidth:Sr,fillColor:null}),Z(i);return}}i.previewPath.moveTo(r),i.previewPath.lineTo(n),i.previewPath.visible=!0,Z(i)}else i.previewPath.visible=!1,Z(i)})}function Rr(i,n){if(!i.path)return;if(i.isShiftPressed){const o=i.path.hitTest(n.point,{stroke:!0,tolerance:ye});if(o?.location){const a=o.location,c=i.path.insert(a.index+1,a.point);for(const l of i.path.segments)l.selected=!1;c.selected=!0,i.selectedSegment=c,i.selectedHandle=null,i.path.fullySelected=!1;return}return}if(i.selectedSegment!==null||i.path.fullySelected){const o=i.path.hitTest(n.point,{handles:!0,tolerance:ye});if(o?.type==="handle-in"||o?.type==="handle-out"){i.selectedHandle={segment:o.segment,type:o.type==="handle-in"?"handleIn":"handleOut"},i.selectedSegment=null;return}}const r=i.path.hitTest(n.point,{segments:!0,tolerance:ye});if(r?.segment){for(const o of i.path.segments)o.selected=!1;i.selectedSegment=r.segment,i.selectedSegment.selected=!0,i.selectedHandle=null;return}if(i.path.hitTest(n.point,{stroke:!0,tolerance:ye})){i.path.fullySelected=!0,i.selectedSegment=null,i.selectedHandle=null;return}i.selectedSegment=null,i.selectedHandle=null,i.path.selected=!1,i.path.fullySelected=!1;for(const o of i.path.segments)o.selected=!1}function Hr(i,n){if(i.selectedSegment)i.selectedSegment.point=i.selectedSegment.point.add(n.delta);else if(i.selectedHandle){const{segment:e,type:r}=i.selectedHandle,s=n.point.subtract(e.point);r==="handleOut"?e.handleOut=s:e.handleIn=s}}const Or=()=>{const i={canvas:null,paperCtx:null,path:null,previewPath:null,mode:"draw",selectedSegment:null,selectedHandle:null,zoom:Ft,isSpacebarPressed:!1,isShiftPressed:!1,pendingPoint:null,isDraggingCurve:!1,isNearFirstPoint:!1,snapIndicator:null};let n=null,e;const r=(u,d)=>{if(i.paperCtx=Qn(u,d.width,d.height),i.canvas=u,!i.paperCtx){console.error("PathEditor: Failed to create Paper.js context");return}W(i.paperCtx,"PathEditor:initializePaper",()=>{const h=i.paperCtx.scope;if(!xt(h,"PathEditor:initializePaper")){console.error("PathEditor: Paper.js not ready - canvas may have been replaced");return}h.settings.handleSize=8;const f=d.initialPath&&d.initialPath.length>0;if(i.mode=f?"edit":"draw",i.path=new h.Path,i.path.strokeColor=new h.Color(d.strokeColor??Nt),i.path.strokeWidth=Rn,f&&d.initialPath){const p=Kt(d.initialPath,i.paperCtx);i.path.segments=p.segments,i.path.strokeColor=new h.Color(d.strokeColor??Nt),i.path.strokeWidth=Rn}i.previewPath=new h.Path,i.previewPath.strokeColor=new h.Color(wr),i.previewPath.strokeWidth=Pr,i.previewPath.dashArray=xr,i.previewPath.visible=!1,n=_r(i,()=>{s(d)},()=>{P.redraw()})})},s=u=>{if(i.path){const d=Vi(i.path);u.onPathChanged(d)}P.redraw()},o=u=>{i.mode==="draw"&&(i.mode="edit",i.pendingPoint=null,i.isDraggingCurve=!1,i.isNearFirstPoint=!1,i.previewPath&&(i.previewPath.removeSegments(),i.previewPath.visible=!1),i.snapIndicator&&(i.snapIndicator.visible=!1),s(u))},a=()=>{n&&(n.remove(),n=null),Dr(i.canvas),i.paperCtx&&i.paperCtx.scope.project.remove(),i.canvas=null,i.paperCtx=null,i.path=null,i.previewPath=null,i.snapIndicator=null,i.selectedSegment=null,i.selectedHandle=null},c=u=>{if(u===i.zoom||!i.paperCtx)return;const d=i.paperCtx.scope,h=u/i.zoom;d.view.scale(h,d.view.center),i.zoom=u,P.redraw()},l=()=>`${Math.round(i.zoom*100)}%`;return{oncreate:({dom:u,attrs:d})=>{const h=u.querySelector("canvas");h&&(r(h,d),e=d.initialPath)},onremove:()=>{a()},onupdate:({attrs:u})=>{if(!i.path||!i.paperCtx||(u.strokeColor&&(i.path.strokeColor=new i.paperCtx.scope.Color(u.strokeColor)),u.initialPath===e))return;const d=e?.length??0,h=u.initialPath?.length??0;if(e=u.initialPath,d===h)return;u.initialPath&&u.initialPath.length>0?u.initialPath&&i.paperCtx&&W(i.paperCtx,"PathEditor:onupdate-loadPath",()=>{const p=i.paperCtx.scope;if(!xt(p,"PathEditor:onupdate-loadPath")){console.error("PathEditor: Paper.js not ready during path reload - canvas may have been replaced");return}i.path.removeSegments();const g=Kt(u.initialPath,i.paperCtx);i.path.segments=g.segments,i.path.strokeColor=new p.Color(u.strokeColor??Nt),i.mode="edit",i.selectedSegment=null,i.selectedHandle=null,i.pendingPoint=null,i.isDraggingCurve=!1,i.isNearFirstPoint=!1,i.snapIndicator&&(i.snapIndicator.visible=!1),P.redraw()}):(i.path.removeSegments(),i.mode="draw",i.selectedSegment=null,i.selectedHandle=null,i.pendingPoint=null,i.isDraggingCurve=!1,i.isNearFirstPoint=!1,i.snapIndicator&&(i.snapIndicator.visible=!1),P.redraw())},view:({attrs:u})=>{const d=l();return P(".path-editor",[P("canvas",{key:"path-editor-canvas",width:u.width,height:u.height,style:{width:`${u.width}px`,height:`${u.height}px`}}),P(".path-editor-controls",{key:"path-editor-controls"},[P(".mode-indicator",`Mode: ${i.mode==="draw"?"Drawing":"Editing"}`),i.mode==="draw"&&P("wa-button.end-drawing-button",{variant:"success",size:"small",onclick:()=>o(u)},"End Drawing"),P("wa-dropdown.zoom-control",{"onwa-select":h=>{h.redraw=!1;const f=h.detail.item.value;if(f&&typeof f=="string"){const p=parseFloat(f);isNaN(p)||c(p)}}},[P("wa-button",{slot:"trigger","with-caret":!0,size:"small",value:i.zoom},d),...kr.map((h,f)=>P("wa-dropdown-item",{type:"checkbox",checked:i.zoom==h?!0:void 0,value:h.toString()},Tr[f]))]),P("wa-tooltip",{for:"recenter-button"},"Recenter view"),P("wa-button#recenter-button",{appearance:"plain",size:"large",onclick:()=>{i.paperCtx&&W(i.paperCtx,"PathEditor:recenter",()=>{const h=i.paperCtx.scope,f=Ft/i.zoom;h.view.scale(f,h.view.center),i.zoom=Ft,h.view.center=new h.Point(h.view.viewSize.width/2,h.view.viewSize.height/2)})}},P("wa-icon",{library:"material",name:"recenter",label:"Recenter view"}))])])}}};function $r(i,n,e){const[r,s]=i,{position:o,rotation:a,scale:c}=e,l=r-n[0],u=s-n[1],d=l*c[0],h=u*c[1],f=Math.cos(a),p=Math.sin(a),g=d*f-h*p,y=d*p+h*f,m=g+o[0],v=y+o[1];return[m,v]}function hn(i,n=.5){const e=[];let r=[0,0];for(const s of i)switch(s.type){case"move":r=s.p,e.push(r);break;case"line":r=s.p,e.push(r);break;case"bezier":{const o=Math.max(8,Math.ceil(Math.hypot(s.p3[0]-r[0],s.p3[1]-r[1])/n));for(let a=1;a<=o;a++){const c=a/o,l=c*c,u=l*c,d=1-c,h=d*d,f=h*d,p=f*r[0]+3*h*c*s.p1[0]+3*d*l*s.p2[0]+u*s.p3[0],g=f*r[1]+3*h*c*s.p1[1]+3*d*l*s.p2[1]+u*s.p3[1];e.push([p,g])}r=s.p3;break}case"arc":{const o=Math.max(8,Math.ceil(Math.hypot(s.p[0]-r[0],s.p[1]-r[1])/n));for(let a=1;a<=o;a++){const c=a/o,l=r[0]+c*(s.p[0]-r[0]),u=r[1]+c*(s.p[1]-r[1]);e.push([l,u])}r=s.p;break}}return e}function at(i){const n=hn(i.path);if(n.length===0)return[];const e=ee(n),r=[(e[0]+e[2])/2,(e[1]+e[3])/2];return n.map(o=>$r(o,r,i.transform))}function wi(i,n){const e=[],r=ee(i);for(const s of n){const o=at(s),a=ee(o);if(!ci(r,a))continue;let c=!1;for(const l of i)if(Ae(l,o)){c=!0;break}if(!c){for(const l of o)if(Ae(l,i)){c=!0;break}}c&&e.push(s)}return e}function Pi(i,n){let e=[i.map(r=>[r[0],r[1]])];for(const r of n){const o=[at(r).map(c=>[c[0],c[1]])],a=ai(e,o);if(!a||a.length===0)return null;e=a}if(Array.isArray(e)&&e.length>0){const r=[];for(const s of e)if(Array.isArray(s)&&s.length>0){const o=s[0];if(Array.isArray(o)){const a=o.map(c=>Array.isArray(c)&&c.length>=2?[c[0],c[1]]:[0,0]);r.push(a)}}return r.length>0?r:null}return null}function Nr(i,n,e){const r=at(i),s=r.reduce((l,u)=>[l[0]+u[0],l[1]+u[1]],[0,0]),o=[s[0]/r.length,s[1]/r.length],a={id:n,site:o,halfEdge:-1,bounds:ee(r),isCustomPiece:!0},c=un(r,n,e);return c.length>0&&(a.halfEdge=c[0].id),a}function Fr(i){const n=hn(i);if(n.length===0)return[0,0,0,0];let e=n[0][0],r=n[0][1],s=n[0][0],o=n[0][1];for(let a=1;a<n.length;a++){const[c,l]=n[a];c<e&&(e=c),c>s&&(s=c),l<r&&(r=l),l>o&&(o=l)}return[e,r,s,o]}function Vr(i,n,e,r){const[s,o,a,c]=Fr(i),l=a-s,u=c-o,d=Math.max(l,u),h=d>0?r/d:1;return{position:[n/2,e/2],rotation:0,scale:[h,h]}}function xi(i,n=.01){if(i.length<2)return!1;let e=null;for(const c of i)if(c.type==="move"){e=c.p;break}if(!e)return!1;let r=null;for(let c=i.length-1;c>=0;c--){const l=i[c];switch(l.type){case"move":case"line":r=l.p;break;case"bezier":r=l.p3;break;case"arc":r=l.p;break}if(r)break}if(!r)return!1;const s=e[0]-r[0],o=e[1]-r[1];return Math.sqrt(s*s+o*o)<=n}function Ur(i,n,e,r){const[s,o]=i,[a,c]=n,[l,u]=e,[d,h]=r,f=(s-a)*(u-h)-(o-c)*(l-d);if(Math.abs(f)<1e-10)return null;const p=((s-l)*(u-h)-(o-u)*(l-d))/f,g=-((s-a)*(o-u)-(o-c)*(s-l))/f;if(p>0&&p<1&&g>0&&g<1){const y=s+p*(a-s),m=o+p*(c-o);return[y,m]}return null}function mt(i,n,e){const r=i[0]-n[0],s=i[1]-n[1];return Math.sqrt(r*r+s*s)<=e}function Gr(i,n,e,r,s){return mt(i,e,s)||mt(i,r,s)||mt(n,e,s)||mt(n,r,s)}function jr(i){const n=hn(i);if(n.length<4)return[];const e=[],r=1;for(let s=0;s<n.length-1;s++)for(let o=s+2;o<n.length-1;o++){const a=n[s],c=n[s+1],l=n[o],u=n[o+1];if(Gr(a,c,l,u,r))continue;const d=Ur(a,c,l,u);d&&e.push(d)}return e}function On(i){const n=[];let e;xi(i)||n.push("Path must be closed (first point must equal last point)");const r=jr(i);return r.length>0&&(n.push(`Path has ${r.length} self-intersection${r.length>1?"s":""}`),e=r),{isValid:n.length===0,errors:n,intersections:e}}function Br(i){try{const e=new DOMParser().parseFromString(i,"image/svg+xml"),r=e.querySelector("parsererror");if(r)return console.error("[SVGParser] XML parsing error:",r.textContent),{commands:[],warning:"Failed to parse SVG"};const s=e.querySelector("path");if(!s)return console.error("[SVGParser] No path element found in SVG"),{commands:[],warning:"Failed to parse SVG: no path element"};const o=s.getAttribute("d");return o?Wr(o):(console.error("[SVGParser] Path element has no d attribute"),{commands:[],warning:"Failed to parse SVG: Path element has no d attribute"})}catch(n){return console.error("[SVGParser] Error parsing SVG:",n),{commands:[],warning:"Failed to parse SVG"}}}function Wr(i){const n=[];let e=!1;const s=i.replace(/([MmLlHhVvCcSsQqTtAaZz])/g," $1 ").replace(/(\d)-/g,"$1 -").replace(/,/g," ").replace(/\s+/g," ").trim().split(" ").filter(m=>m.length>0);let o=0,a=0,c=0,l=0,u=0,d=0,h=0,f="",p=!0;const g=()=>{const m=parseFloat(s[o]);return o++,m};for(;o<s.length;){let m=s[o];isNaN(parseFloat(m))?o++:f==="M"?m="L":f==="m"?m="l":m=f;const v=m===m.toLowerCase();switch(m.toUpperCase()){case"M":{if(!p){e=!0,o=s.length;break}p=!1;const x=g(),T=g();v?(a+=x,c+=T):(a=x,c=T),l=a,u=c,n.push({type:"move",p:[a,c]}),f=m;break}case"L":{const x=g(),T=g();v?(a+=x,c+=T):(a=x,c=T),n.push({type:"line",p:[a,c]}),d=a,h=c,f=m;break}case"H":{const x=g();v?a+=x:a=x,n.push({type:"line",p:[a,c]}),d=a,h=c,f=m;break}case"V":{const x=g();v?c+=x:c=x,n.push({type:"line",p:[a,c]}),d=a,h=c,f=m;break}case"C":{const x=g(),T=g(),S=g(),I=g(),E=g(),b=g();let C=x,M=T,z=S,k=I,_=E,A=b;v&&(C+=a,M+=c,z+=a,k+=c,_+=a,A+=c),n.push({type:"bezier",p1:[C,M],p2:[z,k],p3:[_,A]}),d=z,h=k,a=_,c=A,f=m;break}case"S":{const x=g(),T=g(),S=g(),I=g(),E=2*a-d,b=2*c-h;let C=x,M=T,z=S,k=I;v&&(C+=a,M+=c,z+=a,k+=c),n.push({type:"bezier",p1:[E,b],p2:[C,M],p3:[z,k]}),d=C,h=M,a=z,c=k,f=m;break}case"Q":{const x=g(),T=g(),S=g(),I=g();let E=x,b=T,C=S,M=I;v&&(E+=a,b+=c,C+=a,M+=c);const z=a+2/3*(E-a),k=c+2/3*(b-c),_=C+2/3*(E-C),A=M+2/3*(b-M);n.push({type:"bezier",p1:[z,k],p2:[_,A],p3:[C,M]}),d=E,h=b,a=C,c=M,f=m;break}case"T":{const x=g(),T=g(),S=2*a-d,I=2*c-h;let E=x,b=T;v&&(E+=a,b+=c);const C=a+2/3*(S-a),M=c+2/3*(I-c),z=E+2/3*(S-E),k=b+2/3*(I-b);n.push({type:"bezier",p1:[C,M],p2:[z,k],p3:[E,b]}),d=S,h=I,a=E,c=b,f=m;break}case"A":{g(),g(),g(),g(),g();const x=g(),T=g();let S=x,I=T;v&&(S+=a,I+=c),n.push({type:"line",p:[S,I]}),a=S,c=I,d=S,h=I,f=m;break}case"Z":{(a!==l||c!==u)&&(n.push({type:"line",p:[l,u]}),a=l,c=u),f=m;break}}}const y={commands:n};return e&&(y.warning="This SVG contains a compound path. Only the first subpath was imported."),y}const bi=({attrs:i})=>{const n={el:null,currentAttrs:null,lastNotifiedOpen:i.open,cleanup:()=>{}},e=a=>{n.el&&n.el.open!==a&&(n.el.open=a)},r=a=>{n.lastNotifiedOpen!==a&&(n.lastNotifiedOpen=a,n.currentAttrs?.onStateChanged?.(a))},s=()=>r(!0),o=()=>r(!1);return{oncreate:({attrs:a,dom:c})=>{n.el=c,n.currentAttrs=a,e(a.open),n.el.addEventListener("wa-after-show",s),n.el.addEventListener("wa-after-hide",o),n.cleanup=()=>{n.el?.removeEventListener("wa-after-show",s),n.el?.removeEventListener("wa-after-hide",o),n.el=null,n.currentAttrs=null}},onupdate:({attrs:a})=>{n.currentAttrs=a,e(a.open)},onremove:()=>{n.cleanup()},view:({attrs:a,children:c})=>P("wa-dialog",{id:a.id,label:a.title,class:a.class??a.className,style:{"--width":a.width},open:a.open},a.contentKey!=null?P("div",{key:a.contentKey},c):c)}},qr=()=>{const i={initialPath:[],path:[],name:"",validation:{isValid:!1,errors:[]},prevOpen:!1,prevPieceId:null,contentKey:"initial"};let n=null;const e=c=>{c.piece?(i.contentKey=c.piece.id,i.initialPath=c.piece.path,i.path=c.piece.path,i.name=c.piece.name??"",i.validation=On(i.path)):(i.contentKey=`new-${Date.now()}`,i.initialPath=[],i.path=[],i.name="",i.validation={isValid:!1,errors:[]})},r=c=>{if(i.path=c,c.length===0)i.validation={isValid:!1,errors:[]};else{const l=On(c);i.validation=l}},s=c=>{i.name=c},o=c=>{i.validation.isValid&&c.onSave(i.path,i.name.length>0?i.name:void 0)},a=(c,l,u)=>{if(!c||c.length===0)return;const d=c[0];if(!d.name.endsWith(".svg")){console.error("Please select an SVG file");return}const h=new FileReader;h.onload=f=>{const p=f.target?.result;if(p){const g=Br(p);if(g.warning&&console.warn("SVG import warning:",g.warning),g.commands.length>0){const y=Xo(g.commands,l,u);if(i.initialPath=y,r(y),!i.name){const m=d.name.replace(/\.svg$/i,"");s(m)}P.redraw()}else console.error("Failed to parse SVG file")}},h.readAsText(d)};return{view:({attrs:c})=>{const l=c.piece?.id??null,u=c.open&&!i.prevOpen,d=l!==i.prevPieceId;c.open&&(u||d)&&e(c),i.prevOpen=c.open,i.prevPieceId=l;const h=c.editorWidth??600,f=c.editorHeight??600;return P(bi,{open:c.open,title:c.piece?"Edit Whimsy":"Create Whimsy",className:"custom-piece-editor",width:"50vw",contentKey:i.contentKey,onStateChanged:p=>{p||c.onCancel()}},[P(".editor-content",[P(yi,{config:{type:"string",name:"name",label:"Piece Name (optional)",optional:!0},value:i.name,onChange:p=>{i.name=p??"",P.redraw()}}),i.path.length>0&&(i.validation.isValid?xi(i.path)&&P(".validation-status",[P(".valid",[P("wa-icon",{library:"material",name:"check_circle",style:"color: green;"}),P("span","Valid piece")])]):i.validation.errors.length>0&&P(".validation-status",[P(".invalid",[P("wa-icon",{library:"material",name:"error",style:"color: red;"}),P("span",i.validation.errors.join(", "))])])),P(".editor-canvas",[P(Or,{initialPath:i.initialPath,onPathChanged:r,width:h,height:f,strokeColor:i.validation.isValid?"#2196F3":"#f44336"})]),P(".import-controls",[P("input",{type:"file",accept:".svg",style:"display: none;",oncreate:p=>{n=p.dom},onchange:p=>{p.redraw=!1;const g=p.target;a(g.files,h,f),g.value=""}}),P("wa-button",{variant:"default",size:"small",onclick:p=>{p.redraw=!1,n?.click()}},"Import SVG")])]),P("div",{slot:"footer",style:"display: flex; gap: 8px; justify-content: flex-end;"},[P("wa-button",{variant:"default",onclick:p=>{p.redraw=!1,c.onCancel()}},"Cancel"),P("wa-button",{variant:"primary",disabled:!i.validation.isValid,onclick:p=>{p.redraw=!1,o(c)}},"Save")])])}}};function Xr(i,n,e,r,s=10){const o=document.createElement("canvas");o.width=n,o.height=e;const a=o.getContext("2d");if(!a||i.length===0)return"";a.clearRect(0,0,n,e);const c=Yr(i);if(!c)return"";const[l,u,d,h]=c,f=d-l,p=h-u,g=n-2*s,y=e-2*s,m=Math.min(g/f,y/p),v=f*m,w=p*m,x=s+(g-v)/2-l*m,T=s+(y-w)/2-u*m,S=(I,E)=>[I*m+x,E*m+T];a.beginPath();for(const I of i)switch(I.type){case"move":{const[E,b]=S(I.p[0],I.p[1]);a.moveTo(E,b);break}case"line":{const[E,b]=S(I.p[0],I.p[1]);a.lineTo(E,b);break}case"bezier":{const[E,b]=S(I.p1[0],I.p1[1]),[C,M]=S(I.p2[0],I.p2[1]),[z,k]=S(I.p3[0],I.p3[1]);a.bezierCurveTo(E,b,C,M,z,k);break}case"arc":{const[E,b]=S(I.p[0],I.p[1]);a.lineTo(E,b);break}}return a.strokeStyle=r,a.lineWidth=2,a.stroke(),o.toDataURL("image/png")}function Yr(i){if(i.length===0)return null;let n=1/0,e=1/0,r=-1/0,s=-1/0;const o=(a,c)=>{n=Math.min(n,a),e=Math.min(e,c),r=Math.max(r,a),s=Math.max(s,c)};for(const a of i)switch(a.type){case"move":case"line":case"arc":o(a.p[0],a.p[1]);break;case"bezier":o(a.p1[0],a.p1[1]),o(a.p2[0],a.p2[1]),o(a.p3[0],a.p3[1]);break}return n===1/0?null:[n,e,r,s]}const Kr={view:({attrs:i})=>P(".custom-piece-tile",{key:i.piece.id,class:i.isSelected?"selected":"",onclick:n=>{n.redraw=!1,i.onClick()},ondblclick:n=>{n.redraw=!1,i.onDoubleClick()}},[P(".custom-piece-tile-thumbnail",i.thumbnail?P("img",{src:i.thumbnail,alt:i.piece.name??"Custom piece"}):P(".custom-piece-tile-placeholder",P("wa-icon",{name:"puzzle-piece"}))),P(".custom-piece-tile-name",i.piece.name??"Unnamed"),i.isSelected?P(".custom-piece-tile-selected-indicator",P("wa-icon",{name:"check-circle"})):null])};function Zr(i){const n=document.createElement("div");document.body.appendChild(n);let e=!1;const r=l=>{e||(e=!0,s(),o(l))},s=()=>{try{P.mount(n,null)}catch(l){console.warn("confirm(): unable to mount Mithril component: ",l)}n.remove()};let o;const a=new Promise(l=>{o=l}),c=()=>{const l={open:!0,contentKey:Math.random()},u=h=>{l.open=!1,P.redraw(),d=h};let d=null;return{view(){return P(bi,{id:i.id,title:i.title,width:i.width,open:l.open,contentKey:l.contentKey,onStateChanged:h=>{!h&&d!==null&&r(d),!h&&d===null&&e===!1&&r(!1)}},[P(".confirm-body",i.body??"Are you sure?"),P(".confirm-actions",{slot:"footer"},[P("wa-button.btn-cancel",{variant:"neutral",size:"small","data-dialog":"close",onclick:h=>{h.redraw=!1,u(!1)}},i.cancelLabel??"Cancel"),P("wa-button.btn-confirm",{variant:"brand",size:"small","data-dialog":"close",onclick:h=>{h.redraw=!1,u(!0)}},i.confirmLabel??"OK")])])}}};return P.mount(n,c),a}const Qr=()=>{const i=new Map,n=(e,r)=>{const s=e.modified??e.created,o=`${e.id}-${s}-${r}`;if(!i.has(o)){const a=Xr(e.path,100,100,r);i.set(o,a)}return i.get(o)??""};return{view:({attrs:e})=>{const r=e.selectedPieceId!==null&&e.selectedPieceId!==void 0,s=r?e.pieces.find(o=>o.id===e.selectedPieceId):null;return P(".whimsy-manager",[P(".whimsy-manager-header",[P("h3","Whimsy Pieces"),P("wa-button",{variant:"primary",size:"small",onclick:o=>{o.redraw=!1,e.onAdd()}},[P("wa-icon",{name:"plus",slot:"prefix"}),"Add"])]),P(".whimsy-grid",e.pieces.length===0?P(".whimsy-empty-state",[P("wa-icon",{name:"puzzle-piece",style:"font-size: 48px; opacity: 0.3;"}),P("p","No whimsy pieces yet"),P("p.hint",'Click "Add" to create one')]):e.pieces.map(o=>{const a=o.id===e.selectedPieceId,c=n(o,e.pieceColor);return P(Kr,{key:o.id,piece:o,isSelected:a,thumbnail:c,onClick:()=>{a?e.onSelect(null):e.onSelect(o.id)},onDoubleClick:()=>{e.onEdit(o.id)}})})),P(".whimsy-actions",[P("wa-button",{size:"small",disabled:!r,onclick:o=>{o.redraw=!1,s&&e.onEdit(s.id)}},[P("wa-icon",{name:"pencil",slot:"prefix"}),"Edit"]),P("wa-button",{size:"small",disabled:!r,onclick:o=>{o.redraw=!1,s&&e.onDuplicate(s.id)}},[P("wa-icon",{name:"copy",slot:"prefix"}),"Duplicate"]),P("wa-button",{size:"small",variant:"danger",disabled:!r,onclick:async o=>{o.redraw=!1,s&&await Zr({title:"Delete piece?",body:`Are you sure you want to delete ${s.name??"this piece"}?`,confirmLabel:"Delete"})&&e.onDelete(s.id)}},[P("wa-icon",{name:"trash",slot:"start"}),"Delete"]),P("wa-button",{size:"small",disabled:!r,onclick:o=>{o.redraw=!1,s&&e.onPosition(s.id)}},[P("wa-icon",{name:"arrows-up-down-left-right",slot:"prefix"}),"Position"])])])}}};var Vt,$n;function Ci(){if($n)return Vt;$n=1;function i(e){var r=e.length,s=1,o=new Array(r),a;for(a=r;a>0;a--)o[a-1]=s,s=s*e[a-1];return{stride:o,data:new Uint32Array(s)}}function n(e){var r=e.length,s=1,o=new Array(r),a=[],c,l;for(c=r;c>0;c--)o[c-1]=s,s=s*e[c-1];for(l=0;l<s;l++)a.push([]);return{stride:o,data:a}}return Vt={integer:i,array:n},Vt}var Ut,Nn;function Ii(){if(Nn)return Ut;Nn=1,Ut=i;function i(n,e){var r=new Array(n),s=Math.floor(n/2)<<1,o=0,a,c,l,u,d;for(d=0;d<s;d+=2)a=-2*Math.log(e()),c=Math.sqrt(a),l=2*Math.PI*e(),o+=a,r[d]=c*Math.cos(l),r[d+1]=c*Math.sin(l);if(n%2){var h=Math.sqrt(-2*Math.log(e()))*Math.cos(2*Math.PI*e());r[n-1]=h,o+=Math.pow(h,2)}for(u=1/Math.sqrt(o),d=0;d<n;++d)r[d]*=u;return r}return Ut}var Gt,Fn;function Jr(){return Fn||(Fn=1,Gt=function(n,e){n=n||1,e=e||2;for(var r=n*2+1,s=Math.pow(r,e)-1,o=new Array(s),a=0;a<s;a++)for(var c=o[a]=new Array(e),l=a<s/2?a:a+1,u=1;u<=e;u++){var d=l%Math.pow(r,u);c[u-1]=d/Math.pow(r,u-1)-n,l-=d}return o}),Gt}var jt,Vn;function Si(){if(Vn)return jt;Vn=1;var i=Jr();function n(s){var o=i(2,s),a=[],c;for(o=o.filter(function(l){for(var u=0,d=0;d<s;d++)u+=Math.pow(Math.max(0,Math.abs(l[d])-1),2);return u<s}),c=0;c<s;c++)a.push(0);return o.push(a),o.sort(function(l,u){var d=0,h=0,f;for(f=0;f<s;f++)d+=Math.pow(l[f],2),h+=Math.pow(u[f],2);return d<h?-1:d>h?1:0}),o}var e={};function r(s){return e[s]||(e[s]=n(s)),e[s]}return jt=r,jt}var Bt,Un;function es(){if(Un)return Bt;Un=1;var i=Ci().integer,n=Ii(),e=Si();function r(o,a){for(var c=0,l=0;l<o.length;l++)c+=Math.pow(o[l]-a[l],2);return c}function s(o,a){if(typeof o.distanceFunction=="function")throw new Error("PoissonDiskSampling: Tried to instantiate the fixed density implementation with a distanceFunction");this.shape=o.shape,this.minDistance=o.minDistance,this.maxDistance=o.maxDistance||o.minDistance*2,this.maxTries=Math.ceil(Math.max(1,o.tries||30)),this.rng=a||Math.random;for(var c=0,l=0;l<this.shape.length;l++)c=Math.max(c,this.shape[l]);var u=Math.max(1,c/128|0),d=1e-14*u;this.dimension=this.shape.length,this.squaredMinDistance=this.minDistance*this.minDistance,this.minDistancePlusEpsilon=this.minDistance+d,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.minDistance/Math.sqrt(this.dimension),this.neighbourhood=e(this.dimension),this.currentPoint=null,this.processList=[],this.samplePoints=[],this.gridShape=[];for(var l=0;l<this.dimension;l++)this.gridShape.push(Math.ceil(this.shape[l]/this.cellSize));this.grid=i(this.gridShape)}return s.prototype.shape=null,s.prototype.dimension=null,s.prototype.minDistance=null,s.prototype.maxDistance=null,s.prototype.minDistancePlusEpsilon=null,s.prototype.squaredMinDistance=null,s.prototype.deltaDistance=null,s.prototype.cellSize=null,s.prototype.maxTries=null,s.prototype.rng=null,s.prototype.neighbourhood=null,s.prototype.currentPoint=null,s.prototype.processList=null,s.prototype.samplePoints=null,s.prototype.gridShape=null,s.prototype.grid=null,s.prototype.addRandomPoint=function(){for(var o=new Array(this.dimension),a=0;a<this.dimension;a++)o[a]=this.rng()*this.shape[a];return this.directAddPoint(o)},s.prototype.addPoint=function(o){var a,c=!0;if(o.length===this.dimension)for(a=0;a<this.dimension&&c;a++)c=o[a]>=0&&o[a]<this.shape[a];else c=!1;return c?this.directAddPoint(o):null},s.prototype.directAddPoint=function(o){var a=0,c=this.grid.stride,l;for(this.processList.push(o),this.samplePoints.push(o),l=0;l<this.dimension;l++)a+=(o[l]/this.cellSize|0)*c[l];return this.grid.data[a]=this.samplePoints.length,o},s.prototype.inNeighbourhood=function(o){var a=this.dimension,c=this.grid.stride,l,u,d,h,f;for(l=0;l<this.neighbourhood.length;l++){for(u=0,d=0;d<a;d++){if(h=(o[d]/this.cellSize|0)+this.neighbourhood[l][d],h<0||h>=this.gridShape[d]){u=-1;break}u+=h*c[d]}if(u!==-1&&this.grid.data[u]!==0&&(f=this.samplePoints[this.grid.data[u]-1],r(o,f)<this.squaredMinDistance))return!0}return!1},s.prototype.next=function(){for(var o,a,c,l,u,d,h;this.processList.length>0;){for(this.currentPoint===null&&(this.currentPoint=this.processList.shift()),l=this.currentPoint,o=0;o<this.maxTries;o++){for(d=!0,c=this.minDistancePlusEpsilon+this.deltaDistance*this.rng(),this.dimension===2?(a=this.rng()*Math.PI*2,u=[Math.cos(a),Math.sin(a)]):u=n(this.dimension,this.rng),h=0;d&&h<this.dimension;h++)u[h]=l[h]+u[h]*c,d=u[h]>=0&&u[h]<this.shape[h];if(d&&!this.inNeighbourhood(u))return this.directAddPoint(u)}o===this.maxTries&&(this.currentPoint=null)}return null},s.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},s.prototype.getAllPoints=function(){return this.samplePoints},s.prototype.getAllPointsWithDistance=function(){throw new Error("PoissonDiskSampling: getAllPointsWithDistance() is not available in fixed-density implementation")},s.prototype.reset=function(){var o=this.grid.data,a=0;for(a=0;a<o.length;a++)o[a]=0;this.samplePoints=[],this.currentPoint=null,this.processList.length=0},Bt=s,Bt}var Wt,Gn;function ts(){if(Gn)return Wt;Gn=1;var i=Ci().array,n=Ii(),e=Si();function r(o,a){for(var c=0,l=0;l<o.length;l++)c+=Math.pow(o[l]-a[l],2);return Math.sqrt(c)}function s(o,a){if(typeof o.distanceFunction!="function")throw new Error("PoissonDiskSampling: Tried to instantiate the variable density implementation without a distanceFunction");this.shape=o.shape,this.minDistance=o.minDistance,this.maxDistance=o.maxDistance||o.minDistance*2,this.maxTries=Math.ceil(Math.max(1,o.tries||30)),this.distanceFunction=o.distanceFunction,this.bias=Math.max(0,Math.min(1,o.bias||0)),this.rng=a||Math.random;for(var c=0,l=0;l<this.shape.length;l++)c=Math.max(c,this.shape[l]);var u=Math.max(1,c/128|0),d=1e-14*u;this.dimension=this.shape.length,this.minDistancePlusEpsilon=this.minDistance+d,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.maxDistance/Math.sqrt(this.dimension),this.neighbourhood=e(this.dimension),this.currentPoint=null,this.currentDistance=0,this.processList=[],this.samplePoints=[],this.sampleDistance=[],this.gridShape=[];for(var l=0;l<this.dimension;l++)this.gridShape.push(Math.ceil(this.shape[l]/this.cellSize));this.grid=i(this.gridShape)}return s.prototype.shape=null,s.prototype.dimension=null,s.prototype.minDistance=null,s.prototype.maxDistance=null,s.prototype.minDistancePlusEpsilon=null,s.prototype.deltaDistance=null,s.prototype.cellSize=null,s.prototype.maxTries=null,s.prototype.distanceFunction=null,s.prototype.bias=null,s.prototype.rng=null,s.prototype.neighbourhood=null,s.prototype.currentPoint=null,s.prototype.currentDistance=null,s.prototype.processList=null,s.prototype.samplePoints=null,s.prototype.sampleDistance=null,s.prototype.gridShape=null,s.prototype.grid=null,s.prototype.addRandomPoint=function(){for(var o=new Array(this.dimension),a=0;a<this.dimension;a++)o[a]=this.rng()*this.shape[a];return this.directAddPoint(o)},s.prototype.addPoint=function(o){var a,c=!0;if(o.length===this.dimension)for(a=0;a<this.dimension&&c;a++)c=o[a]>=0&&o[a]<this.shape[a];else c=!1;return c?this.directAddPoint(o):null},s.prototype.directAddPoint=function(o){var a=0,c=this.grid.stride,l=this.samplePoints.length,u;for(this.processList.push(l),this.samplePoints.push(o),this.sampleDistance.push(this.distanceFunction(o)),u=0;u<this.dimension;u++)a+=(o[u]/this.cellSize|0)*c[u];return this.grid.data[a].push(l),o},s.prototype.inNeighbourhood=function(o){var a=this.dimension,c=this.grid.stride,l,u,d,h,f,p,g=this.distanceFunction(o);for(l=0;l<this.neighbourhood.length;l++){for(u=0,d=0;d<a;d++){if(h=(o[d]/this.cellSize|0)+this.neighbourhood[l][d],h<0||h>=this.gridShape[d]){u=-1;break}u+=h*c[d]}if(u!==-1&&this.grid.data[u].length>0)for(var y=0;y<this.grid.data[u].length;y++){f=this.samplePoints[this.grid.data[u][y]],p=this.sampleDistance[this.grid.data[u][y]];var m=Math.min(p,g),v=Math.max(p,g),w=m+(v-m)*this.bias;if(r(o,f)<this.minDistance+this.deltaDistance*w)return!0}}return!1},s.prototype.next=function(){for(var o,a,c,l,u,d,h,f;this.processList.length>0;){if(this.currentPoint===null){var p=this.processList.shift();this.currentPoint=this.samplePoints[p],this.currentDistance=this.sampleDistance[p]}for(l=this.currentPoint,u=this.currentDistance,o=0;o<this.maxTries;o++){for(h=!0,c=this.minDistancePlusEpsilon+this.deltaDistance*(u+(1-u)*this.bias),this.dimension===2?(a=this.rng()*Math.PI*2,d=[Math.cos(a),Math.sin(a)]):d=n(this.dimension,this.rng),f=0;h&&f<this.dimension;f++)d[f]=l[f]+d[f]*c,h=d[f]>=0&&d[f]<this.shape[f];if(h&&!this.inNeighbourhood(d))return this.directAddPoint(d)}o===this.maxTries&&(this.currentPoint=null)}return null},s.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},s.prototype.getAllPoints=function(){return this.samplePoints},s.prototype.getAllPointsWithDistance=function(){var o=new Array(this.samplePoints.length),a=0,c=0,l;for(a=0;a<this.samplePoints.length;a++){for(l=new Array(this.dimension+1),c=0;c<this.dimension;c++)l[c]=this.samplePoints[a][c];l[this.dimension]=this.sampleDistance[a],o[a]=l}return o},s.prototype.reset=function(){var o=this.grid.data,a=0;for(a=0;a<o.length;a++)o[a]=[];this.samplePoints=[],this.currentPoint=null,this.processList.length=0},Wt=s,Wt}var qt,jn;function ns(){if(jn)return qt;jn=1;var i=es(),n=ts();function e(r,s){this.shape=r.shape,typeof r.distanceFunction=="function"?this.implementation=new n(r,s):this.implementation=new i(r,s)}return e.prototype.implementation=null,e.prototype.addRandomPoint=function(){return this.implementation.addRandomPoint()},e.prototype.addPoint=function(r){return this.implementation.addPoint(r)},e.prototype.next=function(){return this.implementation.next()},e.prototype.fill=function(){return this.implementation.fill()},e.prototype.getAllPoints=function(){return this.implementation.getAllPoints()},e.prototype.getAllPointsWithDistance=function(){return this.implementation.getAllPointsWithDistance()},e.prototype.reset=function(){this.implementation.reset()},qt=e,qt}var is=ns();const os=Zn(is),dn="PoissonPointGenerator",rs={name:dn,displayName:"Poisson",description:"Generate seed points using Poisson disk sampling. The algorithm produces points that are tightly-packed, but no closer to each other than a specified minimum distance (the piece size), resulting in a natural, organic look.",sortHint:1,controls:[]},ss=(i,n,e)=>({generatePoints(s){const{width:o,height:a,pieceSize:c,random:l,border:u}=s;return new os({shape:[o,a],minDistance:c,tries:20},l).fill().filter(p=>ln(p,u))}});nt.register(dn,ss,rs);const oe=11102230246251565e-32,B=134217729,as=(3+8*oe)*oe;function Xt(i,n,e,r,s){let o,a,c,l,u=n[0],d=r[0],h=0,f=0;d>u==d>-u?(o=u,u=n[++h]):(o=d,d=r[++f]);let p=0;if(h<i&&f<e)for(d>u==d>-u?(a=u+o,c=o-(a-u),u=n[++h]):(a=d+o,c=o-(a-d),d=r[++f]),o=a,c!==0&&(s[p++]=c);h<i&&f<e;)d>u==d>-u?(a=o+u,l=a-o,c=o-(a-l)+(u-l),u=n[++h]):(a=o+d,l=a-o,c=o-(a-l)+(d-l),d=r[++f]),o=a,c!==0&&(s[p++]=c);for(;h<i;)a=o+u,l=a-o,c=o-(a-l)+(u-l),u=n[++h],o=a,c!==0&&(s[p++]=c);for(;f<e;)a=o+d,l=a-o,c=o-(a-l)+(d-l),d=r[++f],o=a,c!==0&&(s[p++]=c);return(o!==0||p===0)&&(s[p++]=o),p}function cs(i,n){let e=n[0];for(let r=1;r<i;r++)e+=n[r];return e}function ct(i){return new Float64Array(i)}const ls=(3+16*oe)*oe,us=(2+12*oe)*oe,hs=(9+64*oe)*oe*oe,Se=ct(4),Bn=ct(8),Wn=ct(12),qn=ct(16),X=ct(4);function ds(i,n,e,r,s,o,a){let c,l,u,d,h,f,p,g,y,m,v,w,x,T,S,I,E,b;const C=i-s,M=e-s,z=n-o,k=r-o;T=C*k,f=B*C,p=f-(f-C),g=C-p,f=B*k,y=f-(f-k),m=k-y,S=g*m-(T-p*y-g*y-p*m),I=z*M,f=B*z,p=f-(f-z),g=z-p,f=B*M,y=f-(f-M),m=M-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,Se[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,Se[1]=x-(v+h)+(h-I),b=w+v,h=b-w,Se[2]=w-(b-h)+(v-h),Se[3]=b;let _=cs(4,Se),A=us*a;if(_>=A||-_>=A||(h=i-C,c=i-(C+h)+(h-s),h=e-M,u=e-(M+h)+(h-s),h=n-z,l=n-(z+h)+(h-o),h=r-k,d=r-(k+h)+(h-o),c===0&&l===0&&u===0&&d===0)||(A=hs*a+as*Math.abs(_),_+=C*d+k*c-(z*u+M*l),_>=A||-_>=A))return _;T=c*k,f=B*c,p=f-(f-c),g=c-p,f=B*k,y=f-(f-k),m=k-y,S=g*m-(T-p*y-g*y-p*m),I=l*M,f=B*l,p=f-(f-l),g=l-p,f=B*M,y=f-(f-M),m=M-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,X[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,X[1]=x-(v+h)+(h-I),b=w+v,h=b-w,X[2]=w-(b-h)+(v-h),X[3]=b;const L=Xt(4,Se,4,X,Bn);T=C*d,f=B*C,p=f-(f-C),g=C-p,f=B*d,y=f-(f-d),m=d-y,S=g*m-(T-p*y-g*y-p*m),I=z*u,f=B*z,p=f-(f-z),g=z-p,f=B*u,y=f-(f-u),m=u-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,X[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,X[1]=x-(v+h)+(h-I),b=w+v,h=b-w,X[2]=w-(b-h)+(v-h),X[3]=b;const R=Xt(L,Bn,4,X,Wn);T=c*d,f=B*c,p=f-(f-c),g=c-p,f=B*d,y=f-(f-d),m=d-y,S=g*m-(T-p*y-g*y-p*m),I=l*u,f=B*l,p=f-(f-l),g=l-p,f=B*u,y=f-(f-u),m=u-y,E=g*m-(I-p*y-g*y-p*m),v=S-E,h=S-v,X[0]=S-(v+h)+(h-E),w=T+v,h=w-T,x=T-(w-h)+(v-h),v=x-I,h=x-v,X[1]=x-(v+h)+(h-I),b=w+v,h=b-w,X[2]=w-(b-h)+(v-h),X[3]=b;const H=Xt(R,Wn,4,X,qn);return qn[H-1]}function gt(i,n,e,r,s,o){const a=(n-o)*(e-s),c=(i-s)*(r-o),l=a-c,u=Math.abs(a+c);return Math.abs(l)>=ls*u?l:-ds(i,n,e,r,s,o,u)}const Xn=Math.pow(2,-52),yt=new Uint32Array(512);class St{static from(n,e=ys,r=vs){const s=n.length,o=new Float64Array(s*2);for(let a=0;a<s;a++){const c=n[a];o[2*a]=e(c),o[2*a+1]=r(c)}return new St(o)}constructor(n){const e=n.length>>1;if(e>0&&typeof n[0]!="number")throw new Error("Expected coords to contain numbers.");this.coords=n;const r=Math.max(2*e-5,0);this._triangles=new Uint32Array(r*3),this._halfedges=new Int32Array(r*3),this._hashSize=Math.ceil(Math.sqrt(e)),this._hullPrev=new Uint32Array(e),this._hullNext=new Uint32Array(e),this._hullTri=new Uint32Array(e),this._hullHash=new Int32Array(this._hashSize),this._ids=new Uint32Array(e),this._dists=new Float64Array(e),this.update()}update(){const{coords:n,_hullPrev:e,_hullNext:r,_hullTri:s,_hullHash:o}=this,a=n.length>>1;let c=1/0,l=1/0,u=-1/0,d=-1/0;for(let C=0;C<a;C++){const M=n[2*C],z=n[2*C+1];M<c&&(c=M),z<l&&(l=z),M>u&&(u=M),z>d&&(d=z),this._ids[C]=C}const h=(c+u)/2,f=(l+d)/2;let p,g,y;for(let C=0,M=1/0;C<a;C++){const z=Yt(h,f,n[2*C],n[2*C+1]);z<M&&(p=C,M=z)}const m=n[2*p],v=n[2*p+1];for(let C=0,M=1/0;C<a;C++){if(C===p)continue;const z=Yt(m,v,n[2*C],n[2*C+1]);z<M&&z>0&&(g=C,M=z)}let w=n[2*g],x=n[2*g+1],T=1/0;for(let C=0;C<a;C++){if(C===p||C===g)continue;const M=ms(m,v,w,x,n[2*C],n[2*C+1]);M<T&&(y=C,T=M)}let S=n[2*y],I=n[2*y+1];if(T===1/0){for(let z=0;z<a;z++)this._dists[z]=n[2*z]-n[0]||n[2*z+1]-n[1];Te(this._ids,this._dists,0,a-1);const C=new Uint32Array(a);let M=0;for(let z=0,k=-1/0;z<a;z++){const _=this._ids[z],A=this._dists[_];A>k&&(C[M++]=_,k=A)}this.hull=C.subarray(0,M),this.triangles=new Uint32Array(0),this.halfedges=new Uint32Array(0);return}if(gt(m,v,w,x,S,I)<0){const C=g,M=w,z=x;g=y,w=S,x=I,y=C,S=M,I=z}const E=gs(m,v,w,x,S,I);this._cx=E.x,this._cy=E.y;for(let C=0;C<a;C++)this._dists[C]=Yt(n[2*C],n[2*C+1],E.x,E.y);Te(this._ids,this._dists,0,a-1),this._hullStart=p;let b=3;r[p]=e[y]=g,r[g]=e[p]=y,r[y]=e[g]=p,s[p]=0,s[g]=1,s[y]=2,o.fill(-1),o[this._hashKey(m,v)]=p,o[this._hashKey(w,x)]=g,o[this._hashKey(S,I)]=y,this.trianglesLen=0,this._addTriangle(p,g,y,-1,-1,-1);for(let C=0,M,z;C<this._ids.length;C++){const k=this._ids[C],_=n[2*k],A=n[2*k+1];if(C>0&&Math.abs(_-M)<=Xn&&Math.abs(A-z)<=Xn||(M=_,z=A,k===p||k===g||k===y))continue;let L=0;for(let N=0,U=this._hashKey(_,A);N<this._hashSize&&(L=o[(U+N)%this._hashSize],!(L!==-1&&L!==r[L]));N++);L=e[L];let R=L,H;for(;H=r[R],gt(_,A,n[2*R],n[2*R+1],n[2*H],n[2*H+1])>=0;)if(R=H,R===L){R=-1;break}if(R===-1)continue;let $=this._addTriangle(R,k,r[R],-1,-1,s[R]);s[k]=this._legalize($+2),s[R]=$,b++;let O=r[R];for(;H=r[O],gt(_,A,n[2*O],n[2*O+1],n[2*H],n[2*H+1])<0;)$=this._addTriangle(O,k,H,s[k],-1,s[O]),s[k]=this._legalize($+2),r[O]=O,b--,O=H;if(R===L)for(;H=e[R],gt(_,A,n[2*H],n[2*H+1],n[2*R],n[2*R+1])<0;)$=this._addTriangle(H,k,R,-1,s[R],s[H]),this._legalize($+2),s[H]=$,r[R]=R,b--,R=H;this._hullStart=e[k]=R,r[R]=e[O]=k,r[k]=O,o[this._hashKey(_,A)]=k,o[this._hashKey(n[2*R],n[2*R+1])]=R}this.hull=new Uint32Array(b);for(let C=0,M=this._hullStart;C<b;C++)this.hull[C]=M,M=r[M];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(n,e){return Math.floor(fs(n-this._cx,e-this._cy)*this._hashSize)%this._hashSize}_legalize(n){const{_triangles:e,_halfedges:r,coords:s}=this;let o=0,a=0;for(;;){const c=r[n],l=n-n%3;if(a=l+(n+2)%3,c===-1){if(o===0)break;n=yt[--o];continue}const u=c-c%3,d=l+(n+1)%3,h=u+(c+2)%3,f=e[a],p=e[n],g=e[d],y=e[h];if(ps(s[2*f],s[2*f+1],s[2*p],s[2*p+1],s[2*g],s[2*g+1],s[2*y],s[2*y+1])){e[n]=y,e[c]=f;const v=r[h];if(v===-1){let x=this._hullStart;do{if(this._hullTri[x]===h){this._hullTri[x]=n;break}x=this._hullPrev[x]}while(x!==this._hullStart)}this._link(n,v),this._link(c,r[a]),this._link(a,h);const w=u+(c+1)%3;o<yt.length&&(yt[o++]=w)}else{if(o===0)break;n=yt[--o]}}return a}_link(n,e){this._halfedges[n]=e,e!==-1&&(this._halfedges[e]=n)}_addTriangle(n,e,r,s,o,a){const c=this.trianglesLen;return this._triangles[c]=n,this._triangles[c+1]=e,this._triangles[c+2]=r,this._link(c,s),this._link(c+1,o),this._link(c+2,a),this.trianglesLen+=3,c}}function fs(i,n){const e=i/(Math.abs(i)+Math.abs(n));return(n>0?3-e:1+e)/4}function Yt(i,n,e,r){const s=i-e,o=n-r;return s*s+o*o}function ps(i,n,e,r,s,o,a,c){const l=i-a,u=n-c,d=e-a,h=r-c,f=s-a,p=o-c,g=l*l+u*u,y=d*d+h*h,m=f*f+p*p;return l*(h*m-y*p)-u*(d*m-y*f)+g*(d*p-h*f)<0}function ms(i,n,e,r,s,o){const a=e-i,c=r-n,l=s-i,u=o-n,d=a*a+c*c,h=l*l+u*u,f=.5/(a*u-c*l),p=(u*d-c*h)*f,g=(a*h-l*d)*f;return p*p+g*g}function gs(i,n,e,r,s,o){const a=e-i,c=r-n,l=s-i,u=o-n,d=a*a+c*c,h=l*l+u*u,f=.5/(a*u-c*l),p=i+(u*d-c*h)*f,g=n+(a*h-l*d)*f;return{x:p,y:g}}function Te(i,n,e,r){if(r-e<=20)for(let s=e+1;s<=r;s++){const o=i[s],a=n[o];let c=s-1;for(;c>=e&&n[i[c]]>a;)i[c+1]=i[c--];i[c+1]=o}else{const s=e+r>>1;let o=e+1,a=r;Ve(i,s,o),n[i[e]]>n[i[r]]&&Ve(i,e,r),n[i[o]]>n[i[r]]&&Ve(i,o,r),n[i[e]]>n[i[o]]&&Ve(i,e,o);const c=i[o],l=n[c];for(;;){do o++;while(n[i[o]]<l);do a--;while(n[i[a]]>l);if(a<o)break;Ve(i,o,a)}i[e+1]=i[a],i[a]=c,r-o+1>=a-e?(Te(i,n,o,r),Te(i,n,e,a-1)):(Te(i,n,e,a-1),Te(i,n,o,r))}}function Ve(i,n,e){const r=i[n];i[n]=i[e],i[e]=r}function ys(i){return i[0]}function vs(i){return i[1]}const Yn=1e-6;class we{constructor(){this._x0=this._y0=this._x1=this._y1=null,this._=""}moveTo(n,e){this._+=`M${this._x0=this._x1=+n},${this._y0=this._y1=+e}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")}lineTo(n,e){this._+=`L${this._x1=+n},${this._y1=+e}`}arc(n,e,r){n=+n,e=+e,r=+r;const s=n+r,o=e;if(r<0)throw new Error("negative radius");this._x1===null?this._+=`M${s},${o}`:(Math.abs(this._x1-s)>Yn||Math.abs(this._y1-o)>Yn)&&(this._+="L"+s+","+o),r&&(this._+=`A${r},${r},0,1,1,${n-r},${e}A${r},${r},0,1,1,${this._x1=s},${this._y1=o}`)}rect(n,e,r,s){this._+=`M${this._x0=this._x1=+n},${this._y0=this._y1=+e}h${+r}v${+s}h${-r}Z`}value(){return this._||null}}class rn{constructor(){this._=[]}moveTo(n,e){this._.push([n,e])}closePath(){this._.push(this._[0].slice())}lineTo(n,e){this._.push([n,e])}value(){return this._.length?this._:null}}class ws{constructor(n,[e,r,s,o]=[0,0,960,500]){if(!((s=+s)>=(e=+e))||!((o=+o)>=(r=+r)))throw new Error("invalid bounds");this.delaunay=n,this._circumcenters=new Float64Array(n.points.length*2),this.vectors=new Float64Array(n.points.length*2),this.xmax=s,this.xmin=e,this.ymax=o,this.ymin=r,this._init()}update(){return this.delaunay.update(),this._init(),this}_init(){const{delaunay:{points:n,hull:e,triangles:r},vectors:s}=this;let o,a;const c=this.circumcenters=this._circumcenters.subarray(0,r.length/3*2);for(let y=0,m=0,v=r.length,w,x;y<v;y+=3,m+=2){const T=r[y]*2,S=r[y+1]*2,I=r[y+2]*2,E=n[T],b=n[T+1],C=n[S],M=n[S+1],z=n[I],k=n[I+1],_=C-E,A=M-b,L=z-E,R=k-b,H=(_*R-A*L)*2;if(Math.abs(H)<1e-9){if(o===void 0){o=a=0;for(const O of e)o+=n[O*2],a+=n[O*2+1];o/=e.length,a/=e.length}const $=1e9*Math.sign((o-E)*R-(a-b)*L);w=(E+z)/2-$*R,x=(b+k)/2+$*L}else{const $=1/H,O=_*_+A*A,N=L*L+R*R;w=E+(R*O-A*N)*$,x=b+(_*N-L*O)*$}c[m]=w,c[m+1]=x}let l=e[e.length-1],u,d=l*4,h,f=n[2*l],p,g=n[2*l+1];s.fill(0);for(let y=0;y<e.length;++y)l=e[y],u=d,h=f,p=g,d=l*4,f=n[2*l],g=n[2*l+1],s[u+2]=s[d]=p-g,s[u+3]=s[d+1]=f-h}render(n){const e=n==null?n=new we:void 0,{delaunay:{halfedges:r,inedges:s,hull:o},circumcenters:a,vectors:c}=this;if(o.length<=1)return null;for(let d=0,h=r.length;d<h;++d){const f=r[d];if(f<d)continue;const p=Math.floor(d/3)*2,g=Math.floor(f/3)*2,y=a[p],m=a[p+1],v=a[g],w=a[g+1];this._renderSegment(y,m,v,w,n)}let l,u=o[o.length-1];for(let d=0;d<o.length;++d){l=u,u=o[d];const h=Math.floor(s[u]/3)*2,f=a[h],p=a[h+1],g=l*4,y=this._project(f,p,c[g+2],c[g+3]);y&&this._renderSegment(f,p,y[0],y[1],n)}return e&&e.value()}renderBounds(n){const e=n==null?n=new we:void 0;return n.rect(this.xmin,this.ymin,this.xmax-this.xmin,this.ymax-this.ymin),e&&e.value()}renderCell(n,e){const r=e==null?e=new we:void 0,s=this._clip(n);if(s===null||!s.length)return;e.moveTo(s[0],s[1]);let o=s.length;for(;s[0]===s[o-2]&&s[1]===s[o-1]&&o>1;)o-=2;for(let a=2;a<o;a+=2)(s[a]!==s[a-2]||s[a+1]!==s[a-1])&&e.lineTo(s[a],s[a+1]);return e.closePath(),r&&r.value()}*cellPolygons(){const{delaunay:{points:n}}=this;for(let e=0,r=n.length/2;e<r;++e){const s=this.cellPolygon(e);s&&(s.index=e,yield s)}}cellPolygon(n){const e=new rn;return this.renderCell(n,e),e.value()}_renderSegment(n,e,r,s,o){let a;const c=this._regioncode(n,e),l=this._regioncode(r,s);c===0&&l===0?(o.moveTo(n,e),o.lineTo(r,s)):(a=this._clipSegment(n,e,r,s,c,l))&&(o.moveTo(a[0],a[1]),o.lineTo(a[2],a[3]))}contains(n,e,r){return e=+e,e!==e||(r=+r,r!==r)?!1:this.delaunay._step(n,e,r)===n}*neighbors(n){const e=this._clip(n);if(e)for(const r of this.delaunay.neighbors(n)){const s=this._clip(r);if(s){e:for(let o=0,a=e.length;o<a;o+=2)for(let c=0,l=s.length;c<l;c+=2)if(e[o]===s[c]&&e[o+1]===s[c+1]&&e[(o+2)%a]===s[(c+l-2)%l]&&e[(o+3)%a]===s[(c+l-1)%l]){yield r;break e}}}}_cell(n){const{circumcenters:e,delaunay:{inedges:r,halfedges:s,triangles:o}}=this,a=r[n];if(a===-1)return null;const c=[];let l=a;do{const u=Math.floor(l/3);if(c.push(e[u*2],e[u*2+1]),l=l%3===2?l-2:l+1,o[l]!==n)break;l=s[l]}while(l!==a&&l!==-1);return c}_clip(n){if(n===0&&this.delaunay.hull.length===1)return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];const e=this._cell(n);if(e===null)return null;const{vectors:r}=this,s=n*4;return this._simplify(r[s]||r[s+1]?this._clipInfinite(n,e,r[s],r[s+1],r[s+2],r[s+3]):this._clipFinite(n,e))}_clipFinite(n,e){const r=e.length;let s=null,o,a,c=e[r-2],l=e[r-1],u,d=this._regioncode(c,l),h,f=0;for(let p=0;p<r;p+=2)if(o=c,a=l,c=e[p],l=e[p+1],u=d,d=this._regioncode(c,l),u===0&&d===0)h=f,f=0,s?s.push(c,l):s=[c,l];else{let g,y,m,v,w;if(u===0){if((g=this._clipSegment(o,a,c,l,u,d))===null)continue;[y,m,v,w]=g}else{if((g=this._clipSegment(c,l,o,a,d,u))===null)continue;[v,w,y,m]=g,h=f,f=this._edgecode(y,m),h&&f&&this._edge(n,h,f,s,s.length),s?s.push(y,m):s=[y,m]}h=f,f=this._edgecode(v,w),h&&f&&this._edge(n,h,f,s,s.length),s?s.push(v,w):s=[v,w]}if(s)h=f,f=this._edgecode(s[0],s[1]),h&&f&&this._edge(n,h,f,s,s.length);else if(this.contains(n,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2))return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];return s}_clipSegment(n,e,r,s,o,a){const c=o<a;for(c&&([n,e,r,s,o,a]=[r,s,n,e,a,o]);;){if(o===0&&a===0)return c?[r,s,n,e]:[n,e,r,s];if(o&a)return null;let l,u,d=o||a;d&8?(l=n+(r-n)*(this.ymax-e)/(s-e),u=this.ymax):d&4?(l=n+(r-n)*(this.ymin-e)/(s-e),u=this.ymin):d&2?(u=e+(s-e)*(this.xmax-n)/(r-n),l=this.xmax):(u=e+(s-e)*(this.xmin-n)/(r-n),l=this.xmin),o?(n=l,e=u,o=this._regioncode(n,e)):(r=l,s=u,a=this._regioncode(r,s))}}_clipInfinite(n,e,r,s,o,a){let c=Array.from(e),l;if((l=this._project(c[0],c[1],r,s))&&c.unshift(l[0],l[1]),(l=this._project(c[c.length-2],c[c.length-1],o,a))&&c.push(l[0],l[1]),c=this._clipFinite(n,c))for(let u=0,d=c.length,h,f=this._edgecode(c[d-2],c[d-1]);u<d;u+=2)h=f,f=this._edgecode(c[u],c[u+1]),h&&f&&(u=this._edge(n,h,f,c,u),d=c.length);else this.contains(n,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)&&(c=[this.xmin,this.ymin,this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax]);return c}_edge(n,e,r,s,o){for(;e!==r;){let a,c;switch(e){case 5:e=4;continue;case 4:e=6,a=this.xmax,c=this.ymin;break;case 6:e=2;continue;case 2:e=10,a=this.xmax,c=this.ymax;break;case 10:e=8;continue;case 8:e=9,a=this.xmin,c=this.ymax;break;case 9:e=1;continue;case 1:e=5,a=this.xmin,c=this.ymin;break}(s[o]!==a||s[o+1]!==c)&&this.contains(n,a,c)&&(s.splice(o,0,a,c),o+=2)}return o}_project(n,e,r,s){let o=1/0,a,c,l;if(s<0){if(e<=this.ymin)return null;(a=(this.ymin-e)/s)<o&&(l=this.ymin,c=n+(o=a)*r)}else if(s>0){if(e>=this.ymax)return null;(a=(this.ymax-e)/s)<o&&(l=this.ymax,c=n+(o=a)*r)}if(r>0){if(n>=this.xmax)return null;(a=(this.xmax-n)/r)<o&&(c=this.xmax,l=e+(o=a)*s)}else if(r<0){if(n<=this.xmin)return null;(a=(this.xmin-n)/r)<o&&(c=this.xmin,l=e+(o=a)*s)}return[c,l]}_edgecode(n,e){return(n===this.xmin?1:n===this.xmax?2:0)|(e===this.ymin?4:e===this.ymax?8:0)}_regioncode(n,e){return(n<this.xmin?1:n>this.xmax?2:0)|(e<this.ymin?4:e>this.ymax?8:0)}_simplify(n){if(n&&n.length>4){for(let e=0;e<n.length;e+=2){const r=(e+2)%n.length,s=(e+4)%n.length;(n[e]===n[r]&&n[r]===n[s]||n[e+1]===n[r+1]&&n[r+1]===n[s+1])&&(n.splice(r,2),e-=2)}n.length||(n=null)}return n}}const Ps=2*Math.PI,ze=Math.pow;function xs(i){return i[0]}function bs(i){return i[1]}function Cs(i){const{triangles:n,coords:e}=i;for(let r=0;r<n.length;r+=3){const s=2*n[r],o=2*n[r+1],a=2*n[r+2];if((e[a]-e[s])*(e[o+1]-e[s+1])-(e[o]-e[s])*(e[a+1]-e[s+1])>1e-10)return!1}return!0}function Is(i,n,e){return[i+Math.sin(i+n)*e,n+Math.cos(i-n)*e]}class kt{static from(n,e=xs,r=bs,s){return new kt("length"in n?Ss(n,e,r,s):Float64Array.from(zs(n,e,r,s)))}constructor(n){this._delaunator=new St(n),this.inedges=new Int32Array(n.length/2),this._hullIndex=new Int32Array(n.length/2),this.points=this._delaunator.coords,this._init()}update(){return this._delaunator.update(),this._init(),this}_init(){const n=this._delaunator,e=this.points;if(n.hull&&n.hull.length>2&&Cs(n)){this.collinear=Int32Array.from({length:e.length/2},(f,p)=>p).sort((f,p)=>e[2*f]-e[2*p]||e[2*f+1]-e[2*p+1]);const l=this.collinear[0],u=this.collinear[this.collinear.length-1],d=[e[2*l],e[2*l+1],e[2*u],e[2*u+1]],h=1e-8*Math.hypot(d[3]-d[1],d[2]-d[0]);for(let f=0,p=e.length/2;f<p;++f){const g=Is(e[2*f],e[2*f+1],h);e[2*f]=g[0],e[2*f+1]=g[1]}this._delaunator=new St(e)}else delete this.collinear;const r=this.halfedges=this._delaunator.halfedges,s=this.hull=this._delaunator.hull,o=this.triangles=this._delaunator.triangles,a=this.inedges.fill(-1),c=this._hullIndex.fill(-1);for(let l=0,u=r.length;l<u;++l){const d=o[l%3===2?l-2:l+1];(r[l]===-1||a[d]===-1)&&(a[d]=l)}for(let l=0,u=s.length;l<u;++l)c[s[l]]=l;s.length<=2&&s.length>0&&(this.triangles=new Int32Array(3).fill(-1),this.halfedges=new Int32Array(3).fill(-1),this.triangles[0]=s[0],a[s[0]]=1,s.length===2&&(a[s[1]]=0,this.triangles[1]=s[1],this.triangles[2]=s[1]))}voronoi(n){return new ws(this,n)}*neighbors(n){const{inedges:e,hull:r,_hullIndex:s,halfedges:o,triangles:a,collinear:c}=this;if(c){const h=c.indexOf(n);h>0&&(yield c[h-1]),h<c.length-1&&(yield c[h+1]);return}const l=e[n];if(l===-1)return;let u=l,d=-1;do{if(yield d=a[u],u=u%3===2?u-2:u+1,a[u]!==n)return;if(u=o[u],u===-1){const h=r[(s[n]+1)%r.length];h!==d&&(yield h);return}}while(u!==l)}find(n,e,r=0){if(n=+n,n!==n||(e=+e,e!==e))return-1;const s=r;let o;for(;(o=this._step(r,n,e))>=0&&o!==r&&o!==s;)r=o;return o}_step(n,e,r){const{inedges:s,hull:o,_hullIndex:a,halfedges:c,triangles:l,points:u}=this;if(s[n]===-1||!u.length)return(n+1)%(u.length>>1);let d=n,h=ze(e-u[n*2],2)+ze(r-u[n*2+1],2);const f=s[n];let p=f;do{let g=l[p];const y=ze(e-u[g*2],2)+ze(r-u[g*2+1],2);if(y<h&&(h=y,d=g),p=p%3===2?p-2:p+1,l[p]!==n)break;if(p=c[p],p===-1){if(p=o[(a[n]+1)%o.length],p!==g&&ze(e-u[p*2],2)+ze(r-u[p*2+1],2)<h)return p;break}}while(p!==f);return d}render(n){const e=n==null?n=new we:void 0,{points:r,halfedges:s,triangles:o}=this;for(let a=0,c=s.length;a<c;++a){const l=s[a];if(l<a)continue;const u=o[a]*2,d=o[l]*2;n.moveTo(r[u],r[u+1]),n.lineTo(r[d],r[d+1])}return this.renderHull(n),e&&e.value()}renderPoints(n,e){e===void 0&&(!n||typeof n.moveTo!="function")&&(e=n,n=null),e=e==null?2:+e;const r=n==null?n=new we:void 0,{points:s}=this;for(let o=0,a=s.length;o<a;o+=2){const c=s[o],l=s[o+1];n.moveTo(c+e,l),n.arc(c,l,e,0,Ps)}return r&&r.value()}renderHull(n){const e=n==null?n=new we:void 0,{hull:r,points:s}=this,o=r[0]*2,a=r.length;n.moveTo(s[o],s[o+1]);for(let c=1;c<a;++c){const l=2*r[c];n.lineTo(s[l],s[l+1])}return n.closePath(),e&&e.value()}hullPolygon(){const n=new rn;return this.renderHull(n),n.value()}renderTriangle(n,e){const r=e==null?e=new we:void 0,{points:s,triangles:o}=this,a=o[n*=3]*2,c=o[n+1]*2,l=o[n+2]*2;return e.moveTo(s[a],s[a+1]),e.lineTo(s[c],s[c+1]),e.lineTo(s[l],s[l+1]),e.closePath(),r&&r.value()}*trianglePolygons(){const{triangles:n}=this;for(let e=0,r=n.length/3;e<r;++e)yield this.trianglePolygon(e)}trianglePolygon(n){const e=new rn;return this.renderTriangle(n,e),e.value()}}function Ss(i,n,e,r){const s=i.length,o=new Float64Array(s*2);for(let a=0;a<s;++a){const c=i[a];o[a*2]=n.call(r,c,a,i),o[a*2+1]=e.call(r,c,a,i)}return o}function*zs(i,n,e,r){let s=0;for(const o of i)yield n.call(r,o,s,i),yield e.call(r,o,s,i),++s}function zi(i){return{originalBorder:i,flattenedPolygon:fi(i)[0]}}function Ms(i){if(i.length===0)return[0,0];const n=i.reduce((e,r)=>[e[0]+r[0],e[1]+r[1]],[0,0]);return[n[0]/i.length,n[1]/i.length]}function tt(i,n,e){const r={id:i,site:Ms(n),halfEdge:-1,bounds:ee(n)},s=un(n,i,e);return s.length>0&&(r.halfEdge=s[0].id),r}function fn(i,n){const r=i.map(o=>ln(o,n.originalBorder)).filter(Boolean).length;return r===0?null:r===i.length?i:qo(i,n.flattenedPolygon)?.[0]??null}const pn="VoronoiPieceGenerator",Es={name:pn,displayName:"Voronoi",description:"Construct pieces by building a Voronoi diagram from the seed points. Each piece consists of all area of the plane closer to its seed point than any other seed point. In practice, this creates irregular polygons with 3-8 sides.",sortHint:1,controls:[{type:"choice",name:"whimsyMode",label:"Whimsy Mode",defaultValue:"simple+merge",choices:[["simple","Simple","Cuts each whimsy out of the generated pieces."],["simple+merge","Simple+Merge","Cuts out whimsies, then merges small fragments into neighbors. Best balance of quality and uniform density."],["flow","Flow","Eliminates seed points near whimsies. Works best with convex shapes."],["adaptive","Adaptive","Eliminates seed points near whimsies and filters out undersized fragments. Best for complex whimsies."]]},{type:"number",name:"eliminationThreshold",label:"Elimination Threshold",defaultValue:20,min:0,max:60,helpText:"Distance (in pixels) from whimsy boundaries where seed points are eliminated. Higher values remove more seeds near whimsies.",dependsOn:[{config:"whimsyMode",value:"flow"},{config:"whimsyMode",value:"adaptive"}]},{type:"number",name:"minFragmentSizeRatio",label:"Min Fragment Size Ratio",defaultValue:.3,min:.1,max:.8,helpText:"Minimum acceptable piece size as a fraction of average piece size. Pieces smaller than this are eliminated or merged. (e.g., 0.3 = 30% of average)",dependsOn:[{config:"whimsyMode",value:"adaptive"},{config:"whimsyMode",value:"simple+merge"}]},{type:"number",name:"maxIterations",label:"Max Iterations",defaultValue:3,min:1,max:5,helpText:"Number of filtering passes to remove seed points that create undersized pieces. More iterations = more thorough filtering.",dependsOn:[{config:"whimsyMode",value:"adaptive"}]}]};function ks(i){return`${i[0].toPrecision(7)},${i[1].toPrecision(7)}`}function le(i,n){const r=n.flattenedPolygon;for(let s=0;s<r.length;s++){const o=r[s],a=r[(s+1)%r.length];if(Mi(i,o,a)<.001)return!0}return!1}function Mi(i,n,e){const[r,s]=i,[o,a]=n,[c,l]=e,u=c-o,d=l-a,h=u*u+d*d;if(h===0)return Math.hypot(r-o,s-a);let f=((r-o)*u+(s-a)*d)/h;f=Math.max(0,Math.min(1,f));const p=o+f*u,g=a+f*d;return Math.hypot(r-p,s-g)}function Ts(i,n){let e=1/0;for(let r=0;r<n.length;r++){const s=n[r],o=n[(r+1)%n.length],a=Mi(i,s,o);e=Math.min(e,a)}return e}function _s(i,n,e){const r=[],s=n.map(o=>at(o));for(const o of i){let a=!0;for(const c of s){if(Ae(o,c)){a=!1;break}if(Ts(o,c)<e){a=!1;break}}a&&r.push(o)}return r}function Ds(i,n){const e=i.cellPolygon(n);return e?Array.from(e).map(r=>{const[s,o]=r;return[s,o]}):null}function As(i,n,e,r,s){const{minFragmentSizeRatio:o,maxIterations:a}=s,c=e.width*e.height/i.length,l=Math.max(500,c*o);console.log(`Fragment filtering: min area = ${l.toFixed(0)}px (${(o*100).toFixed(0)}% of avg ${c.toFixed(0)}px)`);let u=i,d=0;for(let h=0;h<a;h++){if(u.length===0){console.warn(`Fragment filtering: All seeds eliminated after ${h} iterations`);break}const p=kt.from(u).voronoi([0,0,e.width,e.height]),g=[];let y=0;for(let m=0;m<u.length;m++){const v=Ds(p,m);if(!v){y++;continue}const w=fn(v,r);if(!w){y++;continue}if(n.length>0){const x=wi(w,n);if(x.length>0){const T=Pi(w,x);if(!T||T.length===0){y++;continue}if(T.some(I=>vt(I)<l)){y++;continue}}}g.push(u[m])}if(d+=y,y>0&&console.log(`Fragment filtering iteration ${h+1}: eliminated ${y} seeds (${g.length} remaining)`),y===0){console.log(`Fragment filtering converged after ${h+1} iteration(s) (total eliminated: ${d})`);break}u=g}return u}const Ls=(i,n,e)=>{const{width:r,height:s}=n,o=e.whimsyMode??"adaptive",a=e.eliminationThreshold??20,c=e.minFragmentSizeRatio??.3,l=e.maxIterations??3,u=zi(i);return{generatePieces(h,f){const{border:p,customPieces:g=[]}=f;console.log(`VoronoiPieceGenerator using dimensions ${r}x${s}`);let y=h;if(g.length>0&&(o==="flow"||o==="adaptive")){console.log(`${o==="adaptive"?"Adaptive":"Flow"} mode: adjusting ${h.length} seed points for ${g.length} custom pieces (threshold: ${a}px)`),y=_s(h,g,a);const I=h.length-y.length,E=(I/h.length*100).toFixed(1);if(console.log(`Seed elimination: ${y.length} seed points remaining (eliminated ${I} / ${E}%)`),o==="adaptive"){console.log("Adaptive mode: filtering seeds that would create small fragments"),y=As(y,g,n,u,{minFragmentSizeRatio:c,maxIterations:l});const b=h.length-y.length,C=(b/h.length*100).toFixed(1);console.log(`Adaptive mode: ${y.length} seed points remaining after all filtering (total eliminated ${b} / ${C}%)`)}}const v=kt.from(y).voronoi([0,0,r,s]),w={vertices:[],pieces:new Map,edges:new Map,halfEdges:new Map,boundary:[],borderPath:p},x=new Map;let T=0;for(let I=0;I<y.length;I++){const E=y[I],b=v.cellPolygon(I);if(!b)continue;const C=fn(b,u);if(!C)continue;if(g.length>0){const A=wi(C,g);if(A.length>0){const L=Pi(C,A);if(!L||L.length===0)continue;for(const R of L){if(R.length<3)continue;const H=T++,$=tt(H,R,w);$.site=E,w.pieces.set(H,$);const O=[];let N=$.halfEdge;if(N!==-1){const U=N;do{const V=w.halfEdges.get(N);O.push(V),N=V.next}while(N!==U)}Pe(O,w,x,(U,V)=>le(U,u)&&le(V,u))}continue}}const M=T++,z=tt(M,C,w);z.site=E,w.pieces.set(M,z);const k=[];let _=z.halfEdge;if(_!==-1){const A=_;do{const L=w.halfEdges.get(_);k.push(L),_=L.next}while(_!==A)}Pe(k,w,x,(A,L)=>le(A,u)&&le(L,u))}for(const I of g){const E=T++,b=Nr(I,E,w);w.pieces.set(E,b);const C=[];let M=b.halfEdge;if(M!==-1){const z=M;do{const k=w.halfEdges.get(M);C.push(k),M=k.next}while(M!==z)}Pe(C,w,x,(z,k)=>le(z,u)&&le(k,u))}if(g.length>0&&o==="simple+merge"){const I=n.width*n.height/y.length,E=Math.max(500,I*c);console.log(`Simple+merge mode: post-processing to merge fragments (threshold: ${E.toFixed(0)}px)`),hi(w,E,x,(b,C)=>le(b,u)&&le(C,u))}const S=new Map;for(const I of w.halfEdges.values()){const E=ks(I.origin);S.has(E)||S.set(E,I.origin)}return w.vertices=Array.from(S.values()),w}}};it.register(pn,Ls,Es);const zt="SimpleTabPlacementStrategy",Rs={name:zt,displayName:"Simple",description:"Creates a single tab in the center of each edge with a random orientation.",sortHint:1,controls:[{type:"range",name:"tabSize",label:"Tab Size",optional:!0,min:.01,max:1,step:.01,defaultValue:.5,helpText:"The width of the tab as a fraction of the edge length"},{type:"number",name:"minEdgeLength",label:"Minimum Edge Length",optional:!0,defaultValue:15,helpText:"Edges shorter than this value will not have a tab"},{type:"number",name:"maxTabSize",label:"Maximum Tab Size",helpText:"Maximum width of a generated tab"}]};function Kn(i,n,e,r){if(i.tabs=void 0,!(i.heRight!==-1))return;const o=n.halfEdges.get(i.heLeft),a=n.halfEdges.get(i.heRight);if(!o||!a)return;const c=n.pieces.get(o.piece),l=n.pieces.get(a.piece);if(c?.isCustomPiece||l?.isCustomPiece)return;const u=o.origin,d=a.origin,h=Math.hypot(d[0]-u[0],d[1]-u[1]);if(h>=e.minEdgeLength){let f=e.tabSize;e.maxTabSize&&h*f>e.maxTabSize&&(f=e.maxTabSize/h);const p={position:.5,size:f,convex:r()>.5};i.tabs=[p]}}const Hs=(i,n,e)=>{const{tabSize:r=.5,minEdgeLength:s=0,maxTabSize:o}=e,a={tabSize:r,minEdgeLength:s,maxTabSize:o};return{placeTabs(c){const{topology:l,random:u}=c;for(const d of l.edges.values())Kn(d,l,a,u)},updateTabPlacements(c,l){const{topology:u,random:d}=l;for(const h of c)Kn(h,u,a,d)}}};ot.register(zt,Hs,Rs);const mn="TraditionalTabGenerator",Os={name:mn,displayName:"Traditional",description:"Creates a traditional rounded tab for each (internal) piece edge.",sortHint:1,controls:[{type:"range",name:"jitter",label:"Randomness",defaultValue:8,min:0,max:100,step:1,helpText:"Adds randomness to the tab shape. 0 means completely uniform tabs"},{type:"range",name:"heightToWidthRatio",label:"Tab Height",defaultValue:50,min:5,max:100,step:5,helpText:"The height of the tab as a percent of its width"}]};function $s(i,n,e,r,s,o=!1){const a=n[0]-i[0],c=n[1]-i[1],l=Math.hypot(a,c);if(l===0)return console.warn("Edge has zero length"),[];const u=[a/l,c/l],d=[-u[1],u[0]],h=(k,_)=>[i[0]+(u[0]*k+d[0]*_)*l,i[1]+(u[1]*k+d[1]*_)*l],f=e/100,p=()=>(s()*2-1)*f,g=p(),y=p(),m=p(),v=p(),w=p(),x=.1625,T=o?-1:1,S=r,I=S/3,b=[[0,0],[.2,g*I],[.5+y+v,T*(-I+m*S)],[.5-x+y,T*(I+m*S)],[.5-2*x+y-v,T*(S+m*S)],[.5+2*x+y-v,T*(S+m*S)],[.5+x+y,T*(I+m*S)],[.5+y+v,T*(-I+m*S)],[.8,w*I],[1,0]].map(([k,_])=>h(k,_)),C={type:"bezier",p1:b[1],p2:b[2],p3:b[3]},M={type:"bezier",p1:b[4],p2:b[5],p3:b[6]},z={type:"bezier",p1:b[7],p2:b[8],p3:b[9]};return[C,M,z]}const Ns=(i,n,e)=>{const{jitter:r=8,heightToWidthRatio:s=50}=e;return{createTabSegments(a,c,l,u){const d=!l.convex;return $s(a,c,r,s/100,u,d)}}};xe.register(mn,Ns,Os);function Fs(i){return new Worker("/puzzle-generator/assets/CheckGeometryWorker-B-2izMXZ.js",{name:i?.name})}function Vs(i,n){return new Promise((e,r)=>{const s=new Fs;s.onmessage=a=>{const c=a.data;switch(c.type){case"progress":n?.(c.processed,c.total);break;case"done":e(c.results),s.terminate();break;case"error":r(new Error(c.message)),s.terminate();break}},s.onerror=a=>{r(new Error(a.message)),s.terminate()};const o={topology:No(i)};s.postMessage(o)})}const Ei="GridJitterPointGenerator",Us={name:Ei,displayName:"Grid",description:"Generate seed points using a grid with optional random jitter. Has a uniform, regular look, especially with low randomness values.",sortHint:2,controls:[{type:"range",name:"jitter",label:"Randomness",min:0,max:100,step:5,defaultValue:50,helpText:"Amount of jitter to apply to each grid point (0 to 100%)"}]},Gs=(i,n,e)=>{const{jitter:r=50}=e;return{generatePoints(o){const{width:a,height:c,pieceSize:l,random:u,border:d}=o,h=[];for(let f=0;f<a;f+=l)for(let p=0;p<c;p+=l){const g=[f+l/2,p+l/2];r>0&&(g[0]+=(u()-.5)*(r/100)*l,g[1]+=(u()-.5)*(r/100)*l),ln(g,d)&&h.push(g)}return h}}};nt.register(Ei,Gs,Us);const ki="RectangularPieceGenerator",js={name:ki,displayName:"Rectangular",description:"Construct pieces from a regular grid. All pieces have 4 sides and are the same size (except when the border is irregular). This generator ignores seed points.",sortHint:2,controls:[]},Bs=(i,n,e)=>{const{width:r,height:s}=n,o=zi(i);return{generatePieces(c,l){const{pieceSize:u,border:d,customPieces:h=[]}=l,f={vertices:[],pieces:new Map,edges:new Map,halfEdges:new Map,boundary:[],borderPath:d},p=Math.ceil(r/u),g=Math.ceil(s/u),y=Math.round(r/p),m=Math.round(s/g),v=[];for(let b=0;b<=g;b++){const C=[];for(let M=0;M<=p;M++){const z=M*y,k=b*m;C.push([z,k])}v.push(C)}f.vertices=v.flat();const w=new Map;let x=0;const T=b=>{const C=[];for(let M=0;M<b.length;M++){const z=b[M],k=b[(M+1)%b.length];C.push(z);const _=[];for(let A=0;A<=p;A++){const L=A*y;if(z[0]<L&&k[0]>L||z[0]>L&&k[0]<L){const R=(L-z[0])/(k[0]-z[0]),H=z[1]+R*(k[1]-z[1]);_.push({t:R,point:[L,H]})}}for(let A=0;A<=g;A++){const L=A*m;if(z[1]<L&&k[1]>L||z[1]>L&&k[1]<L){const R=(L-z[1])/(k[1]-z[1]),H=z[0]+R*(k[0]-z[0]);_.push({t:R,point:[H,L]})}}_.sort((A,L)=>A.t-L.t);for(const A of _)C.push(A.point)}return C},S=(b,C,M)=>{const[z,k]=b,[_,A]=C,[L,R]=M,H=L-_,$=R-A,O=H*H+$*$;if(O===0)return Math.hypot(z-_,k-A);let N=((z-_)*H+(k-A)*$)/O;N=Math.max(0,Math.min(1,N));const U=_+N*H,V=A+N*$;return Math.hypot(z-U,k-V)},I=b=>{const M=o.flattenedPolygon;for(let z=0;z<M.length;z++){const k=M[z],_=M[(z+1)%M.length];if(S(b,k,_)<.001)return!0}return!1},E=h.map(b=>{const C=at(b),M=T(C);return{original:b,polygon:M}});for(let b=0;b<g;b++)for(let C=0;C<p;C++){const M=v[b][C],z=v[b][C+1],k=v[b+1][C],_=v[b+1][C+1],L=fn([M,z,_,k],o);if(!L)continue;if(E.length>0){const N=[],U=ee(L);for(const{polygon:V}of E){const de=ee(V);if(!ci(U,de))continue;let G=!1;for(const K of L)if(Ae(K,V)){G=!0;break}if(!G){for(const K of V)if(Ae(K,L)){G=!0;break}}G&&N.push(V)}if(N.length>0){let V=[L.map(G=>[G[0],G[1]])];for(const G of N){const K=[G.map(Q=>[Q[0],Q[1]])],re=ai(V,K);if(!re||re.length===0){V=[];break}V=re}const de=[];if(Array.isArray(V)&&V.length>0){for(const G of V)if(Array.isArray(G)&&G.length>0){const K=G[0];if(Array.isArray(K)){const re=K.map(Q=>Array.isArray(Q)&&Q.length>=2?[Q[0],Q[1]]:[0,0]);de.push(re)}}}if(!de||de.length===0)continue;for(const G of de){if(G.length<3)continue;const K=x++,re=tt(K,G,f);f.pieces.set(K,re);const Q=[];let Le=re.halfEdge;if(Le!==-1){const Tt=Le;do{const lt=f.halfEdges.get(Le);Q.push(lt),Le=lt.next}while(Le!==Tt)}Pe(Q,f,w,(Tt,lt)=>I(Tt)&&I(lt))}continue}}const R=x++,H=tt(R,L,f);f.pieces.set(R,H);const $=[];let O=H.halfEdge;if(O!==-1){const N=O;do{const U=f.halfEdges.get(O);$.push(U),O=U.next}while(O!==N)}Pe($,f,w,(N,U)=>I(N)&&I(U))}for(const{polygon:b}of E){const C=x++,M=tt(C,b,f);f.pieces.set(C,M);const z=[];let k=M.halfEdge;if(k!==-1){const _=k;do{const A=f.halfEdges.get(k);z.push(A),k=A.next}while(k!==_)}Pe(z,f,w,(_,A)=>I(_)&&I(A))}if(h.length>0){const b=g*p,C=n.width*n.height/b,z=Math.max(500,C*.3);console.log(`RectangularPieceGenerator: post-processing to merge fragments (threshold: ${z.toFixed(0)}px)`),hi(f,z,w,(k,_)=>I(k)&&I(_))}return f}}};it.register(ki,Bs,js);const Ti="NullTabGenerator",Ws={name:Ti,displayName:"None",description:"Do not generate tabs. All pieces have straight edges.",sortHint:3,controls:[]},qs=(i,n,e)=>({createTabSegments(s,o,a,c){return[]}});xe.register(Ti,qs,Ws);const _i="TriangleTabGenerator",Xs={name:_i,displayName:"Triangle",description:"Creates a simple triangle between each (internal) piece edge.",sortHint:2,controls:[]},Ys=(i,n,e)=>({createTabSegments(s,o,a,c){const l=[o[0]-s[0],o[1]-s[1]],u=Math.hypot(l[0],l[1]);if(u<1e-6)return[];const d=[l[0]/u,l[1]/u],h=[-d[1],d[0]],f=[s[0]+l[0]/2,s[1]+l[1]/2],p=a.convex?1:-1,g=u*a.size*p,y=[f[0]+h[0]*g,f[1]+h[1]*g],m=[];return m.push({type:"line",p:s}),m.push({type:"line",p:y}),m.push({type:"line",p:o}),m}});xe.register(_i,Ys,Xs);let sn=!1;const Ks=window.matchMedia("(prefers-color-scheme: dark)");Ks.matches&&(sn=!0);const Zs=()=>{const e=dn,r=pn,s=mn,o={seed:new Date().getTime()%10240,canvasWidth:800,canvasHeight:600,aspectRatio:800/600,distance:40,color:sn?"#DDDDDD":"#333333",drawPoints:!1,pointColor:sn?"#FF0000":"#0000FF",borderShape:"rectangle",borderCornerRadius:50,geometryProblems:{autoCheck:!1,problems:void 0,progress:void 0},dirty:!0,generators:{point:{label:"Seed Points",registry:nt,name:e,config:nt.getDefaultConfig(e,800,600)},piece:{label:"Piece Generation",registry:it,name:r,config:it.getDefaultConfig(r,800,600)},placement:{label:"Tab Placement",registry:ot,name:zt,config:ot.getDefaultConfig(zt,800,600)},tab:{label:"Tabs",registry:xe,name:s,config:xe.getDefaultConfig(s,800,600)}},puzzle:void 0,backgroundImageUrl:void 0,backgroundImageName:"",customPieces:[],selectedCustomPieceId:null,customPieceEditorOpen:!1,editingCustomPieceId:void 0};function a(){const{canvasWidth:m,canvasHeight:v,borderShape:w,borderCornerRadius:x}=o;switch(w){case"rectangle":return on(m,v);case"circle":return Ko(Math.min(m,v));case"ellipse":return Zo(m,v);case"rounded-rect":return Qo(m,v,x);default:return on(m,v)}}function c(){o.customPieceEditorOpen=!0,o.editingCustomPieceId=void 0,P.redraw()}function l(m,v){const w=new Date().toISOString();if(o.editingCustomPieceId)o.customPieces=o.customPieces.map(x=>x.id===o.editingCustomPieceId?{...x,name:v,path:m,modified:w}:x);else{const x={id:`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:v,path:m,transform:Vr(m,o.canvasWidth,o.canvasHeight,o.distance),created:w};o.customPieces=[...o.customPieces,x]}o.customPieceEditorOpen=!1,o.editingCustomPieceId=void 0,o.dirty=!0,P.redraw()}function u(){o.customPieceEditorOpen=!1,o.editingCustomPieceId=void 0,P.redraw()}function d(m){o.selectedCustomPieceId=m,P.redraw()}function h(m){o.customPieces.find(w=>w.id===m)&&(o.editingCustomPieceId=m,o.customPieceEditorOpen=!0,P.redraw())}function f(m){const v=o.customPieces.find(w=>w.id===m);if(v){const w=new Date().toISOString(),x=v.name?(()=>{const S=/^(.*?)\s*\((\d+)\)$/,I=v.name.match(S);if(I){const E=I[1],b=parseInt(I[2],10);return`${E} (${b+1})`}return`${v.name} (2)`})():void 0,T={id:`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:x,path:[...v.path],transform:{position:[v.transform.position[0]+20,v.transform.position[1]+20],rotation:v.transform.rotation,scale:[...v.transform.scale]},created:w};o.customPieces=[...o.customPieces,T],o.selectedCustomPieceId=T.id,o.dirty=!0,P.redraw()}}function p(m){o.customPieces=o.customPieces.filter(v=>v.id!==m),o.selectedCustomPieceId===m&&(o.selectedCustomPieceId=null),o.dirty=!0,P.redraw()}function g(m){console.log(`Position custom piece: ${m}`),alert("Whimsy positioning functionality will be available in Phase 5")}function y(){o.puzzle&&(o.geometryProblems.progress=0,P.redraw(),Vs(o.puzzle,(m,v)=>{o.geometryProblems.progress=m/v*100,P.redraw()}).then(m=>{o.geometryProblems.problems=m.length,o.geometryProblems.progress=void 0,o.puzzle&&(o.puzzle.problems=m),P.redraw()}).catch(m=>{o.geometryProblems.progress=void 0,console.error(m),P.redraw()}))}return{oncreate:()=>{je({bounds:{width:o.canvasWidth,height:o.canvasHeight},border:a(),pieceSize:o.distance,pointConfig:o.generators.point.config,pieceConfig:o.generators.piece.config,placementConfig:o.generators.placement.config,tabConfig:o.generators.tab.config,seed:o.seed,customPieces:o.customPieces}).then(m=>{o.puzzle=m,P.redraw(),o.geometryProblems.autoCheck&&y()}).catch(m=>{console.error(m)})},onupdate:()=>{o.dirty&&(o.dirty=!1,je({bounds:{width:o.canvasWidth,height:o.canvasHeight},border:a(),pieceSize:o.distance,pointConfig:o.generators.point.config,pieceConfig:o.generators.piece.config,placementConfig:o.generators.placement.config,tabConfig:o.generators.tab.config,seed:o.seed,customPieces:o.customPieces}).then(m=>{o.geometryProblems.problems=void 0,o.geometryProblems.progress=void 0,o.puzzle=m,P.redraw(),o.geometryProblems.autoCheck&&y()}).catch(m=>{console.error(m)}))},onremove:()=>{o.backgroundImageUrl&&(URL.revokeObjectURL(o.backgroundImageUrl),o.backgroundImageUrl=void 0)},view:()=>P(".page",[P("h1","Puzzle Generator"),P(".container",[o.puzzle&&P(".puzzle-stack",[P(rr,{width:o.canvasWidth,height:o.canvasHeight,color:o.color,imageUrl:o.backgroundImageUrl,puzzle:o.puzzle,isDirty:o.dirty,pointColor:o.drawPoints?o.pointColor:void 0,customPieces:o.customPieces,selectedCustomPieceId:o.selectedCustomPieceId,onPuzzleChanged:m=>{o.puzzle=m,P.redraw()},onCustomPieceSelected:m=>{o.selectedCustomPieceId=m,P.redraw()},onCustomPieceTransformed:(m,v)=>{o.customPieces=o.customPieces.map(w=>w.id===m?{...w,transform:v}:w),o.dirty=!0,P.redraw(),je({bounds:{width:o.canvasWidth,height:o.canvasHeight},border:a(),seed:o.seed,pieceSize:o.distance,pointConfig:o.generators.point.config,pieceConfig:o.generators.piece.config,placementConfig:o.generators.placement.config,tabConfig:o.generators.tab.config,customPieces:o.customPieces}).then(w=>{o.geometryProblems.problems=void 0,o.geometryProblems.progress=void 0,o.puzzle=w,o.dirty=!1,P.redraw(),o.geometryProblems.autoCheck&&y()}).catch(w=>{console.error("Failed to rebuild puzzle with custom pieces:",w),o.dirty=!1,P.redraw()})},onSeedPointMoved:(m,v)=>{o.dirty=!1,o.puzzle&&Yo(o.puzzle,m,v).then(w=>{o.geometryProblems.problems=void 0,o.geometryProblems.progress=void 0,o.puzzle=w,P.redraw(),o.geometryProblems.autoCheck&&y()}).catch(w=>{console.error("Failed to rebuild puzzle with updated seed point:",w)})}}),P(".actions",[P(cr,{puzzle:o.puzzle,width:o.canvasWidth,height:o.canvasHeight,color:o.color}),P(lr,{autoCheck:o.geometryProblems.autoCheck,problems:o.geometryProblems.problems,progressPercent:o.geometryProblems.progress,onCheckRequested:()=>{o.dirty||y(),P.redraw()},onAutocheckChanged:m=>{m!==o.geometryProblems.autoCheck&&(o.geometryProblems.autoCheck=m,P.redraw())}})])]),P(".controls",[P(".background-image",[P(hr,{label:"Background Image",onUpload:(m,v,w,x)=>{o.backgroundImageUrl&&URL.revokeObjectURL(o.backgroundImageUrl),o.canvasWidth=w,o.canvasHeight=x,o.aspectRatio=w/x,o.backgroundImageUrl=m,o.backgroundImageName=v,o.dirty=!0,P.redraw()},onClear:()=>{o.backgroundImageUrl&&URL.revokeObjectURL(o.backgroundImageUrl),o.backgroundImageUrl=void 0,o.backgroundImageName="",o.dirty=!0,P.redraw()}})]),P(gr,{ratio:o.aspectRatio,disabled:o.backgroundImageUrl!==void 0,onChange:m=>{o.aspectRatio=m,o.canvasWidth=o.canvasHeight*m,o.dirty=!0,P.redraw()}}),P(vr,{shape:o.borderShape,disabled:o.backgroundImageUrl!==void 0,onChange:m=>{o.borderShape=m,o.dirty=!0,P.redraw()}}),o.borderShape==="rounded-rect"&&P(Pt,{config:{name:"cornerRadius",label:"Corner Radius",type:"number"},value:o.borderCornerRadius,onChange:m=>{o.borderCornerRadius=m??50,o.dirty=!0,P.redraw()}}),P(Pt,{config:{name:"seed",label:"Seed",type:"number"},value:o.seed,onChange:m=>{o.seed=m??0,o.dirty=!0,P.redraw()}}),P(Pt,{config:{name:"pieceSize",label:"Piece size",type:"number"},value:o.distance,onChange:m=>{o.distance=m??0,o.dirty=!0,P.redraw()}}),P(Ln,{label:"Piece color",color:o.color,size:"small",onUpdate:m=>{o.color=m,P.redraw()}}),P(".draw-points",[P(gi,{config:{name:"drawPoints",label:"Draw seed points",type:"boolean"},value:o.drawPoints,onChange:m=>{o.drawPoints=m,P.redraw()}}),o.drawPoints&&P(Ln,{label:"Seed points color",color:o.pointColor,size:"small",onUpdate:m=>{o.pointColor=m,P.redraw()}})]),P(Qr,{pieces:o.customPieces,selectedPieceId:o.selectedCustomPieceId,pieceColor:o.color,onAdd:c,onSelect:d,onEdit:h,onDuplicate:f,onDelete:p,onPosition:g}),...Object.entries(o.generators).map(([m,v])=>P("label",[v.label+":",P(mr,{generator:v.name,registry:v.registry,config:v.config,onGeneratorChange:w=>{w!=v.name&&(console.log(`${m} generator changed to ${w}`),v.name=w,o.generators[m].config=v.registry.getDefaultConfig(w,o.canvasWidth,o.canvasHeight),o.dirty=!0,P.redraw())},onConfigChange:(w,x)=>{console.log(`${m} generator config "${w}" changed to ${String(x)}`),v.config[w]=x,o.dirty=!0,P.redraw()}})]))])]),P(qr,{open:o.customPieceEditorOpen,piece:o.editingCustomPieceId?o.customPieces.find(m=>m.id===o.editingCustomPieceId):void 0,onSave:l,onCancel:u})])}};function Qs(){const i=window.matchMedia("(prefers-color-scheme: dark)");function n(){i.matches?document.documentElement.classList.add("wa-dark"):document.documentElement.classList.remove("wa-dark")}n(),i.addEventListener("change",n)}Qs();const Js={view:()=>[P(Li,{link:"https://github.com/weevilgenius/puzzle-generator"}),P(Zs)]};Ai("material",{resolver:i=>{const n=i.match(/^(.*?)(_(rounded|sharp))?$/);return n?`https://cdn.jsdelivr.net/npm/@material-symbols/svg-400@0.32.0/${n[3]??"outlined"}/${n[1]}.svg`:""},mutator:i=>i.setAttribute("fill","currentColor")});P.mount(document.body,Js);
//# sourceMappingURL=index-ClqKACnp.js.map
